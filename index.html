<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>青云修仙录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f5ff',
                            100: '#e1ebff',
                            200: '#c3d8ff',
                            300: '#a4c1ff',
                            400: '#819fff',
                            500: '#5D5CDE',
                            600: '#4242c9',
                            700: '#3333a3',
                            800: '#292985',
                            900: '#25256d',
                        },
                        ancient: {
                            50: '#fdf8f1',
                            100: '#f2e3ce',
                            200: '#e6d0ad',
                            300: '#d9b77a',
                            400: '#c99c52',
                            500: '#b68434',
                            600: '#95682b',
                            700: '#744f25',
                            800: '#5a3e23',
                            900: '#46321f',
                        }
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-in': 'slideIn 0.4s ease-out',
                        'slide-out': 'slideOut 0.4s ease-in',
                        'sparkle': 'sparkle 1.5s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite'
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        slideOut: {
                            '0%': { transform: 'translateX(0)', opacity: '1' },
                            '100%': { transform: 'translateX(100%)', opacity: '0' }
                        },
                        sparkle: {
                            '0%, 100%': { opacity: '0.2' },
                            '50%': { opacity: '1', filter: 'brightness(1.5)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.css" rel="stylesheet">
    <!-- Chart.js for analytics visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Noto+Serif+SC:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #5D5CDE;
            --scroll-color: #d9b77a;
            --paper-color: #f2e3ce;
            --ink-color: #46321f;
            --qi-color: #5D5CDE;
            --qi-glow: rgba(93, 92, 222, 0.3);
            --ancient-dark: #46321f;
            --ancient-light: #f2e3ce;
            --ancient-medium: #d9b77a;
            --ancient-accent: #b68434;
            --chart-grid: rgba(70, 50, 31, 0.1);
            --chart-text: #46321f;
            --achievement-common: #8bca8b;
            --achievement-uncommon: #7b98e8;
            --achievement-rare: #bc83e3;
            --achievement-epic: #e8a95c;
            --achievement-legendary: #e35d5d;
            --achievement-mythic: #b76ee8;
            --achievement-hidden: #777777;
        }

        /* Theme: Default Light */
        .theme-default.light {
            --paper-color: #f2e3ce;
            --ink-color: #46321f;
            --ancient-dark: #46321f;
            --ancient-light: #f2e3ce;
            --ancient-medium: #d9b77a;
            --ancient-accent: #b68434;
            --chart-grid: rgba(70, 50, 31, 0.1);
            --chart-text: #46321f;
        }

        /* Theme: Default Dark */
        .theme-default.dark {
            --paper-color: #25256d;
            --ink-color: #f2e3ce;
            --ancient-dark: #f2e3ce;
            --ancient-light: #25256d;
            --ancient-medium: #3333a3;
            --ancient-accent: #819fff;
            --chart-grid: rgba(242, 227, 206, 0.1);
            --chart-text: #f2e3ce;
        }

        /* Theme: Black & White */
        .theme-bw.light {
            --paper-color: #ffffff;
            --ink-color: #121212;
            --ancient-dark: #121212;
            --ancient-light: #ffffff;
            --ancient-medium: #e0e0e0;
            --ancient-accent: #666666;
            --qi-color: #333333;
            --qi-glow: rgba(51, 51, 51, 0.3);
            --chart-grid: rgba(18, 18, 18, 0.1);
            --chart-text: #121212;
        }

        .theme-bw.dark {
            --paper-color: #121212;
            --ink-color: #ffffff;
            --ancient-dark: #ffffff;
            --ancient-light: #121212;
            --ancient-medium: #333333;
            --ancient-accent: #999999;
            --qi-color: #ffffff;
            --qi-glow: rgba(255, 255, 255, 0.3);
            --chart-grid: rgba(255, 255, 255, 0.1);
            --chart-text: #ffffff;
        }

        /* Theme: Retro */
        .theme-retro.light {
            --paper-color: #fbf3d0;
            --ink-color: #8b4513;
            --ancient-dark: #8b4513;
            --ancient-light: #fbf3d0;
            --ancient-medium: #deb887;
            --ancient-accent: #cd853f;
            --qi-color: #a0522d;
            --qi-glow: rgba(160, 82, 45, 0.3);
            --chart-grid: rgba(139, 69, 19, 0.1);
            --chart-text: #8b4513;
        }

        .theme-retro.dark {
            --paper-color: #2f4f4f;
            --ink-color: #f5deb3;
            --ancient-dark: #f5deb3;
            --ancient-light: #2f4f4f;
            --ancient-medium: #4a766e;
            --ancient-accent: #8fbc8f;
            --qi-color: #66cdaa;
            --qi-glow: rgba(102, 205, 170, 0.3);
            --chart-grid: rgba(245, 222, 179, 0.1);
            --chart-text: #f5deb3;
        }

        /* Theme: Oriental */
        .theme-oriental.light {
            --paper-color: #fff1e6;
            --ink-color: #ac0000;
            --ancient-dark: #ac0000;
            --ancient-light: #fff1e6;
            --ancient-medium: #ffb380;
            --ancient-accent: #dc6500;
            --qi-color: #e60000;
            --qi-glow: rgba(230, 0, 0, 0.3);
            --chart-grid: rgba(172, 0, 0, 0.1);
            --chart-text: #ac0000;
        }

        .theme-oriental.dark {
            --paper-color: #1f0c0c;
            --ink-color: #ff9e9e;
            --ancient-dark: #ff9e9e;
            --ancient-light: #1f0c0c;
            --ancient-medium: #3d1a1a;
            --ancient-accent: #d63030;
            --qi-color: #ff5252;
            --qi-glow: rgba(255, 82, 82, 0.3);
            --chart-grid: rgba(255, 158, 158, 0.1);
            --chart-text: #ff9e9e;
        }

        /* Theme: Modern */
        .theme-modern.light {
            --paper-color: #f8f9fa;
            --ink-color: #212529;
            --ancient-dark: #212529;
            --ancient-light: #f8f9fa;
            --ancient-medium: #e9ecef;
            --ancient-accent: #6c757d;
            --qi-color: #0d6efd;
            --qi-glow: rgba(13, 110, 253, 0.3);
            --chart-grid: rgba(33, 37, 41, 0.1);
            --chart-text: #212529;
        }

        .theme-modern.dark {
            --paper-color: #212529;
            --ink-color: #f8f9fa;
            --ancient-dark: #f8f9fa;
            --ancient-light: #212529;
            --ancient-medium: #343a40;
            --ancient-accent: #adb5bd;
            --qi-color: #0dcaf0;
            --qi-glow: rgba(13, 202, 240, 0.3);
            --chart-grid: rgba(248, 249, 250, 0.1);
            --chart-text: #f8f9fa;
        }

        /* Theme: Neon */
        .theme-neon.light {
            --paper-color: #ffffff;
            --ink-color: #121212;
            --ancient-dark: #121212;
            --ancient-light: #ffffff;
            --ancient-medium: #e0e0e0;
            --ancient-accent: #00ff99;
            --qi-color: #ff00ff;
            --qi-glow: rgba(255, 0, 255, 0.3);
            --chart-grid: rgba(18, 18, 18, 0.1);
            --chart-text: #121212;
        }

        .theme-neon.dark {
            --paper-color: #0f0f0f;
            --ink-color: #ffffff;
            --ancient-dark: #ffffff;
            --ancient-light: #0f0f0f;
            --ancient-medium: #222222;
            --ancient-accent: #00ff99;
            --qi-color: #ff00ff;
            --qi-glow: rgba(255, 0, 255, 0.5);
            --chart-grid: rgba(255, 255, 255, 0.1);
            --chart-text: #ffffff;
        }

        body {
            font-family: 'Cinzel', 'Noto Serif SC', serif;
            background-color: var(--paper-color);
            color: var(--ink-color);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .ancient-border {
            border: 2px solid var(--ancient-accent);
            box-shadow: 0 0 10px rgba(182, 132, 52, 0.3);
            background-color: var(--ancient-light);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }

        .ancient-scroll {
            background-color: var(--ancient-light);
            border: 2px solid var(--ancient-accent);
            border-radius: 5px;
            padding: 10px;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .ancient-scroll::before, .ancient-scroll::after {
            content: '';
            position: absolute;
            height: 100%;
            width: 20px;
            top: 0;
            background-color: var(--ancient-medium);
            border: 2px solid var(--ancient-accent);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .ancient-scroll::before {
            left: -10px;
            border-radius: 10px 0 0 10px;
        }

        .ancient-scroll::after {
            right: -10px;
            border-radius: 0 10px 10px 0;
        }

        .cultivation-banner {
            background: linear-gradient(to right, var(--ancient-medium), var(--ancient-light), var(--ancient-medium));
            border-top: 2px solid var(--ancient-accent);
            border-bottom: 2px solid var(--ancient-accent);
            padding: 0.5rem;
            text-align: center;
            position: relative;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .cultivation-banner::before, .cultivation-banner::after {
            content: '☯';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: var(--ancient-accent);
            transition: color 0.3s ease;
        }

        .cultivation-banner::before {
            left: 10px;
        }

        .cultivation-banner::after {
            right: 10px;
        }

        .qi-progress {
            background: linear-gradient(to right, var(--qi-color), var(--qi-glow));
            transition: width 0.5s ease-in-out, background 0.3s ease;
        }

        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--scroll-color) var(--ancient-light);
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: var(--ancient-light);
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background-color: var(--scroll-color);
            border-radius: 4px;
        }

        .tab-button {
            position: relative;
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            color: var(--ink-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-button:hover {
            border-bottom: 2px solid var(--ancient-accent);
        }

        .tab-button.active {
            border-bottom: 2px solid var(--ancient-accent);
            font-weight: bold;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--ancient-accent);
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .tab-button:hover::after {
            width: 100%;
        }

        .tab-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .glow-on-hover:hover {
            box-shadow: 0 0 10px var(--qi-glow);
        }

        .custom-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--ancient-accent);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            position: relative;
            background-color: var(--ancient-light);
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .custom-checkbox:checked {
            background-color: var(--ancient-accent);
        }

        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--ancient-light);
            font-size: 14px;
        }

        .ancient-input {
            background-color: var(--ancient-light);
            border: 2px solid var(--ancient-accent);
            color: var(--ink-color);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 16px;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .ancient-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--qi-glow);
        }

        .ancient-button {
            background-color: var(--ancient-accent);
            color: var(--ancient-light);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .ancient-button:hover {
            background-color: var(--ancient-dark);
            transform: translateY(-2px);
        }

        .ancient-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--ancient-dark);
            color: var(--ancient-light);
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, background-color 0.3s ease, color 0.3s ease;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .rotate-symbol {
            display: inline-block;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            background-color: var(--ancient-accent);
            color: var(--ancient-light);
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .spirit-stone {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .spirit-stone:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .stone-basic {
            background: linear-gradient(135deg, #a1a1a1, #d4d4d4);
        }
        
        .stone-low {
            background: linear-gradient(135deg, #3a8538, #5cc15a);
        }
        
        .stone-medium {
            background: linear-gradient(135deg, #3246b5, #5c7aff);
        }
        
        .stone-high {
            background: linear-gradient(135deg, #9c27b0, #d05ce3);
        }
        
        .stone-supreme {
            background: linear-gradient(135deg, #f57c00, #ffb74d);
        }
        
        .stone-divine {
            background: linear-gradient(135deg, #b71c1c, #f44336);
        }

        .stone-rename {
            background: linear-gradient(135deg, #f2e3ce, #c99c52);
            position: relative;
        }

        .stone-rename::after {
            content: 'R';
            position: absolute;
            font-size: 18px;
            color: #46321f;
            font-weight: bold;
        }

        /* Notification styles */
        .notification {
            position: relative;
            animation: animate-slide-in 0.4s ease-out;
            max-width: 350px;
        }

        .notification.closing {
            animation: animate-slide-out 0.4s ease-in forwards;
        }

        @keyframes animate-slide-in {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        @keyframes animate-slide-out {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background-color: rgba(255,255,255,0.5);
            width: 100%;
            animation: notification-progress 5s linear forwards;
        }

        @keyframes notification-progress {
            0% { width: 100%; }
            100% { width: 0%; }
        }

        .notification-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .notification-header {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .notification-type-breakthrough {
            background: linear-gradient(135deg, #5D5CDE, #3333a3);
            color: white;
        }

        .notification-type-idle {
            background: linear-gradient(135deg, #b68434, #95682b);
            color: white;
        }

        .notification-type-milestone {
            background: linear-gradient(135deg, #d9b77a, #c99c52);
            color: white;
        }

        .notification-type-fellowCultivator {
            background: linear-gradient(135deg, #5cc15a, #3a8538);
            color: white;
        }

        .notification-type-achievement {
            background: linear-gradient(135deg, #e8a95c, #bc83e3);
            color: white;
        }

        .notification-type-pomodoro {
            background: linear-gradient(135deg, #f44336, #e91e63);
            color: white;
        }

        /* Theme selector styles */
        .theme-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin: 0 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .theme-option.active {
            transform: scale(1.2);
            border-color: var(--ancient-accent);
        }

        /* Analytics section styles */
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }

        .qi-source-bar {
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            background-color: var(--ancient-light);
            border: 1px solid var(--ancient-accent);
        }

        .qi-active {
            height: 100%;
            background-color: var(--qi-color);
        }

        .qi-passive {
            height: 100%;
            background-color: var(--ancient-accent);
        }

        /* Input slider for themes */
        .ancient-range {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--ancient-medium);
            outline: none;
            transition: background 0.3s ease;
        }

        .ancient-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--ancient-accent);
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .ancient-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--ancient-accent);
            cursor: pointer;
            transition: background 0.3s ease;
        }

        /* Input toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--ancient-medium);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--ancient-light);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--ancient-accent);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* For scrollable settings sections */
        .settings-scroll {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Fellow Cultivator card style */
        .fellow-cultivator-card {
            border: 2px solid var(--ancient-accent);
            border-radius: 8px;
            background-color: var(--ancient-light);
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .fellow-cultivator-card:hover {
            box-shadow: 0 0 10px var(--qi-glow);
            transform: translateY(-2px);
        }

        .fellow-cultivator-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .fellow-cultivator-meta {
            font-size: 0.8rem;
            color: var(--ancient-dark);
            opacity: 0.8;
        }

        .fellow-cultivator-actions {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
            gap: 5px;
        }

        /* Fellow cultivator boost indicator */
        .boost-indicator {
            background-color: var(--qi-glow);
            border: 1px solid var(--qi-color);
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .boost-indicator i {
            color: var(--qi-color);
        }

        /* Spoiler styles */
        .spoiler-header {
            cursor: pointer;
            padding: 10px;
            background-color: var(--ancient-medium);
            border: 2px solid var(--ancient-accent);
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            transition: background-color 0.3s ease;
        }

        .spoiler-header:hover {
            background-color: var(--ancient-accent);
        }

        .spoiler-content {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-out;
        }

        .spoiler-content.open {
            max-height: 1000px; /* Adjust based on content */
            transition: max-height 0.5s ease-in;
        }

        .spoiler-icon {
            transition: transform 0.3s ease;
        }

        .spoiler-icon.open {
            transform: rotate(180deg);
        }

        /* Pomodoro timer styles */
        .timer-display {
            font-family: 'Cinzel', 'Noto Serif SC', serif;
            font-size: 5rem;
            font-weight: bold;
            text-align: center;
            color: var(--ancient-dark);
            text-shadow: 0 0 10px var(--qi-glow);
            transition: color 0.3s ease;
        }

        .timer-container {
            background: linear-gradient(to right, var(--ancient-medium), var(--ancient-light), var(--ancient-medium));
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 0 20px var(--qi-glow);
            position: relative;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .timer-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: radial-gradient(circle at center, transparent 0%, var(--qi-color) 100%);
            opacity: 0.1;
            z-index: -1;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .timer-button {
            background-color: var(--ancient-accent);
            color: var(--ancient-light);
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timer-button:hover {
            background-color: var(--ancient-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .timer-button i {
            font-size: 1.4rem;
        }

        .timer-progress {
            height: 10px;
            background-color: var(--ancient-light);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--qi-color), var(--qi-glow));
            width: 0%;
            transition: width 0.5s linear;
        }

        .timer-settings {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--ancient-light);
            border-radius: 10px;
            border: 2px solid var(--ancient-accent);
        }

        .break-indicator {
            font-size: 1.2rem;
            color: var(--qi-color);
            text-align: center;
            margin-top: 10px;
        }

        /* Achievement styles */
        .achievement-card {
            border: 2px solid var(--ancient-accent);
            border-radius: 8px;
            background-color: var(--ancient-light);
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .achievement-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .achievement-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .achievement-content {
            flex-grow: 1;
        }

        .achievement-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .achievement-description {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .achievement-progress {
            height: 6px;
            background-color: var(--ancient-medium);
            border-radius: 3px;
            overflow: hidden;
        }

        .achievement-progress-bar {
            height: 100%;
            transition: width 0.5s ease;
        }

        .achievement-common {
            background-color: var(--achievement-common);
        }

        .achievement-uncommon {
            background-color: var(--achievement-uncommon);
        }

        .achievement-rare {
            background-color: var(--achievement-rare);
        }

        .achievement-epic {
            background-color: var(--achievement-epic);
        }

        .achievement-legendary {
            background-color: var(--achievement-legendary);
        }

        .achievement-mythic {
            background-color: var(--achievement-mythic);
        }

        .achievement-hidden {
            background-color: var(--achievement-hidden);
        }

        .achievement-tabs {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            margin-bottom: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--ancient-accent) var(--ancient-light);
        }

        .achievement-tabs::-webkit-scrollbar {
            height: 6px;
        }

        .achievement-tabs::-webkit-scrollbar-track {
            background: var(--ancient-light);
        }

        .achievement-tabs::-webkit-scrollbar-thumb {
            background-color: var(--ancient-accent);
            border-radius: 3px;
        }

        .achievement-tab {
            padding: 8px 15px;
            background-color: var(--ancient-medium);
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .achievement-tab:hover {
            background-color: var(--ancient-accent);
        }

        .achievement-tab.active {
            background-color: var(--qi-color);
            color: white;
        }

        .achievement-count {
            display: inline-block;
            background-color: var(--ancient-dark);
            color: var(--ancient-light);
            border-radius: 9999px;
            padding: 2px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .achievement-summary {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--ancient-medium);
            border-radius: 10px;
            border: 2px solid var(--ancient-accent);
        }

        .achievement-rarity-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .achievement-boosted {
            position: relative;
        }

        .achievement-boosted::after {
            content: '✨';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 20px;
            animation: sparkle 1.5s infinite;
        }

        /* Task with pomodoro boost */
        .task-boosted {
            position: relative;
            overflow: hidden;
        }

        .task-boosted::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, var(--qi-glow), transparent);
            z-index: 0;
            animation: sparkle 2s infinite;
        }

        .task-boosted > * {
            position: relative;
            z-index: 1;
        }

        /* Special styles for completed achievements */
        .achievement-completed .achievement-icon {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Scientific notation toggle */
        .scientific-notation {
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="app" class="container mx-auto px-4 py-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold mb-2">青云修仙录</h1>
            <p class="text-xl">Ascension Through Tasks</p>
            <p id="cultivator-name" class="text-lg italic mt-2">Unnamed Cultivator</p>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-6 flex flex-wrap justify-center border-b border-ancient-accent">
            <button class="tab-button active" data-tab="cultivation">Cultivation</button>
            <button class="tab-button" data-tab="tasks">Tasks</button>
            <button class="tab-button" data-tab="pomodoro">Pomodoro</button>
            <button class="tab-button" data-tab="inventory">Inventory</button>
            <button id="fellowCultivators-tab-button" class="tab-button disabled" data-tab="fellowCultivators">Fellow Cultivators</button>
            <button class="tab-button" data-tab="achievements">Achievements</button>
            <button class="tab-button" data-tab="statistics">Statistics</button>
            <button class="tab-button" data-tab="analytics">Analytics</button>
            <button class="tab-button" data-tab="settings">Settings</button>
        </div>

        <!-- Tab Contents -->
        <div id="tab-content">
            <!-- Cultivation Tab -->
            <div id="cultivation-tab" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Cultivation Status -->
                    <div class="ancient-border rounded-lg p-4">
                        <h2 class="text-2xl font-bold mb-4 cultivation-banner">Cultivation Status</h2>
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <span>Current Realm: <span id="current-realm" class="font-bold">Mortal</span></span>
                                <span>Stage: <span id="current-stage" class="font-bold">1</span>/<span id="max-stage" class="font-bold">9</span></span>
                            </div>
                            <div class="relative pt-1">
                                <div class="overflow-hidden h-4 text-xs flex rounded bg-ancient-light bg-opacity-50 border border-ancient-accent">
                                    <div id="qi-progress-bar" class="qi-progress shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-xs mt-1">
                                    <span id="current-qi">0</span>
                                    <span id="target-qi">100</span>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="cultivation-banner mb-2">Idle Cultivation</div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>Base Rate:</div>
                                <div id="base-rate">0.5 qi/min</div>
                                
                                <div>Current Multiplier:</div>
                                <div id="current-multiplier">×1.0</div>
                                
                                <div>Effective Rate:</div>
                                <div id="effective-rate">0.5 qi/min</div>
                            </div>
                            <div id="fellow-boost-container" class="border border-ancient-accent p-2 rounded mb-2 hidden">
                                <div class="text-center boost-indicator w-full">
                                    <i class="fas fa-user-friends"></i>
                                    <span id="boost-status">Fellow Cultivator Boost: 2× rate for <span id="boost-time-remaining">0m</span></span>
                                </div>
                            </div>
                            <div id="pomodoro-boost-container" class="border border-ancient-accent p-2 rounded mb-2 hidden">
                                <div class="text-center boost-indicator w-full">
                                    <i class="fas fa-stopwatch"></i>
                                    <span id="pomodoro-boost-status">Pomodoro Boost: 2× qi reward for <span id="pomodoro-boosts-remaining">0</span> tasks</span>
                                </div>
                            </div>
                            <div class="border border-ancient-accent p-2 rounded">
                                <div class="text-center mb-1">Next hour will yield approximately:</div>
                                <div id="next-hour-yield" class="text-center font-bold">30 qi</div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="cultivation-banner mb-2">Realm Description</div>
                            <div id="realm-description" class="italic text-center">
                                An ordinary person with no spiritual awareness. The journey of a thousand miles begins with a single step.
                            </div>
                        </div>
                    </div>

                    <!-- Breakthrough Section -->
                    <div class="ancient-border rounded-lg p-4">
                        <h2 class="text-2xl font-bold mb-4 cultivation-banner">Breakthrough</h2>
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <span>Qi Required:</span>
                                <span id="breakthrough-qi-required">100</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span>Base Success Rate:</span>
                                <span id="base-success-rate">75%</span>
                            </div>
                            <div class="flex justify-between mb-4">
                                <span>Final Success Rate:</span>
                                <span id="final-success-rate">75%</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="cultivation-banner mb-2">Use Spirit Stones to Boost Success Rate</div>
                            <div class="flex flex-wrap justify-center gap-2 mb-4">
                                <div class="spirit-stone stone-basic tooltip" data-type="basic" data-count="0">
                                    <span class="tooltiptext">Basic Spirit Stone: +1% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                                <div class="spirit-stone stone-low tooltip" data-type="low" data-count="0">
                                    <span class="tooltiptext">Low-Grade Spirit Stone: +5% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                                <div class="spirit-stone stone-medium tooltip" data-type="medium" data-count="0">
                                    <span class="tooltiptext">Medium-Grade Spirit Stone: +10% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                                <div class="spirit-stone stone-high tooltip" data-type="high" data-count="0">
                                    <span class="tooltiptext">High-Grade Spirit Stone: +15% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                                <div class="spirit-stone stone-supreme tooltip" data-type="supreme" data-count="0">
                                    <span class="tooltiptext">Supreme-Grade Spirit Stone: +20% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                                <div class="spirit-stone stone-divine tooltip" data-type="divine" data-count="0">
                                    <span class="tooltiptext">Divine-Grade Spirit Stone: +25% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                <div>Selected Stones:</div>
                                <div id="selected-stones">None</div>
                                
                                <div>Success Boost:</div>
                                <div id="success-boost">+0%</div>
                            </div>
                            
                            <button id="clear-stones" class="ancient-button w-full mb-4">Clear Selected Stones</button>
                            
                            <button id="attempt-breakthrough" class="ancient-button w-full" disabled>
                                Attempt Breakthrough (Insufficient Qi)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div id="tasks-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Task Management -->
                    <div class="ancient-border rounded-lg p-4">
                        <h2 class="text-2xl font-bold mb-4 cultivation-banner">Task Management</h2>
                        
                        <div class="mb-4">
                            <label class="block mb-1">Task Name:</label>
                            <input type="text" id="task-name" class="ancient-input w-full mb-2" placeholder="Enter task name">
                            
                            <label class="block mb-1">Tags (comma separated):</label>
                            <input type="text" id="task-tags" class="ancient-input w-full mb-2" placeholder="work, study, exercise, etc.">
                            
                            <button id="add-task" class="ancient-button w-full">Add Task</button>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold">Task List</h3>
                                <div class="flex gap-2">
                                    <select id="sort-tasks" class="ancient-input text-sm">
                                        <option value="name-asc">Sort by Name (A-Z)</option>
                                        <option value="name-desc">Sort by Name (Z-A)</option>
                                        <option value="tag-asc">Sort by Tag (A-Z)</option>
                                        <option value="tag-desc">Sort by Tag (Z-A)</option>
                                        <option value="completion-asc">Sort by Completion (Low-High)</option>
                                        <option value="completion-desc">Sort by Completion (High-Low)</option>
                                    </select>
                                    <button id="select-all-tasks" class="ancient-button text-sm px-2">Select All</button>
                                </div>
                            </div>
                            
                            <div id="task-list" class="scroll-container ancient-scroll p-4">
                                <p class="text-center italic">No tasks added yet</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button id="edit-selected-task" class="ancient-button" disabled>Edit Selected</button>
                            <button id="delete-selected-tasks" class="ancient-button" disabled>Delete Selected</button>
                        </div>
                    </div>

                    <!-- Task Generator -->
                    <div class="ancient-border rounded-lg p-4">
                        <h2 class="text-2xl font-bold mb-4 cultivation-banner">Task Generator</h2>
                        
                        <div class="mb-4">
                            <label class="block mb-1">Number of tasks to generate:</label>
                            <input type="number" id="task-count" class="ancient-input w-full" min="1" max="10" value="1">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block mb-1">Filter by tags (optional):</label>
                            <input type="text" id="filter-tags" class="ancient-input w-full" placeholder="Leave empty to include all tags">
                        </div>
                        
                        <button id="generate-tasks" class="ancient-button w-full mb-4">Generate Tasks</button>
                        
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Generated Tasks</h3>
                            <div id="generated-tasks" class="scroll-container ancient-scroll p-4 min-h-[200px]">
                                <p class="text-center italic">No tasks generated yet</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button id="complete-all-tasks" class="ancient-button" disabled>Complete All</button>
                            <button id="give-up-tasks" class="ancient-button" disabled>Give Up (Qi Penalty)</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pomodoro Tab -->
            <div id="pomodoro-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Pomodoro Cultivation</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Timer Display -->
                        <div class="timer-container">
                            <div class="timer-display" id="timer-display">25:00</div>
                            <div class="timer-progress">
                                <div class="timer-progress-bar" id="timer-progress-bar"></div>
                            </div>
                            <div id="break-indicator" class="break-indicator hidden">Break Time</div>
                            <div class="timer-controls">
                                <button id="timer-start" class="timer-button">
                                    <i class="fas fa-play"></i> Start
                                </button>
                                <button id="timer-pause" class="timer-button" disabled>
                                    <i class="fas fa-pause"></i> Pause
                                </button>
                                <button id="timer-reset" class="timer-button">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>
                        
                        <!-- Timer Settings -->
                        <div class="timer-settings">
                            <h3 class="text-xl font-bold mb-4 cultivation-banner">Session Settings</h3>
                            
                            <div class="mb-4">
                                <label class="block mb-1">Focus Duration (minutes):</label>
                                <input type="range" id="focus-duration" class="ancient-range w-full" min="5" max="25" step="5" value="25">
                                <div class="flex justify-between text-sm mt-1">
                                    <span>5 min</span>
                                    <span id="focus-duration-display">25 min</span>
                                    <span>25 min</span>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block mb-1">Break Duration (minutes):</label>
                                <input type="range" id="break-duration" class="ancient-range w-full" min="0" max="10" step="1" value="5">
                                <div class="flex justify-between text-sm mt-1">
                                    <span>0 min</span>
                                    <span id="break-duration-display">5 min</span>
                                    <span>10 min</span>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between items-center">
                                    <label>Use Break Time:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="use-break" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <p class="text-sm mt-1 italic">When enabled, a break timer will start after each focus session</p>
                            </div>
                            
                            <div id="pomodoro-boost-info" class="mt-6 p-3 border border-ancient-accent rounded">
                                <h4 class="font-bold mb-2">Current Boosts:</h4>
                                <div id="active-pomodoro-boost" class="hidden">
                                    <p>You have a pomodoro boost active!</p>
                                    <p>Your next <span id="remaining-boosted-tasks">0</span> task completions will receive double qi rewards.</p>
                                </div>
                                <div id="no-pomodoro-boost">
                                    <p class="italic">No active pomodoro boosts</p>
                                </div>
                                <div class="mt-3">
                                    <p class="text-sm">
                                        <i class="fas fa-info-circle mr-1"></i> Complete a 15-25 minute focus session to receive boosts:
                                    </p>
                                    <ul class="list-disc pl-6 text-sm mt-1">
                                        <li>15 minutes: x2 qi for 5 task completions</li>
                                        <li>20 minutes: x2 qi for 8 task completions</li>
                                        <li>25 minutes: x2 qi for 10 task completions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-4 cultivation-banner">Session History</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-center">
                            <div class="ancient-scroll p-3">
                                <div class="text-3xl font-bold" id="total-sessions">0</div>
                                <div>Sessions Completed</div>
                            </div>
                            <div class="ancient-scroll p-3">
                                <div class="text-3xl font-bold" id="total-focus-time">0</div>
                                <div>Minutes Focused</div>
                            </div>
                            <div class="ancient-scroll p-3">
                                <div class="text-3xl font-bold" id="total-boosts-earned">0</div>
                                <div>Boosts Earned</div>
                            </div>
                            <div class="ancient-scroll p-3">
                                <div class="text-3xl font-bold" id="total-boosted-tasks">0</div>
                                <div>Tasks Boosted</div>
                            </div>
                        </div>
                        
                        <div id="session-history" class="scroll-container ancient-scroll p-4">
                            <p class="text-center italic">No sessions completed yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Spirit Stone Inventory</h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-basic mx-auto mb-2"></div>
                            <h3 class="font-bold">Basic Spirit Stone</h3>
                            <p>Count: <span id="basic-stone-count">0</span></p>
                            <button class="ancient-button mt-2 text-sm" data-stone="basic" disabled>Fuse 100 → Low-Grade</button>
                        </div>
                        
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-low mx-auto mb-2"></div>
                            <h3 class="font-bold">Low-Grade Spirit Stone</h3>
                            <p>Count: <span id="low-stone-count">0</span></p>
                            <button class="ancient-button mt-2 text-sm" data-stone="low" disabled>Fuse 100 → Medium-Grade</button>
                        </div>
                        
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-medium mx-auto mb-2"></div>
                            <h3 class="font-bold">Medium-Grade Spirit Stone</h3>
                            <p>Count: <span id="medium-stone-count">0</span></p>
                            <button class="ancient-button mt-2 text-sm" data-stone="medium" disabled>Fuse 100 → High-Grade</button>
                        </div>
                        
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-high mx-auto mb-2"></div>
                            <h3 class="font-bold">High-Grade Spirit Stone</h3>
                            <p>Count: <span id="high-stone-count">0</span></p>
                            <button class="ancient-button mt-2 text-sm" data-stone="high" disabled>Fuse 100 → Supreme-Grade</button>
                        </div>
                        
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-supreme mx-auto mb-2"></div>
                            <h3 class="font-bold">Supreme-Grade Spirit Stone</h3>
                            <p>Count: <span id="supreme-stone-count">0</span></p>
                            <button class="ancient-button mt-2 text-sm" data-stone="supreme" disabled>Fuse 100 → Divine-Grade</button>
                        </div>
                        
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-divine mx-auto mb-2"></div>
                            <h3 class="font-bold">Divine-Grade Spirit Stone</h3>
                            <p>Count: <span id="divine-stone-count">0</span></p>
                            <p class="text-sm mt-2 italic">Highest tier available</p>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h2 class="text-2xl font-bold mb-4 cultivation-banner">Special Items</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="ancient-scroll p-4 text-center">
                                <div class="spirit-stone stone-rename mx-auto mb-2"></div>
                                <h3 class="font-bold">Rename Scroll</h3>
                                <p>Count: <span id="rename-scroll-count">0/1</span></p>
                                <button id="use-rename-scroll" class="ancient-button mt-2 text-sm" disabled>Use Scroll</button>
                                <p class="text-xs mt-1 italic">Allows you to change your cultivator name</p>
                            </div>
                            
                            <!-- Space for future special items -->
                            <div class="ancient-scroll p-4 text-center opacity-50">
                                <div class="mx-auto mb-2 text-4xl">?</div>
                                <h3 class="font-bold">Unknown Item</h3>
                                <p class="italic text-sm">Yet to be discovered</p>
                            </div>
                            
                            <div class="ancient-scroll p-4 text-center opacity-50">
                                <div class="mx-auto mb-2 text-4xl">?</div>
                                <h3 class="font-bold">Unknown Item</h3>
                                <p class="italic text-sm">Yet to be discovered</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <div class="spoiler-header">
                            <h3 class="text-xl font-bold">Spirit Stone Effects</h3>
                            <i class="fas fa-chevron-down spoiler-icon"></i>
                        </div>
                        <div class="spoiler-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div class="ancient-scroll p-4">
                                    <h4 class="font-bold mb-2">Base Effects</h4>
                                    <ul class="list-disc pl-4">
                                        <li>Basic Spirit Stone: +1% breakthrough success</li>
                                        <li>Low-Grade Spirit Stone: +5% breakthrough success</li>
                                        <li>Medium-Grade Spirit Stone: +10% breakthrough success</li>
                                        <li>High-Grade Spirit Stone: +15% breakthrough success</li>
                                        <li>Supreme-Grade Spirit Stone: +20% breakthrough success</li>
                                        <li>Divine-Grade Spirit Stone: +25% breakthrough success</li>
                                    </ul>
                                </div>
                                
                                <div class="ancient-scroll p-4">
                                    <h4 class="font-bold mb-2">Realm Effectiveness</h4>
                                    <p class="mb-2">Lower spirit stones have reduced effectiveness in higher realms:</p>
                                    <ul class="list-disc pl-4">
                                        <li>3 realms above: 25% effectiveness</li>
                                        <li>2 realms above: 50% effectiveness</li>
                                        <li>1 realm above: 75% effectiveness</li>
                                        <li>Same realm or below: 100% effectiveness</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fellow Cultivators Tab -->
            <div id="fellowCultivators-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Fellow Cultivators</h2>
                    
                    <div class="mb-6">
                        <p class="mb-4">Fellow cultivators you meet on your journey can boost your idle cultivation rate temporarily.</p>
                        
                        <div class="ancient-scroll p-4 mb-4">
                            <h3 class="font-bold mb-2">Current Boost Status</h3>
                            <div id="fc-boost-status" class="text-center">
                                <p id="fc-no-boost" class="italic">No active boost from fellow cultivators</p>
                                <div id="fc-active-boost" class="hidden">
                                    <p>Your idle cultivation rate is currently <span class="font-bold">doubled</span>!</p>
                                    <p>Time remaining: <span id="fc-boost-time-remaining" class="font-bold">0 minutes</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ancient-scroll p-4 mb-4">
                            <h3 class="font-bold mb-2">Last Encounter</h3>
                            <div id="fc-last-encounter" class="text-center">
                                <p id="fc-no-encounters" class="italic">You haven't met any fellow cultivators yet</p>
                                <div id="fc-last-encounter-details" class="hidden">
                                    <p id="fc-last-encounter-message"></p>
                                    <p class="text-sm italic mt-2">Encountered <span id="fc-last-encounter-time"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold mb-4 cultivation-banner">Manage Cultivators</h3>
                            <div class="mb-4">
                                <label class="block mb-1">Add New Cultivator:</label>
                                <div class="flex gap-2">
                                    <input type="text" id="new-cultivator-name" class="ancient-input flex-grow" placeholder="Enter name">
                                    <button id="add-cultivator" class="ancient-button">Add</button>
                                </div>
                                <p id="cultivators-added-today" class="text-xs mt-1">Cultivators added today: 0/5</p>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block mb-1">Edit Custom Cultivator:</label>
                                <div class="flex gap-2">
                                    <select id="edit-cultivator-select" class="ancient-input flex-grow">
                                        <option value="">Select a cultivator</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="edit-cultivator-form" class="mb-4 hidden">
                                <label class="block mb-1">New Name:</label>
                                <div class="flex gap-2">
                                    <input type="text" id="edit-cultivator-name" class="ancient-input flex-grow">
                                    <button id="save-cultivator-edit" class="ancient-button">Save</button>
                                </div>
                                <p id="edit-cooldown-info" class="text-xs mt-1 hidden">Cannot edit until: <span id="edit-available-time"></span></p>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block mb-1">Remove Custom Cultivator:</label>
                                <div class="flex gap-2">
                                    <select id="remove-cultivator-select" class="ancient-input flex-grow">
                                        <option value="">Select a cultivator</option>
                                    </select>
                                    <button id="remove-cultivator" class="ancient-button">Remove</button>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-xl font-bold mb-4 cultivation-banner">Cultivator Pool</h3>
                            
                            <!-- Built-in Cultivators Spoiler -->
                            <div class="spoiler-header mb-2">
                                <span>Built-in Cultivators (<span id="builtin-cultivator-count">0</span>)</span>
                                <i class="fas fa-chevron-down spoiler-icon"></i>
                            </div>
                            <div class="spoiler-content mb-4">
                                <div id="builtin-cultivator-pool" class="scroll-container mt-2" style="max-height: 200px; overflow-y: auto;">
                                    <p id="no-builtin-cultivators-message" class="text-center italic">No built-in cultivators</p>
                                </div>
                            </div>
                            
                            <!-- Custom Cultivators Spoiler -->	
                            <div class="spoiler-header mb-2">
                                <span>Custom Cultivators (<span id="custom-cultivators-count">0</span>)</span>
                                <i class="fas fa-chevron-down spoiler-icon"></i>
                            </div>
                            <div class="spoiler-content">
                                <div id="custom-cultivator-pool" class="scroll-container mt-2" style="max-height: 200px; overflow-y: auto;">
                                    <p id="no-custom-cultivators-message" class="text-center italic">No custom cultivators added yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <div class="spoiler-header">
                            <h3 class="text-xl font-bold">Fellow Cultivator Information</h3>
                            <i class="fas fa-chevron-down spoiler-icon"></i>
                        </div>
                        <div class="spoiler-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div class="ancient-scroll p-4">
                                    <h4 class="font-bold mb-2">Meeting Chances</h4>
                                    <p class="mb-2">Chance to meet a fellow cultivator after returning:</p>
                                    <ul class="list-disc pl-4">
                                        <li>Offline for 10 minutes: 10% chance</li>
                                        <li>Offline for 30 minutes: 20% chance</li>
                                        <li>Offline for 60+ minutes: 30% chance</li>
                                    </ul>
                                </div>
                                
                                <div class="ancient-scroll p-4">
                                    <h4 class="font-bold mb-2">Boost Effects</h4>
                                    <ul class="list-disc pl-4">
                                        <li>Meeting a fellow cultivator doubles your idle cultivation rate</li>
                                        <li>Boost duration ranges from 60-120 minutes randomly</li>
                                        <li>Multiple boosts can stack, but total boost time is capped at 10 hours</li>
                                        <li>There's no limit to how many fellow cultivators you can meet each day</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements Tab -->
            <div id="achievements-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Cultivation Achievements</h2>
                    
                    <!-- Achievement Summary -->
                    <div class="achievement-summary mb-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <div class="text-2xl font-bold" id="achievement-total-count">0/0</div>
                                <div>Achievements Completed</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="achievement-percent">0%</div>
                                <div>Completion Rate</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="achievement-latest">None</div>
                                <div>Latest Achievement</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="achievement-rarest">None</div>
                                <div>Rarest Achievement</div>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap justify-center gap-4">
                            <div>
                                <span class="achievement-rarity-indicator achievement-common"></span>
                                <span>Common</span>
                            </div>
                            <div>
                                <span class="achievement-rarity-indicator achievement-uncommon"></span>
                                <span>Uncommon</span>
                            </div>
                            <div>
                                <span class="achievement-rarity-indicator achievement-rare"></span>
                                <span>Rare</span>
                            </div>
                            <div>
                                <span class="achievement-rarity-indicator achievement-epic"></span>
                                <span>Epic</span>
                            </div>
                            <div>
                                <span class="achievement-rarity-indicator achievement-legendary"></span>
                                <span>Legendary</span>
                            </div>
                            <div>
                                <span class="achievement-rarity-indicator achievement-mythic"></span>
                                <span>Mythic</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Achievement Categories -->
                    <div class="achievement-tabs" id="achievement-tabs">
                        <div class="achievement-tab active" data-category="all">All <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="cultivation">Cultivation <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="tasks">Tasks <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="stones">Spirit Stones <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="cultivators">Fellow Cultivators <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="pomodoro">Pomodoro <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="misc">Miscellaneous <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="hidden">Hidden <span class="achievement-count">0</span></div>
                    </div>
                    
                    <!-- Achievement List -->
                    <div id="achievement-list" class="scroll-container ancient-scroll p-4">
                        <p class="text-center italic">Loading achievements...</p>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="statistics-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Cultivation Statistics</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="ancient-scroll p-4">
                            <h3 class="font-bold mb-2">Task Statistics</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div>Total Existing Tasks:</div>
                                <div id="stat-total-tasks">0</div>
                                
                                <div>Total Completed Tasks:</div>
                                <div id="stat-completed-tasks">0</div>
                                
                                <div>Average Qi/Task:</div>
                                <div id="stat-avg-qi">0</div>
                                
                                <div>Average Stones/Task:</div>
                                <div id="stat-avg-stones">0</div>
                                
                                <div>Most Completed Task:</div>
                                <div id="stat-most-completed-task">None</div>
                                
                                <div>Most Active Tag:</div>
                                <div id="stat-most-active-tag">None</div>

                                <div>Pomodoro Boosted Tasks:</div>
                                <div id="stat-pomodoro-boosted-tasks">0</div>
                            </div>
                        </div>
                        
                        <div class="ancient-scroll p-4">
                            <h3 class="font-bold mb-2">Breakthrough Statistics</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div>Total Breakthroughs:</div>
                                <div id="stat-breakthroughs">0</div>
                                
                                <div>Failed Attempts:</div>
                                <div id="stat-failed-attempts">0</div>
                                
                                <div>Success Rate:</div>
                                <div id="stat-success-rate">0%</div>
                                
                                <div>Highest Realm Reached:</div>
                                <div id="stat-highest-realm">Mortal</div>
                                
                                <div>Total Qi Earned:</div>
                                <div id="stat-total-qi">0</div>
                                
                                <div>Passive Qi (%):</div>
                                <div id="stat-passive-qi">0%</div>

                                <div>Pomodoro Bonus Qi:</div>
                                <div id="stat-pomodoro-qi">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Spirit Stone Statistics</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p>Basic Spirit Stones Found:</p>
                                <p id="stat-basic-stones" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Low-Grade Spirit Stones Found:</p>
                                <p id="stat-low-stones" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Medium-Grade Spirit Stones Found:</p>
                                <p id="stat-medium-stones" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>High-Grade Spirit Stones Found:</p>
                                <p id="stat-high-stones" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Supreme-Grade Spirit Stones Found:</p>
                                <p id="stat-supreme-stones" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Divine-Grade Spirit Stones Found:</p>
                                <p id="stat-divine-stones" class="font-bold">0</p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="font-bold mb-2">Spirit Stones Fused:</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <p>Basic → Low-Grade:</p>
                                    <p id="stat-basic-fused" class="font-bold">0</p>
                                </div>
                                <div class="text-center">
                                    <p>Low → Medium-Grade:</p>
                                    <p id="stat-low-fused" class="font-bold">0</p>
                                </div>
                                <div class="text-center">
                                    <p>Medium → High-Grade:</p>
                                    <p id="stat-medium-fused" class="font-bold">0</p>
                                </div>
                                <div class="text-center">
                                    <p>High → Supreme-Grade:</p>
                                    <p id="stat-high-fused" class="font-bold">0</p>
                                </div>
                                <div class="text-center">
                                    <p>Supreme → Divine-Grade:</p>
                                    <p id="stat-supreme-fused" class="font-bold">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="font-bold mb-2">Special Items:</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <p>Rename Scrolls Found:</p>
                                    <p id="stat-rename-scrolls" class="font-bold">0</p>
                                </div>
                                <div class="text-center">
                                    <p>Rename Scrolls Used:</p>
                                    <p id="stat-rename-scrolls-used" class="font-bold">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Fellow Cultivator Statistics</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p>Fellow Cultivators Met:</p>
                                <p id="stat-cultivators-met" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Total Boost Time (Hours):</p>
                                <p id="stat-total-boost-time" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Extra Qi from Boosts:</p>
                                <p id="stat-qi-from-boosts" class="font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Pomodoro Statistics</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p>Sessions Completed:</p>
                                <p id="stat-pomodoro-sessions" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Total Focus Time (Minutes):</p>
                                <p id="stat-focus-minutes" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Boosts Earned:</p>
                                <p id="stat-boosts-earned" class="font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Achievement Statistics</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p>Total Achievements:</p>
                                <p id="stat-total-achievements" class="font-bold">0/0</p>
                            </div>
                            <div class="text-center">
                                <p>Completion Rate:</p>
                                <p id="stat-achievement-rate" class="font-bold">0%</p>
                            </div>
                            <div class="text-center">
                                <p>Hidden Achievements Found:</p>
                                <p id="stat-hidden-achievements" class="font-bold">0/0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Cultivation Analytics</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="ancient-scroll p-4">
                            <h3 class="font-bold mb-2">Qi Acquisition</h3>
                            <div class="mb-4">
                                <p class="mb-1">Qi Source Distribution:</p>
                                <div class="qi-source-bar">
                                    <div id="qi-source-active" class="qi-active" style="width: 70%; float: left;"></div>
                                    <div id="qi-source-passive" class="qi-passive" style="width: 30%; float: left;"></div>
                                </div>
                                <div class="flex justify-between text-xs mt-1">
                                    <span>Active: <span id="qi-active-percent">70%</span></span>
                                    <span>Passive: <span id="qi-passive-percent">30%</span></span>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <p class="mb-1">Qi Efficiency (Qi/Task Average):</p>
                                <div class="chart-container">
                                    <canvas id="qi-efficiency-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ancient-scroll p-4">
                            <h3 class="font-bold mb-2">Task Completion Patterns</h3>
                            <div class="mb-4">
                                <p class="mb-1">Tasks by Tag:</p>
                                <div class="chart-container">
                                    <canvas id="tasks-by-tag-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Cultivation Journey</h3>
                        <div class="ancient-scroll p-4">
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="cultivation-journey-chart"></canvas>
                            </div>
                            <p class="text-center text-sm italic mt-2">Your cultivation progress over time</p>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Activity Heatmap</h3>
                        <div class="ancient-scroll p-4">
                            <div class="mb-4">
                                <p class="mb-1">Task Completion by Day of Week:</p>
                                <div class="chart-container" style="height: 150px;">
                                    <canvas id="activity-heatmap-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Pomodoro Analysis</h3>
                        <div class="ancient-scroll p-4">
                            <div class="mb-4">
                                <p class="mb-1">Focus Sessions by Duration:</p>
                                <div class="chart-container" style="height: 200px;">
                                    <canvas id="pomodoro-duration-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Settings</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="ancient-scroll p-4 settings-scroll">
                            <h3 class="font-bold mb-4">Game Data</h3>
                            
                            <button id="export-game" class="ancient-button w-full mb-2">Export Game Data</button>
                            <button id="manual-save" class="ancient-button w-full mb-4">Manual Save</button>
                            
                            <div class="mb-4">
                                <label class="block mb-1">Import Game Data:</label>
                                <textarea id="import-data" class="ancient-input w-full h-20" placeholder="Paste exported game data here"></textarea>
                                <button id="import-game" class="ancient-button w-full mt-2">Import Game Data</button>
                            </div>
                            
                            <div class="border-t border-ancient-accent pt-4 mb-4">
                                <h4 class="font-bold mb-2">Cultivator Settings</h4>
                                <div class="mb-4">
                                    <label class="block mb-1">Change Cultivator Name:</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="settings-cultivator-name" class="ancient-input flex-grow" placeholder="Enter new name">
                                        <button id="settings-change-name" class="ancient-button" disabled>Change</button>
                                    </div>
                                    <p class="text-xs mt-1 italic">Requires a Rename Scroll</p>
                                </div>
                            </div>
                            
                            <div class="border-t border-ancient-accent pt-4">
                                <h4 class="font-bold mb-2">Reset Options</h4>
                                <button id="reset-stats" class="ancient-button w-full mb-2">Reset Statistics Only</button>
                                <button id="hard-reset" class="ancient-button w-full">Hard Reset (Delete ALL Data)</button>
                            </div>
                        </div>
                        
                        <div class="ancient-scroll p-4 settings-scroll">
                            <h3 class="font-bold mb-4">Display Settings</h3>
                            
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label>Theme:</label>
                                    <select id="theme-select" class="ancient-input text-sm">
                                        <option value="default">Default</option>
                                        <option value="bw">Black & White</option>
                                        <option value="retro">Retro</option>
                                        <option value="oriental">Oriental</option>
                                        <option value="modern">Modern</option>
                                        <option value="neon">Neon</option>
                                    </select>
                                </div>
                                
                                <div class="flex justify-between items-center mb-4">
                                    <label>Mode:</label>
                                    <div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="theme-mode-toggle">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span id="theme-mode-label" class="ml-2">Light</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4 border-t border-ancient-accent pt-4">
                                <h4 class="font-bold mb-2">Number Format</h4>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Use Scientific Notation:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="use-scientific-notation">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <p class="text-xs italic mb-2">For very large numbers (e.g., 1.23e6 instead of 1,230,000)</p>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Scientific Notation Threshold:</label>
                                    <select id="scientific-notation-threshold" class="ancient-input text-sm">
                                        <option value="1000">1,000</option>
                                        <option value="10000">10,000</option>
                                        <option value="100000">100,000</option>
                                        <option value="1000000" selected>1,000,000</option>
                                        <option value="10000000">10,000,000</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-4 border-t border-ancient-accent pt-4">
                                <h4 class="font-bold mb-2">Task Display</h4>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Show Task Completion Count:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="show-completion-count" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-4 border-t border-ancient-accent pt-4">
                                <h4 class="font-bold mb-2">Fellow Cultivator Settings</h4>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Only Meet Custom Cultivators:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="only-meet-custom-cultivators">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <p class="text-xs italic mb-4">When enabled, you will only meet cultivators you've added yourself</p>
                            </div>
                            
                            <div class="mb-4 border-t border-ancient-accent pt-4">
                                <h4 class="font-bold mb-2">Notifications</h4>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Breakthrough Readiness:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-breakthrough" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Idle Rewards:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-idle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Cultivation Milestones:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-milestone" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <div class="flex justify-between items-center mb-2">
                                    <label>Fellow Cultivator Meetings:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-fellowCultivator" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Achievement Unlocks:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-achievement" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Pomodoro Completions:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-pomodoro" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="border-t border-ancient-accent pt-4">
                                <h3 class="font-bold mb-2">Community & Help</h3>
                                <a href="https://forms.gle/F1tVaUjSG4MsDx779" target="_blank" class="ancient-button w-full block text-center mb-4">Submit Fellow Cultivator Name</a>
                                <button id="show-tutorial" class="ancient-button w-full mb-4">Show Tutorial</button>
                                <a href="https://docs.google.com/document/d/1TisAFgWHv7tHcyO51MzZogOyMkQok9JolQZS3AEe3fw/edit?usp=sharing" target="_blank" class="ancient-button w-full block text-center mb-4">Patch Notes</a>
                                
                                <h3 class="font-bold mb-2">About</h3>
                                <p class="mb-1">青云修仙录 (Qing Yun Xiu Xian Lu) is a task management and cultivation simulation game that helps you overcome procrastination while progressing through various cultivation realms.</p>
                                <p class="text-right mb-4">Ver 1.4</p>
                                
                                <h4 class="font-bold mb-1">Features:</h4>
                                <ul class="list-disc pl-4 mb-4">
                                    <li>Task management with tags</li>
                                    <li>Pomodoro timer with rewards</li>
                                    <li>Random task generation</li>
                                    <li>Cultivation progression system</li>
                                    <li>Spirit stone collection and fusion</li>
                                    <li>Breakthrough mechanics</li>
                                    <li>Idle cultivation progression</li>
                                    <li>Fellow cultivator encounters</li>
                                    <li>Achievement system</li>
                                    <li>Customizable themes</li>
                                    <li>Detailed analytics</li>
                                </ul>
                                
                                <div class="text-center mt-6">
                                    <p class="mb-2">Developed by CygRyu</p>
                                    <div class="flex justify-center space-x-4">
                                        <a href="https://ko-fi.com/cygryu" target="_blank" class="ancient-button">Ko-Fi</a>
                                        <a href="https://www.paypal.com/paypalme/sofiansu?country.x=ID&locale.x=en_US" target="_blank" class="ancient-button">PayPal</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div id="modal-content" class="ancient-border rounded-lg p-6 max-w-md w-full mx-4">
            <div id="modal-header" class="text-xl font-bold mb-4 cultivation-banner">Modal Title</div>
            <div id="modal-body" class="mb-4">Modal content goes here</div>
            <div id="modal-footer" class="flex justify-end space-x-2">
                <button id="modal-cancel" class="ancient-button">Cancel</button>
                <button id="modal-confirm" class="ancient-button">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-40"></div>

    <!-- Custom Notifications Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 flex flex-col gap-3"></div>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex items-center justify-center">
        <div id="tutorial-content" class="ancient-border rounded-lg p-6 max-w-2xl w-full mx-4">
            <div class="text-xl font-bold mb-4 cultivation-banner">Tutorial</div>
            <div id="tutorial-body" class="mb-4 scroll-container" style="max-height: 70vh; overflow-y: auto;">
                <!-- Tutorial content will be populated here -->
            </div>
            <div class="flex justify-between">
                <button id="tutorial-prev" class="ancient-button" disabled>Previous</button>
                <button id="tutorial-skip" class="ancient-button">Skip Tutorial</button>
                <div>
                    <span id="tutorial-page">1/9</span>
                </div>
                <button id="tutorial-next" class="ancient-button">Next</button>
            </div>
        </div>
    </div>

    <!-- Name Change Modal -->
    <div id="name-change-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="ancient-border rounded-lg p-6 max-w-md w-full mx-4">
            <div class="text-xl font-bold mb-4 cultivation-banner">Set Cultivator Name</div>
            <div class="mb-4">
                <p class="mb-2">Choose a name for your cultivation journey:</p>
                <input type="text" id="cultivator-name-input" class="ancient-input w-full" placeholder="Enter your cultivator name" maxlength="30">
                <p class="text-sm mt-2 italic" id="rename-warning">
                    Note: Changing your name after this initial setup will require a Rename Scroll, which is a rare item that can be found by completing tasks.
                </p>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="name-change-cancel" class="ancient-button">Cancel</button>
                <button id="name-change-confirm" class="ancient-button">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Achievement Unlock Modal -->
    <div id="achievement-unlock-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="ancient-border rounded-lg p-6 max-w-md w-full mx-4">
            <div class="text-xl font-bold mb-4 cultivation-banner">Achievement Unlocked!</div>
            <div class="flex items-center mb-4">
                <div id="achievement-unlock-icon" class="achievement-icon achievement-common mr-4">
                    <i class="fas fa-trophy"></i>
                </div>
                <div>
                    <h3 id="achievement-unlock-title" class="text-xl font-bold">Achievement Title</h3>
                    <p id="achievement-unlock-description" class="mt-2">Achievement description here</p>
                </div>
            </div>
            <div class="flex justify-end">
                <button id="achievement-unlock-confirm" class="ancient-button">Continue</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            version: '1.4',
            player: {
                name: 'Unnamed Cultivator',
                realm: 0,
                stage: 1,
                qi: 0,
                lastUpdated: Date.now(),
                lastBreakthroughCheck: Date.now(),
                reachedMilestones: {
                    realms: [0],  // Tracks which realms have been reached for notification purposes
                    stages: {}    // Tracks which stages have been reached for each realm
                },
                fcTabUnlockClicks: 0, // Debug counter for unlocking Fellow Cultivators tab early
                fcTabUnlocked: false   // Whether Fellow Cultivators tab is unlocked
            },
            tasks: [],
            generatedTasks: [],
            stones: {
                basic: 0,
                low: 0,
                medium: 0,
                high: 0,
                supreme: 0,
                divine: 0,
                rename: 0  // Rename scroll item
            },
            selectedStones: {
                basic: 0,
                low: 0,
                medium: 0,
                high: 0,
                supreme: 0,
                divine: 0
            },
            stats: {
                totalTasks: 0,
                completedTasks: 0,
                totalQiEarned: 0,
                totalQiPassive: 0,  // Track passive qi gains
                totalQiPomodoro: 0, // Track qi gained from pomodoro boosts
                totalStonesFound: {
                    basic: 0,
                    low: 0,
                    medium: 0,
                    high: 0,
                    supreme: 0,
                    divine: 0,
                    rename: 0  // Track rename scrolls found
                },
                stonesFused: {
                    basic: 0,
                    low: 0,
                    medium: 0,
                    high: 0,
                    supreme: 0
                },
                breakthroughs: 0,
                failedAttempts: 0,
                highestRealmReached: 0,
                renameScrollsUsed: 0,  // Track rename scrolls used
                taskHistory: [],  // Store task completion history for analytics
                completionByTag: {},  // Track completions by tag
                completionByDayOfWeek: [0, 0, 0, 0, 0, 0, 0],  // [Sun, Mon, Tue, Wed, Thu, Fri, Sat]
                cultivatorsMet: 0,
                totalBoostTime: 0,
                qiFromBoosts: 0,
                // Pomodoro stats
                pomodoroSessions: 0,
                pomodoroTotalMinutes: 0,
                pomodoroBoostsEarned: 0,
                pomodoroTasksCompleted: 0
            },
            notifications: {
                settings: {
                    breakthroughReadiness: true,
                    idleRewards: true,
                    cultivationMilestones: true,
                    fellowCultivator: true,
                    achievement: true,
                    pomodoro: true
                },
                history: []  // To store past notifications if needed
            },
            settings: {
                theme: 'default',
                darkMode: false,
                showCompletionCount: true,
                onlyMeetCustomCultivators: false,
                useScientificNotation: false,
                scientificNotationThreshold: 1000000
            },
            analytics: {
                qiEfficiency: [],  // Store average qi per task over time
                realmHistory: [],  // Store realm advancement history with timestamps
                lastAnalyticsUpdate: Date.now(),
                pomodoroByDuration: {
                    5: 0,
                    10: 0,
                    15: 0,
                    20: 0,
                    25: 0
                }
            },
            fellowCultivators: {
                pool: [],
                meetings: [],
                boostEndTime: 0,
                lastMeetingTime: 0,
                lastEncounter: null,
                addedToday: 0,
                dayLastAdded: null
            },
            pomodoro: {
                focusDuration: 25,  // in minutes
                breakDuration: 5,   // in minutes
                useBreak: true,
                isRunning: false,
                isPaused: false,
                isBreak: false,
                timeRemaining: 25 * 60, // in seconds
                startTime: null,
                endTime: null,
                pauseTime: null,
                boostsRemaining: 0,
                lastSessionTime: null,
                history: []  // Array of session objects
            },
            achievements: {
                unlocked: {},       // Stores unlocked achievements by ID
                progress: {},       // Stores progress for each achievement
                lastUnlocked: null, // Last unlocked achievement
                discoveredHidden: [] // IDs of hidden achievements that have been discovered
            }
        };

        // Initial Fellow Cultivator Pool
        const initialFellowCultivators = [
            { id: 'fc-1', name: 'Lin Ming', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-2', name: 'Ji Ning', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-3', name: 'Wang Lin', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-4', name: 'Meng Hao', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-5', name: 'Han Li', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-6', name: 'Ye Xiu', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-7', name: 'Xiao Yan', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-8', name: 'Chu Feng', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-9', name: 'Su Ming', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-10', name: 'Fang Yuan', custom: false, editCooldown: 0, encounters: 0 }
        ];

        // Meeting messages for fellow cultivators
        const fellowCultivatorMessages = {
            firstMeeting: [
                "You met a fellow cultivator, [name], while visiting the city and you two chatted for a while.",
                "While meditating, a fellow cultivator, [name], walked by and meditated together with you.",
                "During your herb gathering, you encountered [name], who shared some cultivation insights with you.",
                "At the sect's library, you bumped into [name], and exchanged pointers on cultivation techniques.",
                "A sudden thunderstorm brought you and [name] to shelter in the same cave, where you discussed the dao.",
                "You joined a small martial arts competition and met [name], who proved to be a worthy opponent.",
                "While fishing by the spirit lake, [name] approached and shared some rare cultivation experiences.",
                "At the night market, you encountered [name] browsing through cultivation manuals just like you.",
                "During a monster wave in the wilderness, you fought back-to-back with [name] and formed a bond.",
                "On your way to the alchemy shop, you met [name] who was also looking for the same rare ingredients."
            ],
            repeatMeeting: [
                "You met your fellow cultivator [name] again while practicing sword techniques by the waterfall.",
                "That was not your first encounter with [name], as you recognized each other immediately at the sect gathering.",
                "Once again, you crossed paths with [name] at the celestial mountain peak during your cultivation journey.",
                "Your paths intertwined with [name] once more as you both attended the same alchemy seminar.",
                "[name] greeted you like an old friend when you encountered each other at the spirit beast market.",
                "You recognized [name] immediately when they entered the same teahouse where you were resting.",
                "The familiar presence of [name] was a welcome sight during the annual cultivation conference.",
                "In the midst of a fierce spiritual storm, you found [name] again, and you both took shelter together.",
                "During your visit to the ancient ruins, you were pleased to find [name] conducting research there as well.",
                "Your cultivation journeys aligned once more as you and [name] found yourselves at the same spirit spring."
            ]
        };

        // Cultivation realms data
        const cultivationRealms = [
            {
                name: "Mortal",
                chineseName: "凡人",
                stages: 9,
                multiplier: 1,
                description: "An ordinary person with no spiritual awareness. The journey of a thousand miles begins with a single step.",
                baseQiRequirement: 100
            },
            {
                name: "Qi Condensation",
                chineseName: "凝气",
                stages: 9,
                multiplier: 1.2,
                description: "Beginning to sense the qi of heaven and earth. The first step on the path of immortality.",
                baseQiRequirement: 500
            },
            {
                name: "Foundation Establishment",
                chineseName: "筑基",
                stages: 9,
                multiplier: 1.5,
                description: "Building a solid foundation for future cultivation. The spiritual roots take hold.",
                baseQiRequirement: 2000
            },
            {
                name: "Core Formation",
                chineseName: "结丹",
                stages: 9,
                multiplier: 2,
                description: "Forming a golden core within the dantian. The power to command elements begins to manifest.",
                baseQiRequirement: 8000
            },
            {
                name: "Nascent Soul",
                chineseName: "元婴",
                stages: 9,
                multiplier: 3,
                description: "A secondary soul forms within. Consciousness can leave the physical body for short periods.",
                baseQiRequirement: 25000
            },
            {
                name: "Soul Transformation",
                chineseName: "化神",
                stages: 9,
                multiplier: 5,
                description: "The mortal body begins its transformation into an immortal vessel. Lifespan greatly increases.",
                baseQiRequirement: 80000
            },
            {
                name: "Void Refinement",
                chineseName: "炼虚",
                stages: 9,
                multiplier: 8,
                description: "Refining the void between realms. Space and distance become malleable concepts.",
                baseQiRequirement: 250000
            },
            {
                name: "Body Integration",
                chineseName: "合体",
                stages: 9,
                multiplier: 12,
                description: "Integrating with heaven and earth. Natural laws bend to your will.",
                baseQiRequirement: 800000
            },
            {
                name: "Mahayana",
                chineseName: "大乘",
                stages: 9,
                multiplier: 20,
                description: "Becoming one with the universe. Comprehension of the grand dao begins.",
                baseQiRequirement: 2500000
            },
            {
                name: "True Immortal",
                chineseName: "真仙",
                stages: 9,
                multiplier: 35,
                description: "Transcending mortal limitations. Immortality in its truest form is achieved.",
                baseQiRequirement: 8000000
            },
            {
                name: "Golden Immortal",
                chineseName: "金仙",
                stages: 9,
                multiplier: 60,
                description: "Existence as pure golden light. Creation and destruction are within your grasp.",
                baseQiRequirement: 25000000
            },
            {
                name: "Immortal Emperor",
                chineseName: "仙帝",
                stages: 9,
                multiplier: 100,
                description: "Ruling over all immortals. Your name is revered throughout the Three Realms.",
                baseQiRequirement: 80000000
            },
            {
                name: "Dao Sovereign",
                chineseName: "道主",
                stages: Number.POSITIVE_INFINITY,
                multiplier: 300,
                description: "Sovereign of the Dao itself. The universe is but a reflection of your will.",
                baseQiRequirement: 250000000
            }
        ];

        // Spirit stone data
        const spiritStones = {
            basic: { 
                name: "Basic Spirit Stone", 
                successBoost: 1,
                nextTier: "low"
            },
            low: { 
                name: "Low-Grade Spirit Stone", 
                successBoost: 5,
                nextTier: "medium"
            },
            medium: { 
                name: "Medium-Grade Spirit Stone", 
                successBoost: 10,
                nextTier: "high"
            },
            high: { 
                name: "High-Grade Spirit Stone", 
                successBoost: 15,
                nextTier: "supreme"
            },
            supreme: { 
                name: "Supreme-Grade Spirit Stone", 
                successBoost: 20,
                nextTier: "divine"
            },
            divine: { 
                name: "Divine-Grade Spirit Stone", 
                successBoost: 25,
                nextTier: null
            },
            rename: {
                name: "Rename Scroll",
                description: "Allows changing your cultivator name",
                maxCount: 1
            }
        };

        // Achievement data
        const achievementData = {
            // Cultivation achievements
            "cultivation_reach_qi": {
                id: "cultivation_reach_qi",
                title: "First Steps on the Path",
                description: "Reach the Qi Condensation realm",
                category: "cultivation",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 1
            },
            "cultivation_reach_foundation": {
                id: "cultivation_reach_foundation",
                title: "Solid Foundations",
                description: "Reach the Foundation Establishment realm",
                category: "cultivation",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 2
            },
            "cultivation_reach_core": {
                id: "cultivation_reach_core",
                title: "Inner Power",
                description: "Reach the Core Formation realm",
                category: "cultivation",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 3
            },
            "cultivation_reach_nascent": {
                id: "cultivation_reach_nascent",
                title: "Soul Awakening",
                description: "Reach the Nascent Soul realm",
                category: "cultivation",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 4
            },
            "cultivation_reach_transformation": {
                id: "cultivation_reach_transformation",
                title: "Transcending Mortality",
                description: "Reach the Soul Transformation realm",
                category: "cultivation",
                rarity: "rare",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 5
            },
            "cultivation_reach_void": {
                id: "cultivation_reach_void",
                title: "Void Walker",
                description: "Reach the Void Refinement realm",
                category: "cultivation",
                rarity: "rare",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 6
            },
            "cultivation_reach_integration": {
                id: "cultivation_reach_integration",
                title: "One With Everything",
                description: "Reach the Body Integration realm",
                category: "cultivation",
                rarity: "epic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 7
            },
            "cultivation_reach_mahayana": {
                id: "cultivation_reach_mahayana",
                title: "Grand Way Seeker",
                description: "Reach the Mahayana realm",
                category: "cultivation",
                rarity: "epic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 8
            },
            "cultivation_reach_immortal": {
                id: "cultivation_reach_immortal",
                title: "Immortal Ascension",
                description: "Reach the True Immortal realm",
                category: "cultivation",
                rarity: "legendary",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 9
            },
            "cultivation_reach_golden": {
                id: "cultivation_reach_golden",
                title: "Golden Divinity",
                description: "Reach the Golden Immortal realm",
                category: "cultivation",
                rarity: "legendary",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 10
            },
            "cultivation_reach_emperor": {
                id: "cultivation_reach_emperor",
                title: "Emperor Among Immortals",
                description: "Reach the Immortal Emperor realm",
                category: "cultivation",
                rarity: "mythic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 11
            },
            "cultivation_reach_sovereign": {
                id: "cultivation_reach_sovereign",
                title: "Dao Sovereign",
                description: "Reach the pinnacle Dao Sovereign realm",
                category: "cultivation",
                rarity: "mythic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 12
            },
            "cultivation_perfect_breakthrough": {
                id: "cultivation_perfect_breakthrough",
                title: "Perfect Insight",
                description: "Perform a breakthrough with 99% success rate",
                category: "cultivation",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => false // Checked manually during breakthrough
            },
            "cultivation_breakthrough_streak": {
                id: "cultivation_breakthrough_streak",
                title: "Unbroken Path",
                description: "Successfully perform 5 breakthroughs in a row",
                category: "cultivation",
                rarity: "rare",
                maxProgress: 5,
                isHidden: false,
                checkProgress: () => {
                    // This is tracked manually during breakthrough attempts
                    return gameState.achievements.progress["cultivation_breakthrough_streak"] || 0;
                }
            },
            "cultivation_qi_millionaire": {
                id: "cultivation_qi_millionaire",
                title: "Qi Millionaire",
                description: "Accumulate 1,000,000 qi in total",
                category: "cultivation",
                rarity: "epic",
                maxProgress: 1000000,
                isHidden: false,
                checkProgress: () => gameState.stats.totalQiEarned
            },
            "cultivation_fail_at_99": {
                id: "cultivation_fail_at_99",
                title: "Heaven's Envy",
                description: "Fail a breakthrough attempt with 99% success rate",
                category: "cultivation",
                rarity: "rare",
                maxProgress: 1,
                isHidden: true, // Hidden until at least 20% progress
                revealThreshold: 0.2,
                checkCondition: () => false // Checked manually during breakthrough
            },
            
            // Task achievements
            "tasks_complete_first": {
                id: "tasks_complete_first",
                title: "First Step",
                description: "Complete your first task",
                category: "tasks",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.completedTasks >= 1
            },
            "tasks_complete_10": {
                id: "tasks_complete_10",
                title: "Dedicated Cultivator",
                description: "Complete 10 tasks",
                category: "tasks",
                rarity: "common",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => gameState.stats.completedTasks
            },
            "tasks_complete_50": {
                id: "tasks_complete_50",
                title: "Task Master",
                description: "Complete 50 tasks",
                category: "tasks",
                rarity: "uncommon",
                maxProgress: 50,
                isHidden: false,
                checkProgress: () => gameState.stats.completedTasks
            },
            "tasks_complete_100": {
                id: "tasks_complete_100",
                title: "Century of Effort",
                description: "Complete 100 tasks",
                category: "tasks",
                rarity: "rare",
                maxProgress: 100,
                isHidden: false,
                checkProgress: () => gameState.stats.completedTasks
            },
            "tasks_complete_500": {
                id: "tasks_complete_500",
                title: "Indomitable Will",
                description: "Complete 500 tasks",
                category: "tasks",
                rarity: "epic",
                maxProgress: 500,
                isHidden: false,
                checkProgress: () => gameState.stats.completedTasks
            },
            "tasks_complete_1000": {
                id: "tasks_complete_1000",
                title: "Legendary Dedication",
                description: "Complete 1,000 tasks",
                category: "tasks",
                rarity: "legendary",
                maxProgress: 1000,
                isHidden: false,
                checkProgress: () => gameState.stats.completedTasks
            },
            "tasks_tag_specialist": {
                id: "tasks_tag_specialist",
                title: "Tag Specialist",
                description: "Complete 25 tasks with the same tag",
                category: "tasks",
                rarity: "uncommon",
                maxProgress: 25,
                isHidden: false,
                checkProgress: () => {
                    const tagCounts = Object.values(gameState.stats.completionByTag);
                    return tagCounts.length > 0 ? Math.max(...tagCounts) : 0;
                }
            },
            "tasks_daily_5": {
                id: "tasks_daily_5",
                title: "Daily Cultivator",
                description: "Complete 5 tasks in a single day",
                category: "tasks",
                rarity: "uncommon",
                maxProgress: 5,
                isHidden: false,
                checkCondition: () => false // Tracked manually when completing tasks
            },
            "tasks_boosted_10": {
                id: "tasks_boosted_10",
                title: "Focused Efficiency",
                description: "Complete 10 tasks with pomodoro boost",
                category: "tasks",
                rarity: "uncommon",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => gameState.stats.pomodoroTasksCompleted
            },
            "tasks_create_10": {
                id: "tasks_create_10",
                title: "Task Creator",
                description: "Create 10 different tasks",
                category: "tasks",
                rarity: "common",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => gameState.tasks.length
            },
            "tasks_complete_same_10": {
                id: "tasks_complete_same_10",
                title: "Consistent Practice",
                description: "Complete the same task 10 times",
                category: "tasks",
                rarity: "uncommon",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => {
                    const maxCompletions = gameState.tasks.reduce((max, task) => {
                        return Math.max(max, task.completionCount || 0);
                    }, 0);
                    return maxCompletions;
                }
            },
            
            // Spirit Stone achievements
            "stones_collect_first": {
                id: "stones_collect_first",
                title: "Stone Finder",
                description: "Find your first spirit stone",
                category: "stones",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => {
                    const totalStones = Object.values(gameState.stats.totalStonesFound).reduce((sum, count) => sum + count, 0);
                    return totalStones >= 1;
                }
            },
            "stones_collect_100": {
                id: "stones_collect_100",
                title: "Stone Collector",
                description: "Collect 100 spirit stones of any type",
                category: "stones",
                rarity: "uncommon",
                maxProgress: 100,
                isHidden: false,
                checkProgress: () => {
                    const totalStones = Object.values(gameState.stats.totalStonesFound).reduce((sum, count) => sum + count, 0);
                    return totalStones - gameState.stats.totalStonesFound.rename; // Exclude rename scrolls
                }
            },
            "stones_fuse_first": {
                id: "stones_fuse_first",
                title: "Spirit Alchemy",
                description: "Fuse spirit stones for the first time",
                category: "stones",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => {
                    const totalFused = Object.values(gameState.stats.stonesFused).reduce((sum, count) => sum + count, 0);
                    return totalFused >= 1;
                }
            },
            "stones_collect_divine": {
                id: "stones_collect_divine",
                title: "Divine Collector",
                description: "Collect a Divine-Grade Spirit Stone",
                category: "stones",
                rarity: "epic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.totalStonesFound.divine >= 1
            },
            "stones_fuse_divine": {
                id: "stones_fuse_divine",
                title: "Supreme Alchemist",
                description: "Fuse 100 Supreme-Grade stones into a Divine-Grade stone",
                category: "stones",
                rarity: "legendary",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.stonesFused.supreme >= 1
            },
            "stones_all_types": {
                id: "stones_all_types",
                title: "Stone Connoisseur",
                description: "Collect at least one of each spirit stone type",
                category: "stones",
                rarity: "rare",
                maxProgress: 6,
                isHidden: false,
                checkProgress: () => {
                    const types = ['basic', 'low', 'medium', 'high', 'supreme', 'divine'];
                    return types.filter(type => gameState.stats.totalStonesFound[type] > 0).length;
                }
            },
            "stones_rename_use": {
                id: "stones_rename_use",
                title: "Identity Shift",
                description: "Use a Rename Scroll to change your cultivator name",
                category: "stones",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.renameScrollsUsed >= 1
            },
            
            // Fellow Cultivator achievements
            "cultivators_first_meeting": {
                id: "cultivators_first_meeting",
                title: "First Encounter",
                description: "Meet a fellow cultivator for the first time",
                category: "cultivators",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.cultivatorsMet >= 1
            },
            "cultivators_meet_10": {
                id: "cultivators_meet_10",
                title: "Social Cultivator",
                description: "Meet fellow cultivators 10 times",
                category: "cultivators",
                rarity: "uncommon",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => gameState.stats.cultivatorsMet
            },
            "cultivators_boost_24h": {
                id: "cultivators_boost_24h",
                title: "Continuous Support",
                description: "Accumulate 24 hours of fellow cultivator boost time",
                category: "cultivators",
                rarity: "rare",
                maxProgress: 24 * 60, // 24 hours in minutes
                isHidden: false,
                checkProgress: () => gameState.stats.totalBoostTime
            },
            "cultivators_add_custom": {
                id: "cultivators_add_custom",
                title: "Expanding Circle",
                description: "Add your first custom fellow cultivator",
                category: "cultivators",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => {
                    return gameState.fellowCultivators.pool.some(c => c.custom);
                }
            },
            "cultivators_add_5_custom": {
                id: "cultivators_add_5_custom",
                title: "Friend Collector",
                description: "Add 5 custom fellow cultivators",
                category: "cultivators",
                rarity: "uncommon",
                maxProgress: 5,
                isHidden: false,
                checkProgress: () => {
                    return gameState.fellowCultivators.pool.filter(c => c.custom).length;
                }
            },
            "cultivators_max_boost": {
                id: "cultivators_max_boost",
                title: "Maximum Synergy",
                description: "Reach the maximum 10-hour boost time limit",
                category: "cultivators",
                rarity: "epic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => false // Checked manually when meeting cultivators
            },
            "cultivators_meet_same_5": {
                id: "cultivators_meet_same_5",
                title: "Fated Connection",
                description: "Meet the same fellow cultivator 5 times",
                category: "cultivators",
                rarity: "rare",
                maxProgress: 5,
                isHidden: false,
                checkProgress: () => {
                    const encounters = gameState.fellowCultivators.pool.map(c => c.encounters);
                    return encounters.length > 0 ? Math.max(...encounters) : 0;
                }
            },
            "cultivators_fill_pool": {
                id: "cultivators_fill_pool",
                title: "Cultivator Network",
                description: "Fill your cultivator pool to the maximum of 32 custom cultivators",
                category: "cultivators",
                rarity: "legendary",
                maxProgress: 32,
                isHidden: false,
                checkProgress: () => {
                    return gameState.fellowCultivators.pool.filter(c => c.custom).length;
                }
            },
            
            // Pomodoro achievements
            "pomodoro_first_session": {
                id: "pomodoro_first_session",
                title: "Focused Cultivation",
                description: "Complete your first pomodoro session",
                category: "pomodoro",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.pomodoroSessions >= 1
            },
            "pomodoro_10_sessions": {
                id: "pomodoro_10_sessions",
                title: "Concentration Master",
                description: "Complete 10 pomodoro sessions",
                category: "pomodoro",
                rarity: "uncommon",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => gameState.stats.pomodoroSessions
            },
            "pomodoro_50_sessions": {
                id: "pomodoro_50_sessions",
                title: "Focus Cultivator",
                description: "Complete 50 pomodoro sessions",
                category: "pomodoro",
                rarity: "rare",
                maxProgress: 50,
                isHidden: false,
                checkProgress: () => gameState.stats.pomodoroSessions
            },
            "pomodoro_100_sessions": {
                id: "pomodoro_100_sessions",
                title: "Time Lord",
                description: "Complete 100 pomodoro sessions",
                category: "pomodoro",
                rarity: "epic",
                maxProgress: 100,
                isHidden: false,
                checkProgress: () => gameState.stats.pomodoroSessions
            },
            "pomodoro_10_hours": {
                id: "pomodoro_10_hours",
                title: "Time Investment",
                description: "Accumulate 10 hours of focused time",
                category: "pomodoro",
                rarity: "uncommon",
                maxProgress: 10 * 60, // 10 hours in minutes
                isHidden: false,
                checkProgress: () => gameState.stats.pomodoroTotalMinutes
            },
            "pomodoro_max_boost": {
                id: "pomodoro_max_boost",
                title: "Maximum Focus",
                description: "Complete a full 25-minute pomodoro session",
                category: "pomodoro",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => false // Checked manually when completing sessions
            },
            "pomodoro_daily_streak": {
                id: "pomodoro_daily_streak",
                title: "Daily Focus",
                description: "Complete at least one pomodoro session for 5 consecutive days",
                category: "pomodoro",
                rarity: "rare",
                maxProgress: 5,
                isHidden: false,
                checkProgress: () => {
                    // This is tracked manually when completing pomodoro sessions
                    return gameState.achievements.progress["pomodoro_daily_streak"] || 0;
                }
            },
            "pomodoro_boost_all": {
                id: "pomodoro_boost_all",
                title: "Focused Efficiency",
                description: "Complete all generated tasks with pomodoro boost active",
                category: "pomodoro",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => false // Checked manually when completing tasks
            },
            
            // Miscellaneous achievements
            "misc_first_day": {
                id: "misc_first_day",
                title: "Beginning of the Journey",
                description: "Start your cultivation journey",
                category: "misc",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => true // Always unlocked on first load
            },
            "misc_daily_login_7": {
                id: "misc_daily_login_7",
                title: "Weekly Cultivator",
                description: "Log in for 7 consecutive days",
                category: "misc",
                rarity: "uncommon",
                maxProgress: 7,
                isHidden: false,
                checkProgress: () => {
                    // This is tracked manually on login
                    return gameState.achievements.progress["misc_daily_login_7"] || 0;
                }
            },
            "misc_daily_login_30": {
                id: "misc_daily_login_30",
                title: "Monthly Dedication",
                description: "Log in for 30 consecutive days",
                category: "misc",
                rarity: "rare",
                maxProgress: 30,
                isHidden: false,
                checkProgress: () => {
                    // This is tracked manually on login
                    return gameState.achievements.progress["misc_daily_login_30"] || 0;
                }
            },
            "misc_achieve_10": {
                id: "misc_achieve_10",
                title: "Achievement Hunter",
                description: "Unlock 10 achievements",
                category: "misc",
                rarity: "uncommon",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => Object.keys(gameState.achievements.unlocked).length
            },
            "misc_achieve_25": {
                id: "misc_achieve_25",
                title: "Achievement Master",
                description: "Unlock 25 achievements",
                category: "misc",
                rarity: "rare",
                maxProgress: 25,
                isHidden: false,
                checkProgress: () => Object.keys(gameState.achievements.unlocked).length
            },
            "misc_achieve_50": {
                id: "misc_achieve_50",
                title: "Achievement Legend",
                description: "Unlock 50 achievements",
                category: "misc",
                rarity: "epic",
                maxProgress: 50,
                isHidden: false,
                checkProgress: () => Object.keys(gameState.achievements.unlocked).length
            },
            "misc_unlock_all_tabs": {
                id: "misc_unlock_all_tabs",
                title: "Complete Interface",
                description: "Unlock all application tabs",
                category: "misc",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 1 || gameState.player.fcTabUnlocked
            },
            "misc_export_data": {
                id: "misc_export_data",
                title: "Data Guardian",
                description: "Export your game data for safekeeping",
                category: "misc",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => false // Checked manually when exporting
            },
            "misc_theme_explorer": {
                id: "misc_theme_explorer",
                title: "Aesthetic Cultivator",
                description: "Try all available themes",
                category: "misc",
                rarity: "uncommon",
                maxProgress: 6, // Number of themes
                isHidden: false,
                checkProgress: () => {
                    // This is tracked manually when changing themes
                    return gameState.achievements.progress["misc_theme_explorer"] || 0;
                }
            },
            "misc_hidden_fellow": {
                id: "misc_hidden_fellow",
                title: "Impatient Cultivator",
                description: "Unlock the Fellow Cultivators tab early through persistence",
                category: "misc",
                rarity: "rare",
                maxProgress: 1,
                isHidden: true,
                revealThreshold: 0.5,
                checkCondition: () => gameState.player.fcTabUnlocked && gameState.player.realm === 0
            }
        };

        // Tutorial data
        const tutorialContent = [
            {
                title: "Welcome to 青云修仙录!",
                content: `
                    <div class="flex flex-col items-center mb-4">
                        <div class="rotate-symbol text-4xl mb-2">☯</div>
                        <h3 class="text-xl font-bold">Cultivation Through Tasks</h3>
                    </div>
                    <p class="mb-2">This application combines a task management system with a cultivation-themed idle game to help you overcome procrastination while having fun.</p>
                    <p class="mb-2">Complete real-life tasks to gain qi and spirit stones, which will help you advance through cultivation realms!</p>
                    <p>This tutorial will guide you through the main features of the application.</p>
                    <p class="mt-4 text-sm italic">Note: You can access this tutorial anytime from the Settings tab.</p>
                `
            },
            {
                title: "Task Management",
                content: `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <h3 class="font-bold mb-2">Creating Tasks</h3>
                            <p>1. Enter a task name</p>
                            <p>2. Add tags (optional, comma-separated)</p>
                            <p>3. Click "Add Task" to save it</p>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2">Managing Tasks</h3>
                            <p>• Edit or delete existing tasks</p>
                            <p>• Sort by name, tags, or completion count</p>
                            <p>• Select multiple tasks with checkboxes</p>
                            <p>• View completion history for each task</p>
                        </div>
                    </div>
                    <div class="ancient-border p-3 mb-4">
                        <h3 class="font-bold mb-2">Task Generator</h3>
                        <p>1. Choose how many tasks to generate (1-10)</p>
                        <p>2. Optionally filter by specific tags</p>
                        <p>3. Click "Generate Tasks" to randomly select from your task list</p>
                        <p>4. Complete tasks to earn qi and spirit stones</p>
                        <p>5. Skip individual tasks or give up all tasks with a qi penalty</p>
                        <p class="mt-2 text-sm italic">Note: Both skipping tasks and giving up will incur a qi penalty. The penalty for giving up increases with the number of tasks.</p>
                    </div>
                `
            },
            {
                title: "Cultivation System",
                content: `
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Cultivation Progression</h3>
                        <p>• Complete tasks to gain qi</p>
                        <p>• Gain passive qi at a base rate of 0.5 qi/min</p>
                        <p>• Higher realms provide higher multipliers for passive gains</p>
                        <p>• Each realm has multiple stages you must break through</p>
                    </div>
                    <div class="ancient-border p-3 mb-4">
                        <h3 class="font-bold mb-2">Breakthrough</h3>
                        <p>• Accumulate sufficient qi to attempt a breakthrough</p>
                        <p>• Each attempt has a base success rate</p>
                        <p>• Use spirit stones to increase your success chance</p>
                        <p>• Failed breakthroughs result in qi loss (15-35%)</p>
                        <p>• Successful breakthroughs advance you to the next stage or realm</p>
                    </div>
                `
            },
            {
                title: "Spirit Stones",
                content: `
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Spirit Stone Tiers</h3>
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <div class="text-center">
                                <div class="spirit-stone stone-basic mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">Basic</p>
                                <p class="text-xs">+1%</p>
                            </div>
                            <div class="text-center">
                                <div class="spirit-stone stone-low mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">Low</p>
                                <p class="text-xs">+5%</p>
                            </div>
                            <div class="text-center">
                                <div class="spirit-stone stone-medium mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">Medium</p>
                                <p class="text-xs">+10%</p>
                            </div>
                            <div class="text-center">
                                <div class="spirit-stone stone-high mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">High</p>
                                <p class="text-xs">+15%</p>
                            </div>
                            <div class="text-center">
                                <div class="spirit-stone stone-supreme mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">Supreme</p>
                                <p class="text-xs">+20%</p>
                            </div>
                            <div class="text-center">
                                <div class="spirit-stone stone-divine mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">Divine</p>
                                <p class="text-xs">+25%</p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Acquiring & Using Spirit Stones</h3>
                        <p>• Earn spirit stones by completing tasks</p>
                        <p>• Higher realms increase chances of finding better stones</p>
                        <p>• Fuse 100 lower-tier stones to create 1 higher-tier stone</p>
                        <p>• Use stones to boost breakthrough success rate</p>
                        <p>• Lower stones have reduced effectiveness in higher realms</p>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Special Items</h3>
                        <div class="flex items-center">
                            <div class="spirit-stone stone-rename mr-2" style="width:30px;height:30px"></div>
                            <div>
                                <p><strong>Rename Scroll</strong>: Changes your cultivator name</p>
                                <p class="text-xs">• 5% chance to find when completing tasks</p>
                                <p class="text-xs">• Maximum of 1 scroll can be held at once</p>
                                <p class="text-xs">• Can be used from Inventory or Settings page</p>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                title: "Pomodoro Cultivation",
                content: `
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Focus Timer</h3>
                        <p>The Pomodoro technique helps improve focus and productivity through timed work sessions.</p>
                        <ul class="list-disc pl-6 mt-1 mb-2">
                            <li>Set a focus duration between 5-25 minutes</li>
                            <li>Optionally set a break duration between 0-10 minutes</li>
                            <li>Complete the session to earn qi boosting rewards</li>
                            <li>Longer sessions provide better rewards</li>
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Rewards by Duration</h3>
                        <div class="ancient-border p-3">
                            <p>Complete a focus session to receive qi boosts:</p>
                            <ul class="list-disc pl-6 mt-1">
                                <li>15 minutes: x2 qi for 5 task completions</li>
                                <li>20 minutes: x2 qi for 8 task completions</li>
                                <li>25 minutes: x2 qi for 10 task completions</li>
                                <li>5-14 minutes: No rewards, but still counts as practice</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="ancient-border p-3">
                        <h3 class="font-bold mb-2">How to Use</h3>
                        <p>1. Set your desired focus and break durations</p>
                        <p>2. Start the timer and focus on your real-world tasks</p>
                        <p>3. When the timer completes, you'll earn a boost</p>
                        <p>4. Complete tasks in the app to use your boost</p>
                        <p>5. The boost applies automatically to task completions</p>
                        <p class="mt-2 text-sm italic">Tip: Use the pomodoro timer while working on tasks that you've added to the app for maximum efficiency!</p>
                    </div>
                `
            },
            {
                title: "Fellow Cultivators",
                content: `
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Meeting Fellow Cultivators</h3>
                        <p>• You can meet fellow cultivators when returning after being away</p>
                        <p>• Meeting chances increase with longer absence:</p>
                        <ul class="list-disc pl-6 mt-1 mb-2">
                            <li>10 minutes offline: 10% chance</li>
                            <li>30 minutes offline: 20% chance</li>
                            <li>60+ minutes offline: 30% chance</li>
                        </ul>
                        <p class="text-sm italic">Note: The Fellow Cultivators feature unlocks when you reach the Qi Condensation realm.</p>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Benefits & Management</h3>
                        <p>• Meeting a fellow cultivator doubles your idle cultivation rate</p>
                        <p>• Boost duration is random (60-120 minutes per meeting)</p>
                        <p>• Multiple meetings can extend the boost (maximum 10 hours)</p>
                        <p>• The game includes built-in cultivators</p>
                        <p>• You can add up to 32 custom cultivators to your pool</p>
                        <p>• Add up to 5 custom cultivators per day</p>
                    </div>
                    
                    <div class="ancient-border p-3">
                        <h3 class="font-bold mb-2">Custom Cultivator Settings</h3>
                        <p>• You can set the app to only meet your custom cultivators</p>
                        <p>• Edit custom cultivator names (with 48-hour cooldown)</p>
                        <p>• Remove custom cultivators you no longer want</p>
                        <p>• Note: Built-in cultivators cannot be edited or removed</p>
                        <p>• Add your cultivator permanently into the game in Settings</p>
                    </div>
                `
            },
            {
                title: "Achievements",
                content: `
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Achievement System</h3>
                        <p>Track your cultivation progress and unlock achievements as you progress.</p>
                        <p>Achievements are organized into categories:</p>
                        <ul class="list-disc pl-6 mt-1 mb-2">
                            <li>Cultivation - Progress through realms and breakthroughs</li>
                            <li>Tasks - Complete and manage various tasks</li>
                            <li>Spirit Stones - Collect and fuse spirit stones</li>
                            <li>Fellow Cultivators - Meet and manage fellow cultivators</li>
                            <li>Pomodoro - Complete focus sessions</li>
                            <li>Miscellaneous - General achievements</li>
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Achievement Rarities</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2">
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-common mr-1"></span>
                                <span>Common</span>
                            </div>
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-uncommon mr-1"></span>
                                <span>Uncommon</span>
                            </div>
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-rare mr-1"></span>
                                <span>Rare</span>
                            </div>
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-epic mr-1"></span>
                                <span>Epic</span>
                            </div>
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-legendary mr-1"></span>
                                <span>Legendary</span>
                            </div>
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-mythic mr-1"></span>
                                <span>Mythic</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ancient-border p-3">
                        <h3 class="font-bold mb-2">Hidden Achievements</h3>
                        <p>• Some achievements are hidden until you make progress toward them</p>
                        <p>• When you reach about 20% progress, the achievement will be revealed</p>
                        <p>• Hidden achievements tend to be more unusual or challenging</p>
                        <p class="mt-2 text-sm italic">Explore different features and try unusual actions to discover hidden achievements!</p>
                    </div>
                `
            },
            {
                title: "Statistics & Analytics",
                content: `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <h3 class="font-bold mb-2">Statistics</h3>
                            <p>• Track completed tasks</p>
                            <p>• Monitor breakthrough success rate</p>
                            <p>• View spirit stones collected</p>
                            <p>• See your highest realm reached</p>
                            <p>• Track passive vs. active qi gains</p>
                            <p>• View fellow cultivator encounters</p>
                            <p>• Track pomodoro sessions</p>
                            <p>• Monitor achievement progress</p>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2">Analytics</h3>
                            <p>• Task completion patterns by tag</p>
                            <p>• Qi efficiency metrics</p>
                            <p>• Cultivation journey visualization</p>
                            <p>• Weekly activity heatmap</p>
                            <p>• Passive vs. active qi distribution</p>
                            <p>• Boost time from fellow cultivators</p>
                            <p>• Pomodoro session analysis</p>
                        </div>
                    </div>
                    <div class="ancient-border p-3 mb-4">
                        <h3 class="font-bold mb-2">Customization Options</h3>
                        <p>• Choose from multiple visual themes</p>
                        <p>• Toggle between light and dark mode</p>
                        <p>• Set your cultivator name (requires Rename Scroll after setup)</p>
                        <p>• Customize notification preferences</p>
                        <p>• Show or hide task completion counts</p>
                        <p>• Choose to use scientific notation for large numbers</p>
                        <p>• Set fellow cultivator meeting preferences</p>
                    </div>
                `
            },
            {
                title: "Additional Features",
                content: `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <h3 class="font-bold mb-2">Quality of Life</h3>
                            <p>• Manual save button</p>
                            <p>• Skip individual tasks (with qi penalty)</p>
                            <p>• Sort tasks by different criteria</p>
                            <p>• Detailed tooltips</p>
                            <p>• Multiple theme options</p>
                            <p>• Name editing in settings (with Rename Scroll)</p>
                            <p>• Scientific notation for large numbers</p>
                            <p>• Collapsible information sections</p>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2">Settings & Community</h3>
                            <p>• Export/Import game data</p>
                            <p>• Reset statistics</p>
                            <p>• Hard reset option</p>
                            <p>• View this tutorial again</p>
                            <p>• Access patch notes</p>
                            <p>• Submit your fellow cultivator name ideas</p>
                            <p>• Choose to only meet custom cultivators</p>
                            <p>• Manage notification preferences</p>
                        </div>
                    </div>
                    <div class="ancient-border p-3 text-center">
                        <h3 class="font-bold mb-2">You're Ready to Begin!</h3>
                        <p class="mb-2">Start by adding some tasks, then generate random ones to complete.</p>
                        <p>Remember: Consistent effort leads to cultivation mastery!</p>
                        <div class="flex justify-center mt-2">
                            <div class="rotate-symbol text-2xl">☯</div>
                        </div>
                        <p class="mt-4 text-sm italic">You can access this tutorial again anytime from the Settings tab.</p>
                    </div>
                `
            }
        ];

        // DOM elements
        const elements = {
            tabs: document.querySelectorAll('.tab-button'),
            tabContents: document.querySelectorAll('.tab-content'),
            
            // Cultivation tab
            currentRealm: document.getElementById('current-realm'),
            currentStage: document.getElementById('current-stage'),
            maxStage: document.getElementById('max-stage'),
            qiProgressBar: document.getElementById('qi-progress-bar'),
            currentQi: document.getElementById('current-qi'),
            targetQi: document.getElementById('target-qi'),
            baseRate: document.getElementById('base-rate'),
            currentMultiplier: document.getElementById('current-multiplier'),
            effectiveRate: document.getElementById('effective-rate'),
            nextHourYield: document.getElementById('next-hour-yield'),
            realmDescription: document.getElementById('realm-description'),
            fellowBoostContainer: document.getElementById('fellow-boost-container'),
            boostStatus: document.getElementById('boost-status'),
            boostTimeRemaining: document.getElementById('boost-time-remaining'),
            pomodoroBoostContainer: document.getElementById('pomodoro-boost-container'),
            pomodoroBoostStatus: document.getElementById('pomodoro-boost-status'),
            pomodoroBoostsRemaining: document.getElementById('pomodoro-boosts-remaining'),
            
            breakthroughQiRequired: document.getElementById('breakthrough-qi-required'),
            baseSuccessRate: document.getElementById('base-success-rate'),
            finalSuccessRate: document.getElementById('final-success-rate'),
            selectedStones: document.getElementById('selected-stones'),
            successBoost: document.getElementById('success-boost'),
            clearStones: document.getElementById('clear-stones'),
            attemptBreakthrough: document.getElementById('attempt-breakthrough'),
            
            // Tasks tab
            taskName: document.getElementById('task-name'),
            taskTags: document.getElementById('task-tags'),
            addTask: document.getElementById('add-task'),
            sortTasks: document.getElementById('sort-tasks'),
            selectAllTasks: document.getElementById('select-all-tasks'),
            taskList: document.getElementById('task-list'),
            editSelectedTask: document.getElementById('edit-selected-task'),
            deleteSelectedTasks: document.getElementById('delete-selected-tasks'),
            
            taskCount: document.getElementById('task-count'),
            filterTags: document.getElementById('filter-tags'),
            generateTasks: document.getElementById('generate-tasks'),
            generatedTasks: document.getElementById('generated-tasks'),
            completeAllTasks: document.getElementById('complete-all-tasks'),
            giveUpTasks: document.getElementById('give-up-tasks'),

            // Pomodoro tab
            timerDisplay: document.getElementById('timer-display'),
            timerProgressBar: document.getElementById('timer-progress-bar'),
            breakIndicator: document.getElementById('break-indicator'),
            timerStart: document.getElementById('timer-start'),
            timerPause: document.getElementById('timer-pause'),
            timerReset: document.getElementById('timer-reset'),
            focusDuration: document.getElementById('focus-duration'),
            focusDurationDisplay: document.getElementById('focus-duration-display'),
            breakDuration: document.getElementById('break-duration'),
            breakDurationDisplay: document.getElementById('break-duration-display'),
            useBreak: document.getElementById('use-break'),
            activePomodoroBoost: document.getElementById('active-pomodoro-boost'),
            noPomodoroBoost: document.getElementById('no-pomodoro-boost'),
            remainingBoostedTasks: document.getElementById('remaining-boosted-tasks'),
            totalSessions: document.getElementById('total-sessions'),
            totalFocusTime: document.getElementById('total-focus-time'),
            totalBoostsEarned: document.getElementById('total-boosts-earned'),
            totalBoostedTasks: document.getElementById('total-boosted-tasks'),
            sessionHistory: document.getElementById('session-history'),
            
            // Inventory tab
            stoneCounters: {
                basic: document.getElementById('basic-stone-count'),
                low: document.getElementById('low-stone-count'),
                medium: document.getElementById('medium-stone-count'),
                high: document.getElementById('high-stone-count'),
                supreme: document.getElementById('supreme-stone-count'),
                divine: document.getElementById('divine-stone-count')
            },
            stoneButtons: document.querySelectorAll('[data-stone]'),
            renameScrollCount: document.getElementById('rename-scroll-count'),
            useRenameScroll: document.getElementById('use-rename-scroll'),

            // Fellow Cultivators tab
            fcTabButton: document.getElementById('fellowCultivators-tab-button'),
            fcBoostStatus: document.getElementById('fc-boost-status'),
            fcNoBoost: document.getElementById('fc-no-boost'),
            fcActiveBoost: document.getElementById('fc-active-boost'),
            fcBoostTimeRemaining: document.getElementById('fc-boost-time-remaining'),
            fcLastEncounter: document.getElementById('fc-last-encounter'),
            fcNoEncounters: document.getElementById('fc-no-encounters'),
            fcLastEncounterDetails: document.getElementById('fc-last-encounter-details'),
            fcLastEncounterMessage: document.getElementById('fc-last-encounter-message'),
            fcLastEncounterTime: document.getElementById('fc-last-encounter-time'),
            newCultivatorName: document.getElementById('new-cultivator-name'),
            addCultivator: document.getElementById('add-cultivator'),
            cultivatorsAddedToday: document.getElementById('cultivators-added-today'),
            editCultivatorSelect: document.getElementById('edit-cultivator-select'),
            editCultivatorForm: document.getElementById('edit-cultivator-form'),
            editCultivatorName: document.getElementById('edit-cultivator-name'),
            saveCultivatorEdit: document.getElementById('save-cultivator-edit'),
            editCooldownInfo: document.getElementById('edit-cooldown-info'),
            editAvailableTime: document.getElementById('edit-available-time'),
            removeCultivatorSelect: document.getElementById('remove-cultivator-select'),
            removeCultivator: document.getElementById('remove-cultivator'),
            builtinCultivatorPool: document.getElementById('builtin-cultivator-pool'),
            noBuiltinCultivatorsMessage: document.getElementById('no-builtin-cultivators-message'),
            builtinCultivatorCount: document.getElementById('builtin-cultivator-count'),
            customCultivatorPool: document.getElementById('custom-cultivator-pool'),
            noCustomCultivatorsMessage: document.getElementById('no-custom-cultivators-message'),
            customCultivatorsCount: document.getElementById('custom-cultivators-count'),
            
            // Achievements tab
            achievementTabs: document.getElementById('achievement-tabs'),
            achievementList: document.getElementById('achievement-list'),
            achievementTotalCount: document.getElementById('achievement-total-count'),
            achievementPercent: document.getElementById('achievement-percent'),
            achievementLatest: document.getElementById('achievement-latest'),
            achievementRarest: document.getElementById('achievement-rarest'),
            
            // Statistics tab
            statTotalTasks: document.getElementById('stat-total-tasks'),
            statCompletedTasks: document.getElementById('stat-completed-tasks'),
            statAvgQi: document.getElementById('stat-avg-qi'),
            statAvgStones: document.getElementById('stat-avg-stones'),
            statBreakthroughs: document.getElementById('stat-breakthroughs'),
            statFailedAttempts: document.getElementById('stat-failed-attempts'),
            statSuccessRate: document.getElementById('stat-success-rate'),
            statHighestRealm: document.getElementById('stat-highest-realm'),
            statTotalQi: document.getElementById('stat-total-qi'),
            statPassiveQi: document.getElementById('stat-passive-qi'),
            statMostCompletedTask: document.getElementById('stat-most-completed-task'),
            statMostActiveTag: document.getElementById('stat-most-active-tag'),
            statPomodoroQi: document.getElementById('stat-pomodoro-qi'),
            statPomodoroBoostedTasks: document.getElementById('stat-pomodoro-boosted-tasks'),
            
            statBasicStones: document.getElementById('stat-basic-stones'),
            statLowStones: document.getElementById('stat-low-stones'),
            statMediumStones: document.getElementById('stat-medium-stones'),
            statHighStones: document.getElementById('stat-high-stones'),
            statSupremeStones: document.getElementById('stat-supreme-stones'),
            statDivineStones: document.getElementById('stat-divine-stones'),
            
            statBasicFused: document.getElementById('stat-basic-fused'),
            statLowFused: document.getElementById('stat-low-fused'),
            statMediumFused: document.getElementById('stat-medium-fused'),
            statHighFused: document.getElementById('stat-high-fused'),
            statSupremeFused: document.getElementById('stat-supreme-fused'),
            
            statRenameScrolls: document.getElementById('stat-rename-scrolls'),
            statRenameScrollsUsed: document.getElementById('stat-rename-scrolls-used'),
            
            statCultivatorsMet: document.getElementById('stat-cultivators-met'),
            statTotalBoostTime: document.getElementById('stat-total-boost-time'),
            statQiFromBoosts: document.getElementById('stat-qi-from-boosts'),
            
            statPomodoroSessions: document.getElementById('stat-pomodoro-sessions'),
            statFocusMinutes: document.getElementById('stat-focus-minutes'),
            statBoostsEarned: document.getElementById('stat-boosts-earned'),
            
            statTotalAchievements: document.getElementById('stat-total-achievements'),
            statAchievementRate: document.getElementById('stat-achievement-rate'),
            statHiddenAchievements: document.getElementById('stat-hidden-achievements'),
            
            // Analytics tab
            qiSourceActive: document.getElementById('qi-source-active'),
            qiSourcePassive: document.getElementById('qi-source-passive'),
            qiActivePercent: document.getElementById('qi-active-percent'),
            qiPassivePercent: document.getElementById('qi-passive-percent'),
            qiEfficiencyChart: document.getElementById('qi-efficiency-chart'),
            tasksByTagChart: document.getElementById('tasks-by-tag-chart'),
            cultivationJourneyChart: document.getElementById('cultivation-journey-chart'),
            activityHeatmapChart: document.getElementById('activity-heatmap-chart'),
            pomodoroDurationChart: document.getElementById('pomodoro-duration-chart'),
            
            // Settings tab
            exportGame: document.getElementById('export-game'),
            manualSave: document.getElementById('manual-save'),
            importData: document.getElementById('import-data'),
            importGame: document.getElementById('import-game'),
            resetStats: document.getElementById('reset-stats'),
            hardReset: document.getElementById('hard-reset'),
            showTutorial: document.getElementById('show-tutorial'),
            
            settingsCultivatorName: document.getElementById('settings-cultivator-name'),
            settingsChangeName: document.getElementById('settings-change-name'),
            
            themeSelect: document.getElementById('theme-select'),
            themeModeToggle: document.getElementById('theme-mode-toggle'),
            themeModeLabel: document.getElementById('theme-mode-label'),
            showCompletionCount: document.getElementById('show-completion-count'),
            
            useScientificNotation: document.getElementById('use-scientific-notation'),
            scientificNotationThreshold: document.getElementById('scientific-notation-threshold'),
            
            onlyMeetCustomCultivators: document.getElementById('only-meet-custom-cultivators'),
            
            notificationBreakthrough: document.getElementById('notification-breakthrough'),
            notificationIdle: document.getElementById('notification-idle'),
            notificationMilestone: document.getElementById('notification-milestone'),
            notificationFellowCultivator: document.getElementById('notification-fellowCultivator'),
            notificationAchievement: document.getElementById('notification-achievement'),
            notificationPomodoro: document.getElementById('notification-pomodoro'),
            
            // Modals
            modalOverlay: document.getElementById('modal-overlay'),
            modalContent: document.getElementById('modal-content'),
            modalHeader: document.getElementById('modal-header'),
            modalBody: document.getElementById('modal-body'),
            modalFooter: document.getElementById('modal-footer'),
            modalCancel: document.getElementById('modal-cancel'),
            modalConfirm: document.getElementById('modal-confirm'),
            
            // Name Change
            nameChangeOverlay: document.getElementById('name-change-overlay'),
            cultivatorNameInput: document.getElementById('cultivator-name-input'),
            nameChangeCancel: document.getElementById('name-change-cancel'),
            nameChangeConfirm: document.getElementById('name-change-confirm'),
            cultivatorName: document.getElementById('cultivator-name'),
            renameWarning: document.getElementById('rename-warning'),
            
            // Achievement Unlock
            achievementUnlockOverlay: document.getElementById('achievement-unlock-overlay'),
            achievementUnlockIcon: document.getElementById('achievement-unlock-icon'),
            achievementUnlockTitle: document.getElementById('achievement-unlock-title'),
            achievementUnlockDescription: document.getElementById('achievement-unlock-description'),
            achievementUnlockConfirm: document.getElementById('achievement-unlock-confirm'),
            
            // Toast
            toastContainer: document.getElementById('toast-container'),
            
            // Custom Notifications
            notificationContainer: document.getElementById('notification-container'),
            
            // Tutorial
            tutorialOverlay: document.getElementById('tutorial-overlay'),
            tutorialBody: document.getElementById('tutorial-body'),
            tutorialPrev: document.getElementById('tutorial-prev'),
            tutorialNext: document.getElementById('tutorial-next'),
            tutorialSkip: document.getElementById('tutorial-skip'),
            tutorialPage: document.getElementById('tutorial-page'),
            
            // Spoilers
            spoilerHeaders: document.querySelectorAll('.spoiler-header')
        };

        // Chart instances
        let charts = {
            qiEfficiency: null,
            tasksByTag: null,
            cultivationJourney: null,
            activityHeatmap: null,
            pomodoroDuration: null
        };

        // Initialize tabs
        elements.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // Check if Fellow Cultivators tab is locked
                if (tabName === 'fellowCultivators' && elements.fcTabButton.classList.contains('disabled')) {
                    // Increment debug counter for unlocking
                    gameState.player.fcTabUnlockClicks++;
                    
                    // Check if debug clicks reach threshold
                    if (gameState.player.fcTabUnlockClicks >= 12) {
                        // Unlock the tab
                        elements.fcTabButton.classList.remove('disabled');
                        gameState.player.fcTabUnlocked = true;
                        showToast("Fellow Cultivators feature unlocked through persistence!", "success");
                        
                        // Check achievement for hidden unlock
                        checkAchievement("misc_hidden_fellow");
                        
                        // Save game state
                        saveGameState();
                    } else if (gameState.player.fcTabUnlockClicks >= 8) {
                        // Give hint that something is happening
                        showToast(`The tab seems to be responding to your persistence... (${12 - gameState.player.fcTabUnlockClicks} more clicks)`, "info");
                    }
                    return;
                }
                
                // Update active tab
                elements.tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show the corresponding tab content
                elements.tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tabName}-tab`).classList.remove('hidden');
                
                // If switching to analytics tab, update charts
                if (tabName === 'analytics') {
                    updateAnalyticsCharts();
                }
                
                // If switching to fellow cultivators tab, update UI
                if (tabName === 'fellowCultivators') {
                    updateFellowCultivatorsUI();
                }
                
                // If switching to achievements tab, update UI
                if (tabName === 'achievements') {
                    updateAchievementsUI();
                }
                
                // If switching to pomodoro tab, update UI
                if (tabName === 'pomodoro') {
                    updatePomodoroUI();
                }
            });
        });

        // Initialize spoiler headers
        elements.spoilerHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.spoiler-icon');
                
                // Toggle the content visibility
                if (content.classList.contains('open')) {
                    content.classList.remove('open');
                    icon.classList.remove('open');
                } else {
                    content.classList.add('open');
                    icon.classList.add('open');
                }
            });
        });

        // Get current realm object
        function getCurrentRealm() {
            return cultivationRealms[gameState.player.realm];
        }

        // Get next realm object
        function getNextRealm() {
            if (gameState.player.realm < cultivationRealms.length - 1) {
                return cultivationRealms[gameState.player.realm + 1];
            }
            return null;
        }

        // Calculate qi required for current stage breakthrough
        function getQiRequiredForBreakthrough() {
            const currentRealm = getCurrentRealm();
            const baseRequirement = currentRealm.baseQiRequirement;
            const stageFactor = Math.pow(1.5, gameState.player.stage - 1);
            return Math.floor(baseRequirement * stageFactor);
        }

        // Calculate base success rate for breakthrough
        function getBaseSuccessRate() {
            const currentRealm = getCurrentRealm();
            const baseRate = 90 - (gameState.player.realm * 5);
            const stageReduction = (gameState.player.stage - 1) * 2;
            return Math.max(15, baseRate - stageReduction);
        }

        // Calculate stone effectiveness based on realm difference
        function getStoneEffectiveness(stoneType) {
            // Define which realm each stone type is associated with
            const stoneRealms = {
                basic: 0, // Mortal
                low: 2,   // Foundation Establishment
                medium: 4, // Nascent Soul
                high: 6,  // Void Refinement
                supreme: 8, // Mahayana
                divine: 10 // Golden Immortal
            };
            
            const currentRealm = gameState.player.realm;
            const stoneRealm = stoneRealms[stoneType];
            
            const realmDifference = currentRealm - stoneRealm;
            
            if (realmDifference <= 0) {
                return 1.0; // 100% effectiveness for stones of same or higher realm
            } else if (realmDifference === 1) {
                return 0.75; // 75% effectiveness for stones one realm below
            } else if (realmDifference === 2) {
                return 0.5; // 50% effectiveness for stones two realms below
            } else {
                return 0.25; // 25% effectiveness for stones three or more realms below
            }
        }

        // Calculate success rate boost from selected stones
        function calculateSuccessBoost() {
            let totalBoost = 0;
            
            for (const [type, count] of Object.entries(gameState.selectedStones)) {
                if (count > 0) {
                    const stoneInfo = spiritStones[type];
                    const effectiveness = getStoneEffectiveness(type);
                    totalBoost += stoneInfo.successBoost * count * effectiveness;
                }
            }
            
            return Math.floor(totalBoost);
        }

        // Calculate total success rate for breakthrough
        function getTotalSuccessRate() {
            const baseRate = getBaseSuccessRate();
            const boostRate = calculateSuccessBoost();
            return Math.min(99, baseRate + boostRate);
        }

        // Format large numbers with suffixes or scientific notation
        function formatNumber(num) {
            // First ensure it's a number
            num = Number(num);
            
            // Check if we should use scientific notation
            if (gameState.settings.useScientificNotation && num >= gameState.settings.scientificNotationThreshold) {
                return num.toExponential(2);
            }
            
            // Otherwise use suffix formatting
            if (num < 1000) return num.toFixed(0);
            
            const suffixes = ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi'];
            const magnitude = Math.floor(Math.log10(num) / 3);
            const suffix = suffixes[magnitude] || '';
            
            const scaled = num / Math.pow(1000, magnitude);
            const formatted = scaled >= 100 ? scaled.toFixed(0) : 
                              scaled >= 10 ? scaled.toFixed(1) : 
                              scaled.toFixed(2);
            
            return formatted + suffix;
        }

        // Format time in hours and minutes
        function formatTime(minutes) {
            if (minutes < 60) {
                return `${Math.floor(minutes)}m`;
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = Math.floor(minutes % 60);
                return `${hours}h ${mins}m`;
            }
        }

        // Format date to readable string
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        // Format time in minutes and seconds
        function formatTimeMinSec(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Check if it's a new day for resetting daily limits
        function checkNewDay() {
            const now = new Date();
            const today = now.toDateString();
            
            if (gameState.fellowCultivators.dayLastAdded !== today) {
                gameState.fellowCultivators.dayLastAdded = today;
                gameState.fellowCultivators.addedToday = 0;
                saveGameState();
            }
        }

        // Apply current theme to body
        function applyTheme() {
            document.body.className = '';
            document.body.classList.add(`theme-${gameState.settings.theme}`);
            document.body.classList.add(gameState.settings.darkMode ? 'dark' : 'light');
            
            // Update theme mode toggle label
            if (elements.themeModeLabel) {
                elements.themeModeLabel.textContent = gameState.settings.darkMode ? 'Dark' : 'Light';
            }
            
            // Update toggle state
            if (elements.themeModeToggle) {
                elements.themeModeToggle.checked = gameState.settings.darkMode;
            }
            
            // Update theme select
            if (elements.themeSelect) {
                elements.themeSelect.value = gameState.settings.theme;
            }
            
            // Update charts if they exist
            updateAnalyticsCharts();
        }

        // Calculate current idle cultivation rate (including fellow cultivator boosts)
        function getCurrentIdleRate() {
            const currentRealm = getCurrentRealm();
            const baseRate = 0.5; // qi/min
            const realmMultiplier = currentRealm.multiplier;
            
            // Check if fellow cultivator boost is active
            const now = Date.now();
            const boostMultiplier = now < gameState.fellowCultivators.boostEndTime ? 2 : 1;
            
            return baseRate * realmMultiplier * boostMultiplier;
        }

        // Update the UI for cultivation status
        function updateCultivationUI() {
            const currentRealm = getCurrentRealm();
            
            // Update realm and stage info
            elements.currentRealm.textContent = `${currentRealm.name} (${currentRealm.chineseName})`;
            elements.currentStage.textContent = gameState.player.stage;
            elements.maxStage.textContent = isFinite(currentRealm.stages) ? currentRealm.stages : '∞';
            
            // Update qi progress
            const qiRequired = getQiRequiredForBreakthrough();
            const progressPercentage = Math.min(100, (gameState.player.qi / qiRequired) * 100);
            elements.qiProgressBar.style.width = `${progressPercentage}%`;
            elements.currentQi.textContent = formatNumber(gameState.player.qi);
            elements.targetQi.textContent = formatNumber(qiRequired);
            
            // Get current idle rate with potential boost
            const idleRate = getCurrentIdleRate();
            const baseRate = 0.5; // qi/min
            
            // Update idle cultivation rate
            elements.baseRate.textContent = `${baseRate.toFixed(1)} qi/min`;
            elements.currentMultiplier.textContent = `×${currentRealm.multiplier.toFixed(1)}`;
            elements.effectiveRate.textContent = `${idleRate.toFixed(1)} qi/min`;
            elements.nextHourYield.textContent = formatNumber(idleRate * 60);
            
            // Check if fellow cultivator boost is active
            const now = Date.now();
            if (now < gameState.fellowCultivators.boostEndTime) {
                // Show boost indicator
                elements.fellowBoostContainer.classList.remove('hidden');
                
                // Calculate remaining time
                const remainingMinutes = (gameState.fellowCultivators.boostEndTime - now) / (60 * 1000);
                elements.boostTimeRemaining.textContent = formatTime(remainingMinutes);
            } else {
                // Hide boost indicator
                elements.fellowBoostContainer.classList.add('hidden');
            }
            
            // Check if pomodoro boost is active
            if (gameState.pomodoro.boostsRemaining > 0) {
                // Show boost indicator
                elements.pomodoroBoostContainer.classList.remove('hidden');
                elements.pomodoroBoostsRemaining.textContent = gameState.pomodoro.boostsRemaining;
            } else {
                // Hide boost indicator
                elements.pomodoroBoostContainer.classList.add('hidden');
            }
            
            // Update realm description
            elements.realmDescription.textContent = currentRealm.description;
            
            // Update breakthrough information
            elements.breakthroughQiRequired.textContent = formatNumber(qiRequired);
            
            const baseSuccessRate = getBaseSuccessRate();
            elements.baseSuccessRate.textContent = `${baseSuccessRate}%`;
            
            const finalSuccessRate = getTotalSuccessRate();
            elements.finalSuccessRate.textContent = `${finalSuccessRate}%`;
            
            // Update breakthrough button status
            if (gameState.player.qi >= qiRequired) {
                elements.attemptBreakthrough.disabled = false;
                elements.attemptBreakthrough.textContent = "Attempt Breakthrough";
                
                // Check if we should show breakthrough readiness notification
                checkBreakthroughReadiness();
            } else {
                elements.attemptBreakthrough.disabled = true;
                elements.attemptBreakthrough.textContent = `Attempt Breakthrough (Insufficient Qi)`;
            }
            
            // Update cultivator name
            elements.cultivatorName.textContent = gameState.player.name;

            // Update name change field in settings
            if (elements.settingsCultivatorName) {
                elements.settingsCultivatorName.placeholder = gameState.player.name;
                elements.settingsChangeName.disabled = gameState.stones.rename <= 0;
            }
            
            // Check if Fellow Cultivators tab should be unlocked
            if (gameState.player.realm >= 1 && elements.fcTabButton.classList.contains('disabled')) {
                elements.fcTabButton.classList.remove('disabled');
                gameState.player.fcTabUnlocked = true;
                
                // Check achievement for unlocking all tabs
                checkAchievement("misc_unlock_all_tabs");
                
                saveGameState();
            }
        }

        // Update the UI for spirit stones
        function updateStonesUI() {
            // Update stone counts in inventory
            for (const type in gameState.stones) {
                if (type === 'rename') {
                    elements.renameScrollCount.textContent = gameState.stones.rename + '/1';
                    elements.useRenameScroll.disabled = gameState.stones.rename <= 0;
                } else if (elements.stoneCounters[type]) {
                    elements.stoneCounters[type].textContent = gameState.stones[type];
                }
            }
            
            // Update stone fusion buttons
            elements.stoneButtons.forEach(button => {
                const stoneType = button.getAttribute('data-stone');
                if (gameState.stones[stoneType] >= 100) {
                    button.disabled = false;
                } else {
                    button.disabled = true;
                }
            });
            
            // Update selected stones display
            let selectedText = '';
            let hasSelectedStones = false;
            
            for (const [type, count] of Object.entries(gameState.selectedStones)) {
                if (count > 0) {
                    hasSelectedStones = true;
                    selectedText += `${count}× ${spiritStones[type].name}, `;
                }
            }
            
            if (hasSelectedStones) {
                elements.selectedStones.textContent = selectedText.slice(0, -2);
            } else {
                elements.selectedStones.textContent = 'None';
            }
            
            // Update success boost
            const boost = calculateSuccessBoost();
            elements.successBoost.textContent = `+${boost}%`;
            
            // Update stone count in UI
            const stoneElements = document.querySelectorAll('.spirit-stone');
            stoneElements.forEach(stoneEl => {
                const type = stoneEl.getAttribute('data-type');
                if (type) {
                    const countEl = stoneEl.querySelector('.stone-count');
                    if (countEl) {
                        countEl.textContent = gameState.stones[type] || 0;
                    }
                }
            });
        }

        // Update fellow cultivators UI
        function updateFellowCultivatorsUI() {
            // Check if it's a new day for resetting daily limits
            checkNewDay();
            
            // Update added today count
            elements.cultivatorsAddedToday.textContent = `Cultivators added today: ${gameState.fellowCultivators.addedToday}/5`;
            
            // Update boost status
            const now = Date.now();
            if (now < gameState.fellowCultivators.boostEndTime) {
                elements.fcNoBoost.classList.add('hidden');
                elements.fcActiveBoost.classList.remove('hidden');
                
                // Calculate remaining time
                const remainingMinutes = (gameState.fellowCultivators.boostEndTime - now) / (60 * 1000);
                elements.fcBoostTimeRemaining.textContent = formatTime(remainingMinutes);
            } else {
                elements.fcNoBoost.classList.remove('hidden');
                elements.fcActiveBoost.classList.add('hidden');
            }
            
            // Update last encounter
            if (gameState.fellowCultivators.lastEncounter) {
                elements.fcNoEncounters.classList.add('hidden');
                elements.fcLastEncounterDetails.classList.remove('hidden');
                elements.fcLastEncounterMessage.textContent = gameState.fellowCultivators.lastEncounter.message;
                elements.fcLastEncounterTime.textContent = formatDate(gameState.fellowCultivators.lastEncounter.timestamp);
            } else {
                elements.fcNoEncounters.classList.remove('hidden');
                elements.fcLastEncounterDetails.classList.add('hidden');
            }
            
            // Update cultivator pools
            renderCultivatorPools();
            
            // Update dropdowns
            updateCultivatorDropdowns();
            
            // Count cultivators
            const builtinCultivatorCount = gameState.fellowCultivators.pool.filter(c => !c.custom).length;
            const customCultivatorCount = gameState.fellowCultivators.pool.filter(c => c.custom).length;
            
            elements.builtinCultivatorCount.textContent = builtinCultivatorCount;
            elements.customCultivatorsCount.textContent = `${customCultivatorCount}/32`;
            
            // Add button disabled if at max for day or max total
            elements.addCultivator.disabled = 
                gameState.fellowCultivators.addedToday >= 5 || 
                customCultivatorCount >= 32;
            
            // Update "only meet custom" setting
            if (elements.onlyMeetCustomCultivators) {
                elements.onlyMeetCustomCultivators.checked = gameState.settings.onlyMeetCustomCultivators;
            }
        }

        // Render cultivator pools
        function renderCultivatorPools() {
            // Split cultivators into built-in and custom
            const builtinCultivators = gameState.fellowCultivators.pool.filter(c => !c.custom);
            const customCultivators = gameState.fellowCultivators.pool.filter(c => c.custom);
            
            // Update built-in cultivators
            if (builtinCultivators.length === 0) {
                elements.noBuiltinCultivatorsMessage.classList.remove('hidden');
                elements.builtinCultivatorPool.innerHTML = '';
            } else {
                elements.noBuiltinCultivatorsMessage.classList.add('hidden');
                elements.builtinCultivatorPool.innerHTML = '';
                
                // Sort by name
                const sortedBuiltin = [...builtinCultivators].sort((a, b) => 
                    a.name.localeCompare(b.name)
                );
                
                // Create cards for each cultivator
                sortedBuiltin.forEach(cultivator => {
                    const card = document.createElement('div');
                    card.className = 'fellow-cultivator-card';
                    card.dataset.id = cultivator.id;
                    
                    let lastEncounterText = '';
                    if (cultivator.encounters > 0) {
                        lastEncounterText = `<div>Encounters: ${cultivator.encounters}</div>`;
                    }
                    
                    card.innerHTML = `
                        <div class="fellow-cultivator-name">${cultivator.name}</div>
                        <div class="fellow-cultivator-meta">
                            <div>Built-in</div>
                            ${lastEncounterText}
                        </div>
                    `;
                    
                    elements.builtinCultivatorPool.appendChild(card);
                });
            }
            
            // Update custom cultivators
            if (customCultivators.length === 0) {
                elements.noCustomCultivatorsMessage.classList.remove('hidden');
                elements.customCultivatorPool.innerHTML = '';
            } else {
                elements.noCustomCultivatorsMessage.classList.add('hidden');
                elements.customCultivatorPool.innerHTML = '';
                
                // Sort by name
                const sortedCustom = [...customCultivators].sort((a, b) => 
                    a.name.localeCompare(b.name)
                );
                
                // Create cards for each cultivator
                sortedCustom.forEach(cultivator => {
                    const card = document.createElement('div');
                    card.className = 'fellow-cultivator-card';
                    card.dataset.id = cultivator.id;
                    
                    const now = Date.now();
                    const canEdit = now > cultivator.editCooldown;
                    
                    let editCooldownText = '';
                    if (!canEdit) {
                        const cooldownEnds = new Date(cultivator.editCooldown);
                        editCooldownText = `<div>Edit available: ${cooldownEnds.toLocaleDateString()}</div>`;
                    }
                    
                    let lastEncounterText = '';
                    if (cultivator.encounters > 0) {
                        lastEncounterText = `<div>Encounters: ${cultivator.encounters}</div>`;
                    }
                    
                    card.innerHTML = `
                        <div class="fellow-cultivator-name">${cultivator.name}</div>
                        <div class="fellow-cultivator-meta">
                            <div>Custom</div>
                            ${lastEncounterText}
                            ${editCooldownText}
                        </div>
                    `;
                    
                    elements.customCultivatorPool.appendChild(card);
                });
            }
        }

        // Update cultivator dropdowns
        function updateCultivatorDropdowns() {
            // Clear existing options
            elements.editCultivatorSelect.innerHTML = '<option value="">Select a cultivator</option>';
            elements.removeCultivatorSelect.innerHTML = '<option value="">Select a cultivator</option>';
            
            // Get custom cultivators
            const customCultivators = gameState.fellowCultivators.pool.filter(c => c.custom);
            
            // Sort by name
            const sortedCultivators = [...customCultivators].sort((a, b) => 
                a.name.localeCompare(b.name)
            );
            
            // Add options for each custom cultivator
            sortedCultivators.forEach(cultivator => {
                const now = Date.now();
                const canEdit = now > cultivator.editCooldown;
                
                // Edit dropdown - only add custom cultivators that can be edited
                if (canEdit) {
                    const editOption = document.createElement('option');
                    editOption.value = cultivator.id;
                    editOption.textContent = cultivator.name;
                    elements.editCultivatorSelect.appendChild(editOption);
                }
                
                // Remove dropdown - only add custom cultivators
                const removeOption = document.createElement('option');
                removeOption.value = cultivator.id;
                removeOption.textContent = cultivator.name;
                elements.removeCultivatorSelect.appendChild(removeOption);
            });
            
            // Hide edit form initially
            elements.editCultivatorForm.classList.add('hidden');
            elements.editCooldownInfo.classList.add('hidden');
            
            // Disable remove button initially
            elements.removeCultivator.disabled = true;
        }

        // Update pomodoro UI
        function updatePomodoroUI() {
            // Update timer display
            elements.timerDisplay.textContent = formatTimeMinSec(gameState.pomodoro.timeRemaining);
            
            // Update progress bar
            const totalTime = (gameState.pomodoro.isBreak ? gameState.pomodoro.breakDuration : gameState.pomodoro.focusDuration) * 60;
            const progress = ((totalTime - gameState.pomodoro.timeRemaining) / totalTime) * 100;
            elements.timerProgressBar.style.width = `${progress}%`;
            
            // Update break indicator
            if (gameState.pomodoro.isBreak) {
                elements.breakIndicator.classList.remove('hidden');
            } else {
                elements.breakIndicator.classList.add('hidden');
            }
            
            // Update timer controls
            elements.timerStart.disabled = gameState.pomodoro.isRunning && !gameState.pomodoro.isPaused;
	    elements.timerPause.disabled = !gameState.pomodoro.isRunning || gameState.pomodoro.isPaused;
            
            // Update duration sliders
            elements.focusDuration.value = gameState.pomodoro.focusDuration;
            elements.focusDurationDisplay.textContent = `${gameState.pomodoro.focusDuration} min`;
            
            elements.breakDuration.value = gameState.pomodoro.breakDuration;
            elements.breakDurationDisplay.textContent = `${gameState.pomodoro.breakDuration} min`;
            
            // Update use break toggle
            elements.useBreak.checked = gameState.pomodoro.useBreak;
            
            // Update boost info
            if (gameState.pomodoro.boostsRemaining > 0) {
                elements.activePomodoroBoost.classList.remove('hidden');
                elements.noPomodoroBoost.classList.add('hidden');
                elements.remainingBoostedTasks.textContent = gameState.pomodoro.boostsRemaining;
            } else {
                elements.activePomodoroBoost.classList.add('hidden');
                elements.noPomodoroBoost.classList.remove('hidden');
            }
            
            // Update session statistics
            elements.totalSessions.textContent = gameState.stats.pomodoroSessions;
            elements.totalFocusTime.textContent = gameState.stats.pomodoroTotalMinutes;
            elements.totalBoostsEarned.textContent = gameState.stats.pomodoroBoostsEarned;
            elements.totalBoostedTasks.textContent = gameState.stats.pomodoroTasksCompleted;
            
            // Update session history
            updatePomodoroSessionHistory();
        }

        // Update pomodoro session history
        function updatePomodoroSessionHistory() {
            if (!elements.sessionHistory) return;
            
            if (gameState.pomodoro.history.length === 0) {
                elements.sessionHistory.innerHTML = '<p class="text-center italic">No sessions completed yet</p>';
                return;
            }
            
            elements.sessionHistory.innerHTML = '';
            
            // Sort sessions by date (most recent first)
            const sortedSessions = [...gameState.pomodoro.history].reverse();
            
            // Show the last 10 sessions
            const recentSessions = sortedSessions.slice(0, 10);
            
            recentSessions.forEach(session => {
                const sessionEl = document.createElement('div');
                sessionEl.className = 'mb-3 p-2 border border-ancient-accent rounded';
                
                const date = new Date(session.endTime);
                const dateString = date.toLocaleDateString();
                const timeString = date.toLocaleTimeString();
                
                let boostText = '';
                if (session.duration >= 15) {
                    const boosts = session.duration >= 25 ? 10 : (session.duration >= 20 ? 8 : 5);
                    boostText = `<div class="text-sm font-bold text-right">Reward: ${boosts} boosted tasks</div>`;
                }
                
                sessionEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold">${session.duration} minute session</div>
                            <div class="text-sm">${dateString} at ${timeString}</div>
                        </div>
                        ${boostText}
                    </div>
                `;
                
                elements.sessionHistory.appendChild(sessionEl);
            });
            
            // Show count of earlier sessions if there are more
            if (sortedSessions.length > 10) {
                const earlierCount = sortedSessions.length - 10;
                const earlierEl = document.createElement('div');
                earlierEl.className = 'text-center italic mt-2';
                earlierEl.textContent = `... and ${earlierCount} earlier session${earlierCount > 1 ? 's' : ''}`;
                elements.sessionHistory.appendChild(earlierEl);
            }
        }

        // Update achievements UI
        function updateAchievementsUI(category = 'all') {
            if (!elements.achievementList) return;
            
            // Calculate total achievements and completion rate
            const totalAchievements = Object.keys(achievementData).length;
            const unlockedCount = Object.keys(gameState.achievements.unlocked).length;
            const completionRate = totalAchievements > 0 ? (unlockedCount / totalAchievements) * 100 : 0;
            
            // Update achievement summary
            elements.achievementTotalCount.textContent = `${unlockedCount}/${totalAchievements}`;
            elements.achievementPercent.textContent = `${completionRate.toFixed(1)}%`;
            
            // Find latest achievement
            if (gameState.achievements.lastUnlocked) {
                const lastAchievement = achievementData[gameState.achievements.lastUnlocked];
                elements.achievementLatest.textContent = lastAchievement ? lastAchievement.title : 'None';
            } else {
                elements.achievementLatest.textContent = 'None';
            }
            
            // Find rarest achievement (highest rarity that's unlocked)
            const rarityOrder = ['common', 'uncommon', 'rare', 'epic', 'legendary', 'mythic'];
            let rarestAchievement = null;
            
            for (let i = rarityOrder.length - 1; i >= 0; i--) {
                const rarity = rarityOrder[i];
                const matchingAchievement = Object.values(achievementData)
                    .find(a => a.rarity === rarity && gameState.achievements.unlocked[a.id]);
                
                if (matchingAchievement) {
                    rarestAchievement = matchingAchievement;
                    break;
                }
            }
            
            elements.achievementRarest.textContent = rarestAchievement ? rarestAchievement.title : 'None';
            
            // Update category tabs with counts
            document.querySelectorAll('.achievement-tab').forEach(tab => {
                const tabCategory = tab.getAttribute('data-category');
                const countSpan = tab.querySelector('.achievement-count');
                
                if (tabCategory === 'all') {
                    countSpan.textContent = unlockedCount;
                } else if (tabCategory === 'hidden') {
                    // Count undiscovered hidden achievements
                    const hiddenAchievements = Object.values(achievementData)
                        .filter(a => a.isHidden && !gameState.achievements.discoveredHidden.includes(a.id));
                    countSpan.textContent = hiddenAchievements.length;
                } else {
                    // Count achievements in this category
                    const categoryAchievements = Object.values(achievementData)
                        .filter(a => a.category === tabCategory);
                    const unlockedInCategory = categoryAchievements
                        .filter(a => gameState.achievements.unlocked[a.id])
                        .length;
                    countSpan.textContent = unlockedInCategory;
                }
            });
            
            // Clear achievement list
            elements.achievementList.innerHTML = '';
            
            // Get achievements to display based on selected category
            let achievementsToDisplay = [];
            
            if (category === 'all') {
                // All visible achievements and discovered hidden achievements
                achievementsToDisplay = Object.values(achievementData).filter(a => 
                    !a.isHidden || gameState.achievements.discoveredHidden.includes(a.id)
                );
            } else if (category === 'hidden') {
                // Only undiscovered hidden achievements (shown as ??? placeholders)
                achievementsToDisplay = Object.values(achievementData).filter(a => 
                    a.isHidden && !gameState.achievements.discoveredHidden.includes(a.id)
                );
            } else {
                // Filter by category, excluding undiscovered hidden
                achievementsToDisplay = Object.values(achievementData).filter(a => 
                    a.category === category && (!a.isHidden || gameState.achievements.discoveredHidden.includes(a.id))
                );
            }
            
            // If no achievements to display
            if (achievementsToDisplay.length === 0) {
                elements.achievementList.innerHTML = '<p class="text-center italic">No achievements found in this category</p>';
                return;
            }
            
            // Sort achievements: first unlocked, then by progress
            achievementsToDisplay.sort((a, b) => {
                // First sort by unlock status
                const aUnlocked = gameState.achievements.unlocked[a.id] ? 1 : 0;
                const bUnlocked = gameState.achievements.unlocked[b.id] ? 1 : 0;
                
                if (aUnlocked !== bUnlocked) {
                    return bUnlocked - aUnlocked; // Unlocked first
                }
                
                // Then sort by progress
                const aProgress = getAchievementProgress(a.id) / a.maxProgress;
                const bProgress = getAchievementProgress(b.id) / b.maxProgress;
                
                return bProgress - aProgress; // Higher progress first
            });
            
            // Render each achievement
            achievementsToDisplay.forEach(achievement => {
                renderAchievement(achievement);
            });
        }

        // Render a single achievement
        function renderAchievement(achievement) {
            const isUnlocked = gameState.achievements.unlocked[achievement.id];
            const isHidden = achievement.isHidden && !gameState.achievements.discoveredHidden.includes(achievement.id);
            
            const achievementEl = document.createElement('div');
            achievementEl.className = `achievement-card ${isUnlocked ? 'achievement-completed' : ''}`;
            
            // For hidden achievements that haven't been discovered
            if (isHidden) {
                achievementEl.innerHTML = `
                    <div class="achievement-icon achievement-hidden flex-shrink-0">
                        <i class="fas fa-question"></i>
                    </div>
                    <div class="achievement-content">
                        <div class="achievement-title">Hidden Achievement</div>
                        <div class="achievement-description">Continue your cultivation journey to discover this achievement.</div>
                        <div class="achievement-progress">
                            <div class="achievement-progress-bar achievement-hidden" style="width: 0%"></div>
                        </div>
                    </div>
                `;
                elements.achievementList.appendChild(achievementEl);
                return;
            }
            
            // Calculate progress
            const progress = getAchievementProgress(achievement.id);
            const progressPercent = Math.min(100, (progress / achievement.maxProgress) * 100);
            const progressText = `${formatNumber(progress)}/${formatNumber(achievement.maxProgress)}`;
            
            // Choose icon based on achievement status and category
            let icon = '';
            if (isUnlocked) {
                icon = '<i class="fas fa-check"></i>';
            } else {
                switch (achievement.category) {
                    case 'cultivation':
                        icon = '<i class="fas fa-mountain"></i>';
                        break;
                    case 'tasks':
                        icon = '<i class="fas fa-tasks"></i>';
                        break;
                    case 'stones':
                        icon = '<i class="fas fa-gem"></i>';
                        break;
                    case 'cultivators':
                        icon = '<i class="fas fa-user-friends"></i>';
                        break;
                    case 'pomodoro':
                        icon = '<i class="fas fa-stopwatch"></i>';
                        break;
                    case 'misc':
                        icon = '<i class="fas fa-star"></i>';
                        break;
                    default:
                        icon = '<i class="fas fa-trophy"></i>';
                }
            }
            
            achievementEl.innerHTML = `
                <div class="achievement-icon achievement-${achievement.rarity}">
                    ${icon}
                </div>
                <div class="achievement-content">
                    <div class="achievement-title">${achievement.title}</div>
                    <div class="achievement-description">${achievement.description}</div>
                    <div class="flex justify-between items-center text-xs mb-1">
                        <div>${progressText}</div>
                        <div>${isUnlocked ? 'Completed' : achievement.rarity.charAt(0).toUpperCase() + achievement.rarity.slice(1)}</div>
                    </div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar achievement-${achievement.rarity}" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
            `;
            
            elements.achievementList.appendChild(achievementEl);
        }

        // Get current progress for an achievement
        function getAchievementProgress(achievementId) {
            const achievement = achievementData[achievementId];
            if (!achievement) return 0;
            
            // If already unlocked, return max progress
            if (gameState.achievements.unlocked[achievementId]) {
                return achievement.maxProgress;
            }
            
            // Use stored progress value if it exists
            if (gameState.achievements.progress[achievementId] !== undefined) {
                return gameState.achievements.progress[achievementId];
            }
            
            // If achievement has a checkProgress function, use it
            if (achievement.checkProgress) {
                return achievement.checkProgress();
            }
            
            // For condition-based achievements, return 0 or max based on condition
            if (achievement.checkCondition) {
                return achievement.checkCondition() ? achievement.maxProgress : 0;
            }
            
            return 0;
        }

        // Check if an achievement should be unlocked
        function checkAchievement(achievementId) {
            const achievement = achievementData[achievementId];
            if (!achievement || gameState.achievements.unlocked[achievementId]) {
                return false; // Already unlocked or invalid ID
            }
            
            let progress = getAchievementProgress(achievementId);
            
            // For hidden achievements, check if they should be revealed
            if (achievement.isHidden && !gameState.achievements.discoveredHidden.includes(achievementId)) {
                const revealThreshold = achievement.revealThreshold || 0.2; // Default 20%
                if (progress >= achievement.maxProgress * revealThreshold) {
                    gameState.achievements.discoveredHidden.push(achievementId);
                    // No need to show a notification for just revealing
                }
            }
            
            // Check if the achievement is complete
            if (progress >= achievement.maxProgress) {
                // Unlock the achievement
                gameState.achievements.unlocked[achievementId] = {
                    date: Date.now()
                };
                gameState.achievements.lastUnlocked = achievementId;
                
                // Show notification
                if (gameState.notifications.settings.achievement) {
                    showAchievementUnlock(achievement);
                } else {
                    showToast(`Achievement Unlocked: ${achievement.title}`, "success");
                }
                
                // Check for "achieve X" achievements
                const totalAchievements = Object.keys(gameState.achievements.unlocked).length;
                if (totalAchievements >= 10) {
                    checkAchievement("misc_achieve_10");
                }
                if (totalAchievements >= 25) {
                    checkAchievement("misc_achieve_25");
                }
                if (totalAchievements >= 50) {
                    checkAchievement("misc_achieve_50");
                }
                
                // Save game state
                saveGameState();
                
                return true;
            }
            
            return false;
        }

        // Show achievement unlock notification
        function showAchievementUnlock(achievement) {
            // Show custom notification
            showNotification('achievement', "Achievement Unlocked", achievement.title);
            
            // Show achievement unlock modal
            elements.achievementUnlockIcon.className = `achievement-icon achievement-${achievement.rarity}`;
            
            // Choose icon based on category
            let iconClass = 'fas fa-trophy';
            switch (achievement.category) {
                case 'cultivation':
                    iconClass = 'fas fa-mountain';
                    break;
                case 'tasks':
                    iconClass = 'fas fa-tasks';
                    break;
                case 'stones':
                    iconClass = 'fas fa-gem';
                    break;
                case 'cultivators':
                    iconClass = 'fas fa-user-friends';
                    break;
                case 'pomodoro':
                    iconClass = 'fas fa-stopwatch';
                    break;
                case 'misc':
                    iconClass = 'fas fa-star';
                    break;
            }
            
            elements.achievementUnlockIcon.innerHTML = `<i class="${iconClass}"></i>`;
            elements.achievementUnlockTitle.textContent = achievement.title;
            elements.achievementUnlockDescription.textContent = achievement.description;
            
            // Show modal
            elements.achievementUnlockOverlay.classList.remove('hidden');
        }

        // Find most completed task
        function getMostCompletedTask() {
            if (gameState.tasks.length === 0) return 'None';
            
            let mostCompletedTask = null;
            let maxCompletions = -1;
            
            for (const task of gameState.tasks) {
                const completions = task.completionCount || 0;
                if (completions > maxCompletions) {
                    maxCompletions = completions;
                    mostCompletedTask = task;
                }
            }
            
            if (mostCompletedTask && maxCompletions > 0) {
                return `${mostCompletedTask.name} (${maxCompletions})`;
            }
            return 'None';
        }

        // Find most active tag
        function getMostActiveTag() {
            const tagCounts = {};
            
            // Count completions for each tag
            gameState.tasks.forEach(task => {
                const completions = task.completionCount || 0;
                if (completions > 0 && task.tags && task.tags.length > 0) {
                    task.tags.forEach(tag => {
                        if (!tagCounts[tag]) tagCounts[tag] = 0;
                        tagCounts[tag] += completions;
                    });
                }
            });
            
            // Find the tag with the most completions
            let mostActiveTag = null;
            let maxCompletions = -1;
            
            for (const [tag, count] of Object.entries(tagCounts)) {
                if (count > maxCompletions) {
                    maxCompletions = count;
                    mostActiveTag = tag;
                }
            }
            
            if (mostActiveTag && maxCompletions > 0) {
                return `${mostActiveTag} (${maxCompletions})`;
            }
            return 'None';
        }

        // Update the statistics UI
        function updateStatisticsUI() {
            // Task statistics
            elements.statTotalTasks.textContent = gameState.stats.totalTasks;
            elements.statCompletedTasks.textContent = gameState.stats.completedTasks;
            
            const avgQi = gameState.stats.completedTasks > 0 ? 
                (gameState.stats.totalQiEarned / gameState.stats.completedTasks).toFixed(1) : '0';
            elements.statAvgQi.textContent = avgQi;
            
            const totalStones = Object.values(gameState.stats.totalStonesFound).reduce((a, b) => a + b, 0);
            const avgStones = gameState.stats.completedTasks > 0 ? 
                (totalStones / gameState.stats.completedTasks).toFixed(2) : '0';
            elements.statAvgStones.textContent = avgStones;
            
            // Most completed task and most active tag
            elements.statMostCompletedTask.textContent = getMostCompletedTask();
            elements.statMostActiveTag.textContent = getMostActiveTag();
            
            // Breakthrough statistics
            elements.statBreakthroughs.textContent = gameState.stats.breakthroughs;
            elements.statFailedAttempts.textContent = gameState.stats.failedAttempts;
            
            const totalAttempts = gameState.stats.breakthroughs + gameState.stats.failedAttempts;
            const successRate = totalAttempts > 0 ? 
                ((gameState.stats.breakthroughs / totalAttempts) * 100).toFixed(1) : '0';
            elements.statSuccessRate.textContent = `${successRate}%`;
            
            elements.statHighestRealm.textContent = cultivationRealms[gameState.stats.highestRealmReached].name;
            
            // Total Qi and passive percentage
            elements.statTotalQi.textContent = formatNumber(gameState.stats.totalQiEarned);
            
            const totalQi = gameState.stats.totalQiEarned;
            const passiveQi = gameState.stats.totalQiPassive;
            const passivePercent = totalQi > 0 ? ((passiveQi / totalQi) * 100).toFixed(1) : '0';
            elements.statPassiveQi.textContent = `${passivePercent}%`;
            
            // Pomodoro stats
            elements.statPomodoroQi.textContent = formatNumber(gameState.stats.totalQiPomodoro);
            elements.statPomodoroBoostedTasks.textContent = gameState.stats.pomodoroTasksCompleted;
            
            // Spirit stone statistics
            elements.statBasicStones.textContent = gameState.stats.totalStonesFound.basic;
            elements.statLowStones.textContent = gameState.stats.totalStonesFound.low;
            elements.statMediumStones.textContent = gameState.stats.totalStonesFound.medium;
            elements.statHighStones.textContent = gameState.stats.totalStonesFound.high;
            elements.statSupremeStones.textContent = gameState.stats.totalStonesFound.supreme;
            elements.statDivineStones.textContent = gameState.stats.totalStonesFound.divine;
            
            // Fusion statistics
            elements.statBasicFused.textContent = gameState.stats.stonesFused.basic;
            elements.statLowFused.textContent = gameState.stats.stonesFused.low;
            elements.statMediumFused.textContent = gameState.stats.stonesFused.medium;
            elements.statHighFused.textContent = gameState.stats.stonesFused.high;
            elements.statSupremeFused.textContent = gameState.stats.stonesFused.supreme;
            
            // Special items statistics
            elements.statRenameScrolls.textContent = gameState.stats.totalStonesFound.rename;
            elements.statRenameScrollsUsed.textContent = gameState.stats.renameScrollsUsed;
            
            // Fellow Cultivator statistics
            elements.statCultivatorsMet.textContent = gameState.stats.cultivatorsMet;
            elements.statTotalBoostTime.textContent = (gameState.stats.totalBoostTime / 60).toFixed(1);
            elements.statQiFromBoosts.textContent = formatNumber(gameState.stats.qiFromBoosts);
            
            // Pomodoro statistics
            elements.statPomodoroSessions.textContent = gameState.stats.pomodoroSessions;
            elements.statFocusMinutes.textContent = gameState.stats.pomodoroTotalMinutes;
            elements.statBoostsEarned.textContent = gameState.stats.pomodoroBoostsEarned;
            
            // Achievement statistics
            const totalAchievements = Object.keys(achievementData).length;
            const unlockedCount = Object.keys(gameState.achievements.unlocked).length;
            const completionRate = totalAchievements > 0 ? (unlockedCount / totalAchievements) * 100 : 0;
            
            elements.statTotalAchievements.textContent = `${unlockedCount}/${totalAchievements}`;
            elements.statAchievementRate.textContent = `${completionRate.toFixed(1)}%`;
            
            // Hidden achievements
            const hiddenAchievements = Object.values(achievementData).filter(a => a.isHidden).length;
            const discoveredHidden = gameState.achievements.discoveredHidden.length;
            elements.statHiddenAchievements.textContent = `${discoveredHidden}/${hiddenAchievements}`;
        }

        // Update Analytics UI
        function updateAnalyticsUI() {
            // Update Qi Source Distribution
            const totalQi = gameState.stats.totalQiEarned;
            const passiveQi = gameState.stats.totalQiPassive;
            const activeQi = totalQi - passiveQi;
            
            const activePercent = totalQi > 0 ? ((activeQi / totalQi) * 100).toFixed(1) : '0';
            const passivePercent = totalQi > 0 ? ((passiveQi / totalQi) * 100).toFixed(1) : '0';
            
            elements.qiSourceActive.style.width = `${activePercent}%`;
            elements.qiSourcePassive.style.width = `${passivePercent}%`;
            elements.qiActivePercent.textContent = `${activePercent}%`;
            elements.qiPassivePercent.textContent = `${passivePercent}%`;
        }

        // Create or update analytics charts
        function updateAnalyticsCharts() {
            // Set chart defaults based on theme
            Chart.defaults.color = getComputedStyle(document.body).getPropertyValue('--chart-text');
            Chart.defaults.scale.grid.color = getComputedStyle(document.body).getPropertyValue('--chart-grid');
            
            // First update the basic analytics UI
            updateAnalyticsUI();
            
            // Helper to create a color gradient based on current theme
            function getThemeGradient(ctx, chartArea, color1, color2) {
                const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);
                return gradient;
            }
            
            // Get theme colors
            const accentColor = getComputedStyle(document.body).getPropertyValue('--ancient-accent');
            const qiColor = getComputedStyle(document.body).getPropertyValue('--qi-color');
            const mediumColor = getComputedStyle(document.body).getPropertyValue('--ancient-medium');
            
            // Create QI Efficiency Chart
            if (elements.qiEfficiencyChart) {
                // Get last 10 data points for efficiency
                const efficiencyData = gameState.analytics.qiEfficiency.slice(-10);
                
                // If the chart already exists, destroy it first
                if (charts.qiEfficiency) {
                    charts.qiEfficiency.destroy();
                }
                
                // Only create chart if we have data
                if (efficiencyData.length > 0) {
                    charts.qiEfficiency = new Chart(elements.qiEfficiencyChart, {
                        type: 'line',
                        data: {
                            labels: efficiencyData.map((_, index) => `Task Set ${index + 1}`),
                            datasets: [{
                                label: 'Qi/Task',
                                data: efficiencyData,
                                borderColor: qiColor,
                                backgroundColor: function(context) {
                                    const chart = context.chart;
                                    const {ctx, chartArea} = chart;
                                    if (!chartArea) return null;
                                    return getThemeGradient(ctx, chartArea, 'rgba(93, 92, 222, 0.1)', 'rgba(93, 92, 222, 0.4)');
                                },
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Qi Earned'
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Create Tasks By Tag Chart
            if (elements.tasksByTagChart) {
                // Collect tag data
                const tagCounts = {};
                gameState.tasks.forEach(task => {
                    const completions = task.completionCount || 0;
                    if (completions > 0 && task.tags && task.tags.length > 0) {
                        task.tags.forEach(tag => {
                            if (!tagCounts[tag]) tagCounts[tag] = 0;
                            tagCounts[tag] += completions;
                        });
                    }
                });
                
                // Sort tags by count
                const sortedTags = Object.entries(tagCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5); // Top 5 tags
                
                // If the chart already exists, destroy it first
                if (charts.tasksByTag) {
                    charts.tasksByTag.destroy();
                }
                
                // Only create chart if we have data
                if (sortedTags.length > 0) {
                    // Generate colors for each tag
                    const colors = [
                        accentColor,
                        qiColor,
                        mediumColor,
                        '#4CAF50',
                        '#9C27B0'
                    ];
                    
                    charts.tasksByTag = new Chart(elements.tasksByTagChart, {
                        type: 'pie',
                        data: {
                            labels: sortedTags.map(tag => tag[0]),
                            datasets: [{
                                data: sortedTags.map(tag => tag[1]),
                                backgroundColor: colors.slice(0, sortedTags.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                }
            }
            
            // Create Cultivation Journey Chart
            if (elements.cultivationJourneyChart) {
                // Include current state in journey
                const journeyData = [...gameState.analytics.realmHistory];
                
                // Add current state if not already included
                const now = Date.now();
                const currentState = {
                    timestamp: now,
                    realm: gameState.player.realm,
                    stage: gameState.player.stage
                };
                journeyData.push(currentState);
                
                // If the chart already exists, destroy it first
                if (charts.cultivationJourney) {
                    charts.cultivationJourney.destroy();
                }
                
                // Only create chart if we have data
                if (journeyData.length > 0) {
                    const labels = journeyData.map(data => {
                        const date = new Date(data.timestamp);
                        return date.toLocaleDateString();
                    });
                    
                    // Map the realm and stage to a combined value
                    const values = journeyData.map(data => 
                        data.realm + (data.stage / 10)
                    );
                    
                    charts.cultivationJourney = new Chart(elements.cultivationJourneyChart, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Cultivation Level',
                                data: values,
                                borderColor: qiColor,
                                backgroundColor: function(context) {
                                    const chart = context.chart;
                                    const {ctx, chartArea} = chart;
                                    if (!chartArea) return null;
                                    return getThemeGradient(ctx, chartArea, 'rgba(93, 92, 222, 0)', 'rgba(93, 92, 222, 0.3)');
                                },
                                tension: 0.3,
                                fill: true,
                                pointBackgroundColor: accentColor
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const index = context.dataIndex;
                                            const data = journeyData[index];
                                            const realmName = cultivationRealms[data.realm].name;
                                            return `${realmName}, Stage ${data.stage}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    ticks: {
                                        callback: function(value) {
                                            const realm = Math.floor(value);
                                            return cultivationRealms[realm]?.name || '';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Create Activity Heatmap Chart
            if (elements.activityHeatmapChart) {
                // If the chart already exists, destroy it first
                if (charts.activityHeatmap) {
                    charts.activityHeatmap.destroy();
                }
                
                // Get day of week data
                const dayLabels = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const activityData = gameState.stats.completionByDayOfWeek;
                
                charts.activityHeatmap = new Chart(elements.activityHeatmapChart, {
                    type: 'bar',
                    data: {
                        labels: dayLabels,
                        datasets: [{
                            label: 'Tasks Completed',
                            data: activityData,
                            backgroundColor: function(context) {
                                const chart = context.chart;
                                const {ctx, chartArea} = chart;
                                if (!chartArea) return null;
                                return getThemeGradient(ctx, chartArea, accentColor, qiColor);
                            },
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Tasks Completed'
                                }
                            }
                        }
                    }
                });
            }
            
            // Create Pomodoro Duration Chart
            if (elements.pomodoroDurationChart) {
                // If the chart already exists, destroy it first
                if (charts.pomodoroDuration) {
                    charts.pomodoroDuration.destroy();
                }
                
                // Get data from analytics
                const durationData = [
                    gameState.analytics.pomodoroByDuration[5] || 0,
                    gameState.analytics.pomodoroByDuration[10] || 0,
                    gameState.analytics.pomodoroByDuration[15] || 0,
                    gameState.analytics.pomodoroByDuration[20] || 0,
                    gameState.analytics.pomodoroByDuration[25] || 0
                ];
                
                const durationLabels = ['5 min', '10 min', '15 min', '20 min', '25 min'];
                
                charts.pomodoroDuration = new Chart(elements.pomodoroDurationChart, {
                    type: 'bar',
                    data: {
                        labels: durationLabels,
                        datasets: [{
                            label: 'Sessions Completed',
                            data: durationData,
                            backgroundColor: function(context) {
                                const value = context.raw;
                                const index = context.dataIndex;
                                
                                // Different colors based on whether the duration gives rewards
                                if (index >= 2) { // 15+ minutes
                                    return getComputedStyle(document.body).getPropertyValue('--qi-color');
                                } else {
                                    return getComputedStyle(document.body).getPropertyValue('--ancient-medium');
                                }
                            },
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Sessions'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Render task list
        function renderTaskList() {
            if (gameState.tasks.length === 0) {
                elements.taskList.innerHTML = '<p class="text-center italic">No tasks added yet</p>';
                elements.editSelectedTask.disabled = true;
                elements.deleteSelectedTasks.disabled = true;
                return;
            }
            
            // Sort tasks if needed
            const sortOption = elements.sortTasks.value;
            const sortedTasks = [...gameState.tasks];
            
            if (sortOption === 'name-asc') {
                sortedTasks.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortOption === 'name-desc') {
                sortedTasks.sort((a, b) => b.name.localeCompare(a.name));
            } else if (sortOption === 'tag-asc') {
                sortedTasks.sort((a, b) => (a.tags[0] || '').localeCompare(b.tags[0] || ''));
            } else if (sortOption === 'tag-desc') {
                sortedTasks.sort((a, b) => (b.tags[0] || '').localeCompare(a.tags[0] || ''));
            } else if (sortOption === 'completion-asc') {
                sortedTasks.sort((a, b) => (a.completionCount || 0) - (b.completionCount || 0));
            } else if (sortOption === 'completion-desc') {
                sortedTasks.sort((a, b) => (b.completionCount || 0) - (a.completionCount || 0));
            }
            
            // Build the task list HTML
            elements.taskList.innerHTML = '';
            
            sortedTasks.forEach((task, index) => {
                const taskEl = document.createElement('div');
                taskEl.className = 'mb-2 p-2 border border-ancient-accent rounded flex items-start';
                taskEl.dataset.id = task.id;
                
                // Task selection checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'custom-checkbox mr-2 mt-1';
                checkbox.dataset.id = task.id;
                
                // Task content
                const taskContent = document.createElement('div');
                taskContent.className = 'flex-grow';
                
                const taskName = document.createElement('div');
                taskName.className = 'font-bold';
                taskName.textContent = task.name;
                
                const taskTags = document.createElement('div');
                taskTags.className = 'flex flex-wrap mt-1';
                
                if (task.tags && task.tags.length > 0) {
                    task.tags.forEach(tag => {
                        if (tag.trim()) {
                            const tagBadge = document.createElement('span');
                            tagBadge.className = 'badge';
                            tagBadge.textContent = tag.trim();
                            taskTags.appendChild(tagBadge);
                        }
                    });
                }

                // Add completion count if it exists and is enabled in settings
                if (gameState.settings.showCompletionCount && task.completionCount && task.completionCount > 0) {
                    const completionCount = document.createElement('div');
                    completionCount.className = 'text-xs mt-1';
                    completionCount.textContent = `Completed ${task.completionCount} ${task.completionCount === 1 ? 'time' : 'times'}`;
                    
                    // Add last completion date if available
                    if (task.completionDates && task.completionDates.length > 0) {
                        const lastDate = new Date(task.completionDates[task.completionDates.length - 1]);
                        completionCount.textContent += ` (Last: ${lastDate.toLocaleDateString()})`;
                    }
                    
                    taskContent.appendChild(completionCount);
                }
                
                taskContent.appendChild(taskName);
                taskContent.appendChild(taskTags);
                
                taskEl.appendChild(checkbox);
                taskEl.appendChild(taskContent);
                
                elements.taskList.appendChild(taskEl);
            });
            
            // Handle checkbox selection for edit/delete buttons
            updateTaskSelectionStatus();
        }

        // Render generated tasks
        function renderGeneratedTasks() {
            if (gameState.generatedTasks.length === 0) {
                elements.generatedTasks.innerHTML = '<p class="text-center italic">No tasks generated yet</p>';
                elements.completeAllTasks.disabled = true;
                elements.giveUpTasks.disabled = true;
                return;
            }
            
            elements.generatedTasks.innerHTML = '';
            
            gameState.generatedTasks.forEach((task, index) => {
                const taskEl = document.createElement('div');
                
                // Check if task will receive pomodoro boost
                const hasPomodoroBoost = gameState.pomodoro.boostsRemaining > 0;
                taskEl.className = `mb-3 p-3 border border-ancient-accent rounded ${hasPomodoroBoost ? 'task-boosted' : ''}`;
                
                // Task header with name and reward
                const taskHeader = document.createElement('div');
                taskHeader.className = 'flex justify-between items-center mb-2';
                
                const taskName = document.createElement('div');
                taskName.className = 'font-bold';
                taskName.textContent = task.name;
                
                const taskReward = document.createElement('div');
                taskReward.className = 'text-sm';
                
                // Calculate reward with potential pomodoro boost
                const baseReward = task.reward;
                const boostMultiplier = hasPomodoroBoost ? 2 : 1;
                const finalReward = baseReward * boostMultiplier;
                
                if (hasPomodoroBoost) {
                    taskReward.innerHTML = `Reward: <span class="font-bold">${formatNumber(finalReward)} qi</span> <span class="text-xs">(2× boost)</span>`;
                } else {
                    taskReward.innerHTML = `Reward: <span class="font-bold">${formatNumber(finalReward)} qi</span>`;
                }
                
                taskHeader.appendChild(taskName);
                taskHeader.appendChild(taskReward);
                
                // Task tags
                const taskTags = document.createElement('div');
                taskTags.className = 'flex flex-wrap mb-2';
                
                if (task.tags && task.tags.length > 0) {
                    task.tags.forEach(tag => {
                        if (tag.trim()) {
                            const tagBadge = document.createElement('span');
                            tagBadge.className = 'badge';
                            tagBadge.textContent = tag.trim();
                            taskTags.appendChild(tagBadge);
                        }
                    });
                }
                
                // Task action buttons
                const taskActions = document.createElement('div');
                taskActions.className = 'flex justify-end space-x-2';
                
                const skipButton = document.createElement('button');
                skipButton.className = 'ancient-button text-sm';
                skipButton.textContent = 'Skip';
                skipButton.addEventListener('click', () => skipTask(index));
                
                const completeButton = document.createElement('button');
                completeButton.className = 'ancient-button text-sm';
                completeButton.textContent = 'Complete';
                completeButton.addEventListener('click', () => completeTask(index));
                
                taskActions.appendChild(skipButton);
                taskActions.appendChild(completeButton);
                
                // Assemble the task element
                taskEl.appendChild(taskHeader);
                taskEl.appendChild(taskTags);
                taskEl.appendChild(taskActions);
                
                elements.generatedTasks.appendChild(taskEl);
            });
            
            // Enable task action buttons
            elements.completeAllTasks.disabled = false;
            elements.giveUpTasks.disabled = false;
        }

        // Update task selection status
        function updateTaskSelectionStatus() {
            const checkboxes = elements.taskList.querySelectorAll('input[type="checkbox"]');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            if (selectedCount === 0) {
                elements.editSelectedTask.disabled = true;
                elements.deleteSelectedTasks.disabled = true;
            } else {
                elements.deleteSelectedTasks.disabled = false;
                elements.editSelectedTask.disabled = selectedCount !== 1;
            }
        }

        // Start pomodoro timer
        function startPomodoroTimer() {
            if (gameState.pomodoro.isRunning) return;
            
            gameState.pomodoro.isRunning = true;
            gameState.pomodoro.isPaused = false;
            
            // Set initial time based on focus or break
            if (!gameState.pomodoro.isBreak) {
                gameState.pomodoro.timeRemaining = gameState.pomodoro.focusDuration * 60;
                gameState.pomodoro.startTime = Date.now();
            } else {
                gameState.pomodoro.timeRemaining = gameState.pomodoro.breakDuration * 60;
                gameState.pomodoro.startTime = Date.now();
            }
            
            updatePomodoroUI();
            
            // Start the timer interval
            pomodoroTimerInterval = setInterval(updatePomodoroTimer, 1000);
        }

        // Pause pomodoro timer
        function pausePomodoroTimer() {
            if (!gameState.pomodoro.isRunning || gameState.pomodoro.isPaused) return;
            
            gameState.pomodoro.isPaused = true;
            gameState.pomodoro.pauseTime = Date.now();
            
            clearInterval(pomodoroTimerInterval);
            
            updatePomodoroUI();
        }

        // Resume pomodoro timer
        function resumePomodoroTimer() {
            if (!gameState.pomodoro.isRunning || !gameState.pomodoro.isPaused) return;
            
            gameState.pomodoro.isPaused = false;
            
            // Adjust start time to account for pause duration
            const pauseDuration = Date.now() - gameState.pomodoro.pauseTime;
            gameState.pomodoro.startTime += pauseDuration;
            
            pomodoroTimerInterval = setInterval(updatePomodoroTimer, 1000);
            
            updatePomodoroUI();
        }

        // Reset pomodoro timer
        function resetPomodoroTimer() {
            clearInterval(pomodoroTimerInterval);
            
            gameState.pomodoro.isRunning = false;
            gameState.pomodoro.isPaused = false;
            gameState.pomodoro.isBreak = false;
            gameState.pomodoro.timeRemaining = gameState.pomodoro.focusDuration * 60;
            gameState.pomodoro.startTime = null;
            gameState.pomodoro.endTime = null;
            gameState.pomodoro.pauseTime = null;
            
            updatePomodoroUI();
        }

        // Update pomodoro timer
        function updatePomodoroTimer() {
            if (!gameState.pomodoro.isRunning || gameState.pomodoro.isPaused) return;
            
            // Calculate remaining time
            const elapsedSeconds = Math.floor((Date.now() - gameState.pomodoro.startTime) / 1000);
            gameState.pomodoro.timeRemaining = Math.max(0, (gameState.pomodoro.isBreak ? gameState.pomodoro.breakDuration : gameState.pomodoro.focusDuration) * 60 - elapsedSeconds);
            
            // Update UI
            updatePomodoroUI();
            
            // Check if timer is finished
            if (gameState.pomodoro.timeRemaining <= 0) {
                completePomodoroSession();
            }
        }

        // Complete pomodoro session
        function completePomodoroSession() {
            clearInterval(pomodoroTimerInterval);
            
            if (!gameState.pomodoro.isBreak) {
                // Focus session completed
                const focusDuration = gameState.pomodoro.focusDuration;
                
                // Record session
                const session = {
                    duration: focusDuration,
                    startTime: gameState.pomodoro.startTime,
                    endTime: Date.now()
                };
                
                gameState.pomodoro.history.push(session);
                gameState.pomodoro.lastSessionTime = Date.now();
                
                // Update statistics
                gameState.stats.pomodoroSessions++;
                gameState.stats.pomodoroTotalMinutes += focusDuration;
                
                // Update analytics
                if (!gameState.analytics.pomodoroByDuration[focusDuration]) {
                    gameState.analytics.pomodoroByDuration[focusDuration] = 0;
                }
                gameState.analytics.pomodoroByDuration[focusDuration]++;
                
                // Award boosts based on duration
                let boostsAwarded = 0;
                if (focusDuration >= 25) {
                    boostsAwarded = 10;
                    checkAchievement("pomodoro_max_boost");
                } else if (focusDuration >= 20) {
                    boostsAwarded = 8;
                } else if (focusDuration >= 15) {
                    boostsAwarded = 5;
                }
                
                if (boostsAwarded > 0) {
                    gameState.pomodoro.boostsRemaining += boostsAwarded;
                    gameState.stats.pomodoroBoostsEarned += boostsAwarded;
                    
                    // Show notification
                    if (gameState.notifications.settings.pomodoro) {
                        showNotification('pomodoro', "Pomodoro Completed", `You earned ${boostsAwarded} task boosts!`);
                    } else {
                        showToast(`Pomodoro completed! You earned ${boostsAwarded} task boosts.`, "success");
                    }
                    
                    // Rerender task list with boosts
                    renderGeneratedTasks();
                } else {
                    showToast(`Pomodoro session completed! (${focusDuration} minutes)`, "success");
                }
                
                // Check achievements
                checkAchievement("pomodoro_first_session");
                checkAchievement("pomodoro_10_sessions");
                checkAchievement("pomodoro_50_sessions");
                checkAchievement("pomodoro_100_sessions");
                checkAchievement("pomodoro_10_hours");
                
                // Start break if enabled
                if (gameState.pomodoro.useBreak && gameState.pomodoro.breakDuration > 0) {
                    gameState.pomodoro.isBreak = true;
                    gameState.pomodoro.timeRemaining = gameState.pomodoro.breakDuration * 60;
                    gameState.pomodoro.startTime = Date.now();
                    
                    showToast("Break time started!", "info");
                    
                    // Start break timer
                    pomodoroTimerInterval = setInterval(updatePomodoroTimer, 1000);
                } else {
                    // Reset timer
                    gameState.pomodoro.isRunning = false;
                    gameState.pomodoro.timeRemaining = gameState.pomodoro.focusDuration * 60;
                }
            } else {
                // Break completed
                showToast("Break time finished!", "info");
                
                // Reset for next session
                gameState.pomodoro.isBreak = false;
                gameState.pomodoro.isRunning = false;
                gameState.pomodoro.timeRemaining = gameState.pomodoro.focusDuration * 60;
            }
            
            // Update UI
            updatePomodoroUI();
            updateCultivationUI(); // Show boost indicator
            
            // Save game state
            saveGameState();
        }

        // Generate random tasks
        function generateRandomTasks() {
            if (gameState.tasks.length === 0) {
                showToast("You need to add some tasks first", "error");
                return;
            }
            
            const count = parseInt(elements.taskCount.value) || 1;
            if (count < 1 || count > 10) {
                showToast("Please enter a number between 1 and 10", "error");
                return;
            }
            
            // Get filter tags if any
            const filterTags = elements.filterTags.value
                .split(',')
                .map(tag => tag.trim())
                .filter(tag => tag);
            
            // Filter tasks by tags if needed
            let eligibleTasks = [...gameState.tasks];
            
            if (filterTags.length > 0) {
                eligibleTasks = eligibleTasks.filter(task => {
                    return task.tags.some(tag => 
                        filterTags.some(filterTag => 
                            filterTag.toLowerCase() === tag.toLowerCase()
                        )
                    );
                });
                
                if (eligibleTasks.length === 0) {
                    showToast("No tasks match the selected tags", "error");
                    return;
                }
            }
            
            // Clear existing generated tasks
            gameState.generatedTasks = [];
            
            // Generate new random tasks
            for (let i = 0; i < count; i++) {
                if (eligibleTasks.length === 0) break;
                
                const randomIndex = Math.floor(Math.random() * eligibleTasks.length);
                const selectedTask = { ...eligibleTasks[randomIndex] };
                
                // Generate random reward based on realm
                const currentRealm = getCurrentRealm();
                const baseReward = currentRealm.baseQiRequirement / 10;
                const randomFactor = 0.8 + (Math.random() * 0.4); // 80% to 120%
                selectedTask.reward = Math.floor(baseReward * randomFactor);
                
                gameState.generatedTasks.push(selectedTask);
                
                // Remove task from eligible pool to prevent duplicates if there are enough tasks
                if (eligibleTasks.length > count - i - 1) {
                    eligibleTasks.splice(randomIndex, 1);
                }
            }
            
            renderGeneratedTasks();
            showToast(`Generated ${gameState.generatedTasks.length} tasks`, "success");
        }

        // Calculate qi penalty for skipping or giving up
        function calculateQiPenalty(taskCount = 1) {
            const qiRequired = getQiRequiredForBreakthrough();
            // Base penalty is 3-10% of breakthrough requirement, scaled by task count
            const basePercentage = 3 + Math.floor(Math.random() * 8); // 3-10%
            
            // Increase penalty based on number of tasks (1.5x for 2 tasks, 2x for 3 tasks, etc.)
            const scaleFactor = 1 + (taskCount - 1) * 0.5;
            const penaltyPercentage = Math.min(basePercentage * scaleFactor, 50); // Cap at 50%
            
            return {
                penalty: Math.floor(qiRequired * (penaltyPercentage / 100)),
                percentage: penaltyPercentage
            };
        }

        // Complete a task
        function completeTask(index) {
            const task = gameState.generatedTasks[index];
            
            // Check if pomodoro boost should be applied
            const hasPomodoroBoost = gameState.pomodoro.boostsRemaining > 0;
            const boostMultiplier = hasPomodoroBoost ? 2 : 1;
            
            // Calculate and award qi with potential boost
            const baseReward = task.reward;
            const finalReward = Math.floor(baseReward * boostMultiplier);
            
            gameState.player.qi += finalReward;
            gameState.stats.totalQiEarned += finalReward;
            
            // Track pomodoro boosted qi if applicable
            if (hasPomodoroBoost) {
                const bonusQi = finalReward - baseReward;
                gameState.stats.totalQiPomodoro += bonusQi;
                gameState.stats.pomodoroTasksCompleted++;
                gameState.pomodoro.boostsRemaining--;
                
                // Check for boost-related achievement
                if (gameState.generatedTasks.length > 1 && index === 0) {
                    // Mark that we're starting a batch with boost active
                    gameState.achievements.progress["pomodoro_boost_all"] = 1;
                } else if (gameState.achievements.progress["pomodoro_boost_all"] === 1 && 
                           index === gameState.generatedTasks.length - 1) {
                    // If we've completed all tasks with boost, unlock the achievement
                    checkAchievement("pomodoro_boost_all");
                }
            }
            
            // Possibly award spirit stones based on realm
            const stoneTypes = ['basic', 'low', 'medium', 'high', 'supreme', 'divine'];
            const maxStoneIndex = Math.min(Math.floor(gameState.player.realm / 2), stoneTypes.length - 1);
            
            let stoneMessage = '';
            
            // 40% chance to get a spirit stone
            if (Math.random() < 0.4) {
                // Determine which stone type to award
                // Higher chance for lower tier stones, small chance for higher tier
                let stoneIndex;
                const roll = Math.random();
                
                if (roll < 0.6) {
                    // 60% chance for lowest available stone
                    stoneIndex = 0;
                } else if (roll < 0.85) {
                    // 25% chance for second lowest available stone
                    stoneIndex = Math.min(1, maxStoneIndex);
                } else if (roll < 0.95) {
                    // 10% chance for third lowest available stone
                    stoneIndex = Math.min(2, maxStoneIndex);
                } else if (roll < 0.98) {
                    // 3% chance for fourth lowest available stone
                    stoneIndex = Math.min(3, maxStoneIndex);
                } else if (roll < 0.995) {
                    // 1.5% chance for fifth lowest available stone
                    stoneIndex = Math.min(4, maxStoneIndex);
                } else {
                    // 0.5% chance for highest available stone
                    stoneIndex = maxStoneIndex;
                }
                
                const stoneType = stoneTypes[stoneIndex];
                gameState.stones[stoneType]++;
                gameState.stats.totalStonesFound[stoneType]++;
                
                stoneMessage = ` and 1 ${spiritStones[stoneType].name}`;
                
                // Check stone-related achievements
                checkAchievement("stones_collect_first");
                checkAchievement("stones_collect_100");
                checkAchievement("stones_all_types");
                
                if (stoneType === 'divine') {
                    checkAchievement("stones_collect_divine");
                }
            }
            
            // 5% chance to get rename scroll if doesn't already have one
            if (Math.random() < 0.05 && gameState.stones.rename < spiritStones.rename.maxCount) {
                gameState.stones.rename++;
                gameState.stats.totalStonesFound.rename++;
                
                stoneMessage += stoneMessage ? ' plus 1 Rename Scroll!' : ' and 1 Rename Scroll!';
            }
            
            // Update stats
            gameState.stats.completedTasks++;
            
            // Update task completion count in the original task
            const originalTask = gameState.tasks.find(t => t.id === task.id);
            if (originalTask) {
                if (!originalTask.completionCount) {
                    originalTask.completionCount = 0;
                    originalTask.completionDates = [];
                }
                originalTask.completionCount++;
                
                const now = Date.now();
                originalTask.completionDates.push(now);
                
                // Update completion stats for analytics
                const dayOfWeek = new Date(now).getDay(); // 0 = Sunday, 6 = Saturday
                gameState.stats.completionByDayOfWeek[dayOfWeek]++;
                
                // Update tag statistics
                if (originalTask.tags && originalTask.tags.length > 0) {
                    originalTask.tags.forEach(tag => {
                        if (!gameState.stats.completionByTag[tag]) {
                            gameState.stats.completionByTag[tag] = 0;
                        }
                        gameState.stats.completionByTag[tag]++;
                    });
                }
                
                // Check for task completion achievements
                checkAchievement("tasks_complete_first");
                checkAchievement("tasks_complete_10");
                checkAchievement("tasks_complete_50");
                checkAchievement("tasks_complete_100");
                checkAchievement("tasks_complete_500");
                checkAchievement("tasks_complete_1000");
                checkAchievement("tasks_tag_specialist");
                checkAchievement("tasks_complete_same_10");
                
                // Check for daily task completion achievement
                // This would need to track tasks completed today
                // For now, we'll leave this for a future implementation
            }
            
            // Update QI efficiency for analytics
            gameState.analytics.qiEfficiency.push(finalReward);
            if (gameState.analytics.qiEfficiency.length > 30) {
                gameState.analytics.qiEfficiency.shift(); // Keep only last 30 entries
            }
            
            // Remove the task from generated list
            gameState.generatedTasks.splice(index, 1);
            
            // Update UI
            renderGeneratedTasks();
            renderTaskList();
            updateCultivationUI();
            updateStonesUI();
            updateStatisticsUI();
            
            // Show boost indicator in toast if applicable
            let boostText = hasPomodoroBoost ? ' (2× from pomodoro)' : '';
            showToast(`Completed: ${task.name}. Gained ${formatNumber(finalReward)} qi${boostText}${stoneMessage}`, "success");
            
            // Save game state
            saveGameState();
        }

        // Skip a task (with penalty now)
        function skipTask(index) {
            const task = gameState.generatedTasks[index];
            
            showModal(
                "Skip Task",
                `Are you sure you want to skip "${task.name}"? You will lose some qi as a penalty.`,
                () => {
                    // Calculate penalty
                    const { penalty, percentage } = calculateQiPenalty(1);
                    
                    // Apply penalty, but don't go below 0
                    gameState.player.qi = Math.max(0, gameState.player.qi - penalty);
                    
                    // Remove the task from generated list
                    gameState.generatedTasks.splice(index, 1);
                    
                    // Update UI
                    renderGeneratedTasks();
                    updateCultivationUI();
                    
                    showToast(`Skipped: ${task.name}. Lost ${formatNumber(penalty)} qi (${percentage.toFixed(1)}% penalty)`, "info");
                    
                    // Save game state
                    saveGameState();
                }
            );
        }

        // Complete all tasks
        function completeAllTasks() {
            if (gameState.generatedTasks.length === 0) {
                return;
            }
            
            let totalQi = 0;
            const stonesGained = {
                basic: 0,
                low: 0,
                medium: 0,
                high: 0,
                supreme: 0,
                divine: 0,
                rename: 0
            };
            
            // Process each task
            gameState.generatedTasks.forEach(task => {
                // Check if pomodoro boost should be applied
                const hasPomodoroBoost = gameState.pomodoro.boostsRemaining > 0;
                const boostMultiplier = hasPomodoroBoost ? 2 : 1;
                
                // Calculate and award qi with potential boost
                const baseReward = task.reward;
                const finalReward = Math.floor(baseReward * boostMultiplier);
                
                totalQi += finalReward;
                gameState.player.qi += finalReward;
                gameState.stats.totalQiEarned += finalReward;
                
                // Track pomodoro boosted qi if applicable
                if (hasPomodoroBoost) {
                    const bonusQi = finalReward - baseReward;
                    gameState.stats.totalQiPomodoro += bonusQi;
                    gameState.stats.pomodoroTasksCompleted++;
                    gameState.pomodoro.boostsRemaining--;
                    
                    // Check for boost-related achievement (completing all tasks with boost)
                    checkAchievement("pomodoro_boost_all");
                }
                
                // Update QI efficiency for analytics
                gameState.analytics.qiEfficiency.push(finalReward);
                if (gameState.analytics.qiEfficiency.length > 30) {
                    gameState.analytics.qiEfficiency.shift(); // Keep only last 30 entries
                }
                
                // Update task completion count in the original task
                const originalTask = gameState.tasks.find(t => t.id === task.id);
                if (originalTask) {
                    if (!originalTask.completionCount) {
                        originalTask.completionCount = 0;
                        originalTask.completionDates = [];
                    }
                    originalTask.completionCount++;
                    
                    const now = Date.now();
                    originalTask.completionDates.push(now);
                    
                    // Update completion stats for analytics
                    const dayOfWeek = new Date(now).getDay(); // 0 = Sunday, 6 = Saturday
                    gameState.stats.completionByDayOfWeek[dayOfWeek]++;
                    
                    // Update tag statistics
                    if (originalTask.tags && originalTask.tags.length > 0) {
                        originalTask.tags.forEach(tag => {
                            if (!gameState.stats.completionByTag[tag]) {
                                gameState.stats.completionByTag[tag] = 0;
                            }
                            gameState.stats.completionByTag[tag]++;
                        });
                    }
                }
                
                // Possibly award spirit stones based on realm
                const stoneTypes = ['basic', 'low', 'medium', 'high', 'supreme', 'divine'];
                const maxStoneIndex = Math.min(Math.floor(gameState.player.realm / 2), stoneTypes.length - 1);
                
                // 40% chance to get a spirit stone per task
                if (Math.random() < 0.4) {
                    // Determine which stone type to award
                    let stoneIndex;
                    const roll = Math.random();
                    
                    if (roll < 0.6) {
                        stoneIndex = 0;
                    } else if (roll < 0.85) {
                        stoneIndex = Math.min(1, maxStoneIndex);
                    } else if (roll < 0.95) {
                        stoneIndex = Math.min(2, maxStoneIndex);
                    } else if (roll < 0.98) {
                        stoneIndex = Math.min(3, maxStoneIndex);
                    } else if (roll < 0.995) {
                        stoneIndex = Math.min(4, maxStoneIndex);
                    } else {
                        stoneIndex = maxStoneIndex;
                    }
                    
                    const stoneType = stoneTypes[stoneIndex];
                    gameState.stones[stoneType]++;
                    gameState.stats.totalStonesFound[stoneType]++;
                    stonesGained[stoneType]++;
                }
                
                // 5% chance to get rename scroll if doesn't already have one
                if (Math.random() < 0.05 && gameState.stones.rename < spiritStones.rename.maxCount) {
                    gameState.stones.rename++;
                    gameState.stats.totalStonesFound.rename++;
                    stonesGained.rename++;
                }
                
                // Update task completion stat
                gameState.stats.completedTasks++;
            });
            
            // Check for task achievements
            checkAchievement("tasks_complete_first");
            checkAchievement("tasks_complete_10");
            checkAchievement("tasks_complete_50");
            checkAchievement("tasks_complete_100");
            checkAchievement("tasks_complete_500");
            checkAchievement("tasks_complete_1000");
            checkAchievement("tasks_tag_specialist");
            checkAchievement("tasks_complete_same_10");
            
            // Clear generated tasks
            const completedCount = gameState.generatedTasks.length;
            gameState.generatedTasks = [];
            
            // Update UI
            renderGeneratedTasks();
            renderTaskList();
            updateCultivationUI();
            updateStonesUI();
            updateStatisticsUI();
            
            // Build message about stones gained
            let stoneMessage = '';
            let anyStones = false;
            
            for (const [type, count] of Object.entries(stonesGained)) {
                if (count > 0) {
                    if (anyStones) {
                        stoneMessage += ', ';
                    } else {
                        stoneMessage = ' and ';
                        anyStones = true;
                    }
                    
                    const stoneName = type === 'rename' ? 'Rename Scroll' : spiritStones[type].name;
                    stoneMessage += `${count} ${stoneName}${count > 1 ? 's' : ''}`;
                }
            }
            
            // Check for pomodoro boost
            let boostText = gameState.stats.pomodoroTasksCompleted > 0 ? ' (with pomodoro boost)' : '';
            
            showToast(`Completed ${completedCount} tasks. Gained ${formatNumber(totalQi)} qi${boostText}${stoneMessage}`, "success");
            
            // Save game state
            saveGameState();
        }

        // Give up on generated tasks
        function giveUpTasks() {
            if (gameState.generatedTasks.length === 0) {
                return;
            }
            
            const taskCount = gameState.generatedTasks.length;
            
            showModal(
                "Give Up Tasks",
                `Are you sure you want to give up on all ${taskCount} generated tasks? You will lose some qi as a penalty.`,
                () => {
                    // Calculate penalty - increased for multiple tasks
                    const { penalty, percentage } = calculateQiPenalty(taskCount);
                    
                    // Apply penalty, but don't go below 0
                    gameState.player.qi = Math.max(0, gameState.player.qi - penalty);
                    
                    // Clear generated tasks
                    gameState.generatedTasks = [];
                    
                    // Update UI
                    renderGeneratedTasks();
                    updateCultivationUI();
                    
                    showToast(`Gave up on ${taskCount} tasks. Lost ${formatNumber(penalty)} qi (${percentage.toFixed(1)}% penalty)`, "info");
                    
                    // Save game state
                    saveGameState();
                }
            );
        }

        // Attempt breakthrough
        function attemptBreakthrough() {
            const qiRequired = getQiRequiredForBreakthrough();
            
            if (gameState.player.qi < qiRequired) {
                showToast("Insufficient qi for breakthrough", "error");
                return;
            }
            
            const successRate = getTotalSuccessRate();
            const roll = Math.random() * 100;
            const success = roll < successRate;
            
            // Use selected spirit stones
            for (const type in gameState.selectedStones) {
                gameState.stones[type] -= gameState.selectedStones[type];
                gameState.selectedStones[type] = 0;
            }
            
            // Consume qi for the attempt
            gameState.player.qi -= qiRequired;
            
            if (success) {
                // Successful breakthrough
                const oldRealm = gameState.player.realm;
                const oldStage = gameState.player.stage;
                
                gameState.player.stage++;
                gameState.stats.breakthroughs++;
                
                // Update breakthrough streak for achievement
                gameState.achievements.progress["cultivation_breakthrough_streak"] = 
                    (gameState.achievements.progress["cultivation_breakthrough_streak"] || 0) + 1;
                checkAchievement("cultivation_breakthrough_streak");
                
                // Check for perfect breakthrough achievement
                if (successRate === 99) {
                    checkAchievement("cultivation_perfect_breakthrough");
                }
                
                const currentRealm = getCurrentRealm();
                
                // Check if we need to advance to next realm
                if (gameState.player.stage > currentRealm.stages && gameState.player.realm < cultivationRealms.length - 1) {
                    gameState.player.realm++;
                    gameState.player.stage = 1;
                    
                    if (gameState.player.realm > gameState.stats.highestRealmReached) {
                        gameState.stats.highestRealmReached = gameState.player.realm;
                    }
                    
                    const newRealm = getCurrentRealm();
                    showToast(`Breakthrough success! Advanced to ${newRealm.name} (${newRealm.chineseName}) realm!`, "success");
                    
                    // Record realm advancement in analytics
                    gameState.analytics.realmHistory.push({
                        timestamp: Date.now(),
                        realm: gameState.player.realm,
                        stage: gameState.player.stage
                    });
                    
                    // Check if this is a new realm milestone for notifications
                    if (!gameState.player.reachedMilestones.realms.includes(gameState.player.realm)) {
                        showCultivationMilestoneNotification('realm', oldRealm, gameState.player.realm);
                        gameState.player.reachedMilestones.realms.push(gameState.player.realm);
                    }
                    
                    // Check realm achievements
                    checkRealmAchievements();
                    
                    // Check if Fellow Cultivators tab should be unlocked
                    if (gameState.player.realm >= 1 && elements.fcTabButton.classList.contains('disabled')) {
                        elements.fcTabButton.classList.remove('disabled');
                        gameState.player.fcTabUnlocked = true;
                        showToast("Fellow Cultivators feature unlocked!", "success");
                        
                        // Check achievement for unlocking all tabs
                        checkAchievement("misc_unlock_all_tabs");
                    }
                    
                } else {
                    showToast(`Breakthrough success! Advanced to stage ${gameState.player.stage}`, "success");
                    
                    // Record stage advancement in analytics
                    gameState.analytics.realmHistory.push({
                        timestamp: Date.now(),
                        realm: gameState.player.realm,
                        stage: gameState.player.stage
                    });
                    
                    // Check if this is a new stage milestone for notifications
                    if (!gameState.player.reachedMilestones.stages[gameState.player.realm] || 
                        !gameState.player.reachedMilestones.stages[gameState.player.realm].includes(gameState.player.stage)) {
                        
                        showCultivationMilestoneNotification('stage', oldStage, gameState.player.stage);
                        
                        // Initialize the array if it doesn't exist
                        if (!gameState.player.reachedMilestones.stages[gameState.player.realm]) {
                            gameState.player.reachedMilestones.stages[gameState.player.realm] = [];
                        }
                        
                        gameState.player.reachedMilestones.stages[gameState.player.realm].push(gameState.player.stage);
                    }
                }
            } else {
                // Failed breakthrough
                gameState.stats.failedAttempts++;
                
                // Reset breakthrough streak for achievement
                gameState.achievements.progress["cultivation_breakthrough_streak"] = 0;
                
                // Calculate qi loss (15-35% of current qi)
                const penaltyPercentage = 15 + Math.floor(Math.random() * 21); // 15-35%
                const penalty = Math.floor(gameState.player.qi * (penaltyPercentage / 100));
                
                gameState.player.qi = Math.max(0, gameState.player.qi - penalty);
                
                showToast(`Breakthrough failed! Lost ${formatNumber(penalty)} qi (${penaltyPercentage}% penalty)`, "error");
                
                // Check for fail at 99% achievement
                if (successRate === 99) {
                    checkAchievement("cultivation_fail_at_99");
                }
            }
            
            // Update UI
            updateCultivationUI();
            updateStonesUI();
            updateStatisticsUI();
            
            // Reset breakthrough check timestamp
            gameState.player.lastBreakthroughCheck = Date.now();
            
            // Save game state
            saveGameState();
        }

        // Check realm-related achievements
        function checkRealmAchievements() {
            const currentRealm = gameState.player.realm;
            
            // Check cultivation realm achievements
            if (currentRealm >= 1) checkAchievement("cultivation_reach_qi");
            if (currentRealm >= 2) checkAchievement("cultivation_reach_foundation");
            if (currentRealm >= 3) checkAchievement("cultivation_reach_core");
            if (currentRealm >= 4) checkAchievement("cultivation_reach_nascent");
            if (currentRealm >= 5) checkAchievement("cultivation_reach_transformation");
            if (currentRealm >= 6) checkAchievement("cultivation_reach_void");
            if (currentRealm >= 7) checkAchievement("cultivation_reach_integration");
            if (currentRealm >= 8) checkAchievement("cultivation_reach_mahayana");
            if (currentRealm >= 9) checkAchievement("cultivation_reach_immortal");
            if (currentRealm >= 10) checkAchievement("cultivation_reach_golden");
            if (currentRealm >= 11) checkAchievement("cultivation_reach_emperor");
            if (currentRealm >= 12) checkAchievement("cultivation_reach_sovereign");
            
            // Check qi millionaire achievement
            checkAchievement("cultivation_qi_millionaire");
        }

        // Fuse spirit stones
        function fuseStones(type) {
            if (gameState.stones[type] < 100) {
                showToast(`You need 100 ${spiritStones[type].name}s to fuse`, "error");
                return;
            }
            
            const nextTier = spiritStones[type].nextTier;
            if (!nextTier) {
                showToast(`${spiritStones[type].name}s are already the highest tier`, "error");
                return;
            }
            
            // Consume 100 lower tier stones
            gameState.stones[type] -= 100;
            
            // Create 1 higher tier stone
            gameState.stones[nextTier]++;
            
            // Update statistics
            gameState.stats.stonesFused[type]++;
            
            // Update UI
            updateStonesUI();
            updateStatisticsUI();
            
            showToast(`Successfully fused 100 ${spiritStones[type].name}s into 1 ${spiritStones[nextTier].name}`, "success");
            
            // Check achievement
            if (type === 'supreme') {
                checkAchievement("stones_fuse_divine");
            }
            
            // Save game state
            saveGameState();
        }

        // Use rename scroll
        function useRenameScroll() {
            if (gameState.stones.rename <= 0) {
                showToast("You don't have any Rename Scrolls", "error");
                return;
            }
            
            // Show name change modal
            elements.cultivatorNameInput.value = gameState.player.name;
            elements.renameWarning.classList.add('hidden');
            elements.nameChangeOverlay.classList.remove('hidden');
        }

        // Change name in settings
        function changeNameInSettings() {
            if (gameState.stones.rename <= 0) {
                showToast("You don't have any Rename Scrolls", "error");
                return;
            }
            
            const newName = elements.settingsCultivatorName.value.trim();
            
            if (!newName) {
                showToast("Please enter a valid name", "error");
                return;
            }
            
            // Set the new name
            gameState.player.name = newName;
            
            // Consume the rename scroll
            gameState.stones.rename--;
            gameState.stats.renameScrollsUsed++;
            
            // Update UI
            elements.cultivatorName.textContent = newName;
            elements.settingsCultivatorName.value = '';
            elements.settingsCultivatorName.placeholder = newName;
            updateStonesUI();
            updateStatisticsUI();
            
            // Check achievement
            checkAchievement("stones_rename_use");
            
            showToast(`Your cultivator name has been changed to ${newName}`, "success");
            
            // Save game state
            saveGameState();
        }

        // Confirm name change
        function confirmNameChange() {
            const newName = elements.cultivatorNameInput.value.trim();
            
            if (!newName) {
                showToast("Please enter a valid name", "error");
                return;
            }
            
            // Set the new name
            gameState.player.name = newName;
            
            // Check if this is a rename scroll usage (not initial setup)
            if (elements.renameWarning.classList.contains('hidden')) {
                // Consume the rename scroll
                gameState.stones.rename--;
                gameState.stats.renameScrollsUsed++;
                
                // Check achievement
                checkAchievement("stones_rename_use");
                
                // Update stats UI
                updateStonesUI();
                updateStatisticsUI();
            }
            
            // Update UI
            elements.cultivatorName.textContent = newName;
            elements.settingsCultivatorName.placeholder = newName;
            
            // Hide modal
            elements.nameChangeOverlay.classList.add('hidden');
            
            showToast(`Your cultivator name has been changed to ${newName}`, "success");
            
            // Save game state
            saveGameState();
        }

        // Add a fellow cultivator
        function addFellowCultivator() {
            // Check for daily limit
            checkNewDay();
            
            if (gameState.fellowCultivators.addedToday >= 5) {
                showToast("You've reached the daily limit of 5 new cultivators", "error");
                return;
            }
            
            // Check for total limit
            const customCultivatorCount = gameState.fellowCultivators.pool.filter(c => c.custom).length;
            if (customCultivatorCount >= 32) {
                showToast("Your cultivator pool is full (max 32 custom cultivators)", "error");
                return;
            }
            
            const name = elements.newCultivatorName.value.trim();
            if (!name) {
                showToast("Please enter a cultivator name", "error");
                return;
            }
            
            // Check for duplicate name
            if (gameState.fellowCultivators.pool.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                showToast("A cultivator with this name already exists", "error");
                return;
            }
            
            // Create new cultivator
            const newCultivator = {
                id: `fc-custom-${Date.now()}`,
                name: name,
                custom: true,
                editCooldown: 0,
                encounters: 0
            };
            
            // Add to pool
            gameState.fellowCultivators.pool.push(newCultivator);
            gameState.fellowCultivators.addedToday++;
            
            // Clear input
            elements.newCultivatorName.value = '';
            
            // Update UI
            updateFellowCultivatorsUI();
            
            // Check achievements
            checkAchievement("cultivators_add_custom");
            checkAchievement("cultivators_add_5_custom");
            checkAchievement("cultivators_fill_pool");
            
            showToast(`Added ${name} to your fellow cultivators`, "success");
            
            // Save game state
            saveGameState();
        }

        // Edit a fellow cultivator
        function editFellowCultivator() {
            const cultivatorId = elements.editCultivatorSelect.value;
            if (!cultivatorId) {
                showToast("Please select a cultivator to edit", "error");
                return;
            }
            
            const cultivator = gameState.fellowCultivators.pool.find(c => c.id === cultivatorId);
            if (!cultivator) {
                showToast("Cultivator not found", "error");
                return;
            }
            
            // Ensure it's a custom cultivator
            if (!cultivator.custom) {
                showToast("You can only edit custom cultivators", "error");
                return;
            }
            
            const now = Date.now();
            if (now < cultivator.editCooldown) {
                const cooldownEnds = new Date(cultivator.editCooldown);
                showToast(`This cultivator cannot be edited until ${cooldownEnds.toLocaleString()}`, "error");
                return;
            }
            
            // Show edit form and populate with current name
            elements.editCultivatorForm.classList.remove('hidden');
            elements.editCultivatorName.value = cultivator.name;
            
            // Hide cooldown info
            elements.editCooldownInfo.classList.add('hidden');
        }

        // Save cultivator edit
        function saveCultivatorEdit() {
            const cultivatorId = elements.editCultivatorSelect.value;
            if (!cultivatorId) {
                showToast("No cultivator selected", "error");
                return;
            }
            
            const newName = elements.editCultivatorName.value.trim();
            if (!newName) {
                showToast("Please enter a valid name", "error");
                return;
            }
            
            // Check for duplicate name (excluding current cultivator)
            if (gameState.fellowCultivators.pool.some(c => c.id !== cultivatorId && c.name.toLowerCase() === newName.toLowerCase())) {
                showToast("A cultivator with this name already exists", "error");
                return;
            }
            
            const cultivator = gameState.fellowCultivators.pool.find(c => c.id === cultivatorId);
            if (!cultivator) {
                showToast("Cultivator not found", "error");
                return;
            }
            
            // Ensure it's a custom cultivator
            if (!cultivator.custom) {
                showToast("You can only edit custom cultivators", "error");
                return;
            }
            
            // Update name
            cultivator.name = newName;
            
            // Set cooldown (48 hours)
            cultivator.editCooldown = Date.now() + (48 * 60 * 60 * 1000);
            
            // Hide edit form
            elements.editCultivatorForm.classList.add('hidden');
            
            // Update UI
            updateFellowCultivatorsUI();
            
            showToast(`Renamed cultivator to ${newName}. Can be edited again in 48 hours.`, "success");
            
            // Save game state
            saveGameState();
        }

        // Remove a fellow cultivator
        function removeFellowCultivator() {
            const cultivatorId = elements.removeCultivatorSelect.value;
            if (!cultivatorId) {
                showToast("Please select a cultivator to remove", "error");
                return;
            }
            
            const cultivator = gameState.fellowCultivators.pool.find(c => c.id === cultivatorId);
            if (!cultivator) {
                showToast("Cultivator not found", "error");
                return;
            }
            
            // Only allow removing custom cultivators
            if (!cultivator.custom) {
                showToast("Cannot remove default cultivators", "error");
                return;
            }
            
            // Show confirmation modal
            showModal(
                "Remove Cultivator",
                `Are you sure you want to remove ${cultivator.name} from your fellow cultivators?`,
                () => {
                    // Remove from pool
                    gameState.fellowCultivators.pool = gameState.fellowCultivators.pool.filter(c => c.id !== cultivatorId);
                    
                    // Update UI
                    updateFellowCultivatorsUI();
                    
                    showToast(`Removed ${cultivator.name} from your fellow cultivators`, "success");
                    
                    // Save game state
                    saveGameState();
                }
            );
        }

        // Meet a fellow cultivator
        function meetFellowCultivator(offlineMinutes) {
            // Check if Fellow Cultivators is unlocked
            if (!gameState.player.fcTabUnlocked && gameState.player.realm < 1) {
                return false;
            }
            
            // Calculate chance based on time away
            let meetChance = 0;
            if (offlineMinutes >= 60) {
                meetChance = 0.3; // 30% chance if away for 60+ minutes
            } else if (offlineMinutes >= 30) {
                meetChance = 0.2; // 20% chance if away for 30-59 minutes
            } else if (offlineMinutes >= 10) {
                meetChance = 0.1; // 10% chance if away for 10-29 minutes
            } else {
                return false; // No chance if away for less than 10 minutes
            }
            
            // Roll for meeting
            if (Math.random() >= meetChance) {
                return false;
            }
            
            // Create a list of eligible cultivators
            let eligibleCultivators = [];
            
            if (gameState.settings.onlyMeetCustomCultivators) {
                // Only include custom cultivators
                eligibleCultivators = gameState.fellowCultivators.pool.filter(c => c.custom);
                
                // If there are no custom cultivators, can't meet anyone
                if (eligibleCultivators.length === 0) {
                    return false;
                }
            } else {
                // Include all cultivators
                eligibleCultivators = gameState.fellowCultivators.pool;
            }
            
            // Select random cultivator
            const randomIndex = Math.floor(Math.random() * eligibleCultivators.length);
            const cultivator = eligibleCultivators[randomIndex];
            
            // Update encounter count
            cultivator.encounters++;
            
            // Calculate boost duration (60-120 minutes)
            const boostMinutes = 60 + Math.floor(Math.random() * 61);
            const now = Date.now();
            
            // Add boost duration to current boost end time, but cap at 10 hours max
            const currentBoostRemainingMs = Math.max(0, gameState.fellowCultivators.boostEndTime - now);
            const currentBoostRemainingMinutes = currentBoostRemainingMs / (60 * 1000);
            const newTotalBoostMinutes = Math.min(600, currentBoostRemainingMinutes + boostMinutes); // Cap at 10 hours (600 minutes)
            
            // Check if we're reaching max boost time
            const reachingMaxBoost = newTotalBoostMinutes === 600 && currentBoostRemainingMinutes < 600;
            
            // Set new boost end time
            gameState.fellowCultivators.boostEndTime = now + (newTotalBoostMinutes * 60 * 1000);
            
            // Update stats
            gameState.stats.cultivatorsMet++;
            gameState.stats.totalBoostTime += boostMinutes;
            
            // Track boost qi gains (will be updated in update function)
            const basePassiveRate = 0.5 * getCurrentRealm().multiplier; // qi/min
            const extraQiFromBoost = basePassiveRate * boostMinutes; // Extra qi from doubled rate
            gameState.stats.qiFromBoosts += extraQiFromBoost;
            
            // Generate message based on previous encounters
            let messageTemplate;
            if (cultivator.encounters <= 1) {
                // First meeting
                messageTemplate = fellowCultivatorMessages.firstMeeting[Math.floor(Math.random() * fellowCultivatorMessages.firstMeeting.length)];
            } else {
                // Repeat meeting
                messageTemplate = fellowCultivatorMessages.repeatMeeting[Math.floor(Math.random() * fellowCultivatorMessages.repeatMeeting.length)];
            }
            
            // Replace placeholder with cultivator name
            const message = messageTemplate.replace('[name]', cultivator.name);
            
            // Create encounter record
            const encounter = {
                cultivatorId: cultivator.id,
                cultivatorName: cultivator.name,
                timestamp: now,
                boostMinutes: boostMinutes,
                message: message
            };
            
            // Store last encounter
            gameState.fellowCultivators.lastEncounter = encounter;
            gameState.fellowCultivators.lastMeetingTime = now;
            
            // Add to meetings history (limited to last 10)
            gameState.fellowCultivators.meetings.unshift(encounter);
            if (gameState.fellowCultivators.meetings.length > 10) {
                gameState.fellowCultivators.meetings.pop();
            }
            
            // Check for achievements
            checkAchievement("cultivators_first_meeting");
            checkAchievement("cultivators_meet_10");
            checkAchievement("cultivators_boost_24h");
            checkAchievement("cultivators_meet_same_5");
            
            // Check for max boost achievement
            if (reachingMaxBoost) {
                checkAchievement("cultivators_max_boost");
            }
            
            // Show notification
            showFellowCultivatorNotification(encounter);
            
            return encounter;
        }

        // Show a toast notification
        function showToast(message, type = "info") {
            const toast = document.createElement('div');
            toast.className = 'mb-2 p-3 rounded shadow-lg fade-in max-w-xs';
            
            // Set toast style based on type
            if (type === "success") {
                toast.classList.add('bg-green-500', 'text-white');
            } else if (type === "error") {
                toast.classList.add('bg-red-500', 'text-white');
            } else if (type === "info") {
                toast.classList.add('bg-blue-500', 'text-white');
            } else if (type === "warning") {
                toast.classList.add('bg-yellow-500', 'text-white');
            }
            
            toast.textContent = message;
            
            elements.toastContainer.appendChild(toast);
            
            // Remove toast after a delay
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (elements.toastContainer.contains(toast)) {
                        elements.toastContainer.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Show a custom notification
        function showNotification(type, title, message) {
            // Check if notifications for this type are enabled
            if (type === 'breakthroughReadiness' && !gameState.notifications.settings.breakthroughReadiness) {
                return;
            } else if (type === 'idleRewards' && !gameState.notifications.settings.idleRewards) {
                return;
            } else if (type === 'cultivationMilestones' && !gameState.notifications.settings.cultivationMilestones) {
                return;
            } else if (type === 'fellowCultivator' && !gameState.notifications.settings.fellowCultivator) {
                return;
            } else if (type === 'achievement' && !gameState.notifications.settings.achievement) {
                return;
            } else if (type === 'pomodoro' && !gameState.notifications.settings.pomodoro) {
                return;
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ancient-border rounded-lg p-4 notification-type-${type}`;
            notification.setAttribute('data-type', type);
            
            // Create content
            let iconClass = '';
            switch (type) {
                case 'breakthroughReadiness':
                    iconClass = 'fas fa-level-up-alt';
                    break;
                case 'idleRewards':
                    iconClass = 'fas fa-hourglass-half';
                    break;
                case 'cultivationMilestones':
                    iconClass = 'fas fa-trophy';
                    break;
                case 'fellowCultivator':
                    iconClass = 'fas fa-user-friends';
                    break;
                case 'achievement':
                    iconClass = 'fas fa-award';
                    break;
                case 'pomodoro':
                    iconClass = 'fas fa-stopwatch';
                    break;
                default:
                    iconClass = 'fas fa-bell';
            }
            
            const content = `
                <div class="flex items-start">
                    <div class="notification-icon">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="notification-header">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close text-white opacity-75 hover:opacity-100">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="notification-progress"></div>
            `;
            
            notification.innerHTML = content;
            
            // Add to container
            elements.notificationContainer.appendChild(notification);
            
            // Set up auto-close timer
            const autoCloseTimeout = setTimeout(() => {
                closeNotification(notification);
            }, 5000);
            
            // Set up manual close button
            const closeButton = notification.querySelector('.notification-close');
            closeButton.addEventListener('click', () => {
                clearTimeout(autoCloseTimeout);
                closeNotification(notification);
            });
            
            // Store notification data if needed
            gameState.notifications.history.push({
                type,
                title,
                message,
                timestamp: Date.now()
            });
            
            // Keep history manageable
            if (gameState.notifications.history.length > 20) {
                gameState.notifications.history.shift();
            }
            
            return notification;
        }

        // Close a notification with animation
        function closeNotification(notification) {
            notification.classList.add('closing');
            setTimeout(() => {
                if (elements.notificationContainer.contains(notification)) {
                    elements.notificationContainer.removeChild(notification);
                }
            }, 400);
        }

        // Show a modal
        function showModal(title, message, confirmCallback) {
            elements.modalHeader.textContent = title;
            elements.modalBody.textContent = message;
            elements.modalOverlay.classList.remove('hidden');
            
            // Set up event handlers
            const handleConfirm = () => {
                elements.modalOverlay.classList.add('hidden');
                elements.modalConfirm.removeEventListener('click', handleConfirm);
                elements.modalCancel.removeEventListener('click', handleCancel);
                confirmCallback();
            };
            
            const handleCancel = () => {
                elements.modalOverlay.classList.add('hidden');
                elements.modalConfirm.removeEventListener('click', handleConfirm);
                elements.modalCancel.removeEventListener('click', handleCancel);
            };
            
            elements.modalConfirm.addEventListener('click', handleConfirm);
            elements.modalCancel.addEventListener('click', handleCancel);
        }

        // Show edit task modal
        function showEditTaskModal(taskId) {
            const task = gameState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            elements.modalHeader.textContent = "Edit Task";
            
            // Create form for editing
            const form = document.createElement('div');
            
            const nameLabel = document.createElement('label');
            nameLabel.className = 'block mb-1';
            nameLabel.textContent = 'Task Name:';
            
            const nameInput = document.createElement('input');
            nameInput.className = 'ancient-input w-full mb-2';
            nameInput.value = task.name;
            
            const tagsLabel = document.createElement('label');
            tagsLabel.className = 'block mb-1';
            tagsLabel.textContent = 'Tags (comma separated):';
            
            const tagsInput = document.createElement('input');
            tagsInput.className = 'ancient-input w-full';
            tagsInput.value = task.tags.join(', ');
            
            form.appendChild(nameLabel);
            form.appendChild(nameInput);
            form.appendChild(tagsLabel);
            form.appendChild(tagsInput);
            
            elements.modalBody.innerHTML = '';
            elements.modalBody.appendChild(form);
            
            elements.modalOverlay.classList.remove('hidden');
            
            // Set up event handlers
            const handleConfirm = () => {
                const newName = nameInput.value.trim();
                const newTags = tagsInput.value
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag);
                
                if (newName) {
                    // Update task
                    task.name = newName;
                    task.tags = newTags;
                    
                    // Update UI
                    renderTaskList();
                    
                    showToast("Task updated successfully", "success");
                    saveGameState();
                } else {
                    showToast("Task name cannot be empty", "error");
                }
                
                elements.modalOverlay.classList.add('hidden');
                elements.modalConfirm.removeEventListener('click', handleConfirm);
                elements.modalCancel.removeEventListener('click', handleCancel);
            };
            
            const handleCancel = () => {
                elements.modalOverlay.classList.add('hidden');
                elements.modalConfirm.removeEventListener('click', handleConfirm);
                elements.modalCancel.removeEventListener('click', handleCancel);
            };
            
            elements.modalConfirm.addEventListener('click', handleConfirm);
            elements.modalCancel.addEventListener('click', handleCancel);
        }

        // Show tutorial
        let currentTutorialPage = 0;

        function showTutorial() {
            currentTutorialPage = 0;
            updateTutorialContent();
            elements.tutorialOverlay.classList.remove('hidden');
        }

        function updateTutorialContent() {
            const tutorial = tutorialContent[currentTutorialPage];
            elements.tutorialBody.innerHTML = tutorial.content;
            document.querySelector('#tutorial-content .cultivation-banner').textContent = tutorial.title;
            elements.tutorialPage.textContent = `${currentTutorialPage + 1}/${tutorialContent.length}`;
            
            // Update button states
            elements.tutorialPrev.disabled = currentTutorialPage === 0;
            elements.tutorialNext.textContent = currentTutorialPage === tutorialContent.length - 1 ? 'Finish' : 'Next';
        }

        function nextTutorialPage() {
            if (currentTutorialPage < tutorialContent.length - 1) {
                currentTutorialPage++;
                updateTutorialContent();
            } else {
                elements.tutorialOverlay.classList.add('hidden');
            }
        }

        function prevTutorialPage() {
            if (currentTutorialPage > 0) {
                currentTutorialPage--;
                updateTutorialContent();
            }
        }

        function skipTutorial() {
            elements.tutorialOverlay.classList.add('hidden');
        }

        // Check for breakthrough readiness
        function checkBreakthroughReadiness() {
            const now = Date.now();
            // Only check if we haven't checked in the last 10 minutes
            if (now - gameState.player.lastBreakthroughCheck < 10 * 60 * 1000) {
                return;
            }
            
            const qiRequired = getQiRequiredForBreakthrough();
            if (gameState.player.qi >= qiRequired) {
                const currentRealm = getCurrentRealm();
                const title = "Breakthrough Ready";
                let message = `You have accumulated enough qi to attempt a breakthrough to stage ${gameState.player.stage + 1}`;
                
                // Check if this would advance to next realm
                if (gameState.player.stage >= currentRealm.stages) {
                    const nextRealm = getNextRealm();
                    if (nextRealm) {
                        message = `You have accumulated enough qi to advance to the ${nextRealm.name} realm!`;
                    }
                }
                
                showNotification('breakthroughReadiness', title, message);
                gameState.player.lastBreakthroughCheck = now;
            }
        }

        // Show idle rewards notification
        function showIdleRewardsNotification(qiGained) {
            const title = "Idle Cultivation Results";
            let message = `You gained ${formatNumber(qiGained)} qi while away.`;
            
            showNotification('idleRewards', title, message);
        }

        // Show cultivation milestone notification
        function showCultivationMilestoneNotification(type, oldValue, newValue) {
            let title = "Cultivation Milestone";
            let message = "";
            
            if (type === 'realm') {
                const oldRealm = cultivationRealms[oldValue];
                const newRealm = cultivationRealms[newValue];
                title = "Realm Advancement";
                message = `You have broken through to the ${newRealm.name} (${newRealm.chineseName}) realm!`;
            } else if (type === 'stage') {
                const currentRealm = getCurrentRealm();
                title = "Stage Advancement";
                message = `You have advanced to stage ${newValue} of the ${currentRealm.name} realm!`;
            }
            
            showNotification('cultivationMilestones', title, message);
        }

        // Show fellow cultivator notification
        function showFellowCultivatorNotification(encounter) {
            const title = "Fellow Cultivator Encountered";
            const message = `${encounter.message} [Congrats! Your idle cultivation rate is doubled for the next ${formatTime(encounter.boostMinutes)}!]`;
            
            showNotification('fellowCultivator', title, message);
        }

        // Save and load game state
        function saveGameState() {
            try {
                localStorage.setItem('cultivationTaskManager', JSON.stringify(gameState));
                return true;
            } catch (error) {
                console.error('Failed to save game state:', error);
                return false;
            }
        }

        function loadGameState() {
            try {
                const savedState = localStorage.getItem('cultivationTaskManager');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    
                    // Ensure reachedMilestones exists
                    if (!parsedState.player.reachedMilestones) {
                        parsedState.player.reachedMilestones = {
                            realms: [parsedState.player.realm],
                            stages: {}
                        };
                    }
                    
                    // Ensure notification settings exist
                    if (!parsedState.notifications) {
                        parsedState.notifications = {
                            settings: {
                                breakthroughReadiness: true,
                                idleRewards: true,
                                cultivationMilestones: true,
                                fellowCultivator: true,
                                achievement: true,
                                pomodoro: true
                            },
                            history: []
                        };
                    }
                    
                    // Add completion count to tasks if not present
                    if (parsedState.tasks) {
                        parsedState.tasks.forEach(task => {
                            if (!task.completionCount) {
                                task.completionCount = 0;
                                task.completionDates = [];
                            }
                        });
                    }
                    
                    // Ensure settings object exists
                    if (!parsedState.settings) {
                        parsedState.settings = {
                            theme: 'default',
                            darkMode: false,
                            showCompletionCount: true,
                            onlyMeetCustomCultivators: false,
                            useScientificNotation: false,
                            scientificNotationThreshold: 1000000
                        };
                    }
                    
                    // Ensure analytics object exists
                    if (!parsedState.analytics) {
                        parsedState.analytics = {
                            qiEfficiency: [],
                            realmHistory: [],
                            lastAnalyticsUpdate: Date.now(),
                            pomodoroByDuration: {
                                5: 0,
                                10: 0,
                                15: 0,
                                20: 0,
                                25: 0
                            }
                        };
                    }
                    
                    // Ensure pomodoro object exists
                    if (!parsedState.pomodoro) {
                        parsedState.pomodoro = {
                            focusDuration: 25,  // in minutes
                            breakDuration: 5,   // in minutes
                            useBreak: true,
                            isRunning: false,
                            isPaused: false,
                            isBreak: false,
                            timeRemaining: 25 * 60, // in seconds
                            startTime: null,
                            endTime: null,
                            pauseTime: null,
                            boostsRemaining: 0,
                            lastSessionTime: null,
                            history: []  // Array of session objects
                        };
                    }
                    
                    // Ensure achievements object exists
                    if (!parsedState.achievements) {
                        parsedState.achievements = {
                            unlocked: {},
                            progress: {},
                            lastUnlocked: null,
                            discoveredHidden: []
                        };
                    }
                    
                    // Ensure rename scroll in stones
                    if (!parsedState.stones.rename) {
                        parsedState.stones.rename = 0;
                    }
                    
                    // Ensure rename scroll in totalStonesFound
                    if (!parsedState.stats.totalStonesFound.rename) {
                        parsedState.stats.totalStonesFound.rename = 0;
                    }
                    
                    // Ensure renameScrollsUsed exists
                    if (!parsedState.stats.renameScrollsUsed) {
                        parsedState.stats.renameScrollsUsed = 0;
                    }
                    
                    // Ensure totalQiPassive exists
                    if (!parsedState.stats.totalQiPassive) {
                        parsedState.stats.totalQiPassive = 0;
                    }
                    
                    // Ensure totalQiPomodoro exists
                    if (!parsedState.stats.totalQiPomodoro) {
                        parsedState.stats.totalQiPomodoro = 0;
                    }
                    
                    // Ensure completionByTag exists
                    if (!parsedState.stats.completionByTag) {
                        parsedState.stats.completionByTag = {};
                    }
                    
                    // Ensure completionByDayOfWeek exists
                    if (!parsedState.stats.completionByDayOfWeek) {
                        parsedState.stats.completionByDayOfWeek = [0, 0, 0, 0, 0, 0, 0];
                    }
                    
                    // Ensure fellowCultivators object exists
                    if (!parsedState.fellowCultivators) {
                        parsedState.fellowCultivators = {
                            pool: [...initialFellowCultivators],
                            meetings: [],
                            boostEndTime: 0,
                            lastMeetingTime: 0,
                            lastEncounter: null,
                            addedToday: 0,
                            dayLastAdded: null
                        };
                    }
                    
                    // Ensure fellowCultivator notification setting exists
                    if (parsedState.notifications && !parsedState.notifications.settings.hasOwnProperty('fellowCultivator')) {
                        parsedState.notifications.settings.fellowCultivator = true;
                    }
                    
                    // Ensure achievement notification setting exists
                    if (parsedState.notifications && !parsedState.notifications.settings.hasOwnProperty('achievement')) {
                        parsedState.notifications.settings.achievement = true;
                    }
                    
                    // Ensure pomodoro notification setting exists
                    if (parsedState.notifications && !parsedState.notifications.settings.hasOwnProperty('pomodoro')) {
                        parsedState.notifications.settings.pomodoro = true;
                    }
                    
                    // Ensure fellow cultivator stats exist
                    if (!parsedState.stats.cultivatorsMet) {
                        parsedState.stats.cultivatorsMet = 0;
                    }
                    if (!parsedState.stats.totalBoostTime) {
                        parsedState.stats.totalBoostTime = 0;
                    }
                    if (!parsedState.stats.qiFromBoosts) {
                        parsedState.stats.qiFromBoosts = 0;
                    }
                    
                    // Ensure pomodoro stats exist
                    if (!parsedState.stats.pomodoroSessions) {
                        parsedState.stats.pomodoroSessions = 0;
                    }
                    if (!parsedState.stats.pomodoroTotalMinutes) {
                        parsedState.stats.pomodoroTotalMinutes = 0;
                    }
                    if (!parsedState.stats.pomodoroBoostsEarned) {
                        parsedState.stats.pomodoroBoostsEarned = 0;
                    }
                    if (!parsedState.stats.pomodoroTasksCompleted) {
                        parsedState.stats.pomodoroTasksCompleted = 0;
                    }
                    
                    // Ensure scientific notation settings exist
                    if (!parsedState.settings.hasOwnProperty('useScientificNotation')) {
                        parsedState.settings.useScientificNotation = false;
                    }
                    if (!parsedState.settings.hasOwnProperty('scientificNotationThreshold')) {
                        parsedState.settings.scientificNotationThreshold = 1000000;
                    }
                    
                    // Ensure onlyMeetCustomCultivators setting exists
                    if (!parsedState.settings.hasOwnProperty('onlyMeetCustomCultivators')) {
                        parsedState.settings.onlyMeetCustomCultivators = false;
                    }
                    
                    // Ensure fcTabUnlockClicks and fcTabUnlocked exist
                    if (!parsedState.player.hasOwnProperty('fcTabUnlockClicks')) {
                        parsedState.player.fcTabUnlockClicks = 0;
                    }
                    if (!parsedState.player.hasOwnProperty('fcTabUnlocked')) {
                        parsedState.player.fcTabUnlocked = parsedState.player.realm >= 1;
                    }
                    
                    // Ensure pomodoroByDuration exists
                    if (!parsedState.analytics.pomodoroByDuration) {
                        parsedState.analytics.pomodoroByDuration = {
                            5: 0,
                            10: 0,
                            15: 0,
                            20: 0,
                            25: 0
                        };
                    }
                    
                    // Merge the saved state with the default state
                    // This ensures new properties added in updates are included
                    Object.assign(gameState, parsedState);
                    
                    // Ensure initial fellow cultivators are in the pool
                    if (gameState.fellowCultivators.pool.length === 0) {
                        gameState.fellowCultivators.pool = [...initialFellowCultivators];
                    } else {
                        // Make sure the default cultivators are present
                        const existingIds = gameState.fellowCultivators.pool.map(c => c.id);
                        const missingDefaults = initialFellowCultivators.filter(c => !existingIds.includes(c.id));
                        
                        if (missingDefaults.length > 0) {
                            gameState.fellowCultivators.pool = [...gameState.fellowCultivators.pool, ...missingDefaults];
                        }
                    }
                    
                    // Update version
                    gameState.version = '1.4';
                    
                    // Apply theme settings
                    applyTheme();
                    
                    // Set completion count toggle
                    if (elements.showCompletionCount) {
                        elements.showCompletionCount.checked = gameState.settings.showCompletionCount;
                    }
                    
                    // Set notification toggles
                    if (elements.notificationBreakthrough) {
                        elements.notificationBreakthrough.checked = gameState.notifications.settings.breakthroughReadiness;
                    }
                    if (elements.notificationIdle) {
                        elements.notificationIdle.checked = gameState.notifications.settings.idleRewards;
                    }
                    if (elements.notificationMilestone) {
                        elements.notificationMilestone.checked = gameState.notifications.settings.cultivationMilestones;
                    }
                    if (elements.notificationFellowCultivator) {
                        elements.notificationFellowCultivator.checked = gameState.notifications.settings.fellowCultivator;
                    }
                    if (elements.notificationAchievement) {
                        elements.notificationAchievement.checked = gameState.notifications.settings.achievement;
                    }
                    if (elements.notificationPomodoro) {
                        elements.notificationPomodoro.checked = gameState.notifications.settings.pomodoro;
                    }
                    
                    // Set scientific notation settings
                    if (elements.useScientificNotation) {
                        elements.useScientificNotation.checked = gameState.settings.useScientificNotation;
                    }
                    if (elements.scientificNotationThreshold) {
                        elements.scientificNotationThreshold.value = gameState.settings.scientificNotationThreshold;
                    }
                    
                    // Set onlyMeetCustomCultivators toggle
                    if (elements.onlyMeetCustomCultivators) {
                        elements.onlyMeetCustomCultivators.checked = gameState.settings.onlyMeetCustomCultivators;
                    }
                    
                    // Check if Fellow Cultivators tab should be unlocked
                    if ((gameState.player.realm >= 1 || gameState.player.fcTabUnlocked) && elements.fcTabButton) {
                        elements.fcTabButton.classList.remove('disabled');
                    }
                    
                    // Update the UI
                    updateCultivationUI();
                    updateStonesUI();
                    updateStatisticsUI();
                    renderTaskList();
                    renderGeneratedTasks();
                    updatePomodoroUI();
                    
                    // Calculate idle gains since last update
                    const now = Date.now();
                    const elapsedMinutes = (now - gameState.player.lastUpdated) / (1000 * 60);
                    
                    if (elapsedMinutes > 1) { // Only show for at least 1 minute away
                        const currentRealm = getCurrentRealm();
                        
                        // Check if there's a chance to meet a fellow cultivator
                        let fellowCultivatorMet = null;
                        if (elapsedMinutes >= 10) {
                            fellowCultivatorMet = meetFellowCultivator(elapsedMinutes);
                        }
                        
                        // Calculate qi gain with potential boost
                        // Since the boost would start now, we calculate regular idle gains for time away
                        const baseRate = 0.5 * currentRealm.multiplier; // qi/min
                        const idleGain = Math.floor(elapsedMinutes * baseRate);
                        
                        if (idleGain > 0) {
                            gameState.player.qi += idleGain;
                            gameState.player.lastUpdated = now;
                            
                            // Track passive qi gains
                            gameState.stats.totalQiEarned += idleGain;
                            gameState.stats.totalQiPassive += idleGain;
                            
                            // Show idle rewards notification if it's significant
                            if (idleGain > currentRealm.baseQiRequirement * 0.01) { // 1% of breakthrough requirement
                                if (!fellowCultivatorMet) {
                                    showIdleRewardsNotification(idleGain);
                                }
                            } else {
                                if (!fellowCultivatorMet) {
                                    showToast(`Welcome back! You gained ${formatNumber(idleGain)} qi while away.`, "info");
                                }
                            }
                            
                            updateCultivationUI();
                            saveGameState();
                        }
                    }
                    
                    // If it's been more than a day since analytics update, record current state
                    if ((now - gameState.analytics.lastAnalyticsUpdate) > (24 * 60 * 60 * 1000)) {
                        gameState.analytics.realmHistory.push({
                            timestamp: now,
                            realm: gameState.player.realm,
                            stage: gameState.player.stage
                        });
                        
                        gameState.analytics.lastAnalyticsUpdate = now;
                        saveGameState();
                    }
                    
                    // Check for new achievements
                    checkRealmAchievements();
                    checkAchievement("misc_first_day");
                    
                } else {
                    // First time running the app
                    
                    // Initialize fellow cultivators
                    gameState.fellowCultivators.pool = [...initialFellowCultivators];
                    
                    // Initialize achievements
                    checkAchievement("misc_first_day");
                    
                    // Show name selection
                    setTimeout(() => {
                        elements.nameChangeOverlay.classList.remove('hidden');
                        
                        // Remove the rename scroll consumption for first-time setup
                        const originalConfirm = elements.nameChangeConfirm.onclick;
                        elements.nameChangeConfirm.onclick = () => {
                            const newName = elements.cultivatorNameInput.value.trim();
                            
                            if (!newName) {
                                showToast("Please enter a valid name", "error");
                                return;
                            }
                            
                            // Set the new name
                            gameState.player.name = newName;
                            
                            // Update UI
                            elements.cultivatorName.textContent = newName;
                            
                            // Hide modal
                            elements.nameChangeOverlay.classList.add('hidden');
                            
                            // Show tutorial after name is set
                            setTimeout(showTutorial, 500);
                            
                            // Save game state
                            saveGameState();
                            
                            // Restore original onclick
                            elements.nameChangeConfirm.onclick = originalConfirm;
                        };
                    }, 500);
                }
            } catch (error) {
                console.error('Failed to load game state:', error);
                showToast("Error loading saved data. Starting fresh.", "error");
                
                // Initialize fellow cultivators
                gameState.fellowCultivators.pool = [...initialFellowCultivators];
                
                // Show name selection for new user
                setTimeout(() => {
                    elements.nameChangeOverlay.classList.remove('hidden');
                    
                    // Remove the rename scroll consumption for first-time setup
                    const originalConfirm = elements.nameChangeConfirm.onclick;
                    elements.nameChangeConfirm.onclick = () => {
                        const newName = elements.cultivatorNameInput.value.trim();
                        
                        if (!newName) {
                            showToast("Please enter a valid name", "error");
                            return;
                        }
                        
                        // Set the new name
                        gameState.player.name = newName;
                        
                        // Update UI
                        elements.cultivatorName.textContent = newName;
                        
                        // Hide modal
                        elements.nameChangeOverlay.classList.add('hidden');
                        
                        // Show tutorial after name is set
                        setTimeout(showTutorial, 500);
                        
                        // Save game state
                        saveGameState();
                        
                        // Restore original onclick
                        elements.nameChangeConfirm.onclick = originalConfirm;
                    };
                }, 500);
            }
        }

        // Manual save
        function manualSave() {
            if (saveGameState()) {
                showToast("Game data saved successfully", "success");
                
                // Check for export achievement
                checkAchievement("misc_export_data");
            } else {
                showToast("Failed to save game data", "error");
            }
        }

        // Export game state
        function exportGameState() {
            try {
                const exportData = btoa(JSON.stringify(gameState));
                elements.importData.value = exportData;
                showToast("Game data exported to the text area below", "success");
                
                // Check for export achievement
                checkAchievement("misc_export_data");
            } catch (error) {
                console.error('Failed to export game state:', error);
                showToast("Failed to export game data", "error");
            }
        }

        // Import game state
        function importGameState() {
            try {
                const importData = elements.importData.value.trim();
                if (!importData) {
                    showToast("Please paste exported game data first", "error");
                    return;
                }
                
                const parsedState = JSON.parse(atob(importData));
                
                // Verify this is valid game data
                if (!parsedState.version || !parsedState.player) {
                    showToast("Invalid game data format", "error");
                    return;
                }
                
                showModal(
                    "Import Game Data",
                    "Are you sure you want to import this game data? Your current progress will be overwritten.",
                    () => {
                        // Ensure reachedMilestones exists
                        if (!parsedState.player.reachedMilestones) {
                            parsedState.player.reachedMilestones = {
                                realms: [parsedState.player.realm],
                                stages: {}
                            };
                        }
                        
                        // Ensure notification settings exist
                        if (!parsedState.notifications) {
                            parsedState.notifications = {
                                settings: {
                                    breakthroughReadiness: true,
                                    idleRewards: true,
                                    cultivationMilestones: true,
                                    fellowCultivator: true,
                                    achievement: true,
                                    pomodoro: true
                                },
                                history: []
                            };
                        }
                        
                        // Add completion count to tasks if not present
                        if (parsedState.tasks) {
                            parsedState.tasks.forEach(task => {
                                if (!task.completionCount) {
                                    task.completionCount = 0;
                                    task.completionDates = [];
                                }
                            });
                        }
                        
                        // Ensure settings object exists
                        if (!parsedState.settings) {
                            parsedState.settings = {
                                theme: 'default',
                                darkMode: false,
                                showCompletionCount: true,
                                onlyMeetCustomCultivators: false,
                                useScientificNotation: false,
                                scientificNotationThreshold: 1000000
                            };
                        }
                        
                        // Ensure analytics object exists
                        if (!parsedState.analytics) {
                            parsedState.analytics = {
                                qiEfficiency: [],
                                realmHistory: [],
                                lastAnalyticsUpdate: Date.now(),
                                pomodoroByDuration: {
                                    5: 0,
                                    10: 0,
                                    15: 0,
                                    20: 0,
                                    25: 0
                                }
                            };
                        }
                        
                        // Ensure pomodoro object exists
                        if (!parsedState.pomodoro) {
                            parsedState.pomodoro = {
                                focusDuration: 25,  // in minutes
                                breakDuration: 5,   // in minutes
                                useBreak: true,
                                isRunning: false,
                                isPaused: false,
                                isBreak: false,
                                timeRemaining: 25 * 60, // in seconds
                                startTime: null,
                                endTime: null,
                                pauseTime: null,
                                boostsRemaining: 0,
                                lastSessionTime: null,
                                history: []  // Array of session objects
                            };
                        }
                        
                        // Ensure achievements object exists
                        if (!parsedState.achievements) {
                            parsedState.achievements = {
                                unlocked: {},
                                progress: {},
                                lastUnlocked: null,
                                discoveredHidden: []
                            };
                        }
                        
                        // Ensure rename scroll in stones
                        if (!parsedState.stones.rename) {
                            parsedState.stones.rename = 0;
                        }
                        
                        // Ensure rename scroll in totalStonesFound
                        if (!parsedState.stats.totalStonesFound.rename) {
                            parsedState.stats.totalStonesFound.rename = 0;
                        }
                        
                        // Ensure renameScrollsUsed exists
                        if (!parsedState.stats.renameScrollsUsed) {
                            parsedState.stats.renameScrollsUsed = 0;
                        }
                        
                        // Ensure totalQiPassive exists
                        if (!parsedState.stats.totalQiPassive) {
                            parsedState.stats.totalQiPassive = 0;
                        }
                        
                        // Ensure totalQiPomodoro exists
                        if (!parsedState.stats.totalQiPomodoro) {
                            parsedState.stats.totalQiPomodoro = 0;
                        }
                        
                        // Ensure completionByTag exists
                        if (!parsedState.stats.completionByTag) {
                            parsedState.stats.completionByTag = {};
                        }
                        
                        // Ensure completionByDayOfWeek exists
                        if (!parsedState.stats.completionByDayOfWeek) {
                            parsedState.stats.completionByDayOfWeek = [0, 0, 0, 0, 0, 0, 0];
                        }
                        
                        // Ensure fellowCultivators object exists
                        if (!parsedState.fellowCultivators) {
                            parsedState.fellowCultivators = {
                                pool: [...initialFellowCultivators],
                                meetings: [],
                                boostEndTime: 0,
                                lastMeetingTime: 0,
                                lastEncounter: null,
                                addedToday: 0,
                                dayLastAdded: null
                            };
                        }
                        
                        // Ensure fellow cultivator stats exist
                        if (!parsedState.stats.cultivatorsMet) {
                            parsedState.stats.cultivatorsMet = 0;
                        }
                        if (!parsedState.stats.totalBoostTime) {
                            parsedState.stats.totalBoostTime = 0;
                        }
                        if (!parsedState.stats.qiFromBoosts) {
                            parsedState.stats.qiFromBoosts = 0;
                        }
                        
                        // Ensure pomodoro stats exist
                        if (!parsedState.stats.pomodoroSessions) {
                            parsedState.stats.pomodoroSessions = 0;
                        }
                        if (!parsedState.stats.pomodoroTotalMinutes) {
                            parsedState.stats.pomodoroTotalMinutes = 0;
                        }
                        if (!parsedState.stats.pomodoroBoostsEarned) {
                            parsedState.stats.pomodoroBoostsEarned = 0;
                        }
                        if (!parsedState.stats.pomodoroTasksCompleted) {
                            parsedState.stats.pomodoroTasksCompleted = 0;
                        }
                        
                        // Ensure pomodoroByDuration exists
                        if (!parsedState.analytics.pomodoroByDuration) {
                            parsedState.analytics.pomodoroByDuration = {
                                5: 0,
                                10: 0,
                                15: 0,
                                20: 0,
                                25: 0
                            };
                        }
                        
                        // Ensure scientific notation settings exist
                        if (!parsedState.settings.hasOwnProperty('useScientificNotation')) {
                            parsedState.settings.useScientificNotation = false;
                        }
                        if (!parsedState.settings.hasOwnProperty('scientificNotationThreshold')) {
                            parsedState.settings.scientificNotationThreshold = 1000000;
                        }
                        
                        // Ensure onlyMeetCustomCultivators setting exists
                        if (!parsedState.settings.hasOwnProperty('onlyMeetCustomCultivators')) {
                            parsedState.settings.onlyMeetCustomCultivators = false;
                        }
                        
                        // Ensure fcTabUnlockClicks and fcTabUnlocked exist
                        if (!parsedState.player.hasOwnProperty('fcTabUnlockClicks')) {
                            parsedState.player.fcTabUnlockClicks = 0;
                        }
                        if (!parsedState.player.hasOwnProperty('fcTabUnlocked')) {
                            parsedState.player.fcTabUnlocked = parsedState.player.realm >= 1;
                        }
                        
                        // Merge the saved state with the default state
                        Object.assign(gameState, parsedState);
                        
                        // Ensure initial fellow cultivators are in the pool
                        if (gameState.fellowCultivators.pool.length === 0) {
                            gameState.fellowCultivators.pool = [...initialFellowCultivators];
                        } else {
                            // Make sure the default cultivators are present
                            const existingIds = gameState.fellowCultivators.pool.map(c => c.id);
                            const missingDefaults = initialFellowCultivators.filter(c => !existingIds.includes(c.id));
                            
                            if (missingDefaults.length > 0) {
                                gameState.fellowCultivators.pool = [...gameState.fellowCultivators.pool, ...missingDefaults];
                            }
                        }
                        
                        // Update version
                        gameState.version = '1.4';
                        
                        // Apply theme settings
                        applyTheme();
                        
                        // Set completion count toggle
                        if (elements.showCompletionCount) {
                            elements.showCompletionCount.checked = gameState.settings.showCompletionCount;
                        }
                        
                        // Set notification toggles
                        if (elements.notificationBreakthrough) {
                            elements.notificationBreakthrough.checked = gameState.notifications.settings.breakthroughReadiness;
                        }
                        if (elements.notificationIdle) {
                            elements.notificationIdle.checked = gameState.notifications.settings.idleRewards;
                        }
                        if (elements.notificationMilestone) {
                            elements.notificationMilestone.checked = gameState.notifications.settings.cultivationMilestones;
                        }
                        if (elements.notificationFellowCultivator) {
                            elements.notificationFellowCultivator.checked = gameState.notifications.settings.fellowCultivator;
                        }
                        if (elements.notificationAchievement) {
                            elements.notificationAchievement.checked = gameState.notifications.settings.achievement;
                        }
                        if (elements.notificationPomodoro) {
                            elements.notificationPomodoro.checked = gameState.notifications.settings.pomodoro;
                        }
                        
                        // Set scientific notation settings
                        if (elements.useScientificNotation) {
                            elements.useScientificNotation.checked = gameState.settings.useScientificNotation;
                        }
                        if (elements.scientificNotationThreshold) {
                            elements.scientificNotationThreshold.value = gameState.settings.scientificNotationThreshold;
                        }
                        
                        // Set onlyMeetCustomCultivators toggle
                        if (elements.onlyMeetCustomCultivators) {
                            elements.onlyMeetCustomCultivators.checked = gameState.settings.onlyMeetCustomCultivators;
                        }
                        
                        // Check if Fellow Cultivators tab should be unlocked
                        if ((gameState.player.realm >= 1 || gameState.player.fcTabUnlocked) && elements.fcTabButton) {
                            elements.fcTabButton.classList.remove('disabled');
                        }
                        
                        // Update all UI components
                        updateCultivationUI();
                        updateStonesUI();
                        updateStatisticsUI();
                        renderTaskList();
                        renderGeneratedTasks();
                        updatePomodoroUI();
                        
                        // Save to localStorage
                        saveGameState();
                        
                        showToast("Game data imported successfully", "success");
                    }
                );
            } catch (error) {
                console.error('Failed to import game state:', error);
                showToast("Failed to import game data. Make sure you pasted the correct data.", "error");
            }
        }

        // Reset statistics
        function resetStats() {
            showModal(
                "Reset Statistics",
                "Are you sure you want to reset all statistics? This will not affect your cultivation progress or inventory.",
                () => {
                    gameState.stats = {
                        totalTasks: gameState.tasks.length,
                        completedTasks: 0,
                        totalQiEarned: 0,
                        totalQiPassive: 0,
                        totalQiPomodoro: 0,
                        totalStonesFound: {
                            basic: 0,
                            low: 0,
                            medium: 0,
                            high: 0,
                            supreme: 0,
                            divine: 0,
                            rename: 0
                        },
                        stonesFused: {
                            basic: 0,
                            low: 0,
                            medium: 0,
                            high: 0,
                            supreme: 0
                        },
                        breakthroughs: 0,
                        failedAttempts: 0,
                        highestRealmReached: gameState.player.realm,
                        renameScrollsUsed: 0,
                        taskHistory: [],
                        completionByTag: {},
                        completionByDayOfWeek: [0, 0, 0, 0, 0, 0, 0],
                        cultivatorsMet: 0,
                        totalBoostTime: 0,
                        qiFromBoosts: 0,
                        pomodoroSessions: 0,
                        pomodoroTotalMinutes: 0,
                        pomodoroBoostsEarned: 0,
                        pomodoroTasksCompleted: 0
                    };
                    
                    // Also reset analytics data
                    gameState.analytics = {
                        qiEfficiency: [],
                        realmHistory: [],
                        lastAnalyticsUpdate: Date.now(),
                        pomodoroByDuration: {
                            5: 0,
                            10: 0,
                            15: 0,
                            20: 0,
                            25: 0
                        }
                    };
                    
                    // Add current state to realm history
                    gameState.analytics.realmHistory.push({
                        timestamp: Date.now(),
                        realm: gameState.player.realm,
                        stage: gameState.player.stage
                    });
                    
                    // Also reset task completion counts
                    gameState.tasks.forEach(task => {
                        task.completionCount = 0;
                        task.completionDates = [];
                    });
                    
                    // Reset fellow cultivator encounters
                    gameState.fellowCultivators.pool.forEach(cultivator => {
                        cultivator.encounters = 0;
                    });
                    gameState.fellowCultivators.lastEncounter = null;
                    gameState.fellowCultivators.meetings = [];
                    
                    // Reset pomodoro history
                    gameState.pomodoro.history = [];
                    
                    // Reset achievements progress but keep unlocked achievements
                    gameState.achievements.progress = {};
                    
                    updateStatisticsUI();
                    renderTaskList();
                    updateAnalyticsCharts();
                    updateFellowCultivatorsUI();
                    updatePomodoroUI();
                    saveGameState();
                    
                    showToast("Statistics reset successfully", "success");
                }
            );
        }

        // Hard reset
        function hardReset() {
            showModal(
                "Hard Reset",
                "Are you sure you want to reset ALL game data? This will delete your cultivation progress, tasks, inventory, and statistics. This cannot be undone!",
                () => {
                    // Reset to initial state
                    Object.assign(gameState, {
                        version: '1.4',
                        player: {
                            name: 'Unnamed Cultivator',
                            realm: 0,
                            stage: 1,
                            qi: 0,
                            lastUpdated: Date.now(),
                            lastBreakthroughCheck: Date.now(),
                            reachedMilestones: {
                                realms: [0],
                                stages: {}
                            },
                            fcTabUnlockClicks: 0,
                            fcTabUnlocked: false
                        },
                        tasks: [],
                        generatedTasks: [],
                        stones: {
                            basic: 0,
                            low: 0,
                            medium: 0,
                            high: 0,
                            supreme: 0,
                            divine: 0,
                            rename: 0
                        },
                        selectedStones: {
                            basic: 0,
                            low: 0,
                            medium: 0,
                            high: 0,
                            supreme: 0,
                            divine: 0
                        },
                        stats: {
                            totalTasks: 0,
                            completedTasks: 0,
                            totalQiEarned: 0,
                            totalQiPassive: 0,
                            totalQiPomodoro: 0,
                            totalStonesFound: {
                                basic: 0,
                                low: 0,
                                medium: 0,
                                high: 0,
                                supreme: 0,
                                divine: 0,
                                rename: 0
                            },
                            stonesFused: {
                                basic: 0,
                                low: 0,
                                medium: 0,
                                high: 0,
                                supreme: 0
                            },
                            breakthroughs: 0,
                            failedAttempts: 0,
                            highestRealmReached: 0,
                            renameScrollsUsed: 0,
                            taskHistory: [],
                            completionByTag: {},
                            completionByDayOfWeek: [0, 0, 0, 0, 0, 0, 0],
                            cultivatorsMet: 0,
                            totalBoostTime: 0,
                            qiFromBoosts: 0,
                            pomodoroSessions: 0,
                            pomodoroTotalMinutes: 0,
                            pomodoroBoostsEarned: 0,
                            pomodoroTasksCompleted: 0
                        },
                        notifications: {
                            settings: {
                                breakthroughReadiness: true,
                                idleRewards: true,
                                cultivationMilestones: true,
                                fellowCultivator: true,
                                achievement: true,
                                pomodoro: true
                            },
                            history: []
                        },
                        settings: {
                            theme: 'default',
                            darkMode: false,
                            showCompletionCount: true,
                            onlyMeetCustomCultivators: false,
                            useScientificNotation: false,
                            scientificNotationThreshold: 1000000
                        },
                        analytics: {
                            qiEfficiency: [],
                            realmHistory: [],
                            lastAnalyticsUpdate: Date.now(),
                            pomodoroByDuration: {
                                5: 0,
                                10: 0,
                                15: 0,
                                20: 0,
                                25: 0
                            }
                        },
                        fellowCultivators: {
                            pool: [...initialFellowCultivators],
                            meetings: [],
                            boostEndTime: 0,
                            lastMeetingTime: 0,
                            lastEncounter: null,
                            addedToday: 0,
                            dayLastAdded: null
                        },
                        pomodoro: {
                            focusDuration: 25,
                            breakDuration: 5,
                            useBreak: true,
                            isRunning: false,
                            isPaused: false,
                            isBreak: false,
                            timeRemaining: 25 * 60,
                            startTime: null,
                            endTime: null,
                            pauseTime: null,
                            boostsRemaining: 0,
                            lastSessionTime: null,
                            history: []
                        },
                        achievements: {
                            unlocked: {},
                            progress: {},
                            lastUnlocked: null,
                            discoveredHidden: []
                        }
                    });
                    
                    // Lock Fellow Cultivators tab
                    if (elements.fcTabButton) {
                        elements.fcTabButton.classList.add('disabled');
                    }
                    
                    // Show name selection
                    setTimeout(() => {
                        elements.nameChangeOverlay.classList.remove('hidden');
                        
                        // Remove the rename scroll consumption for setup after hard reset
                        const originalConfirm = elements.nameChangeConfirm.onclick;
                        elements.nameChangeConfirm.onclick = () => {
                            const newName = elements.cultivatorNameInput.value.trim();
                            
                            if (!newName) {
                                showToast("Please enter a valid name", "error");
                                return;
                            }
                            
                            // Set the new name
                            gameState.player.name = newName;
                            
                            // Update UI
                            elements.cultivatorName.textContent = newName;
                            
                            // Hide modal
                            elements.nameChangeOverlay.classList.add('hidden');
                            
                            // Show tutorial after name is set
                            setTimeout(showTutorial, 500);
                            
                            // Save game state
                            saveGameState();
                            
                            // Restore original onclick
                            elements.nameChangeConfirm.onclick = originalConfirm;
                        };
                    }, 500);
                    
                    // Apply theme settings
                    applyTheme();
                    
                    // Set completion count toggle
                    if (elements.showCompletionCount) {
                        elements.showCompletionCount.checked = gameState.settings.showCompletionCount;
                    }
                    
                    // Set notification toggles
                    if (elements.notificationBreakthrough) {
                        elements.notificationBreakthrough.checked = gameState.notifications.settings.breakthroughReadiness;
                    }
                    if (elements.notificationIdle) {
                        elements.notificationIdle.checked = gameState.notifications.settings.idleRewards;
                    }
                    if (elements.notificationMilestone) {
                        elements.notificationMilestone.checked = gameState.notifications.settings.cultivationMilestones;
                    }
                    if (elements.notificationFellowCultivator) {
                        elements.notificationFellowCultivator.checked = gameState.notifications.settings.fellowCultivator;
                    }
                    if (elements.notificationAchievement) {
                        elements.notificationAchievement.checked = gameState.notifications.settings.achievement;
                    }
                    if (elements.notificationPomodoro) {
                        elements.notificationPomodoro.checked = gameState.notifications.settings.pomodoro;
                    }
                    
                    // Set scientific notation settings
                    if (elements.useScientificNotation) {
                        elements.useScientificNotation.checked = gameState.settings.useScientificNotation;
                    }
                    if (elements.scientificNotationThreshold) {
                        elements.scientificNotationThreshold.value = gameState.settings.scientificNotationThreshold;
                    }
                    
                    // Set onlyMeetCustomCultivators toggle
                    if (elements.onlyMeetCustomCultivators) {
                        elements.onlyMeetCustomCultivators.checked = gameState.settings.onlyMeetCustomCultivators;
                    }
                    
                    // Update all UI components
                    updateCultivationUI();
                    updateStonesUI();
                    updateStatisticsUI();
                    renderTaskList();
                    renderGeneratedTasks();
                    updateFellowCultivatorsUI();
                    updatePomodoroUI();
                    
                    // Save to localStorage
                    saveGameState();
                    
                    showToast("Game data reset successfully", "success");
                }
            );
        }

        // Set up event listeners
        function setupEventListeners() {
            // Cultivation tab
            elements.clearStones.addEventListener('click', () => {
                // Reset selected stones
                for (const type in gameState.selectedStones) {
                    gameState.selectedStones[type] = 0;
                }
                
                updateStonesUI();
                updateCultivationUI();
            });
            
            elements.attemptBreakthrough.addEventListener('click', attemptBreakthrough);
            
            // Spirit stone selection
            document.querySelectorAll('.spirit-stone').forEach(stone => {
                stone.addEventListener('click', () => {
                    const type = stone.dataset.type;
                    if (!type) return;
                    
                    // Special handling for rename scroll
                    if (type === 'rename') {
                        if (gameState.stones.rename > 0) {
                            useRenameScroll();
                        } else {
                            showToast(`You don't have any Rename Scrolls`, "info");
                        }
                        return;
                    }
                    
                    // Regular spirit stones
                    // Can't select more stones than you have
                    if (gameState.selectedStones[type] < gameState.stones[type]) {
                        gameState.selectedStones[type]++;
                        updateStonesUI();
                        updateCultivationUI();
                    } else {
                        showToast(`You don't have any more ${spiritStones[type].name}s to use`, "info");
                    }
                });
            });
            
            // Tasks tab
            elements.addTask.addEventListener('click', () => {
                const name = elements.taskName.value.trim();
                const tagsInput = elements.taskTags.value.trim();
                
                if (!name) {
                    showToast("Please enter a task name", "error");
                    return;
                }
                
                const tags = tagsInput
                    ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag)
                    : [];
                
                const newTask = {
                    id: Date.now().toString(),
                    name,
                    tags,
                    completionCount: 0,
                    completionDates: []
                };
                
                gameState.tasks.push(newTask);
                gameState.stats.totalTasks++;
                
                elements.taskName.value = '';
                elements.taskTags.value = '';
                
                renderTaskList();
                updateStatisticsUI();
                saveGameState();
                
                // Check for task creation achievements
                checkAchievement("tasks_create_10");
                
                showToast("Task added successfully", "success");
            });
            
            elements.sortTasks.addEventListener('change', renderTaskList);
            
            elements.selectAllTasks.addEventListener('click', () => {
                const checkboxes = elements.taskList.querySelectorAll('input[type="checkbox"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                
                checkboxes.forEach(cb => {
                    cb.checked = !allChecked;
                });
                
                updateTaskSelectionStatus();
            });
            
            elements.taskList.addEventListener('change', event => {
                if (event.target.type === 'checkbox') {
                    updateTaskSelectionStatus();
                }
            });
            
            elements.editSelectedTask.addEventListener('click', () => {
                const checkboxes = elements.taskList.querySelectorAll('input[type="checkbox"]:checked');
                if (checkboxes.length === 1) {
                    const taskId = checkboxes[0].dataset.id;
                    showEditTaskModal(taskId);
                }
            });
            
            elements.deleteSelectedTasks.addEventListener('click', () => {
                const checkboxes = elements.taskList.querySelectorAll('input[type="checkbox"]:checked');
                const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.id);
                
                if (selectedIds.length === 0) return;
                
                showModal(
                    "Delete Tasks",
                    `Are you sure you want to delete ${selectedIds.length} task(s)?`,
                    () => {
                        // Remove tasks with selected IDs
                        gameState.tasks = gameState.tasks.filter(task => !selectedIds.includes(task.id));
                        
                        // Update stats
                        gameState.stats.totalTasks = gameState.tasks.length;
                        
                        renderTaskList();
                        updateStatisticsUI();
                        saveGameState();
                        
                        showToast(`${selectedIds.length} task(s) deleted`, "success");
                    }
                );
            });
            
            elements.generateTasks.addEventListener('click', generateRandomTasks);
            
            elements.completeAllTasks.addEventListener('click', completeAllTasks);
            
            elements.giveUpTasks.addEventListener('click', giveUpTasks);
            
            // Pomodoro tab
            elements.timerStart.addEventListener('click', () => {
                if (!gameState.pomodoro.isRunning) {
                    startPomodoroTimer();
                } else if (gameState.pomodoro.isPaused) {
                    resumePomodoroTimer();
                }
            });
            
            elements.timerPause.addEventListener('click', () => {
                if (gameState.pomodoro.isRunning && !gameState.pomodoro.isPaused) {
                    pausePomodoroTimer();
                }
            });
            
            elements.timerReset.addEventListener('click', resetPomodoroTimer);
            
            elements.focusDuration.addEventListener('input', () => {
                const value = parseInt(elements.focusDuration.value);
                gameState.pomodoro.focusDuration = value;
                elements.focusDurationDisplay.textContent = `${value} min`;
                
                // Only update time remaining if not currently running
                if (!gameState.pomodoro.isRunning && !gameState.pomodoro.isBreak) {
                    gameState.pomodoro.timeRemaining = value * 60;
                    updatePomodoroUI();
                }
                
                saveGameState();
            });
            
            elements.breakDuration.addEventListener('input', () => {
                const value = parseInt(elements.breakDuration.value);
                gameState.pomodoro.breakDuration = value;
                elements.breakDurationDisplay.textContent = `${value} min`;
                
                // Only update time remaining if currently in break and not running
                if (!gameState.pomodoro.isRunning && gameState.pomodoro.isBreak) {
                    gameState.pomodoro.timeRemaining = value * 60;
                    updatePomodoroUI();
                }
                
                saveGameState();
            });
            
            elements.useBreak.addEventListener('change', () => {
                gameState.pomodoro.useBreak = elements.useBreak.checked;
                saveGameState();
            });
            
            // Inventory tab
            elements.stoneButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const stoneType = button.getAttribute('data-stone');
                    fuseStones(stoneType);
                });
            });
            
            elements.useRenameScroll.addEventListener('click', useRenameScroll);
            
            // Fellow Cultivator tab
            elements.addCultivator.addEventListener('click', addFellowCultivator);
            
            elements.editCultivatorSelect.addEventListener('change', () => {
                const cultivatorId = elements.editCultivatorSelect.value;
                if (!cultivatorId) {
                    elements.editCultivatorForm.classList.add('hidden');
                    return;
                }
                
                const cultivator = gameState.fellowCultivators.pool.find(c => c.id === cultivatorId);
                if (!cultivator) return;
                
                const now = Date.now();
                if (now < cultivator.editCooldown) {
                    // Show cooldown info
                    elements.editCultivatorForm.classList.add('hidden');
                    elements.editCooldownInfo.classList.remove('hidden');
                    elements.editAvailableTime.textContent = new Date(cultivator.editCooldown).toLocaleString();
                } else {
                    // Show edit form
                    editFellowCultivator();
                }
            });
            
            elements.saveCultivatorEdit.addEventListener('click', saveCultivatorEdit);
            
            elements.removeCultivatorSelect.addEventListener('change', () => {
                elements.removeCultivator.disabled = !elements.removeCultivatorSelect.value;
            });
            
            elements.removeCultivator.addEventListener('click', removeFellowCultivator);
            
            // Achievements tab
            elements.achievementTabs.addEventListener('click', (e) => {
                if (e.target.classList.contains('achievement-tab')) {
                    const category = e.target.getAttribute('data-category');
                    
                    // Update active tab
                    document.querySelectorAll('.achievement-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // Update achievement list
                    updateAchievementsUI(category);
                }
            });
            
            // Name change events
            elements.nameChangeConfirm.addEventListener('click', confirmNameChange);
            
            elements.nameChangeCancel.addEventListener('click', () => {
                elements.nameChangeOverlay.classList.add('hidden');
            });
            
            // Achievement unlock events
            elements.achievementUnlockConfirm.addEventListener('click', () => {
                elements.achievementUnlockOverlay.classList.add('hidden');
            });
            
            // Settings tab
            elements.exportGame.addEventListener('click', exportGameState);
            elements.manualSave.addEventListener('click', manualSave);
            elements.importGame.addEventListener('click', importGameState);
            elements.resetStats.addEventListener('click', resetStats);
            elements.hardReset.addEventListener('click', hardReset);
            elements.showTutorial.addEventListener('click', showTutorial);
            
            elements.settingsChangeName.addEventListener('click', changeNameInSettings);
            
            // Theme settings
            elements.themeSelect.addEventListener('change', () => {
                gameState.settings.theme = elements.themeSelect.value;
                applyTheme();
                saveGameState();
                
                // Check for theme explorer achievement
                if (!gameState.achievements.progress["misc_theme_explorer"]) {
                    gameState.achievements.progress["misc_theme_explorer"] = new Set();
                }
                
                if (typeof gameState.achievements.progress["misc_theme_explorer"] === 'object') {
                    // Convert Set to array if needed (for older saves)
                    const themeSet = new Set(Array.from(gameState.achievements.progress["misc_theme_explorer"]));
                    themeSet.add(gameState.settings.theme);
                    gameState.achievements.progress["misc_theme_explorer"] = themeSet.size;
                    
                    // Check achievement
                    checkAchievement("misc_theme_explorer");
                    saveGameState();
                }
            });
            
            elements.themeModeToggle.addEventListener('change', () => {
                gameState.settings.darkMode = elements.themeModeToggle.checked;
                applyTheme();
                saveGameState();
            });
            
            elements.showCompletionCount.addEventListener('change', () => {
                gameState.settings.showCompletionCount = elements.showCompletionCount.checked;
                renderTaskList();
                saveGameState();
            });
            
            // Scientific notation settings
            elements.useScientificNotation.addEventListener('change', () => {
                gameState.settings.useScientificNotation = elements.useScientificNotation.checked;
                updateCultivationUI();
                updateStatisticsUI();
                saveGameState();
            });
            
            elements.scientificNotationThreshold.addEventListener('change', () => {
                gameState.settings.scientificNotationThreshold = parseInt(elements.scientificNotationThreshold.value);
                updateCultivationUI();
                updateStatisticsUI();
                saveGameState();
            });
            
            // Fellow Cultivator settings
            elements.onlyMeetCustomCultivators.addEventListener('change', () => {
                gameState.settings.onlyMeetCustomCultivators = elements.onlyMeetCustomCultivators.checked;
                saveGameState();
            });
            
            // Notification settings
            elements.notificationBreakthrough.addEventListener('change', () => {
                gameState.notifications.settings.breakthroughReadiness = elements.notificationBreakthrough.checked;
                saveGameState();
            });
            
            elements.notificationIdle.addEventListener('change', () => {
                gameState.notifications.settings.idleRewards = elements.notificationIdle.checked;
                saveGameState();
            });
            
            elements.notificationMilestone.addEventListener('change', () => {
                gameState.notifications.settings.cultivationMilestones = elements.notificationMilestone.checked;
                saveGameState();
            });
            
            elements.notificationFellowCultivator.addEventListener('change', () => {
                gameState.notifications.settings.fellowCultivator = elements.notificationFellowCultivator.checked;
                saveGameState();
            });
            
            elements.notificationAchievement.addEventListener('change', () => {
                gameState.notifications.settings.achievement = elements.notificationAchievement.checked;
                saveGameState();
            });
            
            elements.notificationPomodoro.addEventListener('change', () => {
                gameState.notifications.settings.pomodoro = elements.notificationPomodoro.checked;
                saveGameState();
            });
            
            // Tutorial navigation
            elements.tutorialNext.addEventListener('click', nextTutorialPage);
            elements.tutorialPrev.addEventListener('click', prevTutorialPage);
            elements.tutorialSkip.addEventListener('click', skipTutorial);
            
            // Setup idle progression update
            setInterval(() => {
                const now = Date.now();
                const elapsedMinutes = (now - gameState.player.lastUpdated) / (1000 * 60);
                
                if (elapsedMinutes > 0) {
                    // Get current idle rate with potential boost
                    const idleRate = getCurrentIdleRate();
                    const idleGain = elapsedMinutes * idleRate;
                    
                    // If boost is active, track the extra qi gained
                    if (now < gameState.fellowCultivators.boostEndTime) {
                        const baseRate = 0.5 * getCurrentRealm().multiplier; // qi/min
                        const extraQi = elapsedMinutes * baseRate; // The amount gained from the 2x multiplier
                        gameState.stats.qiFromBoosts += extraQi;
                    }
                    
                    gameState.player.qi += idleGain;
                    gameState.player.lastUpdated = now;
                    
                    // Track passive qi gains
                    gameState.stats.totalQiEarned += idleGain;
                    gameState.stats.totalQiPassive += idleGain;
                    
                    // Update UI components
                    updateCultivationUI();
                    updateStatisticsUI();
                    saveGameState();
                }
            }, 60000); // Update every minute
            
            // Check for breakthrough readiness periodically
            setInterval(() => {
                checkBreakthroughReadiness();
            }, 5 * 60 * 1000); // Check every 5 minutes
            
            // Update boost timer display
            setInterval(() => {
                const now = Date.now();
                if (now < gameState.fellowCultivators.boostEndTime) {
                    // Calculate remaining time
                    const remainingMinutes = (gameState.fellowCultivators.boostEndTime - now) / (60 * 1000);
                    
                    // Update displays
                    if (elements.boostTimeRemaining) {
                        elements.boostTimeRemaining.textContent = formatTime(remainingMinutes);
                    }
                    if (elements.fcBoostTimeRemaining) {
                        elements.fcBoostTimeRemaining.textContent = formatTime(remainingMinutes);
                    }
                    
                    // Show boost indicators
                    if (elements.fellowBoostContainer) {
                        elements.fellowBoostContainer.classList.remove('hidden');
                    }
                    if (elements.fcNoBoost && elements.fcActiveBoost) {
                        elements.fcNoBoost.classList.add('hidden');
                        elements.fcActiveBoost.classList.remove('hidden');
                    }
                } else {
                    // Hide boost indicators when expired
                    if (elements.fellowBoostContainer) {
                        elements.fellowBoostContainer.classList.add('hidden');
                    }
                    if (elements.fcNoBoost && elements.fcActiveBoost) {
                        elements.fcNoBoost.classList.remove('hidden');
                        elements.fcActiveBoost.classList.add('hidden');
                    }
                }
            }, 10000); // Update every 10 seconds
            
            // Setup dark mode detection if no theme setting yet
            if (window.matchMedia && !localStorage.getItem('cultivationTaskManager')) {
                gameState.settings.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme();
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                // Only automatically change if user hasn't manually set theme
                if (!localStorage.getItem('cultivationTaskManager')) {
                    gameState.settings.darkMode = event.matches;
                    applyTheme();
                }
            });
        }

        // Initialize the app
        function init() {
            setupEventListeners();
            loadGameState();
            
            // Update UI components initially
            updateCultivationUI();
            updateStonesUI();
            updateStatisticsUI();
            renderTaskList();
            renderGeneratedTasks();
            
            // Update fellow cultivators UI if tab is active
            if (!document.getElementById('fellowCultivators-tab').classList.contains('hidden')) {
                updateFellowCultivatorsUI();
            }
            
            // Check for first day achievement
            checkAchievement("misc_first_day");
        }

        // Timer interval for pomodoro
        let pomodoroTimerInterval = null;

        // Start the app
        init();
    </script>
</body>
</html>
