<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>青云修仙录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f5ff',
                            100: '#e1ebff',
                            200: '#c3d8ff',
                            300: '#a4c1ff',
                            400: '#819fff',
                            500: '#5D5CDE',
                            600: '#4242c9',
                            700: '#3333a3',
                            800: '#292985',
                            900: '#25256d',
                        },
                        ancient: {
                            50: '#fdf8f1',
                            100: '#f2e3ce',
                            200: '#e6d0ad',
                            300: '#d9b77a',
                            400: '#c99c52',
                            500: '#b68434',
                            600: '#95682b',
                            700: '#744f25',
                            800: '#5a3e23',
                            900: '#46321f',
                        }
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-in': 'slideIn 0.4s ease-out',
                        'slide-out': 'slideOut 0.4s ease-in',
                        'sparkle': 'sparkle 1.5s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite'
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        slideOut: {
                            '0%': { transform: 'translateX(0)', opacity: '1' },
                            '100%': { transform: 'translateX(100%)', opacity: '0' }
                        },
                        sparkle: {
                            '0%, 100%': { opacity: '0.2' },
                            '50%': { opacity: '1', filter: 'brightness(1.5)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.css" rel="stylesheet">
    <!-- Chart.js for analytics visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Noto+Serif+SC:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #5D5CDE;
            --scroll-color: #d9b77a;
            --paper-color: #f2e3ce;
            --ink-color: #46321f;
            --qi-color: #5D5CDE;
            --qi-glow: rgba(93, 92, 222, 0.3);
            --ancient-dark: #46321f;
            --ancient-light: #f2e3ce;
            --ancient-medium: #d9b77a;
            --ancient-accent: #b68434;
            --chart-grid: rgba(70, 50, 31, 0.1);
            --chart-text: #46321f;
            --achievement-common: #8bca8b;
            --achievement-uncommon: #7b98e8;
            --achievement-rare: #bc83e3;
            --achievement-epic: #e8a95c;
            --achievement-legendary: #e35d5d;
            --achievement-mythic: #b76ee8;
            --achievement-hidden: #777777;
        }

        /* Theme: Default Light */
        .theme-default.light {
            --paper-color: #f2e3ce;
            --ink-color: #46321f;
            --ancient-dark: #46321f;
            --ancient-light: #f2e3ce;
            --ancient-medium: #d9b77a;
            --ancient-accent: #b68434;
            --chart-grid: rgba(70, 50, 31, 0.1);
            --chart-text: #46321f;
        }

        /* Theme: Default Dark */
        .theme-default.dark {
            --paper-color: #25256d;
            --ink-color: #f2e3ce;
            --ancient-dark: #f2e3ce;
            --ancient-light: #25256d;
            --ancient-medium: #3333a3;
            --ancient-accent: #819fff;
            --chart-grid: rgba(242, 227, 206, 0.1);
            --chart-text: #f2e3ce;
        }

        /* Theme: Black & White */
        .theme-bw.light {
            --paper-color: #ffffff;
            --ink-color: #121212;
            --ancient-dark: #121212;
            --ancient-light: #ffffff;
            --ancient-medium: #e0e0e0;
            --ancient-accent: #666666;
            --qi-color: #333333;
            --qi-glow: rgba(51, 51, 51, 0.3);
            --chart-grid: rgba(18, 18, 18, 0.1);
            --chart-text: #121212;
        }

        .theme-bw.dark {
            --paper-color: #121212;
            --ink-color: #ffffff;
            --ancient-dark: #ffffff;
            --ancient-light: #121212;
            --ancient-medium: #333333;
            --ancient-accent: #999999;
            --qi-color: #ffffff;
            --qi-glow: rgba(255, 255, 255, 0.3);
            --chart-grid: rgba(255, 255, 255, 0.1);
            --chart-text: #ffffff;
        }

        /* Theme: Retro */
        .theme-retro.light {
            --paper-color: #fbf3d0;
            --ink-color: #8b4513;
            --ancient-dark: #8b4513;
            --ancient-light: #fbf3d0;
            --ancient-medium: #deb887;
            --ancient-accent: #cd853f;
            --qi-color: #a0522d;
            --qi-glow: rgba(160, 82, 45, 0.3);
            --chart-grid: rgba(139, 69, 19, 0.1);
            --chart-text: #8b4513;
        }

        .theme-retro.dark {
            --paper-color: #2f4f4f;
            --ink-color: #f5deb3;
            --ancient-dark: #f5deb3;
            --ancient-light: #2f4f4f;
            --ancient-medium: #4a766e;
            --ancient-accent: #8fbc8f;
            --qi-color: #66cdaa;
            --qi-glow: rgba(102, 205, 170, 0.3);
            --chart-grid: rgba(245, 222, 179, 0.1);
            --chart-text: #f5deb3;
        }

        /* Theme: Oriental */
        .theme-oriental.light {
            --paper-color: #fff1e6;
            --ink-color: #ac0000;
            --ancient-dark: #ac0000;
            --ancient-light: #fff1e6;
            --ancient-medium: #ffb380;
            --ancient-accent: #dc6500;
            --qi-color: #e60000;
            --qi-glow: rgba(230, 0, 0, 0.3);
            --chart-grid: rgba(172, 0, 0, 0.1);
            --chart-text: #ac0000;
        }

        .theme-oriental.dark {
            --paper-color: #1f0c0c;
            --ink-color: #ff9e9e;
            --ancient-dark: #ff9e9e;
            --ancient-light: #1f0c0c;
            --ancient-medium: #3d1a1a;
            --ancient-accent: #d63030;
            --qi-color: #ff5252;
            --qi-glow: rgba(255, 82, 82, 0.3);
            --chart-grid: rgba(255, 158, 158, 0.1);
            --chart-text: #ff9e9e;
        }

        /* Theme: Modern */
        .theme-modern.light {
            --paper-color: #f8f9fa;
            --ink-color: #212529;
            --ancient-dark: #212529;
            --ancient-light: #f8f9fa;
            --ancient-medium: #e9ecef;
            --ancient-accent: #6c757d;
            --qi-color: #0d6efd;
            --qi-glow: rgba(13, 110, 253, 0.3);
            --chart-grid: rgba(33, 37, 41, 0.1);
            --chart-text: #212529;
        }

        .theme-modern.dark {
            --paper-color: #212529;
            --ink-color: #f8f9fa;
            --ancient-dark: #f8f9fa;
            --ancient-light: #212529;
            --ancient-medium: #343a40;
            --ancient-accent: #adb5bd;
            --qi-color: #0dcaf0;
            --qi-glow: rgba(13, 202, 240, 0.3);
            --chart-grid: rgba(248, 249, 250, 0.1);
            --chart-text: #f8f9fa;
        }

        /* Theme: Neon */
        .theme-neon.light {
            --paper-color: #ffffff;
            --ink-color: #121212;
            --ancient-dark: #121212;
            --ancient-light: #ffffff;
            --ancient-medium: #e0e0e0;
            --ancient-accent: #00ff99;
            --qi-color: #ff00ff;
            --qi-glow: rgba(255, 0, 255, 0.3);
            --chart-grid: rgba(18, 18, 18, 0.1);
            --chart-text: #121212;
        }

        .theme-neon.dark {
            --paper-color: #0f0f0f;
            --ink-color: #ffffff;
            --ancient-dark: #ffffff;
            --ancient-light: #0f0f0f;
            --ancient-medium: #222222;
            --ancient-accent: #00ff99;
            --qi-color: #ff00ff;
            --qi-glow: rgba(255, 0, 255, 0.5);
            --chart-grid: rgba(255, 255, 255, 0.1);
            --chart-text: #ffffff;
        }

        body {
            font-family: 'Cinzel', 'Noto Serif SC', serif;
            background-color: var(--paper-color);
            color: var(--ink-color);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .ancient-border {
            border: 2px solid var(--ancient-accent);
            box-shadow: 0 0 10px rgba(182, 132, 52, 0.3);
            background-color: var(--ancient-light);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }

        .ancient-scroll {
            background-color: var(--ancient-light);
            border: 2px solid var(--ancient-accent);
            border-radius: 5px;
            padding: 10px;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .ancient-scroll::before, .ancient-scroll::after {
            content: '';
            position: absolute;
            height: 100%;
            width: 20px;
            top: 0;
            background-color: var(--ancient-medium);
            border: 2px solid var(--ancient-accent);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .ancient-scroll::before {
            left: -10px;
            border-radius: 10px 0 0 10px;
        }

        .ancient-scroll::after {
            right: -10px;
            border-radius: 0 10px 10px 0;
        }

        .cultivation-banner {
            background: linear-gradient(to right, var(--ancient-medium), var(--ancient-light), var(--ancient-medium));
            border-top: 2px solid var(--ancient-accent);
            border-bottom: 2px solid var(--ancient-accent);
            padding: 0.5rem;
            text-align: center;
            position: relative;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .cultivation-banner::before, .cultivation-banner::after {
            content: '☯';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: var(--ancient-accent);
            transition: color 0.3s ease;
        }

        .cultivation-banner::before {
            left: 10px;
        }

        .cultivation-banner::after {
            right: 10px;
        }

        .qi-progress {
            background: linear-gradient(to right, var(--qi-color), var(--qi-glow));
            transition: width 0.5s ease-in-out, background 0.3s ease;
        }

        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--scroll-color) var(--ancient-light);
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: var(--ancient-light);
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background-color: var(--scroll-color);
            border-radius: 4px;
        }

        .tab-button {
            position: relative;
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            color: var(--ink-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-button:hover {
            border-bottom: 2px solid var(--ancient-accent);
        }

        .tab-button.active {
            border-bottom: 2px solid var(--ancient-accent);
            font-weight: bold;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--ancient-accent);
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .tab-button:hover::after {
            width: 100%;
        }

        .glow-on-hover:hover {
            box-shadow: 0 0 10px var(--qi-glow);
        }

        .custom-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--ancient-accent);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            position: relative;
            background-color: var(--ancient-light);
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .custom-checkbox:checked {
            background-color: var(--ancient-accent);
        }

        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--ancient-light);
            font-size: 14px;
        }

        .ancient-input {
            background-color: var(--ancient-light);
            border: 2px solid var(--ancient-accent);
            color: var(--ink-color);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 16px;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .ancient-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--qi-glow);
        }

        .ancient-button {
            background-color: var(--ancient-accent);
            color: var(--ancient-light);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .ancient-button:hover {
            background-color: var(--ancient-dark);
            transform: translateY(-2px);
        }

        .ancient-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--ancient-dark);
            color: var(--ancient-light);
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, background-color 0.3s ease, color 0.3s ease;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .rotate-symbol {
            display: inline-block;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            background-color: var(--ancient-accent);
            color: var(--ancient-light);
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .spirit-stone {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .spirit-stone:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .stone-basic {
            background: linear-gradient(135deg, #a1a1a1, #d4d4d4);
        }
        
        .stone-low {
            background: linear-gradient(135deg, #3a8538, #5cc15a);
        }
        
        .stone-medium {
            background: linear-gradient(135deg, #3246b5, #5c7aff);
        }
        
        .stone-high {
            background: linear-gradient(135deg, #9c27b0, #d05ce3);
        }
        
        .stone-supreme {
            background: linear-gradient(135deg, #f57c00, #ffb74d);
        }
        
        .stone-divine {
            background: linear-gradient(135deg, #b71c1c, #f44336);
        }

        .stone-rename {
            background: linear-gradient(135deg, #f2e3ce, #c99c52);
            position: relative;
        }

        .stone-rename::after {
            content: 'R';
            position: absolute;
            font-size: 18px;
            color: #46321f;
            font-weight: bold;
        }

        /* Notification styles */
        .notification {
            position: relative;
            animation: animate-slide-in 0.4s ease-out;
            max-width: 350px;
        }

        .notification.closing {
            animation: animate-slide-out 0.4s ease-in forwards;
        }

        @keyframes animate-slide-in {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        @keyframes animate-slide-out {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background-color: rgba(255,255,255,0.5);
            width: 100%;
            animation: notification-progress 5s linear forwards;
        }

        @keyframes notification-progress {
            0% { width: 100%; }
            100% { width: 0%; }
        }

        .notification-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .notification-header {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .notification-type-breakthrough {
            background: linear-gradient(135deg, #5D5CDE, #3333a3);
            color: white;
        }

        .notification-type-idle {
            background: linear-gradient(135deg, #b68434, #95682b);
            color: white;
        }

        .notification-type-milestone {
            background: linear-gradient(135deg, #d9b77a, #c99c52);
            color: white;
        }

        .notification-type-fellowCultivator {
            background: linear-gradient(135deg, #5cc15a, #3a8538);
            color: white;
        }

        .notification-type-achievement {
            background: linear-gradient(135deg, #e8a95c, #bc83e3);
            color: white;
        }

        .notification-type-pomodoro {
            background: linear-gradient(135deg, #f44336, #e91e63);
            color: white;
        }

        /* Theme selector styles */
        .theme-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin: 0 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .theme-option.active {
            transform: scale(1.2);
            border-color: var(--ancient-accent);
        }

        /* Analytics section styles */
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }

        .qi-source-bar {
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            background-color: var(--ancient-light);
            border: 1px solid var(--ancient-accent);
        }

        .qi-active {
            height: 100%;
            background-color: var(--qi-color);
        }

        .qi-passive {
            height: 100%;
            background-color: var(--ancient-accent);
        }

        /* Input slider for themes */
        .ancient-range {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--ancient-medium);
            outline: none;
            transition: background 0.3s ease;
        }

        .ancient-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--ancient-accent);
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .ancient-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--ancient-accent);
            cursor: pointer;
            transition: background 0.3s ease;
        }

        /* Input toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--ancient-medium);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--ancient-light);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--ancient-accent);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* For scrollable settings sections */
        .settings-scroll {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Fellow Cultivator card style */
        .fellow-cultivator-card {
            border: 2px solid var(--ancient-accent);
            border-radius: 8px;
            background-color: var(--ancient-light);
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .fellow-cultivator-card:hover {
            box-shadow: 0 0 10px var(--qi-glow);
            transform: translateY(-2px);
        }

        .fellow-cultivator-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .fellow-cultivator-meta {
            font-size: 0.8rem;
            color: var(--ancient-dark);
            opacity: 0.8;
        }

        .fellow-cultivator-actions {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
            gap: 5px;
        }

        /* Fellow cultivator boost indicator */
        .boost-indicator {
            background-color: var(--qi-glow);
            border: 1px solid var(--qi-color);
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .boost-indicator i {
            color: var(--qi-color);
        }

        /* Spoiler styles */
        .spoiler-header {
            cursor: pointer;
            padding: 10px;
            background-color: var(--ancient-medium);
            border: 2px solid var(--ancient-accent);
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            transition: background-color 0.3s ease;
        }

        .spoiler-header:hover {
            background-color: var(--ancient-accent);
        }

        .spoiler-content {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-out;
        }

        .spoiler-content.open {
            max-height: 1000px; /* Adjust based on content */
            transition: max-height 0.5s ease-in;
        }

        .spoiler-icon {
            transition: transform 0.3s ease;
        }

        .spoiler-icon.open {
            transform: rotate(180deg);
        }

        /* Pomodoro timer styles */
        .timer-display {
            font-family: 'Cinzel', 'Noto Serif SC', serif;
            font-size: 5rem;
            font-weight: bold;
            text-align: center;
            color: var(--ancient-dark);
            text-shadow: 0 0 10px var(--qi-glow);
            transition: color 0.3s ease;
        }

        .timer-container {
            background: linear-gradient(to right, var(--ancient-medium), var(--ancient-light), var(--ancient-medium));
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 0 20px var(--qi-glow);
            position: relative;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .timer-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: radial-gradient(circle at center, transparent 0%, var(--qi-color) 100%);
            opacity: 0.1;
            z-index: -1;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .timer-button {
            background-color: var(--ancient-accent);
            color: var(--ancient-light);
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timer-button:hover {
            background-color: var(--ancient-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .timer-button i {
            font-size: 1.4rem;
        }

        .timer-progress {
            height: 10px;
            background-color: var(--ancient-light);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--qi-color), var(--qi-glow));
            width: 0%;
            transition: width 0.5s linear;
        }

        .timer-settings {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--ancient-light);
            border-radius: 10px;
            border: 2px solid var(--ancient-accent);
        }

        .break-indicator {
            font-size: 1.2rem;
            color: var(--qi-color);
            text-align: center;
            margin-top: 10px;
        }

        /* Achievement styles */
        .achievement-card {
            border: 2px solid var(--ancient-accent);
            border-radius: 8px;
            background-color: var(--ancient-light);
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .achievement-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .achievement-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .achievement-content {
            flex-grow: 1;
        }

        .achievement-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .achievement-description {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .achievement-progress {
            height: 6px;
            background-color: var(--ancient-medium);
            border-radius: 3px;
            overflow: hidden;
        }

        .achievement-progress-bar {
            height: 100%;
            transition: width 0.5s ease;
        }

        .achievement-common {
            background-color: var(--achievement-common);
        }

        .achievement-uncommon {
            background-color: var(--achievement-uncommon);
        }

        .achievement-rare {
            background-color: var(--achievement-rare);
        }

        .achievement-epic {
            background-color: var(--achievement-epic);
        }

        .achievement-legendary {
            background-color: var(--achievement-legendary);
        }

        .achievement-mythic {
            background-color: var(--achievement-mythic);
        }

        .achievement-hidden {
            background-color: var(--achievement-hidden);
        }

        .achievement-tabs {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            margin-bottom: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--ancient-accent) var(--ancient-light);
        }

        .achievement-tabs::-webkit-scrollbar {
            height: 6px;
        }

        .achievement-tabs::-webkit-scrollbar-track {
            background: var(--ancient-light);
        }

        .achievement-tabs::-webkit-scrollbar-thumb {
            background-color: var(--ancient-accent);
            border-radius: 3px;
        }

        .achievement-tab {
            padding: 8px 15px;
            background-color: var(--ancient-medium);
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .achievement-tab:hover {
            background-color: var(--ancient-accent);
        }

        .achievement-tab.active {
            background-color: var(--qi-color);
            color: white;
        }

        .achievement-count {
            display: inline-block;
            background-color: var(--ancient-dark);
            color: var(--ancient-light);
            border-radius: 9999px;
            padding: 2px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .achievement-summary {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--ancient-medium);
            border-radius: 10px;
            border: 2px solid var(--ancient-accent);
        }

        .achievement-rarity-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .achievement-boosted {
            position: relative;
        }

        .achievement-boosted::after {
            content: '✨';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 20px;
            animation: sparkle 1.5s infinite;
        }

        /* Task with pomodoro boost */
        .task-boosted {
            position: relative;
            overflow: hidden;
        }

        .task-boosted::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, var(--qi-glow), transparent);
            z-index: 0;
            animation: sparkle 2s infinite;
        }

        .task-boosted > * {
            position: relative;
            z-index: 1;
        }

        /* Special styles for completed achievements */
        .achievement-completed .achievement-icon {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Scientific notation toggle */
        .scientific-notation {
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="app" class="container mx-auto px-4 py-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold mb-2">青云修仙录</h1>
            <p class="text-xl">Qingyun Cultivation Chronicle</p>
            <p id="cultivator-name" class="text-lg italic mt-2">Unnamed Cultivator</p>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-6 flex flex-wrap justify-center border-b border-ancient-accent">
            <button class="tab-button active" data-tab="cultivation">Cultivation</button>
            <button class="tab-button" data-tab="tasks">Tasks</button>
            <button class="tab-button" data-tab="pomodoro">Pomodoro</button>
            <button class="tab-button" data-tab="inventory">Inventory</button>
            <button id="fellowCultivators-tab-button" class="tab-button" data-tab="fellowCultivators">Fellow Cultivators</button>
            <button class="tab-button" data-tab="achievements">Achievements</button>
            <button class="tab-button" data-tab="statistics">Statistics</button>
            <button class="tab-button" data-tab="analytics">Analytics</button>
            <button class="tab-button" data-tab="settings">Settings</button>
        </div>

        <!-- Tab Contents -->
        <div id="tab-content">
            <!-- Cultivation Tab -->
            <div id="cultivation-tab" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Cultivation Status -->
                    <div class="ancient-border rounded-lg p-4">
                        <h2 class="text-2xl font-bold mb-4 cultivation-banner">Cultivation Status</h2>
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <span>Current Realm: <span id="current-realm" class="font-bold">Mortal</span></span>
                                <span>Stage: <span id="current-stage" class="font-bold">1</span>/<span id="max-stage" class="font-bold">9</span></span>
                            </div>
                            <div class="relative pt-1">
                                <div class="overflow-hidden h-4 text-xs flex rounded bg-ancient-light bg-opacity-50 border border-ancient-accent">
                                    <div id="qi-progress-bar" class="qi-progress shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-xs mt-1">
                                    <span id="current-qi">0</span>
                                    <span id="target-qi">100</span>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="cultivation-banner mb-2">Idle Cultivation</div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>Base Rate:</div>
                                <div id="base-rate">0.5 qi/min</div>
                                
                                <div>Current Multiplier:</div>
                                <div id="current-multiplier">×1.0</div>
                                
                                <div>Effective Rate:</div>
                                <div id="effective-rate">0.5 qi/min</div>
                            </div>
                            <div id="fellow-boost-container" class="border border-ancient-accent p-2 rounded mb-2 hidden">
                                <div class="text-center boost-indicator w-full">
                                    <i class="fas fa-user-friends"></i>
                                    <span id="boost-status">Fellow Cultivator Boost: 2× rate for <span id="boost-time-remaining">0m</span></span>
                                </div>
                            </div>
                            <div id="pomodoro-boost-container" class="border border-ancient-accent p-2 rounded mb-2 hidden">
                                <div class="text-center boost-indicator w-full">
                                    <i class="fas fa-stopwatch"></i>
                                    <span id="pomodoro-boost-status">Pomodoro Boost: 2× qi reward for <span id="pomodoro-boosts-remaining">0</span> tasks</span>
                                </div>
                            </div>
                            <div class="border border-ancient-accent p-2 rounded">
                                <div class="text-center mb-1">Next hour will yield approximately:</div>
                                <div id="next-hour-yield" class="text-center font-bold">30 qi</div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="cultivation-banner mb-2">Realm Description</div>
                            <div id="realm-description" class="italic text-center">
                                An ordinary person with no spiritual awareness. The journey of a thousand miles begins with a single step.
                            </div>
                        </div>
                    </div>

                    <!-- Breakthrough Section -->
                    <div class="ancient-border rounded-lg p-4">
                        <h2 class="text-2xl font-bold mb-4 cultivation-banner">Breakthrough</h2>
                        <div class="mb-4">
                            <div class="flex justify-between mb-1">
                                <span>Qi Required:</span>
                                <span id="breakthrough-qi-required">100</span>
                            </div>
                            <div class="flex justify-between mb-1">
                                <span>Base Success Rate:</span>
                                <span id="base-success-rate">75%</span>
                            </div>
                            <div class="flex justify-between mb-4">
                                <span>Final Success Rate:</span>
                                <span id="final-success-rate">75%</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="cultivation-banner mb-2">Use Spirit Stones to Boost Success Rate</div>
                            <div class="flex flex-wrap justify-center gap-2 mb-4">
                                <div class="spirit-stone stone-basic tooltip" data-type="basic" data-count="0">
                                    <span class="tooltiptext">Basic Spirit Stone: +1% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                                <div class="spirit-stone stone-low tooltip" data-type="low" data-count="0">
                                    <span class="tooltiptext">Low-Grade Spirit Stone: +5% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                                <div class="spirit-stone stone-medium tooltip" data-type="medium" data-count="0">
                                    <span class="tooltiptext">Medium-Grade Spirit Stone: +10% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                                <div class="spirit-stone stone-high tooltip" data-type="high" data-count="0">
                                    <span class="tooltiptext">High-Grade Spirit Stone: +15% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                                <div class="spirit-stone stone-supreme tooltip" data-type="supreme" data-count="0">
                                    <span class="tooltiptext">Supreme-Grade Spirit Stone: +20% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                                <div class="spirit-stone stone-divine tooltip" data-type="divine" data-count="0">
                                    <span class="tooltiptext">Divine-Grade Spirit Stone: +25% success rate</span>
                                    <span class="stone-count">0</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                <div>Selected Stones:</div>
                                <div id="selected-stones">None</div>
                                
                                <div>Success Boost:</div>
                                <div id="success-boost">+0%</div>
                            </div>
                            
                            <button id="clear-stones" class="ancient-button w-full mb-4">Clear Selected Stones</button>
                            
                            <button id="attempt-breakthrough" class="ancient-button w-full" disabled>
                                Attempt Breakthrough (Insufficient Qi)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div id="tasks-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Task Management -->
                    <div class="ancient-border rounded-lg p-4">
                        <h2 class="text-2xl font-bold mb-4 cultivation-banner">Task Management</h2>
                        
                        <div class="mb-4">
                            <label class="block mb-1">Task Name:</label>
                            <input type="text" id="task-name" class="ancient-input w-full mb-2" placeholder="Enter task name">
                            
                            <label class="block mb-1">Tags (comma separated):</label>
                            <input type="text" id="task-tags" class="ancient-input w-full mb-2" placeholder="work, study, exercise, etc.">
                            
                            <button id="add-task" class="ancient-button w-full">Add Task</button>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold">Task List</h3>
                                <div class="flex gap-2">
                                    <select id="sort-tasks" class="ancient-input text-sm">
                                        <option value="name-asc">Sort by Name (A-Z)</option>
                                        <option value="name-desc">Sort by Name (Z-A)</option>
                                        <option value="tag-asc">Sort by Tag (A-Z)</option>
                                        <option value="tag-desc">Sort by Tag (Z-A)</option>
                                        <option value="completion-asc">Sort by Completion (Low-High)</option>
                                        <option value="completion-desc">Sort by Completion (High-Low)</option>
                                    </select>
                                    <button id="select-all-tasks" class="ancient-button text-sm px-2">Select All</button>
                                </div>
                            </div>
                            
                            <div id="task-list" class="scroll-container ancient-scroll p-4">
                                <p class="text-center italic">No tasks added yet</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button id="edit-selected-task" class="ancient-button" disabled>Edit Selected</button>
                            <button id="delete-selected-tasks" class="ancient-button" disabled>Delete Selected</button>
                        </div>
                    </div>

                    <!-- Task Generator -->
                    <div class="ancient-border rounded-lg p-4">
                        <h2 class="text-2xl font-bold mb-4 cultivation-banner">Task Generator</h2>
                        
                        <div class="mb-4">
                            <label class="block mb-1">Number of tasks to generate:</label>
                            <input type="number" id="task-count" class="ancient-input w-full" min="1" max="10" value="1">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block mb-1">Filter by tags (optional):</label>
                            <input type="text" id="filter-tags" class="ancient-input w-full" placeholder="Leave empty to include all tags">
                        </div>
                        
                        <button id="generate-tasks" class="ancient-button w-full mb-4">Generate Tasks</button>
                        
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Generated Tasks</h3>
                            <div id="generated-tasks" class="scroll-container ancient-scroll p-4 min-h-[200px]">
                                <p class="text-center italic">No tasks generated yet</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button id="complete-all-tasks" class="ancient-button" disabled>Complete All</button>
                            <button id="give-up-tasks" class="ancient-button" disabled>Give Up (Qi Penalty)</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pomodoro Tab -->
            <div id="pomodoro-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Pomodoro Cultivation</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Timer Display -->
                        <div class="timer-container">
                            <div class="timer-display" id="timer-display">25:00</div>
                            <div class="timer-progress">
                                <div class="timer-progress-bar" id="timer-progress-bar"></div>
                            </div>
                            <div id="break-indicator" class="break-indicator hidden">Break Time</div>
                            <div class="timer-controls">
                                <button id="timer-start" class="timer-button">
                                    <i class="fas fa-play"></i> Start
                                </button>
                                <button id="timer-pause" class="timer-button" disabled>
                                    <i class="fas fa-pause"></i> Pause
                                </button>
                                <button id="timer-reset" class="timer-button">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>
                        
                        <!-- Timer Settings -->
                        <div class="timer-settings">
                            <h3 class="text-xl font-bold mb-4 cultivation-banner">Session Settings</h3>
                            
                            <div class="mb-4">
                                <label class="block mb-1">Focus Duration (minutes):</label>
                                <input type="range" id="focus-duration" class="ancient-range w-full" min="5" max="25" step="5" value="25">
                                <div class="flex justify-between text-sm mt-1">
                                    <span>5 min</span>
                                    <span id="focus-duration-display">25 min</span>
                                    <span>25 min</span>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block mb-1">Break Duration (minutes):</label>
                                <input type="range" id="break-duration" class="ancient-range w-full" min="0" max="10" step="1" value="5">
                                <div class="flex justify-between text-sm mt-1">
                                    <span>0 min</span>
                                    <span id="break-duration-display">5 min</span>
                                    <span>10 min</span>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between items-center">
                                    <label>Use Break Time:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="use-break" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <p class="text-sm mt-1 italic">When enabled, a break timer will start after each focus session</p>
                            </div>
                            
                            <div id="pomodoro-boost-info" class="mt-6 p-3 border border-ancient-accent rounded">
                                <h4 class="font-bold mb-2">Current Boosts:</h4>
                                <div id="active-pomodoro-boost" class="hidden">
                                    <p>You have a pomodoro boost active!</p>
                                    <p>Your next <span id="remaining-boosted-tasks">0</span> task completions will receive double qi rewards.</p>
                                </div>
                                <div id="no-pomodoro-boost">
                                    <p class="italic">No active pomodoro boosts</p>
                                </div>
                                <div class="mt-3">
                                    <p class="text-sm">
                                        <i class="fas fa-info-circle mr-1"></i> Complete a 15-25 minute focus session to receive boosts:
                                    </p>
                                    <ul class="list-disc pl-6 text-sm mt-1">
                                        <li>15 minutes: x2 qi for 5 task completions</li>
                                        <li>20 minutes: x2 qi for 8 task completions</li>
                                        <li>25 minutes: x2 qi for 10 task completions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-4 cultivation-banner">Session History</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-center">
                            <div class="ancient-scroll p-3">
                                <div class="text-3xl font-bold" id="total-sessions">0</div>
                                <div>Sessions Completed</div>
                            </div>
                            <div class="ancient-scroll p-3">
                                <div class="text-3xl font-bold" id="total-focus-time">0</div>
                                <div>Minutes Focused</div>
                            </div>
                            <div class="ancient-scroll p-3">
                                <div class="text-3xl font-bold" id="total-boosts-earned">0</div>
                                <div>Boosts Earned</div>
                            </div>
                            <div class="ancient-scroll p-3">
                                <div class="text-3xl font-bold" id="total-boosted-tasks">0</div>
                                <div>Tasks Boosted</div>
                            </div>
                        </div>
                        
                        <div id="session-history" class="scroll-container ancient-scroll p-4">
                            <p class="text-center italic">No sessions completed yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Spirit Stone Inventory</h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-basic mx-auto mb-2"></div>
                            <h3 class="font-bold">Basic Spirit Stone</h3>
                            <p>Count: <span id="basic-stone-count">0</span></p>
                            <button class="ancient-button mt-2 text-sm" data-stone="basic" disabled>Fuse 100 → Low-Grade</button>
                        </div>
                        
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-low mx-auto mb-2"></div>
                            <h3 class="font-bold">Low-Grade Spirit Stone</h3>
                            <p>Count: <span id="low-stone-count">0</span></p>
                            <button class="ancient-button mt-2 text-sm" data-stone="low" disabled>Fuse 100 → Medium-Grade</button>
                        </div>
                        
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-medium mx-auto mb-2"></div>
                            <h3 class="font-bold">Medium-Grade Spirit Stone</h3>
                            <p>Count: <span id="medium-stone-count">0</span></p>
                            <button class="ancient-button mt-2 text-sm" data-stone="medium" disabled>Fuse 100 → High-Grade</button>
                        </div>
                        
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-high mx-auto mb-2"></div>
                            <h3 class="font-bold">High-Grade Spirit Stone</h3>
                            <p>Count: <span id="high-stone-count">0</span></p>
                            <button class="ancient-button mt-2 text-sm" data-stone="high" disabled>Fuse 100 → Supreme-Grade</button>
                        </div>
                        
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-supreme mx-auto mb-2"></div>
                            <h3 class="font-bold">Supreme-Grade Spirit Stone</h3>
                            <p>Count: <span id="supreme-stone-count">0</span></p>
                            <button class="ancient-button mt-2 text-sm" data-stone="supreme" disabled>Fuse 100 → Divine-Grade</button>
                        </div>
                        
                        <div class="ancient-scroll p-4 text-center">
                            <div class="spirit-stone stone-divine mx-auto mb-2"></div>
                            <h3 class="font-bold">Divine-Grade Spirit Stone</h3>
                            <p>Count: <span id="divine-stone-count">0</span></p>
                            <p class="text-sm mt-2 italic">Highest tier available</p>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h2 class="text-2xl font-bold mb-4 cultivation-banner">Special Items</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="ancient-scroll p-4 text-center">
                                <div class="spirit-stone stone-rename mx-auto mb-2"></div>
                                <h3 class="font-bold">Rename Scroll</h3>
                                <p>Count: <span id="rename-scroll-count">0/1</span></p>
                                <button id="use-rename-scroll" class="ancient-button mt-2 text-sm" disabled>Use Scroll</button>
                                <p class="text-xs mt-1 italic">Allows you to change your cultivator name</p>
                            </div>
                            
                            <!-- Space for future special items -->
                            <div class="ancient-scroll p-4 text-center opacity-50">
                                <div class="mx-auto mb-2 text-4xl">?</div>
                                <h3 class="font-bold">Unknown Item</h3>
                                <p class="italic text-sm">Yet to be discovered</p>
                            </div>
                            
                            <div class="ancient-scroll p-4 text-center opacity-50">
                                <div class="mx-auto mb-2 text-4xl">?</div>
                                <h3 class="font-bold">Unknown Item</h3>
                                <p class="italic text-sm">Yet to be discovered</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <div class="spoiler-header">
                            <h3 class="text-xl font-bold">Spirit Stone Effects</h3>
                            <i class="fas fa-chevron-down spoiler-icon"></i>
                        </div>
                        <div class="spoiler-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div class="ancient-scroll p-4">
                                    <h4 class="font-bold mb-2">Base Effects</h4>
                                    <ul class="list-disc pl-4">
                                        <li>Basic Spirit Stone: +1% breakthrough success</li>
                                        <li>Low-Grade Spirit Stone: +5% breakthrough success</li>
                                        <li>Medium-Grade Spirit Stone: +10% breakthrough success</li>
                                        <li>High-Grade Spirit Stone: +15% breakthrough success</li>
                                        <li>Supreme-Grade Spirit Stone: +20% breakthrough success</li>
                                        <li>Divine-Grade Spirit Stone: +25% breakthrough success</li>
                                    </ul>
                                </div>
                                
                                <div class="ancient-scroll p-4">
                                    <h4 class="font-bold mb-2">Realm Effectiveness</h4>
                                    <p class="mb-2">Lower spirit stones have reduced effectiveness in higher realms:</p>
                                    <ul class="list-disc pl-4">
                                        <li>3 realms above: 25% effectiveness</li>
                                        <li>2 realms above: 50% effectiveness</li>
                                        <li>1 realm above: 75% effectiveness</li>
                                        <li>Same realm or below: 100% effectiveness</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fellow Cultivators Tab -->
            <div id="fellowCultivators-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Fellow Cultivators</h2>
                    
                    <div class="mb-6">
                        <p class="mb-4">Fellow cultivators you meet on your journey can boost your idle cultivation rate temporarily.</p>
                        
                        <div class="ancient-scroll p-4 mb-4">
                            <h3 class="font-bold mb-2">Current Boost Status</h3>
                            <div id="fc-boost-status" class="text-center">
                                <p id="fc-no-boost" class="italic">No active boost from fellow cultivators</p>
                                <div id="fc-active-boost" class="hidden">
                                    <p>Your idle cultivation rate is currently <span class="font-bold">doubled</span>!</p>
                                    <p>Time remaining: <span id="fc-boost-time-remaining" class="font-bold">0 minutes</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ancient-scroll p-4 mb-4">
                            <h3 class="font-bold mb-2">Last Encounter</h3>
                            <div id="fc-last-encounter" class="text-center">
                                <p id="fc-no-encounters" class="italic">You haven't met any fellow cultivators yet</p>
                                <div id="fc-last-encounter-details" class="hidden">
                                    <p id="fc-last-encounter-message"></p>
                                    <p class="text-sm italic mt-2">Encountered <span id="fc-last-encounter-time"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold mb-4 cultivation-banner">Manage Cultivators</h3>
                            <div class="mb-4">
                                <label class="block mb-1">Add New Cultivator:</label>
                                <div class="flex gap-2">
                                    <input type="text" id="new-cultivator-name" class="ancient-input flex-grow" placeholder="Enter name">
                                    <button id="add-cultivator" class="ancient-button">Add</button>
                                </div>
                                <p id="cultivators-added-today" class="text-xs mt-1">Cultivators added today: 0/5</p>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block mb-1">Edit Custom Cultivator:</label>
                                <div class="flex gap-2">
                                    <select id="edit-cultivator-select" class="ancient-input flex-grow">
                                        <option value="">Select a cultivator</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="edit-cultivator-form" class="mb-4 hidden">
                                <label class="block mb-1">New Name:</label>
                                <div class="flex gap-2">
                                    <input type="text" id="edit-cultivator-name" class="ancient-input flex-grow">
                                    <button id="save-cultivator-edit" class="ancient-button">Save</button>
                                </div>
                                <p id="edit-cooldown-info" class="text-xs mt-1 hidden">Cannot edit until: <span id="edit-available-time"></span></p>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block mb-1">Remove Custom Cultivator:</label>
                                <div class="flex gap-2">
                                    <select id="remove-cultivator-select" class="ancient-input flex-grow">
                                        <option value="">Select a cultivator</option>
                                    </select>
                                    <button id="remove-cultivator" class="ancient-button">Remove</button>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-xl font-bold mb-4 cultivation-banner">Cultivator Pool</h3>
                            
                            <!-- Built-in Cultivators Spoiler -->
                            <div class="spoiler-header mb-2">
                                <span>Built-in Cultivators (<span id="builtin-cultivator-count">0</span>)</span>
                                <i class="fas fa-chevron-down spoiler-icon"></i>
                            </div>
                            <div class="spoiler-content mb-4">
                                <div id="builtin-cultivator-pool" class="scroll-container mt-2" style="max-height: 200px; overflow-y: auto;">
                                    <p id="no-builtin-cultivators-message" class="text-center italic">No built-in cultivators</p>
                                </div>
                            </div>
                            
                            <!-- Custom Cultivators Spoiler -->	
                            <div class="spoiler-header mb-2">
                                <span>Custom Cultivators (<span id="custom-cultivators-count">0</span>)</span>
                                <i class="fas fa-chevron-down spoiler-icon"></i>
                            </div>
                            <div class="spoiler-content">
                                <div id="custom-cultivator-pool" class="scroll-container mt-2" style="max-height: 200px; overflow-y: auto;">
                                    <p id="no-custom-cultivators-message" class="text-center italic">No custom cultivators added yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <div class="spoiler-header">
                            <h3 class="text-xl font-bold">Fellow Cultivator Information</h3>
                            <i class="fas fa-chevron-down spoiler-icon"></i>
                        </div>
                        <div class="spoiler-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div class="ancient-scroll p-4">
                                    <h4 class="font-bold mb-2">Meeting Chances</h4>
                                    <p class="mb-2">Chance to meet a fellow cultivator after returning:</p>
                                    <ul class="list-disc pl-4">
                                        <li>Offline for 10 minutes: 10% chance</li>
                                        <li>Offline for 30 minutes: 20% chance</li>
                                        <li>Offline for 60+ minutes: 30% chance</li>
                                    </ul>
                                </div>
                                
                                <div class="ancient-scroll p-4">
                                    <h4 class="font-bold mb-2">Boost Effects</h4>
                                    <ul class="list-disc pl-4">
                                        <li>Meeting a fellow cultivator doubles your idle cultivation rate</li>
                                        <li>Boost duration ranges from 60-120 minutes randomly</li>
                                        <li>Multiple boosts can stack, but total boost time is capped at 10 hours</li>
                                        <li>There's no limit to how many fellow cultivators you can meet each day</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements Tab -->
            <div id="achievements-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Cultivation Achievements</h2>
                    
                    <!-- Achievement Summary -->
                    <div class="achievement-summary mb-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <div class="text-2xl font-bold" id="achievement-total-count">0/0</div>
                                <div>Achievements Completed</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="achievement-percent">0%</div>
                                <div>Completion Rate</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="achievement-latest">None</div>
                                <div>Latest Achievement</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" id="achievement-rarest">None</div>
                                <div>Rarest Achievement</div>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap justify-center gap-4">
                            <div>
                                <span class="achievement-rarity-indicator achievement-common"></span>
                                <span>Common</span>
                            </div>
                            <div>
                                <span class="achievement-rarity-indicator achievement-uncommon"></span>
                                <span>Uncommon</span>
                            </div>
                            <div>
                                <span class="achievement-rarity-indicator achievement-rare"></span>
                                <span>Rare</span>
                            </div>
                            <div>
                                <span class="achievement-rarity-indicator achievement-epic"></span>
                                <span>Epic</span>
                            </div>
                            <div>
                                <span class="achievement-rarity-indicator achievement-legendary"></span>
                                <span>Legendary</span>
                            </div>
                            <div>
                                <span class="achievement-rarity-indicator achievement-mythic"></span>
                                <span>Mythic</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Achievement Categories -->
                    <div class="achievement-tabs" id="achievement-tabs">
                        <div class="achievement-tab active" data-category="all">All <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="cultivation">Cultivation <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="tasks">Tasks <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="stones">Spirit Stones <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="cultivators">Fellow Cultivators <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="pomodoro">Pomodoro <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="misc">Miscellaneous <span class="achievement-count">0</span></div>
                        <div class="achievement-tab" data-category="hidden">Hidden <span class="achievement-count">0</span></div>
                    </div>
                    
                    <!-- Achievement List -->
                    <div id="achievement-list" class="scroll-container ancient-scroll p-4">
                        <p class="text-center italic">Loading achievements...</p>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="statistics-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Cultivation Statistics</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="ancient-scroll p-4">
                            <h3 class="font-bold mb-2">Task Statistics</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div>Total Existing Tasks:</div>
                                <div id="stat-total-tasks">0</div>
                                
                                <div>Total Completed Tasks:</div>
                                <div id="stat-completed-tasks">0</div>
                                
                                <div>Average Qi/Task:</div>
                                <div id="stat-avg-qi">0</div>
                                
                                <div>Average Stones/Task:</div>
                                <div id="stat-avg-stones">0</div>
                                
                                <div>Most Completed Task:</div>
                                <div id="stat-most-completed-task">None</div>
                                
                                <div>Most Active Tag:</div>
                                <div id="stat-most-active-tag">None</div>

                                <div>Pomodoro Boosted Tasks:</div>
                                <div id="stat-pomodoro-boosted-tasks">0</div>
                            </div>
                        </div>
                        
                        <div class="ancient-scroll p-4">
                            <h3 class="font-bold mb-2">Breakthrough Statistics</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div>Total Breakthroughs:</div>
                                <div id="stat-breakthroughs">0</div>
                                
                                <div>Failed Attempts:</div>
                                <div id="stat-failed-attempts">0</div>
                                
                                <div>Success Rate:</div>
                                <div id="stat-success-rate">0%</div>
                                
                                <div>Highest Realm Reached:</div>
                                <div id="stat-highest-realm">Mortal</div>
                                
                                <div>Total Qi Earned:</div>
                                <div id="stat-total-qi">0</div>
                                
                                <div>Passive Qi (%):</div>
                                <div id="stat-passive-qi">0%</div>

                                <div>Pomodoro Bonus Qi:</div>
                                <div id="stat-pomodoro-qi">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Spirit Stone Statistics</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p>Basic Spirit Stones Found:</p>
                                <p id="stat-basic-stones" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Low-Grade Spirit Stones Found:</p>
                                <p id="stat-low-stones" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Medium-Grade Spirit Stones Found:</p>
                                <p id="stat-medium-stones" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>High-Grade Spirit Stones Found:</p>
                                <p id="stat-high-stones" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Supreme-Grade Spirit Stones Found:</p>
                                <p id="stat-supreme-stones" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Divine-Grade Spirit Stones Found:</p>
                                <p id="stat-divine-stones" class="font-bold">0</p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="font-bold mb-2">Spirit Stones Fused:</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <p>Basic → Low-Grade:</p>
                                    <p id="stat-basic-fused" class="font-bold">0</p>
                                </div>
                                <div class="text-center">
                                    <p>Low → Medium-Grade:</p>
                                    <p id="stat-low-fused" class="font-bold">0</p>
                                </div>
                                <div class="text-center">
                                    <p>Medium → High-Grade:</p>
                                    <p id="stat-medium-fused" class="font-bold">0</p>
                                </div>
                                <div class="text-center">
                                    <p>High → Supreme-Grade:</p>
                                    <p id="stat-high-fused" class="font-bold">0</p>
                                </div>
                                <div class="text-center">
                                    <p>Supreme → Divine-Grade:</p>
                                    <p id="stat-supreme-fused" class="font-bold">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="font-bold mb-2">Special Items:</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <p>Rename Scrolls Found:</p>
                                    <p id="stat-rename-scrolls" class="font-bold">0</p>
                                </div>
                                <div class="text-center">
                                    <p>Rename Scrolls Used:</p>
                                    <p id="stat-rename-scrolls-used" class="font-bold">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Fellow Cultivator Statistics</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p>Fellow Cultivators Met:</p>
                                <p id="stat-cultivators-met" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Total Boost Time (Hours):</p>
                                <p id="stat-total-boost-time" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Extra Qi from Boosts:</p>
                                <p id="stat-qi-from-boosts" class="font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Pomodoro Statistics</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p>Sessions Completed:</p>
                                <p id="stat-pomodoro-sessions" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Total Focus Time (Minutes):</p>
                                <p id="stat-focus-minutes" class="font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p>Boosts Earned:</p>
                                <p id="stat-boosts-earned" class="font-bold">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Achievement Statistics</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p>Total Achievements:</p>
                                <p id="stat-total-achievements" class="font-bold">0/0</p>
                            </div>
                            <div class="text-center">
                                <p>Completion Rate:</p>
                                <p id="stat-achievement-rate" class="font-bold">0%</p>
                            </div>
                            <div class="text-center">
                                <p>Hidden Achievements Found:</p>
                                <p id="stat-hidden-achievements" class="font-bold">0/0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Cultivation Analytics</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="ancient-scroll p-4">
                            <h3 class="font-bold mb-2">Qi Acquisition</h3>
                            <div class="mb-4">
                                <p class="mb-1">Qi Source Distribution:</p>
                                <div class="qi-source-bar">
                                    <div id="qi-source-active" class="qi-active" style="width: 70%; float: left;"></div>
                                    <div id="qi-source-passive" class="qi-passive" style="width: 30%; float: left;"></div>
                                </div>
                                <div class="flex justify-between text-xs mt-1">
                                    <span>Active: <span id="qi-active-percent">70%</span></span>
                                    <span>Passive: <span id="qi-passive-percent">30%</span></span>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <p class="mb-1">Qi Efficiency (Qi/Task Average):</p>
                                <div class="chart-container">
                                    <canvas id="qi-efficiency-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ancient-scroll p-4">
                            <h3 class="font-bold mb-2">Task Completion Patterns</h3>
                            <div class="mb-4">
                                <p class="mb-1">Tasks by Tag:</p>
                                <div class="chart-container">
                                    <canvas id="tasks-by-tag-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Cultivation Journey</h3>
                        <div class="ancient-scroll p-4">
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="cultivation-journey-chart"></canvas>
                            </div>
                            <p class="text-center text-sm italic mt-2">Your cultivation progress over time</p>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Activity Heatmap</h3>
                        <div class="ancient-scroll p-4">
                            <div class="mb-4">
                                <p class="mb-1">Task Completion by Day of Week:</p>
                                <div class="chart-container" style="height: 150px;">
                                    <canvas id="activity-heatmap-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-2 cultivation-banner">Pomodoro Analysis</h3>
                        <div class="ancient-scroll p-4">
                            <div class="mb-4">
                                <p class="mb-1">Focus Sessions by Duration:</p>
                                <div class="chart-container" style="height: 200px;">
                                    <canvas id="pomodoro-duration-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content hidden">
                <div class="ancient-border rounded-lg p-4">
                    <h2 class="text-2xl font-bold mb-4 cultivation-banner">Settings</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="ancient-scroll p-4 settings-scroll">
                            <h3 class="font-bold mb-4">Game Data</h3>
                            
                            <button id="export-game" class="ancient-button w-full mb-2">Export Game Data</button>
                            <button id="manual-save" class="ancient-button w-full mb-4">Manual Save</button>
                            
                            <div class="mb-4">
                                <label class="block mb-1">Import Game Data:</label>
<textarea id="import-data" class="ancient-input w-full h-20" placeholder="Paste encoded game data here"></textarea>
                                <button id="import-game" class="ancient-button w-full mt-2">Import Game Data</button>
                            </div>
                            
                            <div class="border-t border-ancient-accent pt-4 mb-4">
                                <h4 class="font-bold mb-2">Cultivator Settings</h4>
                                <div class="mb-4">
                                    <label class="block mb-1">Change Cultivator Name:</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="settings-cultivator-name" class="ancient-input flex-grow" placeholder="Enter new name">
                                        <button id="settings-change-name" class="ancient-button" disabled>Change</button>
                                    </div>
                                    <p class="text-xs mt-1 italic">Requires a Rename Scroll</p>
                                </div>
                            </div>
                            
                            <div class="border-t border-ancient-accent pt-4">
                                <h4 class="font-bold mb-2">Reset Options</h4>
                                <button id="reset-stats" class="ancient-button w-full mb-2">Reset Statistics Only</button>
                                <button id="hard-reset" class="ancient-button w-full">Hard Reset (Delete ALL Data)</button>
                            </div>
                        </div>
                        
                        <div class="ancient-scroll p-4 settings-scroll">
                            <h3 class="font-bold mb-4">Display Settings</h3>
                            
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label>Theme:</label>
                                    <select id="theme-select" class="ancient-input text-sm">
                                        <option value="default">Default</option>
                                        <option value="bw">Black & White</option>
                                        <option value="retro">Retro</option>
                                        <option value="oriental">Oriental</option>
                                        <option value="modern">Modern</option>
                                        <option value="neon">Neon</option>
                                    </select>
                                </div>
                                
                                <div class="flex justify-between items-center mb-4">
                                    <label>Mode:</label>
                                    <div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="theme-mode-toggle">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span id="theme-mode-label" class="ml-2">Light</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4 border-t border-ancient-accent pt-4">
                                <h4 class="font-bold mb-2">Number Format</h4>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Use Scientific Notation:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="use-scientific-notation">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <p class="text-xs italic mb-2">For very large numbers (e.g., 1.23e6 instead of 1,230,000)</p>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Scientific Notation Threshold:</label>
                                    <select id="scientific-notation-threshold" class="ancient-input text-sm">
                                        <option value="1000">1,000</option>
                                        <option value="10000">10,000</option>
                                        <option value="100000">100,000</option>
                                        <option value="1000000" selected>1,000,000</option>
                                        <option value="10000000">10,000,000</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-4 border-t border-ancient-accent pt-4">
                                <h4 class="font-bold mb-2">Task Display</h4>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Show Task Completion Count:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="show-completion-count" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-4 border-t border-ancient-accent pt-4">
                                <h4 class="font-bold mb-2">Fellow Cultivator Settings</h4>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Only Meet Custom Cultivators:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="only-meet-custom-cultivators">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <p class="text-xs italic mb-4">When enabled, you will only meet cultivators you've added yourself</p>
                            </div>
                            
                            <div class="mb-4 border-t border-ancient-accent pt-4">
                                <h4 class="font-bold mb-2">Notifications</h4>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Breakthrough Readiness:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-breakthrough" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Idle Rewards:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-idle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Cultivation Milestones:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-milestone" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <div class="flex justify-between items-center mb-2">
                                    <label>Fellow Cultivator Meetings:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-fellowCultivator" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Achievement Unlocks:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-achievement" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="flex justify-between items-center mb-2">
                                    <label>Pomodoro Completions:</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notification-pomodoro" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="border-t border-ancient-accent pt-4">
                                <h3 class="font-bold mb-2">Community & Help</h3>
                                <a href="https://forms.gle/F1tVaUjSG4MsDx779" target="_blank" class="ancient-button w-full block text-center mb-4">Submit Fellow Cultivator Name</a>
                                <button id="show-tutorial" class="ancient-button w-full mb-4">Show Tutorial</button>
                                <a href="https://docs.google.com/document/d/1TisAFgWHv7tHcyO51MzZogOyMkQok9JolQZS3AEe3fw/edit?usp=sharing" target="_blank" class="ancient-button w-full block text-center mb-4">Patch Notes</a>
                                
                                <h3 class="font-bold mb-2">About</h3>
                                <p class="mb-1">青云修仙录 (Qing Yun Xiu Xian Lu) is a task management and cultivation simulation game that helps you overcome procrastination while progressing through various cultivation realms.</p>
                                <p class="text-right mb-4">Ver 1.5</p>
                                
                                <h4 class="font-bold mb-1">Features:</h4>
                                <ul class="list-disc pl-4 mb-4">
                                    <li>Task management with tags</li>
                                    <li>Pomodoro timer with rewards</li>
                                    <li>Random task generation</li>
                                    <li>Cultivation progression system</li>
                                    <li>Spirit stone collection and fusion</li>
                                    <li>Breakthrough mechanics</li>
                                    <li>Idle cultivation progression</li>
                                    <li>Fellow cultivator encounters</li>
                                    <li>Achievement system</li>
                                    <li>Customizable themes</li>
                                    <li>Detailed analytics</li>
                                </ul>
                                
                                <div class="text-center mt-6">
                                    <p class="mb-2">Developed by CygRyu</p>
                                    <div class="flex justify-center space-x-4">
                                        <a href="https://ko-fi.com/cygryu" target="_blank" class="ancient-button">Ko-Fi</a>
                                        <a href="https://www.paypal.com/paypalme/sofiansu?country.x=ID&locale.x=en_US" target="_blank" class="ancient-button">PayPal</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div id="modal-content" class="ancient-border rounded-lg p-6 max-w-md w-full mx-4">
            <div id="modal-header" class="text-xl font-bold mb-4 cultivation-banner">Modal Title</div>
            <div id="modal-body" class="mb-4">Modal content goes here</div>
            <div id="modal-footer" class="flex justify-end space-x-2">
                <button id="modal-cancel" class="ancient-button">Cancel</button>
                <button id="modal-confirm" class="ancient-button">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-40"></div>

    <!-- Custom Notifications Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 flex flex-col gap-3"></div>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex items-center justify-center">
        <div id="tutorial-content" class="ancient-border rounded-lg p-6 max-w-2xl w-full mx-4">
            <div class="text-xl font-bold mb-4 cultivation-banner">Tutorial</div>
            <div id="tutorial-body" class="mb-4 scroll-container" style="max-height: 70vh; overflow-y: auto;">
                <!-- Tutorial content will be populated here -->
            </div>
            <div class="flex justify-between">
                <button id="tutorial-prev" class="ancient-button" disabled>Previous</button>
                <button id="tutorial-skip" class="ancient-button">Skip Tutorial</button>
                <div>
                    <span id="tutorial-page">1/9</span>
                </div>
                <button id="tutorial-next" class="ancient-button">Next</button>
            </div>
        </div>
    </div>

    <!-- Name Change Modal -->
    <div id="name-change-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="ancient-border rounded-lg p-6 max-w-md w-full mx-4">
            <div class="text-xl font-bold mb-4 cultivation-banner">Set Cultivator Name</div>
            <div class="mb-4">
                <p class="mb-2">Choose a name for your cultivation journey:</p>
                <input type="text" id="cultivator-name-input" class="ancient-input w-full" placeholder="Enter your cultivator name" maxlength="30">
                <p class="text-sm mt-2 italic" id="rename-warning">
                    Note: Changing your name after this initial setup will require a Rename Scroll, which is a rare item that can be found by completing tasks.
                </p>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="name-change-cancel" class="ancient-button">Cancel</button>
                <button id="name-change-confirm" class="ancient-button">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Achievement Unlock Modal -->
    <div id="achievement-unlock-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="ancient-border rounded-lg p-6 max-w-md w-full mx-4">
            <div class="text-xl font-bold mb-4 cultivation-banner">Achievement Unlocked!</div>
            <div class="flex items-center mb-4">
                <div id="achievement-unlock-icon" class="achievement-icon achievement-common mr-4">
                    <i class="fas fa-trophy"></i>
                </div>
                <div>
                    <h3 id="achievement-unlock-title" class="text-xl font-bold">Achievement Title</h3>
                    <p id="achievement-unlock-description" class="mt-2">Achievement description here</p>
                </div>
            </div>
            <div class="flex justify-end">
                <button id="achievement-unlock-confirm" class="ancient-button">Continue</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            version: '1.5',
            player: {
                name: 'Unnamed Cultivator',
                realm: 0,
                stage: 1,
                qi: 0,
                lastUpdated: Date.now(),
                lastBreakthroughCheck: Date.now(),
                reachedMilestones: {
                    realms: [0],  // Tracks which realms have been reached for notification purposes
                    stages: {}    // Tracks which stages have been reached for each realm
                }
            },
            tasks: [],
            generatedTasks: [],
            stones: {
                basic: 0,
                low: 0,
                medium: 0,
                high: 0,
                supreme: 0,
                divine: 0,
                rename: 0  // Rename scroll item
            },
            selectedStones: {
                basic: 0,
                low: 0,
                medium: 0,
                high: 0,
                supreme: 0,
                divine: 0
            },
            stats: {
                totalTasks: 0,
                completedTasks: 0,
                totalQiEarned: 0,
                totalQiPassive: 0,  // Track passive qi gains
                totalQiPomodoro: 0, // Track qi gained from pomodoro boosts
                totalStonesFound: {
                    basic: 0,
                    low: 0,
                    medium: 0,
                    high: 0,
                    supreme: 0,
                    divine: 0,
                    rename: 0  // Track rename scrolls found
                },
                stonesFused: {
                    basic: 0,
                    low: 0,
                    medium: 0,
                    high: 0,
                    supreme: 0
                },
                breakthroughs: 0,
                failedAttempts: 0,
                highestRealmReached: 0,
                renameScrollsUsed: 0,  // Track rename scrolls used
                taskHistory: [],  // Store task completion history for analytics
                completionByTag: {},  // Track completions by tag
                completionByDayOfWeek: [0, 0, 0, 0, 0, 0, 0],  // [Sun, Mon, Tue, Wed, Thu, Fri, Sat]
                cultivatorsMet: 0,
                totalBoostTime: 0,
                qiFromBoosts: 0,
                // Pomodoro stats
                pomodoroSessions: 0,
                pomodoroTotalMinutes: 0,
                pomodoroBoostsEarned: 0,
                pomodoroTasksCompleted: 0
            },
            notifications: {
                settings: {
                    breakthroughReadiness: true,
                    idleRewards: true,
                    cultivationMilestones: true,
                    fellowCultivator: true,
                    achievement: true,
                    pomodoro: true
                },
                history: []  // To store past notifications if needed
            },
            settings: {
                theme: 'default',
                darkMode: false,
                showCompletionCount: true,
                onlyMeetCustomCultivators: false,
                useScientificNotation: false,
                scientificNotationThreshold: 1000000
            },
            analytics: {
                qiEfficiency: [],  // Store average qi per task over time
                realmHistory: [],  // Store realm advancement history with timestamps
                lastAnalyticsUpdate: Date.now(),
                pomodoroByDuration: {
                    5: 0,
                    10: 0,
                    15: 0,
                    20: 0,
                    25: 0
                }
            },
            fellowCultivators: {
                pool: [],
                meetings: [],
                boostEndTime: 0,
                lastMeetingTime: 0,
                lastEncounter: null,
                addedToday: 0,
                dayLastAdded: null
            },
            pomodoro: {
                focusDuration: 25,  // in minutes
                breakDuration: 5,   // in minutes
                useBreak: true,
                isRunning: false,
                isPaused: false,
                isBreak: false,
                timeRemaining: 25 * 60, // in seconds
                startTime: null,
                endTime: null,
                pauseTime: null,
                boostsRemaining: 0,
                lastSessionTime: null,
                history: []  // Array of session objects
            },
            achievements: {
                unlocked: {},       // Stores unlocked achievements by ID
                progress: {},       // Stores progress for each achievement
                lastUnlocked: null, // Last unlocked achievement
                discoveredHidden: [] // IDs of hidden achievements that have been discovered
            }
        };

        // Initial Fellow Cultivator Pool
        const initialFellowCultivators = [
            { id: 'fc-1', name: 'Lin Ming', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-2', name: 'Ji Ning', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-3', name: 'Wang Lin', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-4', name: 'Meng Hao', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-5', name: 'Han Li', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-6', name: 'Ye Xiu', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-7', name: 'Xiao Yan', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-8', name: 'Chu Feng', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-9', name: 'Su Ming', custom: false, editCooldown: 0, encounters: 0 },
            { id: 'fc-10', name: 'Fang Yuan', custom: false, editCooldown: 0, encounters: 0 }
        ];

	const messageComponents = {
    studyObjects: [
        "an ancient cultivation array",
        "an ancient cultivation technique", 
        "a weathered stone tablet",
        "a corpse of a spiritual beast",
        "mysterious formations carved into rock",
        "an abandoned cultivation manual",
        "strange spiritual inscriptions",
        "ancient beast bones with residual qi",
        "a meteorite emanating spiritual energy",
        "faded murals depicting cultivation methods",
        "a broken spiritual artifact",
        "crystallized spiritual essence"
    ],
    
    // Categorized activities for different contexts
    studyActivities: [
        "examining the spiritual formations together",
        "deciphering ancient inscriptions",
        "studying cultivation techniques",
        "analyzing spiritual energy patterns",
        "researching historical cultivation methods",
        "comparing notes on ancient texts"
    ],
    
    socialActivities: [
        "discussing recent cultivation breakthroughs",
        "sharing stories of your journeys", 
        "exchanging cultivation insights",
        "comparing martial arts techniques",
        "trading rare cultivation resources",
        "debating philosophical aspects of the dao"
    ],
    
    adventureActivities: [
        "hunting powerful spiritual beasts",
        "tackling a rogue cultivator together",
        "exploring dangerous territories",
        "fighting off beast attacks",
        "searching for rare spiritual herbs",
        "investigating mysterious phenomena"
    ],
    
    peacefulActivities: [
        "meditating in harmony with nature",
        "practicing breathing techniques",
        "enjoying the tranquil atmosphere",
        "reflecting on your cultivation paths",
        "sharing a moment of spiritual connection",
        "appreciating the natural spiritual energy"
    ],
    
    // Categorized locations
    studyLocations: [
        "an ancient library",
        "a hidden cave filled with inscriptions", 
        "the ruins of an old sect",
        "a forgotten cultivation chamber",
        "an abandoned research facility",
        "a sacred archive"
    ],
    
    socialLocations: [
        "a bustling marketplace",
        "a popular teahouse",
        "the sect's main hall",
        "a crowded inn",
        "the city's central plaza",
        "a well-known restaurant"
    ],
    
    adventureLocations: [
        "a dangerous beast's lair",
        "the treacherous mountain pass",
        "a monster-infested forest",
        "the chaotic borderlands", 
        "a collapsing ancient tomb",
        "a volatile spiritual vortex area"
    ],
    
    peacefulLocations: [
        "a serene lotus pond",
        "a tranquil bamboo grove",
        "a quiet mountain peak",
        "a secluded waterfall",
        "a peaceful spirit spring",
        "a beautiful flower garden",
        "a calm riverside"
    ],
    
    gatherings: [
        "alchemy conference",
        "martial arts tournament",
        "cultivation seminar", 
        "artifact auction",
        "sect gathering",
        "lantern festival",
        "trade fair",
        "spiritual beast exhibition",
        "cultivation technique demonstration",
        "scholarly symposium"
    ],
    
    weather: [
        "during a gentle spring rain",
        "under the bright morning sun",
        "in the cool evening breeze",
        "amidst swirling autumn leaves",
        "while snow fell softly around you",
        "as storm clouds gathered overhead",
        "under a sky full of stars",
        "in the warm afternoon light",
        "during a mystical fog",
        "beneath the pale moonlight"
    ],
    
    time: [
        "at dawn",
        "in the early morning",
        "during midday",
        "in the late afternoon", 
        "at sunset",
        "in the evening",
        "late at night",
        "during the midnight hour",
        "before sunrise",
        "as day turned to night"
    ],
    
    firstMeetingEmotions: [
        "with mutual curiosity and respect",
        "in a moment of serendipitous connection",
        "with cautious but growing interest",
        "sharing an immediate sense of kinship",
        "with polite but genuine warmth",
        "in a surprisingly comfortable manner",
        "with intrigued fascination",
        "displaying natural camaraderie"
    ],
    
    repeatMeetingEmotions: [
        "with warm familiarity",
        "like old friends reuniting",
        "with genuine joy and recognition",
        "sharing comfortable companionship",
        "with the ease of trusted allies",
        "in a heartwarming reunion",
        "with mutual delight",
        "as kindred spirits meeting again"
    ]
};

        // Meeting messages for fellow cultivators
        const fellowCultivatorMessages = {
    firstMeeting: [
        // Scholarly/Study Context (Original + New)
        "While exploring [studyLocation] [time], you encountered [name] who was intently studying [studyObject]. You approached [emotion] and began [studyActivity].",
        
        "[Weather], you discovered [name] at [studyLocation], carefully examining [studyObject]. The two of you connected [emotion] while [studyActivity].",
        
        "[Time], your research led you to [studyLocation] where [name] was already engrossed in [studyObject]. [Emotion], you joined them in [studyActivity] [weather].",
        
        "Your quest for knowledge brought you to [studyLocation] [weather], where you found [name] puzzling over [studyObject]. Meeting [emotion], you offered to help with [studyActivity].",
        
        "[Weather] [time], you stumbled upon [name] at [studyLocation], who was making notes about [studyObject]. Introducing yourselves [emotion], you began [studyActivity] together.",
        
        "At [studyLocation], you noticed [name] struggling to understand [studyObject] [time]. Approaching [emotion], you suggested [studyActivity] [weather].",
        
        // Social Context (Original + New)
        "At a local [gathering] [time], [name] joined your table [emotion]. You spent the time [socialActivity] [weather].",
        
        "[Weather] during a [gathering], you met [name] [emotion]. The atmosphere was perfect for [socialActivity].",
        
        "You encountered [name] at [socialLocation] [time], and [emotion], you found yourselves [socialActivity] [weather].",
        
        "[Time] at [socialLocation], you were approached by [name] who seemed interested in conversation. [Emotion], you began [socialActivity] [weather].",
        
        "During a busy [gathering] [weather], you and [name] happened to sit near each other. [Emotion], you started [socialActivity] [time].",
        
        "[Weather], the [gathering] was in full swing when you noticed [name] looking around uncertainly. [Emotion], you invited them to join you in [socialActivity].",
        
        "While waiting for a [gathering] to begin [time], you struck up a conversation with [name] [emotion]. Soon you were [socialActivity] [weather].",
        
        "[Time] at [socialLocation], [name] overheard your conversation and politely joined in [emotion]. The three of you ended up [socialActivity] [weather].",
        
        // Adventure Context (Original + New)
        "[Time] [weather], you and [name] found yourselves at [adventureLocation]. Initially meeting [emotion], you ended up [adventureActivity] together.",
        
        "During an expedition to [adventureLocation], you met [name] while [adventureActivity]. Despite the danger, you connected [emotion] [weather].",
        
        "[Weather] [time], danger forced you and [name] to take shelter together at [adventureLocation]. [Emotion], you worked together [adventureActivity].",
        
        "Your path led to [adventureLocation] [time], where you encountered [name] who was also [adventureActivity]. [Emotion] despite the perilous situation, you decided to cooperate [weather].",
        
        "[Time], you heard sounds of combat from [adventureLocation] and rushed to help, finding [name] [adventureActivity]. [Emotion], you joined the effort [weather].",
        
        "[Weather], both you and [name] arrived at [adventureLocation] with the same goal. Meeting [emotion], you agreed to work together [adventureActivity] [time].",
        
        "An emergency at [adventureLocation] [time] brought you and [name] together. [Emotion], you coordinated your efforts while [adventureActivity] [weather].",
        
        // Peaceful Context (Original + New)
        "[Weather] [time], you came across [name] at [peacefulLocation]. [Emotion], you both began [peacefulActivity] in harmony.",
        
        "At [peacefulLocation] [time], you encountered [name] [emotion]. The serene environment led to [peacefulActivity] together [weather].",
        
        "[Time] [weather], you sought solitude at [peacefulLocation] but found [name] already there. [Emotion], you both enjoyed [peacefulActivity] in comfortable silence.",
        
        "Your meditation was gently interrupted [time] when [name] arrived at [peacefulLocation]. [Emotion], you welcomed them to join you in [peacefulActivity] [weather].",
        
        "[Weather], the beauty of [peacefulLocation] drew both you and [name] to the same spot [time]. Meeting [emotion], you shared [peacefulActivity].",
        
        "[Time], you were [peacefulActivity] at [peacefulLocation] when [name] approached respectfully. [Emotion], you invited them to join you [weather].",
        
        // Mixed/Unique Contexts
        "[Weather] [time], fate seemed to guide both you and [name] to [studyLocation]. [Emotion], what started as [studyActivity] evolved into [socialActivity].",
        
        "A chance encounter [time] at [socialLocation] led you and [name] to discover a mutual interest. [Emotion], you ventured together to [peacefulLocation] for [peacefulActivity] [weather].",
        
        "[Time], your separate journeys converged at [adventureLocation]. After [adventureActivity] together [emotion], you retreated to [peacefulLocation] for [peacefulActivity] [weather]."
    ],
    
    repeatMeeting: [
        // Scholarly/Study Context (Original + New)
        "You met [name] again at [studyLocation] [time], where you both were [studyActivity]. [Emotion] [weather], you delved deeper into your research together.",
        
        "[Weather], you found [name] once more at [studyLocation], this time [studyActivity]. You greeted each other [emotion] and continued your scholarly pursuits.",
        
        "[Time], your research paths crossed with [name]'s again at [studyLocation]. [Emotion], you resumed [studyActivity] [weather], building on your previous discoveries.",
        
        "Returning to [studyLocation] [weather], you weren't surprised to find [name] there again, [studyActivity]. [Emotion], you picked up where you left off [time].",
        
        "[Weather] [time], you and [name] rendezvoused at [studyLocation] as planned. [Emotion], you continued your collaborative work [studyActivity].",
        
        // Social Context (Original + New)
        "Your paths crossed with [name] again at [socialLocation] [time]. [Emotion], you spent time [socialActivity] [weather].",
        
        "At another [gathering] [time], you spotted [name] across the crowd. Meeting [emotion], you resumed [socialActivity] [weather].",
        
        "[Weather], you bumped into [name] again at [socialLocation]. [Emotion] like old friends, you immediately began [socialActivity] [time].",
        
        "[Time] at a different [gathering], you and [name] found each other once more. [Emotion], the familiarity made [socialActivity] even more enjoyable [weather].",
        
        "[Name] waved to you [emotion] across [socialLocation] [time]. Soon you were together again, [socialActivity] [weather] as if no time had passed.",
        
        "By coincidence, you and [name] ended up at the same [gathering] again [time]. [Emotion], you naturally gravitated toward each other and began [socialActivity] [weather].",
        
        // Adventure Context (Original + New)
        "[Time], you and [name] found yourselves at [adventureLocation] once more. [Emotion], you teamed up again for [adventureActivity] [weather].",
        
        "Once again, danger brought you and [name] together at [adventureLocation]. [Emotion] despite the circumstances, you began [adventureActivity] [weather].",
        
        "[Weather] [time], duty called both you and [name] back to [adventureLocation]. [Emotion], you coordinated seamlessly while [adventureActivity].",
        
        "Your second expedition to [adventureLocation] [time] reunited you with [name]. [Emotion], your previous experience together made [adventureActivity] much smoother [weather].",
        
        "[Time], reports from [adventureLocation] drew both you and [name] back to action. Meeting [emotion], you knew you could count on each other while [adventureActivity] [weather].",
        
        // Peaceful Context (Original + New)
        "[Weather] [time], you encountered [name] again at [peacefulLocation]. [Emotion], you both enjoyed [peacefulActivity] in the tranquil setting.",
        
        "Your cultivation journey led you to [peacefulLocation] again, where you met [name] [emotion]. Together, you spent time [peacefulActivity] [weather].",
        
        "[Time], you returned to [peacefulLocation] and were delighted to find [name] there as well. [Emotion], you continued [peacefulActivity] [weather] with renewed appreciation.",
        
        "[Weather], both you and [name] seemed drawn back to [peacefulLocation] [time]. [Emotion], you settled into [peacefulActivity] together as if it were the most natural thing.",
        
        "The serenity of [peacefulLocation] called to both you and [name] again [time]. Meeting [emotion], you shared [peacefulActivity] [weather] in comfortable companionship.",
        
        // Progressive/Relationship Building
        "[Weather] [time], you sought out [name] at [studyLocation], hoping to continue your previous discussion. [Emotion], you dove into [studyActivity] with renewed enthusiasm.",
        
        "Having enjoyed your last encounter, you and [name] agreed to meet again at [socialLocation] [time]. [Emotion], you spent the occasion [socialActivity] [weather].",
        
        "[Time], your previous adventure created a bond, so when you heard [name] was heading to [adventureLocation], you joined them. [Emotion], you worked together [adventureActivity] [weather].",
        
        "[Weather], you found yourself hoping to encounter [name] again at [peacefulLocation] [time]. [Emotion], when they appeared, you both smiled and began [peacefulActivity].",
        
        // Callback to Previous Meetings
        "[Time] [weather], you and [name] returned to [studyLocation] where you first met. [Emotion], you reflected on your journey while [studyActivity].",
        
        "Remembering your pleasant first meeting, you suggested [name] join you at [socialLocation] [time]. [Emotion], you enjoyed [socialActivity] even more than before [weather].",
        
        "[Weather], fate brought you and [name] together at [adventureLocation] yet again. [Emotion], you joked about your tendency to meet in dangerous places while [adventureActivity] [time].",
        
        // Mixed/Evolving Contexts
        "[Time], what began as [studyActivity] with [name] at [studyLocation] naturally evolved into [socialActivity] [emotion] as you moved to [socialLocation] [weather].",
        
        "[Weather], your partnership with [name] had grown strong enough that [adventureActivity] at [adventureLocation] felt routine. [Emotion], you later unwound with [peacefulActivity] at [peacefulLocation] [time]."
    ]
};

        // Cultivation realms data
        const cultivationRealms = [
            {
                name: "Mortal",
                chineseName: "凡人",
                stages: 9,
                multiplier: 1,
                description: "An ordinary person with no spiritual awareness. The journey of a thousand miles begins with a single step.",
                baseQiRequirement: 100
            },
            {
                name: "Qi Condensation",
                chineseName: "凝气",
                stages: 9,
                multiplier: 1.2,
                description: "Beginning to sense the qi of heaven and earth. The first step on the path of immortality.",
                baseQiRequirement: 500
            },
            {
                name: "Foundation Establishment",
                chineseName: "筑基",
                stages: 9,
                multiplier: 1.5,
                description: "Building a solid foundation for future cultivation. The spiritual roots take hold.",
                baseQiRequirement: 2000
            },
            {
                name: "Core Formation",
                chineseName: "结丹",
                stages: 9,
                multiplier: 2,
                description: "Forming a golden core within the dantian. The power to command elements begins to manifest.",
                baseQiRequirement: 8000
            },
            {
                name: "Nascent Soul",
                chineseName: "元婴",
                stages: 9,
                multiplier: 3,
                description: "A secondary soul forms within. Consciousness can leave the physical body for short periods.",
                baseQiRequirement: 25000
            },
            {
                name: "Soul Transformation",
                chineseName: "化神",
                stages: 9,
                multiplier: 5,
                description: "The mortal body begins its transformation into an immortal vessel. Lifespan greatly increases.",
                baseQiRequirement: 80000
            },
            {
                name: "Void Refinement",
                chineseName: "炼虚",
                stages: 9,
                multiplier: 8,
                description: "Refining the void between realms. Space and distance become malleable concepts.",
                baseQiRequirement: 250000
            },
            {
                name: "Body Integration",
                chineseName: "合体",
                stages: 9,
                multiplier: 12,
                description: "Integrating with heaven and earth. Natural laws bend to your will.",
                baseQiRequirement: 800000
            },
            {
                name: "Mahayana",
                chineseName: "大乘",
                stages: 9,
                multiplier: 20,
                description: "Becoming one with the universe. Comprehension of the grand dao begins.",
                baseQiRequirement: 2500000
            },
            {
                name: "True Immortal",
                chineseName: "真仙",
                stages: 9,
                multiplier: 35,
                description: "Transcending mortal limitations. Immortality in its truest form is achieved.",
                baseQiRequirement: 8000000
            },
            {
                name: "Golden Immortal",
                chineseName: "金仙",
                stages: 9,
                multiplier: 60,
                description: "Existence as pure golden light. Creation and destruction are within your grasp.",
                baseQiRequirement: 25000000
            },
            {
                name: "Immortal Emperor",
                chineseName: "仙帝",
                stages: 9,
                multiplier: 100,
                description: "Ruling over all immortals. Your name is revered throughout the Three Realms.",
                baseQiRequirement: 80000000
            },
            {
                name: "Dao Sovereign",
                chineseName: "道主",
                stages: Number.POSITIVE_INFINITY,
                multiplier: 300,
                description: "Sovereign of the Dao itself. The universe is but a reflection of your will.",
                baseQiRequirement: 250000000
            }
        ];

        // Spirit stone data
        const spiritStones = {
            basic: { 
                name: "Basic Spirit Stone", 
                successBoost: 1,
                nextTier: "low"
            },
            low: { 
                name: "Low-Grade Spirit Stone", 
                successBoost: 5,
                nextTier: "medium"
            },
            medium: { 
                name: "Medium-Grade Spirit Stone", 
                successBoost: 10,
                nextTier: "high"
            },
            high: { 
                name: "High-Grade Spirit Stone", 
                successBoost: 15,
                nextTier: "supreme"
            },
            supreme: { 
                name: "Supreme-Grade Spirit Stone", 
                successBoost: 20,
                nextTier: "divine"
            },
            divine: { 
                name: "Divine-Grade Spirit Stone", 
                successBoost: 25,
                nextTier: null
            },
            rename: {
                name: "Rename Scroll",
                description: "Allows changing your cultivator name",
                maxCount: 1
            }
        };

        // Achievement data
        const achievementData = {
            // Cultivation achievements
            "cultivation_reach_qi": {
                id: "cultivation_reach_qi",
                title: "First Steps on the Path",
                description: "Reach the Qi Condensation realm",
                category: "cultivation",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 1
            },
            "cultivation_reach_foundation": {
                id: "cultivation_reach_foundation",
                title: "Solid Foundations",
                description: "Reach the Foundation Establishment realm",
                category: "cultivation",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 2
            },
            "cultivation_reach_core": {
                id: "cultivation_reach_core",
                title: "Inner Power",
                description: "Reach the Core Formation realm",
                category: "cultivation",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 3
            },
            "cultivation_reach_nascent": {
                id: "cultivation_reach_nascent",
                title: "Soul Awakening",
                description: "Reach the Nascent Soul realm",
                category: "cultivation",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 4
            },
            "cultivation_reach_transformation": {
                id: "cultivation_reach_transformation",
                title: "Transcending Mortality",
                description: "Reach the Soul Transformation realm",
                category: "cultivation",
                rarity: "rare",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 5
            },
            "cultivation_reach_void": {
                id: "cultivation_reach_void",
                title: "Void Walker",
                description: "Reach the Void Refinement realm",
                category: "cultivation",
                rarity: "rare",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 6
            },
            "cultivation_reach_integration": {
                id: "cultivation_reach_integration",
                title: "One With Everything",
                description: "Reach the Body Integration realm",
                category: "cultivation",
                rarity: "epic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 7
            },
            "cultivation_reach_mahayana": {
                id: "cultivation_reach_mahayana",
                title: "Grand Way Seeker",
                description: "Reach the Mahayana realm",
                category: "cultivation",
                rarity: "epic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 8
            },
            "cultivation_reach_immortal": {
                id: "cultivation_reach_immortal",
                title: "Immortal Ascension",
                description: "Reach the True Immortal realm",
                category: "cultivation",
                rarity: "legendary",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 9
            },
            "cultivation_reach_golden": {
                id: "cultivation_reach_golden",
                title: "Golden Divinity",
                description: "Reach the Golden Immortal realm",
                category: "cultivation",
                rarity: "legendary",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 10
            },
            "cultivation_reach_emperor": {
                id: "cultivation_reach_emperor",
                title: "Emperor Among Immortals",
                description: "Reach the Immortal Emperor realm",
                category: "cultivation",
                rarity: "mythic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 11
            },
            "cultivation_reach_sovereign": {
                id: "cultivation_reach_sovereign",
                title: "Dao Sovereign",
                description: "Reach the pinnacle Dao Sovereign realm",
                category: "cultivation",
                rarity: "mythic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.player.realm >= 12
            },
            "cultivation_perfect_breakthrough": {
                id: "cultivation_perfect_breakthrough",
                title: "Perfect Insight",
                description: "Perform a breakthrough with 99% success rate",
                category: "cultivation",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => false // Checked manually during breakthrough
            },
            "cultivation_breakthrough_streak": {
                id: "cultivation_breakthrough_streak",
                title: "Unbroken Path",
                description: "Successfully perform 5 breakthroughs in a row",
                category: "cultivation",
                rarity: "rare",
                maxProgress: 5,
                isHidden: false,
                checkProgress: () => {
                    // This is tracked manually during breakthrough attempts
                    return gameState.achievements.progress["cultivation_breakthrough_streak"] || 0;
                }
            },
            "cultivation_qi_millionaire": {
                id: "cultivation_qi_millionaire",
                title: "Qi Millionaire",
                description: "Accumulate 1,000,000 qi in total",
                category: "cultivation",
                rarity: "epic",
                maxProgress: 1000000,
                isHidden: false,
                checkProgress: () => gameState.stats.totalQiEarned
            },
            "cultivation_fail_at_99": {
                id: "cultivation_fail_at_99",
                title: "Heaven's Envy",
                description: "Fail a breakthrough attempt with 99% success rate",
                category: "cultivation",
                rarity: "rare",
                maxProgress: 1,
                isHidden: true, // Hidden until at least 20% progress
                revealThreshold: 0.2,
                checkCondition: () => false // Checked manually during breakthrough
            },
            
            // Task achievements
            "tasks_complete_first": {
                id: "tasks_complete_first",
                title: "First Step",
                description: "Complete your first task",
                category: "tasks",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.completedTasks >= 1
            },
            "tasks_complete_10": {
                id: "tasks_complete_10",
                title: "Dedicated Cultivator",
                description: "Complete 10 tasks",
                category: "tasks",
                rarity: "common",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => gameState.stats.completedTasks
            },
            "tasks_complete_50": {
                id: "tasks_complete_50",
                title: "Task Master",
                description: "Complete 50 tasks",
                category: "tasks",
                rarity: "uncommon",
                maxProgress: 50,
                isHidden: false,
                checkProgress: () => gameState.stats.completedTasks
            },
            "tasks_complete_100": {
                id: "tasks_complete_100",
                title: "Century of Effort",
                description: "Complete 100 tasks",
                category: "tasks",
                rarity: "rare",
                maxProgress: 100,
                isHidden: false,
                checkProgress: () => gameState.stats.completedTasks
            },
            "tasks_complete_500": {
                id: "tasks_complete_500",
                title: "Indomitable Will",
                description: "Complete 500 tasks",
                category: "tasks",
                rarity: "epic",
                maxProgress: 500,
                isHidden: false,
                checkProgress: () => gameState.stats.completedTasks
            },
            "tasks_complete_1000": {
                id: "tasks_complete_1000",
                title: "Legendary Dedication",
                description: "Complete 1,000 tasks",
                category: "tasks",
                rarity: "legendary",
                maxProgress: 1000,
                isHidden: false,
                checkProgress: () => gameState.stats.completedTasks
            },
            "tasks_tag_specialist": {
                id: "tasks_tag_specialist",
                title: "Tag Specialist",
                description: "Complete 25 tasks with the same tag",
                category: "tasks",
                rarity: "uncommon",
                maxProgress: 25,
                isHidden: false,
                checkProgress: () => {
                    const tagCounts = Object.values(gameState.stats.completionByTag);
                    return tagCounts.length > 0 ? Math.max(...tagCounts) : 0;
                }
            },
            "tasks_daily_5": {
                id: "tasks_daily_5",
                title: "Daily Cultivator",
                description: "Complete 5 tasks in a single day",
                category: "tasks",
                rarity: "uncommon",
                maxProgress: 5,
                isHidden: false,
                checkCondition: () => false // Tracked manually when completing tasks
            },
            "tasks_boosted_10": {
                id: "tasks_boosted_10",
                title: "Focused Efficiency",
                description: "Complete 10 tasks with pomodoro boost",
                category: "tasks",
                rarity: "uncommon",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => gameState.stats.pomodoroTasksCompleted
            },
            "tasks_create_10": {
                id: "tasks_create_10",
                title: "Task Creator",
                description: "Create 10 different tasks",
                category: "tasks",
                rarity: "common",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => gameState.tasks.length
            },
            "tasks_complete_same_10": {
                id: "tasks_complete_same_10",
                title: "Consistent Practice",
                description: "Complete the same task 10 times",
                category: "tasks",
                rarity: "uncommon",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => {
                    const maxCompletions = gameState.tasks.reduce((max, task) => {
                        return Math.max(max, task.completionCount || 0);
                    }, 0);
                    return maxCompletions;
                }
            },
            
            // Spirit Stone achievements
            "stones_collect_first": {
                id: "stones_collect_first",
                title: "Stone Finder",
                description: "Find your first spirit stone",
                category: "stones",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => {
                    const totalStones = Object.values(gameState.stats.totalStonesFound).reduce((sum, count) => sum + count, 0);
                    return totalStones >= 1;
                }
            },
            "stones_collect_100": {
                id: "stones_collect_100",
                title: "Stone Collector",
                description: "Collect 100 spirit stones of any type",
                category: "stones",
                rarity: "uncommon",
                maxProgress: 100,
                isHidden: false,
                checkProgress: () => {
                    const totalStones = Object.values(gameState.stats.totalStonesFound).reduce((sum, count) => sum + count, 0);
                    return totalStones - gameState.stats.totalStonesFound.rename; // Exclude rename scrolls
                }
            },
            "stones_fuse_first": {
                id: "stones_fuse_first",
                title: "Spirit Alchemy",
                description: "Fuse spirit stones for the first time",
                category: "stones",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => {
                    const totalFused = Object.values(gameState.stats.stonesFused).reduce((sum, count) => sum + count, 0);
                    return totalFused >= 1;
                }
            },
            "stones_collect_divine": {
                id: "stones_collect_divine",
                title: "Divine Collector",
                description: "Collect a Divine-Grade Spirit Stone",
                category: "stones",
                rarity: "epic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.totalStonesFound.divine >= 1
            },
            "stones_fuse_divine": {
                id: "stones_fuse_divine",
                title: "Supreme Alchemist",
                description: "Fuse 100 Supreme-Grade stones into a Divine-Grade stone",
                category: "stones",
                rarity: "legendary",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.stonesFused.supreme >= 1
            },
            "stones_all_types": {
                id: "stones_all_types",
                title: "Stone Connoisseur",
                description: "Collect at least one of each spirit stone type",
                category: "stones",
                rarity: "rare",
                maxProgress: 6,
                isHidden: false,
                checkProgress: () => {
                    const types = ['basic', 'low', 'medium', 'high', 'supreme', 'divine'];
                    return types.filter(type => gameState.stats.totalStonesFound[type] > 0).length;
                }
            },
            "stones_rename_use": {
                id: "stones_rename_use",
                title: "Identity Shift",
                description: "Use a Rename Scroll to change your cultivator name",
                category: "stones",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.renameScrollsUsed >= 1
            },
            
            // Fellow Cultivator achievements
            "cultivators_first_meeting": {
                id: "cultivators_first_meeting",
                title: "First Encounter",
                description: "Meet a fellow cultivator for the first time",
                category: "cultivators",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.cultivatorsMet >= 1
            },
            "cultivators_meet_10": {
                id: "cultivators_meet_10",
                title: "Social Cultivator",
                description: "Meet fellow cultivators 10 times",
                category: "cultivators",
                rarity: "uncommon",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => gameState.stats.cultivatorsMet
            },
            "cultivators_boost_24h": {
                id: "cultivators_boost_24h",
                title: "Continuous Support",
                description: "Accumulate 24 hours of fellow cultivator boost time",
                category: "cultivators",
                rarity: "rare",
                maxProgress: 24 * 60, // 24 hours in minutes
                isHidden: false,
                checkProgress: () => gameState.stats.totalBoostTime
            },
            "cultivators_add_custom": {
                id: "cultivators_add_custom",
                title: "Expanding Circle",
                description: "Add your first custom fellow cultivator",
                category: "cultivators",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => {
                    return gameState.fellowCultivators.pool.some(c => c.custom);
                }
            },
            "cultivators_add_5_custom": {
                id: "cultivators_add_5_custom",
                title: "Friend Collector",
                description: "Add 5 custom fellow cultivators",
                category: "cultivators",
                rarity: "uncommon",
                maxProgress: 5,
                isHidden: false,
                checkProgress: () => {
                    return gameState.fellowCultivators.pool.filter(c => c.custom).length;
                }
            },
            "cultivators_max_boost": {
                id: "cultivators_max_boost",
                title: "Maximum Synergy",
                description: "Reach the maximum 10-hour boost time limit",
                category: "cultivators",
                rarity: "epic",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => false // Checked manually when meeting cultivators
            },
            "cultivators_meet_same_5": {
                id: "cultivators_meet_same_5",
                title: "Fated Connection",
                description: "Meet the same fellow cultivator 5 times",
                category: "cultivators",
                rarity: "rare",
                maxProgress: 5,
                isHidden: false,
                checkProgress: () => {
                    const encounters = gameState.fellowCultivators.pool.map(c => c.encounters);
                    return encounters.length > 0 ? Math.max(...encounters) : 0;
                }
            },
            "cultivators_fill_pool": {
                id: "cultivators_fill_pool",
                title: "Cultivator Network",
                description: "Fill your cultivator pool to the maximum of 32 custom cultivators",
                category: "cultivators",
                rarity: "legendary",
                maxProgress: 32,
                isHidden: false,
                checkProgress: () => {
                    return gameState.fellowCultivators.pool.filter(c => c.custom).length;
                }
            },
            
            // Pomodoro achievements
            "pomodoro_first_session": {
                id: "pomodoro_first_session",
                title: "Focused Cultivation",
                description: "Complete your first pomodoro session",
                category: "pomodoro",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => gameState.stats.pomodoroSessions >= 1
            },
            "pomodoro_10_sessions": {
                id: "pomodoro_10_sessions",
                title: "Concentration Master",
                description: "Complete 10 pomodoro sessions",
                category: "pomodoro",
                rarity: "uncommon",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => gameState.stats.pomodoroSessions
            },
            "pomodoro_50_sessions": {
                id: "pomodoro_50_sessions",
                title: "Focus Cultivator",
                description: "Complete 50 pomodoro sessions",
                category: "pomodoro",
                rarity: "rare",
                maxProgress: 50,
                isHidden: false,
                checkProgress: () => gameState.stats.pomodoroSessions
            },
            "pomodoro_100_sessions": {
                id: "pomodoro_100_sessions",
                title: "Time Lord",
                description: "Complete 100 pomodoro sessions",
                category: "pomodoro",
                rarity: "epic",
                maxProgress: 100,
                isHidden: false,
                checkProgress: () => gameState.stats.pomodoroSessions
            },
            "pomodoro_10_hours": {
                id: "pomodoro_10_hours",
                title: "Time Investment",
                description: "Accumulate 10 hours of focused time",
                category: "pomodoro",
                rarity: "uncommon",
                maxProgress: 10 * 60, // 10 hours in minutes
                isHidden: false,
                checkProgress: () => gameState.stats.pomodoroTotalMinutes
            },
            "pomodoro_max_boost": {
                id: "pomodoro_max_boost",
                title: "Maximum Focus",
                description: "Complete a full 25-minute pomodoro session",
                category: "pomodoro",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => false // Checked manually when completing sessions
            },
            "pomodoro_daily_streak": {
                id: "pomodoro_daily_streak",
                title: "Daily Focus",
                description: "Complete at least one pomodoro session for 5 consecutive days",
                category: "pomodoro",
                rarity: "rare",
                maxProgress: 5,
                isHidden: false,
                checkProgress: () => {
                    // This is tracked manually when completing pomodoro sessions
                    return gameState.achievements.progress["pomodoro_daily_streak"] || 0;
                }
            },
            "pomodoro_boost_all": {
                id: "pomodoro_boost_all",
                title: "Focused Efficiency",
                description: "Complete all generated tasks with pomodoro boost active",
                category: "pomodoro",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => false // Checked manually when completing tasks
            },
            
            // Miscellaneous achievements
            "misc_first_day": {
                id: "misc_first_day",
                title: "Beginning of the Journey",
                description: "Start your cultivation journey",
                category: "misc",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => true // Always unlocked on first load
            },
            "misc_daily_login_7": {
                id: "misc_daily_login_7",
                title: "Weekly Cultivator",
                description: "Log in for 7 consecutive days",
                category: "misc",
                rarity: "uncommon",
                maxProgress: 7,
                isHidden: false,
                checkProgress: () => {
                    // This is tracked manually on login
                    return gameState.achievements.progress["misc_daily_login_7"] || 0;
                }
            },
            "misc_daily_login_30": {
                id: "misc_daily_login_30",
                title: "Monthly Dedication",
                description: "Log in for 30 consecutive days",
                category: "misc",
                rarity: "rare",
                maxProgress: 30,
                isHidden: false,
                checkProgress: () => {
                    // This is tracked manually on login
                    return gameState.achievements.progress["misc_daily_login_30"] || 0;
                }
            },
            "misc_achieve_10": {
                id: "misc_achieve_10",
                title: "Achievement Hunter",
                description: "Unlock 10 achievements",
                category: "misc",
                rarity: "uncommon",
                maxProgress: 10,
                isHidden: false,
                checkProgress: () => Object.keys(gameState.achievements.unlocked).length
            },
            "misc_achieve_25": {
                id: "misc_achieve_25",
                title: "Achievement Master",
                description: "Unlock 25 achievements",
                category: "misc",
                rarity: "rare",
                maxProgress: 25,
                isHidden: false,
                checkProgress: () => Object.keys(gameState.achievements.unlocked).length
            },
            "misc_achieve_50": {
                id: "misc_achieve_50",
                title: "Achievement Legend",
                description: "Unlock 50 achievements",
                category: "misc",
                rarity: "epic",
                maxProgress: 50,
                isHidden: false,
                checkProgress: () => Object.keys(gameState.achievements.unlocked).length
            },
            "misc_unlock_all_tabs": {
                id: "misc_unlock_all_tabs",
                title: "Complete Interface",
                description: "Unlock all application tabs",
                category: "misc",
                rarity: "uncommon",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => true // All tabs are unlocked from the beginning now
            },
            "misc_export_data": {
                id: "misc_export_data",
                title: "Data Guardian",
                description: "Export your game data for safekeeping",
                category: "misc",
                rarity: "common",
                maxProgress: 1,
                isHidden: false,
                checkCondition: () => false // Checked manually when exporting
            },
            "misc_theme_explorer": {
                id: "misc_theme_explorer",
                title: "Aesthetic Cultivator",
                description: "Try all available themes",
                category: "misc",
                rarity: "uncommon",
                maxProgress: 6, // Number of themes
                isHidden: false,
                checkProgress: () => {
                    // This is tracked manually when changing themes
                    return gameState.achievements.progress["misc_theme_explorer"] || 0;
                }
            }
        };

        // Tutorial data
        const tutorialContent = [
            {
                title: "Welcome to 青云修仙录!",
                content: `
                    <div class="flex flex-col items-center mb-4">
                        <div class="rotate-symbol text-4xl mb-2">☯</div>
                        <h3 class="text-xl font-bold">Cultivation Through Tasks</h3>
                    </div>
                    <p class="mb-2">This application combines a task management system with a cultivation-themed idle game to help you overcome procrastination while having fun.</p>
                    <p class="mb-2">Complete real-life tasks to gain qi and spirit stones, which will help you advance through cultivation realms!</p>
                    <p>This tutorial will guide you through the main features of the application.</p>
                    <p class="mt-4 text-sm italic">Note: You can access this tutorial anytime from the Settings tab.</p>
                `
            },
            {
                title: "Task Management",
                content: `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <h3 class="font-bold mb-2">Creating Tasks</h3>
                            <p>1. Enter a task name</p>
                            <p>2. Add tags (optional, comma-separated)</p>
                            <p>3. Click "Add Task" to save it</p>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2">Managing Tasks</h3>
                            <p>• Edit or delete existing tasks</p>
                            <p>• Sort by name, tags, or completion count</p>
                            <p>• Select multiple tasks with checkboxes</p>
                            <p>• View completion history for each task</p>
                        </div>
                    </div>
                    <div class="ancient-border p-3 mb-4">
                        <h3 class="font-bold mb-2">Task Generator</h3>
                        <p>1. Choose how many tasks to generate (1-10)</p>
                        <p>2. Optionally filter by specific tags</p>
                        <p>3. Click "Generate Tasks" to randomly select from your task list</p>
                        <p>4. Complete tasks to earn qi and spirit stones</p>
                        <p>5. Skip individual tasks or give up all tasks with a qi penalty</p>
                        <p class="mt-2 text-sm italic">Note: Both skipping tasks and giving up will incur a qi penalty. The penalty for giving up increases with the number of tasks.</p>
                    </div>
                `
            },
            {
                title: "Cultivation System",
                content: `
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Cultivation Progression</h3>
                        <p>• Complete tasks to gain qi</p>
                        <p>• Gain passive qi at a base rate of 0.5 qi/min</p>
                        <p>• Higher realms provide higher multipliers for passive gains</p>
                        <p>• Each realm has multiple stages you must break through</p>
                    </div>
                    <div class="ancient-border p-3 mb-4">
                        <h3 class="font-bold mb-2">Breakthrough</h3>
                        <p>• Accumulate sufficient qi to attempt a breakthrough</p>
                        <p>• Each attempt has a base success rate</p>
                        <p>• Use spirit stones to increase your success chance</p>
                        <p>• Failed breakthroughs result in qi loss (15-35%)</p>
                        <p>• Successful breakthroughs advance you to the next stage or realm</p>
                    </div>
                `
            },
            {
                title: "Spirit Stones",
                content: `
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Spirit Stone Tiers</h3>
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <div class="text-center">
                                <div class="spirit-stone stone-basic mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">Basic</p>
                                <p class="text-xs">+1%</p>
                            </div>
                            <div class="text-center">
                                <div class="spirit-stone stone-low mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">Low</p>
                                <p class="text-xs">+5%</p>
                            </div>
                            <div class="text-center">
                                <div class="spirit-stone stone-medium mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">Medium</p>
                                <p class="text-xs">+10%</p>
                            </div>
                            <div class="text-center">
                                <div class="spirit-stone stone-high mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">High</p>
                                <p class="text-xs">+15%</p>
                            </div>
                            <div class="text-center">
                                <div class="spirit-stone stone-supreme mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">Supreme</p>
                                <p class="text-xs">+20%</p>
                            </div>
                            <div class="text-center">
                                <div class="spirit-stone stone-divine mx-auto mb-1" style="width:30px;height:30px"></div>
                                <p class="text-sm">Divine</p>
                                <p class="text-xs">+25%</p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Acquiring & Using Spirit Stones</h3>
                        <p>• Earn spirit stones by completing tasks</p>
                        <p>• Higher realms increase chances of finding better stones</p>
                        <p>• Fuse 100 lower-tier stones to create 1 higher-tier stone</p>
                        <p>• Use stones to boost breakthrough success rate</p>
                        <p>• Lower stones have reduced effectiveness in higher realms</p>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Special Items</h3>
                        <div class="flex items-center">
                            <div class="spirit-stone stone-rename mr-2" style="width:30px;height:30px"></div>
                            <div>
                                <p><strong>Rename Scroll</strong>: Changes your cultivator name</p>
                                <p class="text-xs">• 5% chance to find when completing tasks</p>
                                <p class="text-xs">• Maximum of 1 scroll can be held at once</p>
                                <p class="text-xs">• Can be used from Inventory or Settings page</p>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                title: "Pomodoro Cultivation",
                content: `
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Focus Timer</h3>
                        <p>The Pomodoro technique helps improve focus and productivity through timed work sessions.</p>
                        <ul class="list-disc pl-6 mt-1 mb-2">
                            <li>Set a focus duration between 5-25 minutes</li>
                            <li>Optionally set a break duration between 0-10 minutes</li>
                            <li>Complete the session to earn qi boosting rewards</li>
                            <li>Longer sessions provide better rewards</li>
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Rewards by Duration</h3>
                        <div class="ancient-border p-3">
                            <p>Complete a focus session to receive qi boosts:</p>
                            <ul class="list-disc pl-6 mt-1">
                                <li>15 minutes: x2 qi for 5 task completions</li>
                                <li>20 minutes: x2 qi for 8 task completions</li>
                                <li>25 minutes: x2 qi for 10 task completions</li>
                                <li>5-14 minutes: No rewards, but still counts as practice</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="ancient-border p-3">
                        <h3 class="font-bold mb-2">How to Use</h3>
                        <p>1. Set your desired focus and break durations</p>
                        <p>2. Start the timer and focus on your real-world tasks</p>
                        <p>3. When the timer completes, you'll earn a boost</p>
                        <p>4. Complete tasks in the app to use your boost</p>
                        <p>5. The boost applies automatically to task completions</p>
                        <p class="mt-2 text-sm italic">Tip: Use the pomodoro timer while working on tasks that you've added to the app for maximum efficiency!</p>
                    </div>
                `
            },
            {
                title: "Fellow Cultivators",
                content: `
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Meeting Fellow Cultivators</h3>
                        <p>• You can meet fellow cultivators when returning after being away</p>
                        <p>• Meeting chances increase with longer absence:</p>
                        <ul class="list-disc pl-6 mt-1 mb-2">
                            <li>10 minutes offline: 10% chance</li>
                            <li>30 minutes offline: 20% chance</li>
                            <li>60+ minutes offline: 30% chance</li>
                        </ul>
                        <p class="text-sm italic">Note: The Fellow Cultivators feature is available from the beginning.</p>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Benefits & Management</h3>
                        <p>• Meeting a fellow cultivator doubles your idle cultivation rate</p>
                        <p>• Boost duration is random (60-120 minutes per meeting)</p>
                        <p>• Multiple meetings can extend the boost (maximum 10 hours)</p>
                        <p>• The game includes built-in cultivators</p>
                        <p>• You can add up to 32 custom cultivators to your pool</p>
                        <p>• Add up to 5 custom cultivators per day</p>
                    </div>
                    
                    <div class="ancient-border p-3">
                        <h3 class="font-bold mb-2">Custom Cultivator Settings</h3>
                        <p>• You can set the app to only meet your custom cultivators</p>
                        <p>• Edit custom cultivator names (with 48-hour cooldown)</p>
                        <p>• Remove custom cultivators you no longer want</p>
                        <p>• Note: Built-in cultivators cannot be edited or removed</p>
                        <p>• Add your cultivator permanently into the game in Settings</p>
                    </div>
                `
            },
            {
                title: "Achievements",
                content: `
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Achievement System</h3>
                        <p>Track your cultivation progress and unlock achievements as you progress.</p>
                        <p>Achievements are organized into categories:</p>
                        <ul class="list-disc pl-6 mt-1 mb-2">
                            <li>Cultivation - Progress through realms and breakthroughs</li>
                            <li>Tasks - Complete and manage various tasks</li>
                            <li>Spirit Stones - Collect and fuse spirit stones</li>
                            <li>Fellow Cultivators - Meet and manage fellow cultivators</li>
                            <li>Pomodoro - Complete focus sessions</li>
                            <li>Miscellaneous - General achievements</li>
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Achievement Rarities</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-2">
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-common mr-1"></span>
                                <span>Common</span>
                            </div>
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-uncommon mr-1"></span>
                                <span>Uncommon</span>
                            </div>
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-rare mr-1"></span>
                                <span>Rare</span>
                            </div>
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-epic mr-1"></span>
                                <span>Epic</span>
                            </div>
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-legendary mr-1"></span>
                                <span>Legendary</span>
                            </div>
                            <div class="flex items-center">
                                <span class="achievement-rarity-indicator achievement-mythic mr-1"></span>
                                <span>Mythic</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ancient-border p-3">
                        <h3 class="font-bold mb-2">Hidden Achievements</h3>
                        <p>• Some achievements are hidden until you make progress toward them</p>
                        <p>• When you reach about 20% progress, the achievement will be revealed</p>
                        <p>• Hidden achievements tend to be more unusual or challenging</p>
                        <p class="mt-2 text-sm italic">Explore different features and try unusual actions to discover hidden achievements!</p>
                    </div>
                `
            },
            {
                title: "Statistics & Analytics",
                content: `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <h3 class="font-bold mb-2">Statistics</h3>
                            <p>• Track completed tasks</p>
                            <p>• Monitor breakthrough success rate</p>
                            <p>• View spirit stones collected</p>
                            <p>• See your highest realm reached</p>
                            <p>• Track passive vs. active qi gains</p>
                            <p>• View fellow cultivator encounters</p>
                            <p>• Track pomodoro sessions</p>
                            <p>• Monitor achievement progress</p>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2">Analytics</h3>
                            <p>• Task completion patterns by tag</p>
                            <p>• Qi efficiency metrics</p>
                            <p>• Cultivation journey visualization</p>
                            <p>• Weekly activity heatmap</p>
                            <p>• Passive vs. active qi distribution</p>
                            <p>• Boost time from fellow cultivators</p>
                            <p>• Pomodoro session analysis</p>
                        </div>
                    </div>
                    <div class="ancient-border p-3 mb-4">
                        <h3 class="font-bold mb-2">Customization Options</h3>
                        <p>• Choose from multiple visual themes</p>
                        <p>• Toggle between light and dark mode</p>
                        <p>• Set your cultivator name (requires Rename Scroll after setup)</p>
                        <p>• Customize notification preferences</p>
                        <p>• Show or hide task completion counts</p>
                        <p>• Choose to use scientific notation for large numbers</p>
                        <p>• Set fellow cultivator meeting preferences</p>
                    </div>
                `
            },
            {
                title: "Additional Features",
                content: `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <h3 class="font-bold mb-2">Quality of Life</h3>
                            <p>• Manual save button</p>
                            <p>• Skip individual tasks (with qi penalty)</p>
                            <p>• Sort tasks by different criteria</p>
                            <p>• Detailed tooltips</p>
                            <p>• Multiple theme options</p>
                            <p>• Name editing in settings (with Rename Scroll)</p>
                            <p>• Scientific notation for large numbers</p>
                            <p>• Collapsible information sections</p>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2">Settings & Community</h3>
                            <p>• Export/Import game data</p>
                            <p>• Reset statistics</p>
                            <p>• Hard reset option</p>
                            <p>• View this tutorial again</p>
                            <p>• Access patch notes</p>
                            <p>• Submit your fellow cultivator name ideas</p>
                            <p>• Choose to only meet custom cultivators</p>
                            <p>• Manage notification preferences</p>
                        </div>
                    </div>
                    <div class="ancient-border p-3 text-center">
                        <h3 class="font-bold mb-2">You're Ready to Begin!</h3>
                        <p class="mb-2">Start by adding some tasks, then generate random ones to complete.</p>
                        <p>Remember: Consistent effort leads to cultivation mastery!</p>
                        <div class="flex justify-center mt-2">
                            <div class="rotate-symbol text-2xl">☯</div>
                        </div>
                        <p class="mt-4 text-sm italic">You can access this tutorial again anytime from the Settings tab.</p>
                    </div>
                `
            }
        ];

        // DOM elements
        const elements = {
            tabs: document.querySelectorAll('.tab-button'),
            tabContents: document.querySelectorAll('.tab-content'),
            
            // Cultivation tab
            currentRealm: document.getElementById('current-realm'),
            currentStage: document.getElementById('current-stage'),
            maxStage: document.getElementById('max-stage'),
            qiProgressBar: document.getElementById('qi-progress-bar'),
            currentQi: document.getElementById('current-qi'),
            targetQi: document.getElementById('target-qi'),
            baseRate: document.getElementById('base-rate'),
            currentMultiplier: document.getElementById('current-multiplier'),
            effectiveRate: document.getElementById('effective-rate'),
            nextHourYield: document.getElementById('next-hour-yield'),
            realmDescription: document.getElementById('realm-description'),
            fellowBoostContainer: document.getElementById('fellow-boost-container'),
            boostStatus: document.getElementById('boost-status'),
            boostTimeRemaining: document.getElementById('boost-time-remaining'),
            pomodoroBoostContainer: document.getElementById('pomodoro-boost-container'),
            pomodoroBoostStatus: document.getElementById('pomodoro-boost-status'),
            pomodoroBoostsRemaining: document.getElementById('pomodoro-boosts-remaining'),
            
            breakthroughQiRequired: document.getElementById('breakthrough-qi-required'),
            baseSuccessRate: document.getElementById('base-success-rate'),
            finalSuccessRate: document.getElementById('final-success-rate'),
            selectedStones: document.getElementById('selected-stones'),
            successBoost: document.getElementById('success-boost'),
            clearStones: document.getElementById('clear-stones'),
            attemptBreakthrough: document.getElementById('attempt-breakthrough'),
            
            // Tasks tab
            taskName: document.getElementById('task-name'),
            taskTags: document.getElementById('task-tags'),
            addTask: document.getElementById('add-task'),
            sortTasks: document.getElementById('sort-tasks'),
            selectAllTasks: document.getElementById('select-all-tasks'),
            taskList: document.getElementById('task-list'),
            editSelectedTask: document.getElementById('edit-selected-task'),
            deleteSelectedTasks: document.getElementById('delete-selected-tasks'),
            
            taskCount: document.getElementById('task-count'),
            filterTags: document.getElementById('filter-tags'),
            generateTasks: document.getElementById('generate-tasks'),
            generatedTasks: document.getElementById('generated-tasks'),
            completeAllTasks: document.getElementById('complete-all-tasks'),
            giveUpTasks: document.getElementById('give-up-tasks'),

            // Pomodoro tab
            timerDisplay: document.getElementById('timer-display'),
            timerProgressBar: document.getElementById('timer-progress-bar'),
            breakIndicator: document.getElementById('break-indicator'),
            timerStart: document.getElementById('timer-start'),
            timerPause: document.getElementById('timer-pause'),
            timerReset: document.getElementById('timer-reset'),
            focusDuration: document.getElementById('focus-duration'),
            focusDurationDisplay: document.getElementById('focus-duration-display'),
            breakDuration: document.getElementById('break-duration'),
            breakDurationDisplay: document.getElementById('break-duration-display'),
            useBreak: document.getElementById('use-break'),
            activePomodoroBoost: document.getElementById('active-pomodoro-boost'),
            noPomodoroBoost: document.getElementById('no-pomodoro-boost'),
            remainingBoostedTasks: document.getElementById('remaining-boosted-tasks'),
            totalSessions: document.getElementById('total-sessions'),
            totalFocusTime: document.getElementById('total-focus-time'),
            totalBoostsEarned: document.getElementById('total-boosts-earned'),
            totalBoostedTasks: document.getElementById('total-boosted-tasks'),
            sessionHistory: document.getElementById('session-history'),
            
            // Inventory tab
            stoneCounters: {
                basic: document.getElementById('basic-stone-count'),
                low: document.getElementById('low-stone-count'),
                medium: document.getElementById('medium-stone-count'),
                high: document.getElementById('high-stone-count'),
                supreme: document.getElementById('supreme-stone-count'),
                divine: document.getElementById('divine-stone-count')
            },
            stoneButtons: document.querySelectorAll('[data-stone]'),
            renameScrollCount: document.getElementById('rename-scroll-count'),
            useRenameScroll: document.getElementById('use-rename-scroll'),

            // Fellow Cultivators tab
            fcTabButton: document.getElementById('fellowCultivators-tab-button'),
            fcBoostStatus: document.getElementById('fc-boost-status'),
            fcNoBoost: document.getElementById('fc-no-boost'),
            fcActiveBoost: document.getElementById('fc-active-boost'),
            fcBoostTimeRemaining: document.getElementById('fc-boost-time-remaining'),
            fcLastEncounter: document.getElementById('fc-last-encounter'),
            fcNoEncounters: document.getElementById('fc-no-encounters'),
            fcLastEncounterDetails: document.getElementById('fc-last-encounter-details'),
            fcLastEncounterMessage: document.getElementById('fc-last-encounter-message'),
            fcLastEncounterTime: document.getElementById('fc-last-encounter-time'),
            newCultivatorName: document.getElementById('new-cultivator-name'),
            addCultivator: document.getElementById('add-cultivator'),
            cultivatorsAddedToday: document.getElementById('cultivators-added-today'),
            editCultivatorSelect: document.getElementById('edit-cultivator-select'),
            editCultivatorForm: document.getElementById('edit-cultivator-form'),
            editCultivatorName: document.getElementById('edit-cultivator-name'),
            saveCultivatorEdit: document.getElementById('save-cultivator-edit'),
            editCooldownInfo: document.getElementById('edit-cooldown-info'),
            editAvailableTime: document.getElementById('edit-available-time'),
            removeCultivatorSelect: document.getElementById('remove-cultivator-select'),
            removeCultivator: document.getElementById('remove-cultivator'),
            builtinCultivatorPool: document.getElementById('builtin-cultivator-pool'),
            noBuiltinCultivatorsMessage: document.getElementById('no-builtin-cultivators-message'),
            builtinCultivatorCount: document.getElementById('builtin-cultivator-count'),
            customCultivatorPool: document.getElementById('custom-cultivator-pool'),
            noCustomCultivatorsMessage: document.getElementById('no-custom-cultivators-message'),
            customCultivatorsCount: document.getElementById('custom-cultivators-count'),
            
            // Achievements tab
            achievementTabs: document.getElementById('achievement-tabs'),
            achievementList: document.getElementById('achievement-list'),
            achievementTotalCount: document.getElementById('achievement-total-count'),
            achievementPercent: document.getElementById('achievement-percent'),
            achievementLatest: document.getElementById('achievement-latest'),
            achievementRarest: document.getElementById('achievement-rarest'),
            
            // Statistics tab
            statTotalTasks: document.getElementById('stat-total-tasks'),
            statCompletedTasks: document.getElementById('stat-completed-tasks'),
            statAvgQi: document.getElementById('stat-avg-qi'),
            statAvgStones: document.getElementById('stat-avg-stones'),
            statBreakthroughs: document.getElementById('stat-breakthroughs'),
            statFailedAttempts: document.getElementById('stat-failed-attempts'),
            statSuccessRate: document.getElementById('stat-success-rate'),
            statHighestRealm: document.getElementById('stat-highest-realm'),
            statTotalQi: document.getElementById('stat-total-qi'),
            statPassiveQi: document.getElementById('stat-passive-qi'),
            statMostCompletedTask: document.getElementById('stat-most-completed-task'),
            statMostActiveTag: document.getElementById('stat-most-active-tag'),
            statPomodoroQi: document.getElementById('stat-pomodoro-qi'),
            statPomodoroBoostedTasks: document.getElementById('stat-pomodoro-boosted-tasks'),
            
            statBasicStones: document.getElementById('stat-basic-stones'),
            statLowStones: document.getElementById('stat-low-stones'),
            statMediumStones: document.getElementById('stat-medium-stones'),
            statHighStones: document.getElementById('stat-high-stones'),
            statSupremeStones: document.getElementById('stat-supreme-stones'),
            statDivineStones: document.getElementById('stat-divine-stones'),
            
            statBasicFused: document.getElementById('stat-basic-fused'),
            statLowFused: document.getElementById('stat-low-fused'),
            statMediumFused: document.getElementById('stat-medium-fused'),
            statHighFused: document.getElementById('stat-high-fused'),
            statSupremeFused: document.getElementById('stat-supreme-fused'),
            
            statRenameScrolls: document.getElementById('stat-rename-scrolls'),
            statRenameScrollsUsed: document.getElementById('stat-rename-scrolls-used'),
            
            statCultivatorsMet: document.getElementById('stat-cultivators-met'),
            statTotalBoostTime: document.getElementById('stat-total-boost-time'),
            statQiFromBoosts: document.getElementById('stat-qi-from-boosts'),
            
            statPomodoroSessions: document.getElementById('stat-pomodoro-sessions'),
            statFocusMinutes: document.getElementById('stat-focus-minutes'),
            statBoostsEarned: document.getElementById('stat-boosts-earned'),
            
            statTotalAchievements: document.getElementById('stat-total-achievements'),
            statAchievementRate: document.getElementById('stat-achievement-rate'),
            statHiddenAchievements: document.getElementById('stat-hidden-achievements'),
            
            // Analytics tab
            qiSourceActive: document.getElementById('qi-source-active'),
            qiSourcePassive: document.getElementById('qi-source-passive'),
            qiActivePercent: document.getElementById('qi-active-percent'),
            qiPassivePercent: document.getElementById('qi-passive-percent'),
            qiEfficiencyChart: document.getElementById('qi-efficiency-chart'),
            tasksByTagChart: document.getElementById('tasks-by-tag-chart'),
            cultivationJourneyChart: document.getElementById('cultivation-journey-chart'),
            activityHeatmapChart: document.getElementById('activity-heatmap-chart'),
            pomodoroDurationChart: document.getElementById('pomodoro-duration-chart'),
            
            // Settings tab
            exportGame: document.getElementById('export-game'),
            manualSave: document.getElementById('manual-save'),
            importData: document.getElementById('import-data'),
            importGame: document.getElementById('import-game'),
            resetStats: document.getElementById('reset-stats'),
            hardReset: document.getElementById('hard-reset'),
            showTutorial: document.getElementById('show-tutorial'),
            
            settingsCultivatorName: document.getElementById('settings-cultivator-name'),
            settingsChangeName: document.getElementById('settings-change-name'),
            
            themeSelect: document.getElementById('theme-select'),
            themeModeToggle: document.getElementById('theme-mode-toggle'),
            themeModeLabel: document.getElementById('theme-mode-label'),
            showCompletionCount: document.getElementById('show-completion-count'),
            
            useScientificNotation: document.getElementById('use-scientific-notation'),
            scientificNotationThreshold: document.getElementById('scientific-notation-threshold'),
            
            onlyMeetCustomCultivators: document.getElementById('only-meet-custom-cultivators'),
            
            notificationBreakthrough: document.getElementById('notification-breakthrough'),
            notificationIdle: document.getElementById('notification-idle'),
            notificationMilestone: document.getElementById('notification-milestone'),
            notificationFellowCultivator: document.getElementById('notification-fellowCultivator'),
            notificationAchievement: document.getElementById('notification-achievement'),
            notificationPomodoro: document.getElementById('notification-pomodoro'),
            
            // Modals
            modalOverlay: document.getElementById('modal-overlay'),
            modalContent: document.getElementById('modal-content'),
            modalHeader: document.getElementById('modal-header'),
            modalBody: document.getElementById('modal-body'),
            modalFooter: document.getElementById('modal-footer'),
            modalCancel: document.getElementById('modal-cancel'),
            modalConfirm: document.getElementById('modal-confirm'),
            
            // Name Change
            nameChangeOverlay: document.getElementById('name-change-overlay'),
            cultivatorNameInput: document.getElementById('cultivator-name-input'),
            nameChangeCancel: document.getElementById('name-change-cancel'),
            nameChangeConfirm: document.getElementById('name-change-confirm'),
            cultivatorName: document.getElementById('cultivator-name'),
            renameWarning: document.getElementById('rename-warning'),
            
            // Achievement Unlock
            achievementUnlockOverlay: document.getElementById('achievement-unlock-overlay'),
            achievementUnlockIcon: document.getElementById('achievement-unlock-icon'),
            achievementUnlockTitle: document.getElementById('achievement-unlock-title'),
            achievementUnlockDescription: document.getElementById('achievement-unlock-description'),
            achievementUnlockConfirm: document.getElementById('achievement-unlock-confirm'),
            
            // Toast
            toastContainer: document.getElementById('toast-container'),
            
            // Custom Notifications
            notificationContainer: document.getElementById('notification-container'),
            
            // Tutorial
            tutorialOverlay: document.getElementById('tutorial-overlay'),
            tutorialBody: document.getElementById('tutorial-body'),
            tutorialPrev: document.getElementById('tutorial-prev'),
            tutorialNext: document.getElementById('tutorial-next'),
            tutorialSkip: document.getElementById('tutorial-skip'),
            tutorialPage: document.getElementById('tutorial-page'),
            
            // Spoilers
            spoilerHeaders: document.querySelectorAll('.spoiler-header')
        };

        // Chart instances
        let charts = {
            qiEfficiency: null,
            tasksByTag: null,
            cultivationJourney: null,
            activityHeatmap: null,
            pomodoroDuration: null
        };

        // Initialize tabs
        elements.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // Update active tab
                elements.tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show the corresponding tab content
                elements.tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tabName}-tab`).classList.remove('hidden');
                
                // If switching to analytics tab, update charts
                if (tabName === 'analytics') {
                    updateAnalyticsCharts();
                }
                
                // If switching to fellow cultivators tab, update UI
                if (tabName === 'fellowCultivators') {
                    updateFellowCultivatorsUI();
                }
                
                // If switching to achievements tab, update UI
                if (tabName === 'achievements') {
                    updateAchievementsUI();
                }
                
                // If switching to pomodoro tab, update UI
                if (tabName === 'pomodoro') {
                    updatePomodoroUI();
                }
            });
        });

        // Initialize spoiler headers
        elements.spoilerHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.spoiler-icon');
                
                // Toggle the content visibility
                if (content.classList.contains('open')) {
                    content.classList.remove('open');
                    icon.classList.remove('open');
                } else {
                    content.classList.add('open');
                    icon.classList.add('open');
                }
            });
        });

	function replacePlaceholders(template, cultivatorName, isFirstMeeting = true) {
    let message = template.replace('[name]', cultivatorName);
    
    // Choose appropriate emotion based on meeting type
    const emotions = isFirstMeeting ? 
        messageComponents.firstMeetingEmotions : 
        messageComponents.repeatMeetingEmotions;
    
    const placeholders = {
        '[studyObject]': messageComponents.studyObjects,
        '[studyActivity]': messageComponents.studyActivities,
        '[socialActivity]': messageComponents.socialActivities,
        '[adventureActivity]': messageComponents.adventureActivities,
        '[peacefulActivity]': messageComponents.peacefulActivities,
        '[studyLocation]': messageComponents.studyLocations,
        '[socialLocation]': messageComponents.socialLocations,
        '[adventureLocation]': messageComponents.adventureLocations,
        '[peacefulLocation]': messageComponents.peacefulLocations,
        '[gathering]': messageComponents.gatherings,
        '[weather]': messageComponents.weather,
        '[time]': messageComponents.time,
        '[emotion]': emotions
    };
    
    for (const [placeholder, options] of Object.entries(placeholders)) {
        if (message.includes(placeholder)) {
            const randomOption = options[Math.floor(Math.random() * options.length)];
            message = message.replace(placeholder, randomOption);
        }
    }
    
    return message;
}

        // Get current realm object
        function getCurrentRealm() {
            return cultivationRealms[gameState.player.realm];
        }

        // Get next realm object
        function getNextRealm() {
            if (gameState.player.realm < cultivationRealms.length - 1) {
                return cultivationRealms[gameState.player.realm + 1];
            }
            return null;
        }

        // Calculate qi required for current stage breakthrough
        function getQiRequiredForBreakthrough() {
            const currentRealm = getCurrentRealm();
            const baseRequirement = currentRealm.baseQiRequirement;
            const stageFactor = Math.pow(1.5, gameState.player.stage - 1);
            return Math.floor(baseRequirement * stageFactor);
        }

        // Calculate base success rate for breakthrough
        function getBaseSuccessRate() {
            const currentRealm = getCurrentRealm();
            const baseRate = 90 - (gameState.player.realm * 5);
            const stageReduction = (gameState.player.stage - 1) * 2;
            return Math.max(15, baseRate - stageReduction);
        }

        // Calculate stone effectiveness based on realm difference
        function getStoneEffectiveness(stoneType) {
            // Define which realm each stone type is associated with
            const stoneRealms = {
                basic: 0, // Mortal
                low: 2,   // Foundation Establishment
                medium: 4, // Nascent Soul
                high: 6,  // Void Refinement
                supreme: 8, // Mahayana
                divine: 10 // Golden Immortal
            };
            
            const currentRealm = gameState.player.realm;
            const stoneRealm = stoneRealms[stoneType];
            
            const realmDifference = currentRealm - stoneRealm;
            
            if (realmDifference <= 0) {
                return 1.0; // 100% effectiveness for stones of same or higher realm
            } else if (realmDifference === 1) {
                return 0.75; // 75% effectiveness for stones one realm below
            } else if (realmDifference === 2) {
                return 0.5; // 50% effectiveness for stones two realms below
            } else {
                return 0.25; // 25% effectiveness for stones three or more realms below
            }
        }

        // Calculate success rate boost from selected stones
        function calculateSuccessBoost() {
            let totalBoost = 0;
            
            for (const [type, count] of Object.entries(gameState.selectedStones)) {
                if (count > 0) {
                    const stoneInfo = spiritStones[type];
                    const effectiveness = getStoneEffectiveness(type);
                    totalBoost += stoneInfo.successBoost * count * effectiveness;
                }
            }
            
            return Math.floor(totalBoost);
        }

        // Calculate total success rate for breakthrough
        function getTotalSuccessRate() {
            const baseRate = getBaseSuccessRate();
            const boostRate = calculateSuccessBoost();
            return Math.min(99, baseRate + boostRate);
        }

        // Format large numbers with suffixes or scientific notation
        function formatNumber(num) {
            // First ensure it's a number
            num = Number(num);
            
            // Check if we should use scientific notation
            if (gameState.settings.useScientificNotation && num >= gameState.settings.scientificNotationThreshold) {
                return num.toExponential(2);
            }
            
            // Otherwise use suffix formatting
            if (num < 1000) return num.toFixed(0);
            
            const suffixes = ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi'];
            const magnitude = Math.floor(Math.log10(num) / 3);
            const suffix = suffixes[magnitude] || '';
            
            const scaled = num / Math.pow(1000, magnitude);
            const formatted = scaled >= 100 ? scaled.toFixed(0) : 
                              scaled >= 10 ? scaled.toFixed(1) : 
                              scaled.toFixed(2);
            
            return formatted + suffix;
        }

        // Format time in hours and minutes
        function formatTime(minutes) {
            if (minutes < 60) {
                return `${Math.floor(minutes)}m`;
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = Math.floor(minutes % 60);
                return `${hours}h ${mins}m`;
            }
        }

        // Format date to readable string
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        // Format time in minutes and seconds
        function formatTimeMinSec(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Check if it's a new day for resetting daily limits
        function checkNewDay() {
            const now = new Date();
            const today = now.toDateString();
            
            if (gameState.fellowCultivators.dayLastAdded !== today) {
                gameState.fellowCultivators.dayLastAdded = today;
                gameState.fellowCultivators.addedToday = 0;
                saveGameState();
            }
        }

        // Apply current theme to body
        function applyTheme() {
            document.body.className = '';
            document.body.classList.add(`theme-${gameState.settings.theme}`);
            document.body.classList.add(gameState.settings.darkMode ? 'dark' : 'light');
            
            // Update theme mode toggle label
            if (elements.themeModeLabel) {
                elements.themeModeLabel.textContent = gameState.settings.darkMode ? 'Dark' : 'Light';
            }
            
            // Update toggle state
            if (elements.themeModeToggle) {
                elements.themeModeToggle.checked = gameState.settings.darkMode;
            }
            
            // Update theme select
            if (elements.themeSelect) {
                elements.themeSelect.value = gameState.settings.theme;
            }
            
            // Update charts if they exist
            updateAnalyticsCharts();
        }

        // Calculate current idle cultivation rate (including fellow cultivator boosts)
        function getCurrentIdleRate() {
            const currentRealm = getCurrentRealm();
            const baseRate = 0.5; // qi/min
            const realmMultiplier = currentRealm.multiplier;
            
            // Check if fellow cultivator boost is active
            const now = Date.now();
            const boostMultiplier = now < gameState.fellowCultivators.boostEndTime ? 2 : 1;
            
            return baseRate * realmMultiplier * boostMultiplier;
        }

        // Update the UI for cultivation status
        function updateCultivationUI() {
            const currentRealm = getCurrentRealm();
            
            // Update realm and stage info
            elements.currentRealm.textContent = `${currentRealm.name} (${currentRealm.chineseName})`;
            elements.currentStage.textContent = gameState.player.stage;
            elements.maxStage.textContent = isFinite(currentRealm.stages) ? currentRealm.stages : '∞';
            
            // Update qi progress
            const qiRequired = getQiRequiredForBreakthrough();
            const progressPercentage = Math.min(100, (gameState.player.qi / qiRequired) * 100);
            elements.qiProgressBar.style.width = `${progressPercentage}%`;
            elements.currentQi.textContent = formatNumber(gameState.player.qi);
            elements.targetQi.textContent = formatNumber(qiRequired);
            
            // Get current idle rate with potential boost
            const idleRate = getCurrentIdleRate();
            const baseRate = 0.5; // qi/min
            
            // Update idle cultivation rate
            elements.baseRate.textContent = `${baseRate.toFixed(1)} qi/min`;
            elements.currentMultiplier.textContent = `×${currentRealm.multiplier.toFixed(1)}`;
            elements.effectiveRate.textContent = `${idleRate.toFixed(1)} qi/min`;
            elements.nextHourYield.textContent = formatNumber(idleRate * 60);
            
            // Check if fellow cultivator boost is active
            const now = Date.now();
            if (now < gameState.fellowCultivators.boostEndTime) {
                // Show boost indicator
                elements.fellowBoostContainer.classList.remove('hidden');
                
                // Calculate remaining time
                const remainingMinutes = (gameState.fellowCultivators.boostEndTime - now) / (60 * 1000);
                elements.boostTimeRemaining.textContent = formatTime(remainingMinutes);
            } else {
                // Hide boost indicator
                elements.fellowBoostContainer.classList.add('hidden');
            }
            
            // Check if pomodoro boost is active
            if (gameState.pomodoro.boostsRemaining > 0) {
                // Show boost indicator
                elements.pomodoroBoostContainer.classList.remove('hidden');
                elements.pomodoroBoostsRemaining.textContent = gameState.pomodoro.boostsRemaining;
            } else {
                // Hide boost indicator
                elements.pomodoroBoostContainer.classList.add('hidden');
            }
            
            // Update realm description
            elements.realmDescription.textContent = currentRealm.description;
            
            // Update breakthrough information
            elements.breakthroughQiRequired.textContent = formatNumber(qiRequired);
            
            const baseSuccessRate = getBaseSuccessRate();
            elements.baseSuccessRate.textContent = `${baseSuccessRate}%`;
            
            const finalSuccessRate = getTotalSuccessRate();
            elements.finalSuccessRate.textContent = `${finalSuccessRate}%`;
            
            // Update breakthrough button status
            if (gameState.player.qi >= qiRequired) {
                elements.attemptBreakthrough.disabled = false;
                elements.attemptBreakthrough.textContent = "Attempt Breakthrough";
                
                // Check if we should show breakthrough readiness notification
                checkBreakthroughReadiness();
            } else {
                elements.attemptBreakthrough.disabled = true;
                elements.attemptBreakthrough.textContent = `Attempt Breakthrough (Insufficient Qi)`;
            }
            
            // Update cultivator name
            elements.cultivatorName.textContent = gameState.player.name;

            // Update name change field in settings
            if (elements.settingsCultivatorName) {
                elements.settingsCultivatorName.placeholder = gameState.player.name;
                elements.settingsChangeName.disabled = gameState.stones.rename <= 0;
            }
        }

        // Update the UI for spirit stones
        function updateStonesUI() {
            // Update stone counts in inventory
            for (const type in gameState.stones) {
                if (type === 'rename') {
                    elements.renameScrollCount.textContent = gameState.stones.rename + '/1';
                    elements.useRenameScroll.disabled = gameState.stones.rename <= 0;
                } else if (elements.stoneCounters[type]) {
                    elements.stoneCounters[type].textContent = gameState.stones[type];
                }
            }
            
            // Update stone fusion buttons
            elements.stoneButtons.forEach(button => {
                const stoneType = button.getAttribute('data-stone');
                if (gameState.stones[stoneType] >= 100) {
                    button.disabled = false;
                } else {
                    button.disabled = true;
                }
            });
            
            // Update selected stones display
            let selectedText = '';
            let hasSelectedStones = false;
            
            for (const [type, count] of Object.entries(gameState.selectedStones)) {
                if (count > 0) {
                    hasSelectedStones = true;
                    selectedText += `${count}× ${spiritStones[type].name}, `;
                }
            }
            
            if (hasSelectedStones) {
                elements.selectedStones.textContent = selectedText.slice(0, -2);
            } else {
                elements.selectedStones.textContent = 'None';
            }
            
            // Update success boost
            const boost = calculateSuccessBoost();
            elements.successBoost.textContent = `+${boost}%`;
            
            // Update stone count in UI
            const stoneElements = document.querySelectorAll('.spirit-stone');
            stoneElements.forEach(stoneEl => {
                const type = stoneEl.getAttribute('data-type');
                if (type) {
                    const countEl = stoneEl.querySelector('.stone-count');
                    if (countEl) {
                        countEl.textContent = gameState.stones[type] || 0;
                    }
                }
            });
        }

        // Update fellow cultivators UI
        function updateFellowCultivatorsUI() {
            // Check if it's a new day for resetting daily limits
            checkNewDay();
            
            // Update added today count
            elements.cultivatorsAddedToday.textContent = `Cultivators added today: ${gameState.fellowCultivators.addedToday}/5`;
            
            // Update boost status
            const now = Date.now();
            if (now < gameState.fellowCultivators.boostEndTime) {
                elements.fcNoBoost.classList.add('hidden');
                elements.fcActiveBoost.classList.remove('hidden');
                
                // Calculate remaining time
                const remainingMinutes = (gameState.fellowCultivators.boostEndTime - now) / (60 * 1000);
                elements.fcBoostTimeRemaining.textContent = formatTime(remainingMinutes);
            } else {
                elements.fcNoBoost.classList.remove('hidden');
                elements.fcActiveBoost.classList.add('hidden');
            }
            
            // Update last encounter
            if (gameState.fellowCultivators.lastEncounter) {
                elements.fcNoEncounters.classList.add('hidden');
                elements.fcLastEncounterDetails.classList.remove('hidden');
                elements.fcLastEncounterMessage.textContent = gameState.fellowCultivators.lastEncounter.message;
                elements.fcLastEncounterTime.textContent = formatDate(gameState.fellowCultivators.lastEncounter.timestamp);
            } else {
                elements.fcNoEncounters.classList.remove('hidden');
                elements.fcLastEncounterDetails.classList.add('hidden');
            }
            
            // Update cultivator pools
            renderCultivatorPools();
            
            // Update dropdowns
            updateCultivatorDropdowns();
            
            // Count cultivators
            const builtinCultivatorCount = gameState.fellowCultivators.pool.filter(c => !c.custom).length;
            const customCultivatorCount = gameState.fellowCultivators.pool.filter(c => c.custom).length;
            
            elements.builtinCultivatorCount.textContent = builtinCultivatorCount;
            elements.customCultivatorsCount.textContent = `${customCultivatorCount}/32`;
            
            // Add button disabled if at max for day or max total
            elements.addCultivator.disabled = 
                gameState.fellowCultivators.addedToday >= 5 || 
                customCultivatorCount >= 32;
            
            // Update "only meet custom" setting
            if (elements.onlyMeetCustomCultivators) {
                elements.onlyMeetCustomCultivators.checked = gameState.settings.onlyMeetCustomCultivators;
            }
        }

        // Render cultivator pools
        function renderCultivatorPools() {
            // Split cultivators into built-in and custom
            const builtinCultivators = gameState.fellowCultivators.pool.filter(c => !c.custom);
            const customCultivators = gameState.fellowCultivators.pool.filter(c => c.custom);
            
            // Update built-in cultivators
            if (builtinCultivators.length === 0) {
                elements.noBuiltinCultivatorsMessage.classList.remove('hidden');
                elements.builtinCultivatorPool.innerHTML = '';
            } else {
                elements.noBuiltinCultivatorsMessage.classList.add('hidden');
                elements.builtinCultivatorPool.innerHTML = '';
                
                // Sort by name
                const sortedBuiltin = [...builtinCultivators].sort((a, b) => 
                    a.name.localeCompare(b.name)
                );
                
                // Create cards for each cultivator
                sortedBuiltin.forEach(cultivator => {
                    const card = document.createElement('div');
                    card.className = 'fellow-cultivator-card';
                    card.dataset.id = cultivator.id;
                    
                    let lastEncounterText = '';
                    if (cultivator.encounters > 0) {
                        lastEncounterText = `<div>Encounters: ${cultivator.encounters}</div>`;
                    }
                    
                    card.innerHTML = `
                        <div class="fellow-cultivator-name">${cultivator.name}</div>
                        <div class="fellow-cultivator-meta">
                            <div>Built-in</div>
                            ${lastEncounterText}
                        </div>
                    `;
                    
                    elements.builtinCultivatorPool.appendChild(card);
                });
            }
            
            // Update custom cultivators
            if (customCultivators.length === 0) {
                elements.noCustomCultivatorsMessage.classList.remove('hidden');
                elements.customCultivatorPool.innerHTML = '';
            } else {
                elements.noCustomCultivatorsMessage.classList.add('hidden');
                elements.customCultivatorPool.innerHTML = '';
                
                // Sort by name
                const sortedCustom = [...customCultivators].sort((a, b) => 
                    a.name.localeCompare(b.name)
                );
                
                // Create cards for each cultivator
                sortedCustom.forEach(cultivator => {
                    const card = document.createElement('div');
                    card.className = 'fellow-cultivator-card';
                    card.dataset.id = cultivator.id;
                    
                    const now = Date.now();
                    const canEdit = now > cultivator.editCooldown;
                    
                    let editCooldownText = '';
                    if (!canEdit) {
                        const cooldownEnds = new Date(cultivator.editCooldown);
                        editCooldownText = `<div>Edit available: ${cooldownEnds.toLocaleDateString()}</div>`;
                    }
                    
                    let lastEncounterText = '';
                    if (cultivator.encounters > 0) {
                        lastEncounterText = `<div>Encounters: ${cultivator.encounters}</div>`;
                    }
                    
                    card.innerHTML = `
                        <div class="fellow-cultivator-name">${cultivator.name}</div>
                        <div class="fellow-cultivator-meta">
                            <div>Custom</div>
                            ${lastEncounterText}
                            ${editCooldownText}
                        </div>
                    `;
                    
                    elements.customCultivatorPool.appendChild(card);
                });
            }
        }

        // Update cultivator dropdowns
        function updateCultivatorDropdowns() {
            // Clear existing options
            elements.editCultivatorSelect.innerHTML = '<option value="">Select a cultivator</option>';
            elements.removeCultivatorSelect.innerHTML = '<option value="">Select a cultivator</option>';
            
            // Get custom cultivators
            const customCultivators = gameState.fellowCultivators.pool.filter(c => c.custom);
            
            // Sort by name
            const sortedCultivators = [...customCultivators].sort((a, b) => 
                a.name.localeCompare(b.name)
            );
            
            // Add options for each custom cultivator
            sortedCultivators.forEach(cultivator => {
                const now = Date.now();
                const canEdit = now > cultivator.editCooldown;
                
                // Edit dropdown - only add custom cultivators that can be edited
                if (canEdit) {
                    const editOption = document.createElement('option');
                    editOption.value = cultivator.id;
                    editOption.textContent = cultivator.name;
                    elements.editCultivatorSelect.appendChild(editOption);
                }
                
                // Remove dropdown - only add custom cultivators
                const removeOption = document.createElement('option');
                removeOption.value = cultivator.id;
                removeOption.textContent = cultivator.name;
                elements.removeCultivatorSelect.appendChild(removeOption);
            });
            
            // Hide edit form initially
            elements.editCultivatorForm.classList.add('hidden');
            elements.editCooldownInfo.classList.add('hidden');
            
            // Disable remove button initially
            elements.removeCultivator.disabled = true;
        }

        // Update pomodoro UI
        function updatePomodoroUI() {
            // Update timer display
            elements.timerDisplay.textContent = formatTimeMinSec(gameState.pomodoro.timeRemaining);
            
            // Update progress bar
            const totalTime = (gameState.pomodoro.isBreak ? gameState.pomodoro.breakDuration : gameState.pomodoro.focusDuration) * 60;
            const progress = ((totalTime - gameState.pomodoro.timeRemaining) / totalTime) * 100;
            elements.timerProgressBar.style.width = `${progress}%`;
            
            // Update break indicator
            if (gameState.pomodoro.isBreak) {
                elements.breakIndicator.classList.remove('hidden');
            } else {
                elements.breakIndicator.classList.add('hidden');
            }
            
            // Update timer controls
            elements.timerStart.disabled = gameState.pomodoro.isRunning && !gameState.pomodoro.isPaused;
	    elements.timerPause.disabled = !gameState.pomodoro.isRunning || gameState.pomodoro.isPaused;
            
            // Update duration sliders
            elements.focusDuration.value = gameState.pomodoro.focusDuration;
            elements.focusDurationDisplay.textContent = `${gameState.pomodoro.focusDuration} min`;
            
            elements.breakDuration.value = gameState.pomodoro.breakDuration;
            elements.breakDurationDisplay.textContent = `${gameState.pomodoro.breakDuration} min`;
            
            // Update use break toggle
            elements.useBreak.checked = gameState.pomodoro.useBreak;
            
            // Update boost info
            if (gameState.pomodoro.boostsRemaining > 0) {
                elements.activePomodoroBoost.classList.remove('hidden');
                elements.noPomodoroBoost.classList.add('hidden');
                elements.remainingBoostedTasks.textContent = gameState.pomodoro.boostsRemaining;
            } else {
                elements.activePomodoroBoost.classList.add('hidden');
                elements.noPomodoroBoost.classList.remove('hidden');
            }
            
            // Update session statistics
            elements.totalSessions.textContent = gameState.stats.pomodoroSessions;
            elements.totalFocusTime.textContent = gameState.stats.pomodoroTotalMinutes;
            elements.totalBoostsEarned.textContent = gameState.stats.pomodoroBoostsEarned;
            elements.totalBoostedTasks.textContent = gameState.stats.pomodoroTasksCompleted;
            
            // Update session history
            updatePomodoroSessionHistory();
        }

        // Update pomodoro session history
        function updatePomodoroSessionHistory() {
            if (!elements.sessionHistory) return;
            
            if (gameState.pomodoro.history.length === 0) {
                elements.sessionHistory.innerHTML = '<p class="text-center italic">No sessions completed yet</p>';
                return;
            }
            
            elements.sessionHistory.innerHTML = '';
            
            // Sort sessions by date (most recent first)
            const sortedSessions = [...gameState.pomodoro.history].reverse();
            
            // Show the last 10 sessions
            const recentSessions = sortedSessions.slice(0, 10);
            
            recentSessions.forEach(session => {
                const sessionEl = document.createElement('div');
                sessionEl.className = 'mb-3 p-2 border border-ancient-accent rounded';
                
                const date = new Date(session.endTime);
                const dateString = date.toLocaleDateString();
                const timeString = date.toLocaleTimeString();
                
                let boostText = '';
                if (session.duration >= 15) {
                    const boosts = session.duration >= 25 ? 10 : (session.duration >= 20 ? 8 : 5);
                    boostText = `<div class="text-sm font-bold text-right">Reward: ${boosts} boosted tasks</div>`;
                }
                
                sessionEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold">${session.duration} minute session</div>
                            <div class="text-sm">${dateString} at ${timeString}</div>
                        </div>
                        ${boostText}
                    </div>
                `;
                
                elements.sessionHistory.appendChild(sessionEl);
            });
            
            // Show count of earlier sessions if there are more
            if (sortedSessions.length > 10) {
                const earlierCount = sortedSessions.length - 10;
                const earlierEl = document.createElement('div');
                earlierEl.className = 'text-center italic mt-2';
                earlierEl.textContent = `... and ${earlierCount} earlier session${earlierCount > 1 ? 's' : ''}`;
                elements.sessionHistory.appendChild(earlierEl);
            }
        }

        // Update achievements UI
        function updateAchievementsUI(category = 'all') {
            if (!elements.achievementList) return;
            
            // Calculate total achievements and completion rate
            const totalAchievements = Object.keys(achievementData).length;
            const unlockedCount = Object.keys(gameState.achievements.unlocked).length;
            const completionRate = totalAchievements > 0 ? (unlockedCount / totalAchievements) * 100 : 0;
            
            // Update achievement summary
            elements.achievementTotalCount.textContent = `${unlockedCount}/${totalAchievements}`;
            elements.achievementPercent.textContent = `${completionRate.toFixed(1)}%`;
            
            // Find latest achievement
            if (gameState.achievements.lastUnlocked) {
                const lastAchievement = achievementData[gameState.achievements.lastUnlocked];
                elements.achievementLatest.textContent = lastAchievement ? lastAchievement.title : 'None';
            } else {
                elements.achievementLatest.textContent = 'None';
            }
            
            // Find rarest achievement (highest rarity that's unlocked)
            const rarityOrder = ['common', 'uncommon', 'rare', 'epic', 'legendary', 'mythic'];
            let rarestAchievement = null;
            
            for (let i = rarityOrder.length - 1; i >= 0; i--) {
                const rarity = rarityOrder[i];
                const matchingAchievement = Object.values(achievementData)
                    .find(a => a.rarity === rarity && gameState.achievements.unlocked[a.id]);
                
                if (matchingAchievement) {
                    rarestAchievement = matchingAchievement;
                    break;
                }
            }
            
            elements.achievementRarest.textContent = rarestAchievement ? rarestAchievement.title : 'None';
            
            // Update category tabs with counts
            document.querySelectorAll('.achievement-tab').forEach(tab => {
                const tabCategory = tab.getAttribute('data-category');
                const countSpan = tab.querySelector('.achievement-count');
                
                if (tabCategory === 'all') {
                    countSpan.textContent = unlockedCount;
                } else if (tabCategory === 'hidden') {
                    // Count undiscovered hidden achievements
                    const hiddenAchievements = Object.values(achievementData)
                        .filter(a => a.isHidden && !gameState.achievements.discoveredHidden.includes(a.id));
                    countSpan.textContent = hiddenAchievements.length;
                } else {
                    // Count achievements in this category
                    const categoryAchievements = Object.values(achievementData)
                        .filter(a => a.category === tabCategory);
                    const unlockedInCategory = categoryAchievements
                        .filter(a => gameState.achievements.unlocked[a.id])
                        .length;
                    countSpan.textContent = unlockedInCategory;
                }
            });
            
            // Clear achievement list
            elements.achievementList.innerHTML = '';
            
            // Get achievements to display based on selected category
            let achievementsToDisplay = [];
            
            if (category === 'all') {
                // All visible achievements and discovered hidden achievements
                achievementsToDisplay = Object.values(achievementData).filter(a => 
                    !a.isHidden || gameState.achievements.discoveredHidden.includes(a.id)
                );
            } else if (category === 'hidden') {
                // Only undiscovered hidden achievements (shown as ??? placeholders)
                achievementsToDisplay = Object.values(achievementData).filter(a => 
                    a.isHidden && !gameState.achievements.discoveredHidden.includes(a.id)
                );
            } else {
                // Filter by category, excluding undiscovered hidden
                achievementsToDisplay = Object.values(achievementData).filter(a => 
                    a.category === category && (!a.isHidden || gameState.achievements.discoveredHidden.includes(a.id))
                );
            }
            
            // If no achievements to display
            if (achievementsToDisplay.length === 0) {
                elements.achievementList.innerHTML = '<p class="text-center italic">No achievements found in this category</p>';
                return;
            }
            
            // Sort achievements: first unlocked, then by progress
            achievementsToDisplay.sort((a, b) => {
                // First sort by unlock status
                const aUnlocked = gameState.achievements.unlocked[a.id] ? 1 : 0;
                const bUnlocked = gameState.achievements.unlocked[b.id] ? 1 : 0;
                
                if (aUnlocked !== bUnlocked) {
                    return bUnlocked - aUnlocked; // Unlocked first
                }
                
                // Then sort by progress
                const aProgress = getAchievementProgress(a.id) / a.maxProgress;
                const bProgress = getAchievementProgress(b.id) / b.maxProgress;
                
                return bProgress - aProgress; // Higher progress first
            });
            
            // Render each achievement
            achievementsToDisplay.forEach(achievement => {
                renderAchievement(achievement);
            });
        }

        // Render a single achievement
        function renderAchievement(achievement) {
            const isUnlocked = gameState.achievements.unlocked[achievement.id];
            const isHidden = achievement.isHidden && !gameState.achievements.discoveredHidden.includes(achievement.id);
            
            const achievementEl = document.createElement('div');
            achievementEl.className = `achievement-card ${isUnlocked ? 'achievement-completed' : ''}`;
            
            // For hidden achievements that haven't been discovered
            if (isHidden) {
                achievementEl.innerHTML = `
                    <div class="achievement-icon achievement-hidden flex-shrink-0">
                        <i class="fas fa-question"></i>
                    </div>
                    <div class="achievement-content">
                        <div class="achievement-title">Hidden Achievement</div>
                        <div class="achievement-description">Continue your cultivation journey to discover this achievement.</div>
                        <div class="achievement-progress">
                            <div class="achievement-progress-bar achievement-hidden" style="width: 0%"></div>
                        </div>
                    </div>
                `;
                elements.achievementList.appendChild(achievementEl);
                return;
            }
            
            // Calculate progress
            const progress = getAchievementProgress(achievement.id);
            const progressPercent = Math.min(100, (progress / achievement.maxProgress) * 100);
            const progressText = `${formatNumber(progress)}/${formatNumber(achievement.maxProgress)}`;
            
            // Choose icon based on achievement status and category
            let icon = '';
            if (isUnlocked) {
                icon = '<i class="fas fa-check"></i>';
            } else {
                switch (achievement.category) {
                    case 'cultivation':
                        icon = '<i class="fas fa-mountain"></i>';
                        break;
                    case 'tasks':
                        icon = '<i class="fas fa-tasks"></i>';
                        break;
                    case 'stones':
                        icon = '<i class="fas fa-gem"></i>';
                        break;
                    case 'cultivators':
                        icon = '<i class="fas fa-user-friends"></i>';
                        break;
                    case 'pomodoro':
                        icon = '<i class="fas fa-stopwatch"></i>';
                        break;
                    case 'misc':
                        icon = '<i class="fas fa-star"></i>';
                        break;
                    default:
                        icon = '<i class="fas fa-trophy"></i>';
                }
            }
            
            achievementEl.innerHTML = `
                <div class="achievement-icon achievement-${achievement.rarity}">
                    ${icon}
                </div>
                <div class="achievement-content">
                    <div class="achievement-title">${achievement.title}</div>
                    <div class="achievement-description">${achievement.description}</div>
                    <div class="flex justify-between items-center text-xs mb-1">
                        <div>${progressText}</div>
                        <div>${isUnlocked ? 'Completed' : achievement.rarity.charAt(0).toUpperCase() + achievement.rarity.slice(1)}</div>
                    </div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar achievement-${achievement.rarity}" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
            `;
            
            elements.achievementList.appendChild(achievementEl);
        }

        // Get current progress for an achievement
        function getAchievementProgress(achievementId) {
            const achievement = achievementData[achievementId];
            if (!achievement) return 0;
            
            // If already unlocked, return max progress
            if (gameState.achievements.unlocked[achievementId]) {
                return achievement.maxProgress;
            }
            
            // Use stored progress value if it exists
            if (gameState.achievements.progress[achievementId] !== undefined) {
                return gameState.achievements.progress[achievementId];
            }
            
            // If achievement has a checkProgress function, use it
            if (achievement.checkProgress) {
                return achievement.checkProgress();
            }
            
            // For condition-based achievements, return 0 or max based on condition
            if (achievement.checkCondition) {
                return achievement.checkCondition() ? achievement.maxProgress : 0;
            }
            
            return 0;
        }

        // Check if an achievement should be unlocked
        function checkAchievement(achievementId) {
            const achievement = achievementData[achievementId];
            if (!achievement || gameState.achievements.unlocked[achievementId]) {
                return false; // Already unlocked or invalid ID
            }
            
            let progress = getAchievementProgress(achievementId);
            
            // For hidden achievements, check if they should be revealed
            if (achievement.isHidden && !gameState.achievements.discoveredHidden.includes(achievementId)) {
                const revealThreshold = achievement.revealThreshold || 0.2; // Default 20%
                if (progress >= achievement.maxProgress * revealThreshold) {
                    gameState.achievements.discoveredHidden.push(achievementId);
                    // No need to show a notification for just revealing
                }
            }
            
            // Check if the achievement is complete
            if (progress >= achievement.maxProgress) {
                // Unlock the achievement
                gameState.achievements.unlocked[achievementId] = {
                    date: Date.now()
                };
                gameState.achievements.lastUnlocked = achievementId;
                
                // Show notification
                if (gameState.notifications.settings.achievement) {
                    showAchievementUnlock(achievement);
                } else {
                    showToast(`Achievement Unlocked: ${achievement.title}`, "success");
                }
                
                // Check for "achieve X" achievements
                const totalAchievements = Object.keys(gameState.achievements.unlocked).length;
                if (totalAchievements >= 10) {
                    checkAchievement("misc_achieve_10");
                }
                if (totalAchievements >= 25) {
                    checkAchievement("misc_achieve_25");
                }
                if (totalAchievements >= 50) {
                    checkAchievement("misc_achieve_50");
                }
                
                // Save game state
                saveGameState();
                
                return true;
            }
            
            return false;
        }

        // Show achievement unlock notification
        function showAchievementUnlock(achievement) {
            // Show custom notification
            showNotification('achievement', "Achievement Unlocked", achievement.title);
            
            // Show achievement unlock modal
            elements.achievementUnlockIcon.className = `achievement-icon achievement-${achievement.rarity}`;
            
            // Choose icon based on category
            let iconClass = 'fas fa-trophy';
            switch (achievement.category) {
                case 'cultivation':
                    iconClass = 'fas fa-mountain';
                    break;
                case 'tasks':
                    iconClass = 'fas fa-tasks';
                    break;
                case 'stones':
                    iconClass = 'fas fa-gem';
                    break;
                case 'cultivators':
                    iconClass = 'fas fa-user-friends';
                    break;
                case 'pomodoro':
                    iconClass = 'fas fa-stopwatch';
                    break;
                case 'misc':
                    iconClass = 'fas fa-star';
                    break;
            }
            
            elements.achievementUnlockIcon.innerHTML = `<i class="${iconClass}"></i>`;
            elements.achievementUnlockTitle.textContent = achievement.title;
            elements.achievementUnlockDescription.textContent = achievement.description;
            
            // Show modal
            elements.achievementUnlockOverlay.classList.remove('hidden');
        }

        // Find most completed task
        function getMostCompletedTask() {
            if (gameState.tasks.length === 0) return 'None';
            
            let mostCompletedTask = null;
            let maxCompletions = -1;
            
            for (const task of gameState.tasks) {
                const completions = task.completionCount || 0;
                if (completions > maxCompletions) {
                    maxCompletions = completions;
                    mostCompletedTask = task;
                }
            }
            
            if (mostCompletedTask && maxCompletions > 0) {
                return `${mostCompletedTask.name} (${maxCompletions})`;
            }
            return 'None';
        }

        // Find most active tag
        function getMostActiveTag() {
            const tagCounts = {};
            
            // Count completions for each tag
            gameState.tasks.forEach(task => {
                const completions = task.completionCount || 0;
                if (completions > 0 && task.tags && task.tags.length > 0) {
                    task.tags.forEach(tag => {
                        if (!tagCounts[tag]) tagCounts[tag] = 0;
                        tagCounts[tag] += completions;
                    });
                }
            });
            
            // Find the tag with the most completions
            let mostActiveTag = null;
            let maxCompletions = -1;
            
            for (const [tag, count] of Object.entries(tagCounts)) {
                if (count > maxCompletions) {
                    maxCompletions = count;
                    mostActiveTag = tag;
                }
            }
            
            if (mostActiveTag && maxCompletions > 0) {
                return `${mostActiveTag} (${maxCompletions})`;
            }
            return 'None';
        }

        // Update the statistics UI
        function updateStatisticsUI() {
            // Task statistics
            elements.statTotalTasks.textContent = gameState.stats.totalTasks;
            elements.statCompletedTasks.textContent = gameState.stats.completedTasks;
            
            const avgQi = gameState.stats.completedTasks > 0 ? 
                (gameState.stats.totalQiEarned / gameState.stats.completedTasks).toFixed(1) : '0';
            elements.statAvgQi.textContent = avgQi;
            
            const totalStones = Object.values(gameState.stats.totalStonesFound).reduce((a, b) => a + b, 0);
            const avgStones = gameState.stats.completedTasks > 0 ? 
                (totalStones / gameState.stats.completedTasks).toFixed(2) : '0';
            elements.statAvgStones.textContent = avgStones;
            
            // Most completed task and most active tag
            elements.statMostCompletedTask.textContent = getMostCompletedTask();
            elements.statMostActiveTag.textContent = getMostActiveTag();
            
            // Breakthrough statistics
            elements.statBreakthroughs.textContent = gameState.stats.breakthroughs;
            elements.statFailedAttempts.textContent = gameState.stats.failedAttempts;
            
            const totalAttempts = gameState.stats.breakthroughs + gameState.stats.failedAttempts;
            const successRate = totalAttempts > 0 ? 
                ((gameState.stats.breakthroughs / totalAttempts) * 100).toFixed(1) : '0';
            elements.statSuccessRate.textContent = `${successRate}%`;
            
            elements.statHighestRealm.textContent = cultivationRealms[gameState.stats.highestRealmReached].name;
            
            // Total Qi and passive percentage
            elements.statTotalQi.textContent = formatNumber(gameState.stats.totalQiEarned);
            
            const totalQi = gameState.stats.totalQiEarned;
            const passiveQi = gameState.stats.totalQiPassive;
            const passivePercent = totalQi > 0 ? ((passiveQi / totalQi) * 100).toFixed(1) : '0';
            elements.statPassiveQi.textContent = `${passivePercent}%`;
            
            // Pomodoro stats
            elements.statPomodoroQi.textContent = formatNumber(gameState.stats.totalQiPomodoro);
            elements.statPomodoroBoostedTasks.textContent = gameState.stats.pomodoroTasksCompleted;
            
            // Spirit stone statistics
            elements.statBasicStones.textContent = gameState.stats.totalStonesFound.basic;
            elements.statLowStones.textContent = gameState.stats.totalStonesFound.low;
            elements.statMediumStones.textContent = gameState.stats.totalStonesFound.medium;
            elements.statHighStones.textContent = gameState.stats.totalStonesFound.high;
            elements.statSupremeStones.textContent = gameState.stats.totalStonesFound.supreme;
            elements.statDivineStones.textContent = gameState.stats.totalStonesFound.divine;
            
            // Fusion statistics
            elements.statBasicFused.textContent = gameState.stats.stonesFused.basic;
            elements.statLowFused.textContent = gameState.stats.stonesFused.low;
            elements.statMediumFused.textContent = gameState.stats.stonesFused.medium;
            elements.statHighFused.textContent = gameState.stats.stonesFused.high;
            elements.statSupremeFused.textContent = gameState.stats.stonesFused.supreme;
            
            // Special items statistics
            elements.statRenameScrolls.textContent = gameState.stats.totalStonesFound.rename;
            elements.statRenameScrollsUsed.textContent = gameState.stats.renameScrollsUsed;
            
            // Fellow Cultivator statistics
            elements.statCultivatorsMet.textContent = gameState.stats.cultivatorsMet;
            elements.statTotalBoostTime.textContent = (gameState.stats.totalBoostTime / 60).toFixed(1);
            elements.statQiFromBoosts.textContent = formatNumber(gameState.stats.qiFromBoosts);
            
            // Pomodoro statistics
            elements.statPomodoroSessions.textContent = gameState.stats.pomodoroSessions;
            elements.statFocusMinutes.textContent = gameState.stats.pomodoroTotalMinutes;
            elements.statBoostsEarned.textContent = gameState.stats.pomodoroBoostsEarned;
            
            // Achievement statistics
            const totalAchievements = Object.keys(achievementData).length;
            const unlockedCount = Object.keys(gameState.achievements.unlocked).length;
            const completionRate = totalAchievements > 0 ? (unlockedCount / totalAchievements) * 100 : 0;
            
            elements.statTotalAchievements.textContent = `${unlockedCount}/${totalAchievements}`;
            elements.statAchievementRate.textContent = `${completionRate.toFixed(1)}%`;
            
            // Hidden achievements
            const hiddenAchievements = Object.values(achievementData).filter(a => a.isHidden).length;
            const discoveredHidden = gameState.achievements.discoveredHidden.length;
            elements.statHiddenAchievements.textContent = `${discoveredHidden}/${hiddenAchievements}`;
        }

        // Update Analytics UI
        function updateAnalyticsUI() {
            // Update Qi Source Distribution
            const totalQi = gameState.stats.totalQiEarned;
            const passiveQi = gameState.stats.totalQiPassive;
            const activeQi = totalQi - passiveQi;
            
            const activePercent = totalQi > 0 ? ((activeQi / totalQi) * 100).toFixed(1) : '0';
            const passivePercent = totalQi > 0 ? ((passiveQi / totalQi) * 100).toFixed(1) : '0';
            
            elements.qiSourceActive.style.width = `${activePercent}%`;
            elements.qiSourcePassive.style.width = `${passivePercent}%`;
            elements.qiActivePercent.textContent = `${activePercent}%`;
            elements.qiPassivePercent.textContent = `${passivePercent}%`;
        }

        // Create or update analytics charts
        function updateAnalyticsCharts() {
            // Set chart defaults based on theme
            Chart.defaults.color = getComputedStyle(document.body).getPropertyValue('--chart-text');
            Chart.defaults.scale.grid.color = getComputedStyle(document.body).getPropertyValue('--chart-grid');
            
            // First update the basic analytics UI
            updateAnalyticsUI();
            
            // Helper to create a color gradient based on current theme
            function getThemeGradient(ctx, chartArea, color1, color2) {
                const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);
                return gradient;
            }
            
            // Get theme colors
            const accentColor = getComputedStyle(document.body).getPropertyValue('--ancient-accent');
            const qiColor = getComputedStyle(document.body).getPropertyValue('--qi-color');
            const mediumColor = getComputedStyle(document.body).getPropertyValue('--ancient-medium');
            
            // Create QI Efficiency Chart
            if (elements.qiEfficiencyChart) {
                // Get last 10 data points for efficiency
                const efficiencyData = gameState.analytics.qiEfficiency.slice(-10);
                
                // If the chart already exists, destroy it first
                if (charts.qiEfficiency) {
                    charts.qiEfficiency.destroy();
                }
                
                // Only create chart if we have data
                if (efficiencyData.length > 0) {
                    charts.qiEfficiency = new Chart(elements.qiEfficiencyChart, {
                        type: 'line',
                        data: {
                            labels: efficiencyData.map((_, index) => `Task Set ${index + 1}`),
                            datasets: [{
                                label: 'Qi/Task',
                                data: efficiencyData,
                                borderColor: qiColor,
                                backgroundColor: function(context) {
                                    const chart = context.chart;
                                    const {ctx, chartArea} = chart;
                                    if (!chartArea) return null;
                                    return getThemeGradient(ctx, chartArea, 'rgba(93, 92, 222, 0.1)', 'rgba(93, 92, 222, 0.4)');
                                },
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Qi Earned'
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Create Tasks By Tag Chart
            if (elements.tasksByTagChart) {
                // Collect tag data
                const tagCounts = {};
                gameState.tasks.forEach(task => {
                    const completions = task.completionCount || 0;
                    if (completions > 0 && task.tags && task.tags.length > 0) {
                        task.tags.forEach(tag => {
                            if (!tagCounts[tag]) tagCounts[tag] = 0;
                            tagCounts[tag] += completions;
                        });
                    }
                });
                
                // Sort tags by count
                const sortedTags = Object.entries(tagCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5); // Top 5 tags
                
                // If the chart already exists, destroy it first
                if (charts.tasksByTag) {
                    charts.tasksByTag.destroy();
                }
                
                // Only create chart if we have data
                if (sortedTags.length > 0) {
                    // Generate colors for each tag
                    const colors = [
                        accentColor,
                        qiColor,
                        mediumColor,
                        '#4CAF50',
                        '#9C27B0'
                    ];
                    
                    charts.tasksByTag = new Chart(elements.tasksByTagChart, {
                        type: 'pie',
                        data: {
                            labels: sortedTags.map(tag => tag[0]),
                            datasets: [{
                                data: sortedTags.map(tag => tag[1]),
                                backgroundColor: colors.slice(0, sortedTags.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                }
            }
            
            // Create Cultivation Journey Chart
            if (elements.cultivationJourneyChart) {
                // Include current state in journey
                const journeyData = [...gameState.analytics.realmHistory];
                
                // Add current state if not already included
                const now = Date.now();
                const currentState = {
                    timestamp: now,
                    realm: gameState.player.realm,
                    stage: gameState.player.stage
                };
                journeyData.push(currentState);
                
                // If the chart already exists, destroy it first
                if (charts.cultivationJourney) {
                    charts.cultivationJourney.destroy();
                }
                
                // Only create chart if we have data
                if (journeyData.length > 0) {
                    const labels = journeyData.map(data => {
                        const date = new Date(data.timestamp);
                        return date.toLocaleDateString();
                    });
                    
                    // Map the realm and stage to a combined value
                    const values = journeyData.map(data => 
                        data.realm + (data.stage / 10)
                    );
                    
                    charts.cultivationJourney = new Chart(elements.cultivationJourneyChart, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Cultivation Level',
                                data: values,
                                borderColor: qiColor,
                                backgroundColor: function(context) {
                                    const chart = context.chart;
                                    const {ctx, chartArea} = chart;
                                    if (!chartArea) return null;
                                    return getThemeGradient(ctx, chartArea, 'rgba(93, 92, 222, 0)', 'rgba(93, 92, 222, 0.3)');
                                },
                                tension: 0.3,
                                fill: true,
                                pointBackgroundColor: accentColor
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const index = context.dataIndex;
                                            const data = journeyData[index];
                                            const realmName = cultivationRealms[data.realm].name;
                                            return `${realmName}, Stage ${data.stage}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    ticks: {
                                        callback: function(value) {
                                            const realm = Math.floor(value);
                                            return cultivationRealms[realm]?.name || '';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Create Activity Heatmap Chart
            if (elements.activityHeatmapChart) {
                // If the chart already exists, destroy it first
                if (charts.activityHeatmap) {
                    charts.activityHeatmap.destroy();
                }
                
                // Get day of week data
                const dayLabels = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const activityData = gameState.stats.completionByDayOfWeek;
                
                charts.activityHeatmap = new Chart(elements.activityHeatmapChart, {
                    type: 'bar',
                    data: {
                        labels: dayLabels,
                        datasets: [{
                            label: 'Tasks Completed',
                            data: activityData,
                            backgroundColor: function(context) {
                                const chart = context.chart;
                                const {ctx, chartArea} = chart;
                                if (!chartArea) return null;
                                return getThemeGradient(ctx, chartArea, accentColor, qiColor);
                            },
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Tasks Completed'
                                }
                            }
                        }
                    }
                });
            }
            
            // Create Pomodoro Duration Chart
            if (elements.pomodoroDurationChart) {
                // If the chart already exists, destroy it first
                if (charts.pomodoroDuration) {
                    charts.pomodoroDuration.destroy();
                }
                
                // Get data from analytics
                const durationData = [
                    gameState.analytics.pomodoroByDuration[5] || 0,
                    gameState.analytics.pomodoroByDuration[10] || 0,
                    gameState.analytics.pomodoroByDuration[15] || 0,
                    gameState.analytics.pomodoroByDuration[20] || 0,
                    gameState.analytics.pomodoroByDuration[25] || 0
                ];
                
                const durationLabels = ['5 min', '10 min', '15 min', '20 min', '25 min'];
                
                charts.pomodoroDuration = new Chart(elements.pomodoroDurationChart, {
                    type: 'bar',
                    data: {
                        labels: durationLabels,
                        datasets: [{
                            label: 'Sessions Completed',
                            data: durationData,
                            backgroundColor: function(context) {
                                const value = context.raw;
                                const index = context.dataIndex;
                                
                                // Different colors based on whether the duration gives rewards
                                if (index >= 2) { // 15+ minutes
                                    return getComputedStyle(document.body).getPropertyValue('--qi-color');
                                } else {
                                    return getComputedStyle(document.body).getPropertyValue('--ancient-medium');
                                }
                            },
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Sessions'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Render task list
        function renderTaskList() {
            if (gameState.tasks.length === 0) {
                elements.taskList.innerHTML = '<p class="text-center italic">No tasks added yet</p>';
                elements.editSelectedTask.disabled = true;
                elements.deleteSelectedTasks.disabled = true;
                return;
            }
            
            // Sort tasks if needed
            const sortOption = elements.sortTasks.value;
            const sortedTasks = [...gameState.tasks];
            
            if (sortOption === 'name-asc') {
                sortedTasks.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortOption === 'name-desc') {
                sortedTasks.sort((a, b) => b.name.localeCompare(a.name));
            } else if (sortOption === 'tag-asc') {
                sortedTasks.sort((a, b) => (a.tags[0] || '').localeCompare(b.tags[0] || ''));
            } else if (sortOption === 'tag-desc') {
                sortedTasks.sort((a, b) => (b.tags[0] || '').localeCompare(a.tags[0] || ''));
            } else if (sortOption === 'completion-asc') {
                sortedTasks.sort((a, b) => (a.completionCount || 0) - (b.completionCount || 0));
            } else if (sortOption === 'completion-desc') {
                sortedTasks.sort((a, b) => (b.completionCount || 0) - (a.completionCount || 0));
            }
            
            // Build the task list HTML
            elements.taskList.innerHTML = '';
            
            sortedTasks.forEach((task, index) => {
                const taskEl = document.createElement('div');
                taskEl.className = 'mb-2 p-2 border border-ancient-accent rounded flex items-start';
                taskEl.dataset.id = task.id;
                
                // Task selection checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'custom-checkbox mr-2 mt-1';
                checkbox.dataset.id = task.id;
                
                // Task content
                const taskContent = document.createElement('div');
                taskContent.className = 'flex-grow';
                
                const taskName = document.createElement('div');
                taskName.className = 'font-bold';
                taskName.textContent = task.name;
                
                const taskTags = document.createElement('div');
                taskTags.className = 'flex flex-wrap mt-1';
                
                if (task.tags && task.tags.length > 0) {
                    task.tags.forEach(tag => {
                        if (tag.trim()) {
                            const tagBadge = document.createElement('span');
                            tagBadge.className = 'badge';
                            tagBadge.textContent = tag.trim();
                            taskTags.appendChild(tagBadge);
                        }
                    });
                }

                // Add completion count if it exists and is enabled in settings
                if (gameState.settings.showCompletionCount && task.completionCount && task.completionCount > 0) {
                    const completionCount = document.createElement('div');
                    completionCount.className = 'text-xs mt-1';
                    completionCount.textContent = `Completed ${task.completionCount} ${task.completionCount === 1 ? 'time' : 'times'}`;
                    
                    // Add last completion date if available
                    if (task.completionDates && task.completionDates.length > 0) {
                        const lastDate = new Date(task.completionDates[task.completionDates.length - 1]);
completionCount.textContent += ` (last: ${lastDate.toLocaleDateString()})`;
                    }
                    
                    taskContent.appendChild(completionCount);
                }
                
                taskContent.appendChild(taskName);
                taskContent.appendChild(taskTags);
                
                // Add checkbox event listener
                checkbox.addEventListener('change', updateTaskSelectionButtons);
                
                taskEl.appendChild(checkbox);
                taskEl.appendChild(taskContent);
                elements.taskList.appendChild(taskEl);
            });
            
            updateTaskSelectionButtons();
        }

        // Update task selection buttons
        function updateTaskSelectionButtons() {
            const checkboxes = document.querySelectorAll('.custom-checkbox[data-id]');
            const checkedBoxes = document.querySelectorAll('.custom-checkbox[data-id]:checked');
            
            elements.editSelectedTask.disabled = checkedBoxes.length !== 1;
            elements.deleteSelectedTasks.disabled = checkedBoxes.length === 0;
        }

        // Render generated tasks
        function renderGeneratedTasks() {
            if (gameState.generatedTasks.length === 0) {
                elements.generatedTasks.innerHTML = '<p class="text-center italic">No tasks generated yet</p>';
                elements.completeAllTasks.disabled = true;
                elements.giveUpTasks.disabled = true;
	        updateGenerateTasksButton();
                return;
            }
            
            elements.generatedTasks.innerHTML = '';
            
            gameState.generatedTasks.forEach((task, index) => {
                const taskEl = document.createElement('div');
                taskEl.className = 'mb-2 p-2 border border-ancient-accent rounded flex items-center justify-between';
                if (gameState.pomodoro.boostsRemaining > 0) {
                    taskEl.classList.add('task-boosted');
                }
                
                const taskInfo = document.createElement('div');
                taskInfo.className = 'flex-grow';
                
                const taskName = document.createElement('div');
                taskName.className = 'font-bold';
                taskName.textContent = task.name;
                
                const taskTags = document.createElement('div');
                taskTags.className = 'flex flex-wrap mt-1';
                
                if (task.tags && task.tags.length > 0) {
                    task.tags.forEach(tag => {
                        if (tag.trim()) {
                            const tagBadge = document.createElement('span');
                            tagBadge.className = 'badge';
                            tagBadge.textContent = tag.trim();
                            taskTags.appendChild(tagBadge);
                        }
                    });
                }
                
                taskInfo.appendChild(taskName);
                taskInfo.appendChild(taskTags);
                
                const taskActions = document.createElement('div');
                taskActions.className = 'flex gap-2';
                
                const completeBtn = document.createElement('button');
                completeBtn.className = 'ancient-button text-sm px-2';
                completeBtn.textContent = 'Complete';
                completeBtn.addEventListener('click', () => completeTask(index));
                
                const skipBtn = document.createElement('button');
                skipBtn.className = 'ancient-button text-sm px-2';
                skipBtn.textContent = 'Skip';
                skipBtn.addEventListener('click', () => skipTask(index));
                
                taskActions.appendChild(completeBtn);
                taskActions.appendChild(skipBtn);
                
                taskEl.appendChild(taskInfo);
                taskEl.appendChild(taskActions);
                elements.generatedTasks.appendChild(taskEl);
            });
            
            elements.completeAllTasks.disabled = false;
            elements.giveUpTasks.disabled = false;
	    updateGenerateTasksButton();
        }

        // Complete a single task
        function completeTask(taskIndex) {
            if (taskIndex < 0 || taskIndex >= gameState.generatedTasks.length) return;
            
            const task = gameState.generatedTasks[taskIndex];
            
            // Calculate qi reward
            const currentRealm = getCurrentRealm();
            const baseQi = Math.floor(Math.random() * 50) + 25; // 25-74 base qi
            const realmMultiplier = currentRealm.multiplier;
            let qiReward = Math.floor(baseQi * realmMultiplier);
            
            // Apply pomodoro boost if available
            let pomodoroBoost = false;
            if (gameState.pomodoro.boostsRemaining > 0) {
                qiReward *= 2;
                gameState.pomodoro.boostsRemaining--;
                gameState.stats.pomodoroTasksCompleted++;
                pomodoroBoost = true;
            }
            
            // Add qi
            gameState.player.qi += qiReward;
            gameState.stats.totalQiEarned += qiReward;
            
            // Track pomodoro bonus qi separately
            if (pomodoroBoost) {
                gameState.stats.totalQiPomodoro += qiReward / 2; // Half of the reward was the bonus
            }
            
            // Find spirit stones (random chance based on realm)
            const stoneReward = findSpiritStones();
            
            // Update task completion count and date
            const originalTask = gameState.tasks.find(t => t.id === task.id);
            if (originalTask) {
                if (!originalTask.completionCount) originalTask.completionCount = 0;
                originalTask.completionCount++;
                
                if (!originalTask.completionDates) originalTask.completionDates = [];
                originalTask.completionDates.push(Date.now());
                
                // Update tag completion stats
                if (originalTask.tags && originalTask.tags.length > 0) {
                    originalTask.tags.forEach(tag => {
                        const tagKey = tag.trim();
                        if (!gameState.stats.completionByTag[tagKey]) {
                            gameState.stats.completionByTag[tagKey] = 0;
                        }
                        gameState.stats.completionByTag[tagKey]++;
                    });
                }
            }
            
            // Update statistics
            gameState.stats.completedTasks++;
            
            // Track day of week for analytics
            const dayOfWeek = new Date().getDay();
            gameState.stats.completionByDayOfWeek[dayOfWeek]++;
            
            // Track task history for analytics
            gameState.stats.taskHistory.push({
                timestamp: Date.now(),
                qiReward: qiReward,
                realmAtCompletion: gameState.player.realm,
                taskName: task.name,
                tags: task.tags || [],
                pomodoroBoost: pomodoroBoost
            });
            
            // Remove task from generated list
            gameState.generatedTasks.splice(taskIndex, 1);
            
            // Show reward message
            let rewardMessage = `Completed "${task.name}" and gained ${formatNumber(qiReward)} qi`;
            if (pomodoroBoost) {
                rewardMessage += ' (with pomodoro boost!)';
            }
            if (stoneReward.found) {
                rewardMessage += ` and found ${stoneReward.description}!`;
            }
            showToast(rewardMessage, "success");
            
            // Check achievements
            checkTaskAchievements();
            
            // Update UI
            renderGeneratedTasks();
            updateCultivationUI();
            updateStonesUI();
            updatePomodoroUI();
            
            // Save game state
            saveGameState();
        }

        // Skip a single task (with qi penalty)
        function skipTask(taskIndex) {
            if (taskIndex < 0 || taskIndex >= gameState.generatedTasks.length) return;
            
            const task = gameState.generatedTasks[taskIndex];
            
            // Apply qi penalty (5% of current qi)
            const penalty = Math.floor(gameState.player.qi * 0.05);
            gameState.player.qi = Math.max(0, gameState.player.qi - penalty);
            
            // Remove task from generated list
            gameState.generatedTasks.splice(taskIndex, 1);
            
            // Show penalty message
            if (penalty > 0) {
                showToast(`Skipped "${task.name}" and lost ${formatNumber(penalty)} qi as penalty`, "warning");
            } else {
                showToast(`Skipped "${task.name}"`, "info");
            }
            
            // Update UI
            renderGeneratedTasks();
            updateCultivationUI();
            
            // Save game state
            saveGameState();
        }

        // Complete all generated tasks
        function completeAllTasks() {
            if (gameState.generatedTasks.length === 0) return;
            
            // Check for pomodoro boost all achievement
            if (gameState.pomodoro.boostsRemaining >= gameState.generatedTasks.length && gameState.pomodoro.boostsRemaining > 0) {
                checkAchievement("pomodoro_boost_all");
            }
            
            // Complete all tasks
            while (gameState.generatedTasks.length > 0) {
                completeTask(0);
            }
        }

        // Give up all tasks (with increasing qi penalty)
        function giveUpTasks() {
            if (gameState.generatedTasks.length === 0) return;
            
            // Calculate penalty based on number of tasks (increasing penalty)
            const taskCount = gameState.generatedTasks.length;
            const penaltyPercent = Math.min(20, 5 + (taskCount * 2)); // 5% + 2% per task, max 20%
            const penalty = Math.floor(gameState.player.qi * (penaltyPercent / 100));
            gameState.player.qi = Math.max(0, gameState.player.qi - penalty);
            
            // Clear all generated tasks
            gameState.generatedTasks = [];
            
            // Show penalty message
            if (penalty > 0) {
                showToast(`Gave up all tasks and lost ${formatNumber(penalty)} qi (${penaltyPercent}% penalty)`, "error");
            } else {
                showToast(`Gave up all tasks`, "info");
            }
            
            // Update UI
            renderGeneratedTasks();
            updateCultivationUI();
            
            // Save game state
            saveGameState();
        }

        // Find spirit stones randomly
        function findSpiritStones() {
            const result = { found: false, description: '' };
            
            // Base chance of finding any stone: 15%
            if (Math.random() < 0.15) {
                // Chance of finding each type based on current realm
                const realm = gameState.player.realm;
                
                // Define base chances for each stone type (these get modified by realm)
                const baseChances = {
                    basic: 50,
                    low: 25,
                    medium: 15,
                    high: 7,
                    supreme: 2.5,
                    divine: 0.5,
                    rename: 5 // 5% chance when any stone is found
                };
                
                // Modify chances based on realm
                const adjustedChances = {};
                for (const [type, baseChance] of Object.entries(baseChances)) {
                    if (type === 'rename') {
                        adjustedChances[type] = baseChance; // Rename scroll chance doesn't change
                    } else {
                        // Higher realms increase chances of better stones
                        const realmBonus = Math.pow(1.2, realm);
                        adjustedChances[type] = baseChance * realmBonus;
                    }
                }
                
                // Normalize to 100%
                const totalChance = Object.values(adjustedChances).reduce((sum, chance) => sum + chance, 0);
                const normalizedChances = {};
                for (const [type, chance] of Object.entries(adjustedChances)) {
                    normalizedChances[type] = (chance / totalChance) * 100;
                }
                
                // Roll for stone type
                const roll = Math.random() * 100;
                let cumulativeChance = 0;
                
                for (const [type, chance] of Object.entries(normalizedChances)) {
                    cumulativeChance += chance;
                    if (roll <= cumulativeChance) {
                        if (type === 'rename') {
                            // Check if we can hold a rename scroll
                            if (gameState.stones.rename < 1) {
                                gameState.stones.rename = 1;
                                gameState.stats.totalStonesFound.rename++;
                                result.found = true;
                                result.description = spiritStones.rename.name;
                            }
                        } else {
                            // Regular spirit stone
                            gameState.stones[type]++;
                            gameState.stats.totalStonesFound[type]++;
                            result.found = true;
                            result.description = spiritStones[type].name;
                        }
                        break;
                    }
                }
            }
            
            return result;
        }

        // Check task-related achievements
        function checkTaskAchievements() {
            // Basic task completion achievements
            checkAchievement("tasks_complete_first");
            checkAchievement("tasks_complete_10");
            checkAchievement("tasks_complete_50");
            checkAchievement("tasks_complete_100");
            checkAchievement("tasks_complete_500");
            checkAchievement("tasks_complete_1000");
            
            // Tag specialist achievement
            checkAchievement("tasks_tag_specialist");
            
            // Same task completion achievement
            checkAchievement("tasks_complete_same_10");
            
            // Pomodoro boosted tasks achievement
            checkAchievement("tasks_boosted_10");
            
            // Daily task achievement (check if user completed 5 tasks today)
            const today = new Date().toDateString();
            const todayCompletions = gameState.stats.taskHistory.filter(task => {
                const taskDate = new Date(task.timestamp).toDateString();
                return taskDate === today;
            }).length;
            
            if (todayCompletions >= 5) {
                checkAchievement("tasks_daily_5");
            }
            
            // Stone finding achievements
            checkAchievement("stones_collect_first");
            checkAchievement("stones_collect_100");
            checkAchievement("stones_collect_divine");
            checkAchievement("stones_all_types");
            checkAchievement("stones_rename_use");
        }

        // Check for breakthrough readiness notification
        function checkBreakthroughReadiness() {
            if (!gameState.notifications.settings.breakthroughReadiness) return;
            
            const now = Date.now();
            const timeSinceLastCheck = now - gameState.player.lastBreakthroughCheck;
            
            // Only check once every 5 minutes to avoid spam
            if (timeSinceLastCheck > 5 * 60 * 1000) {
                const qiRequired = getQiRequiredForBreakthrough();
                if (gameState.player.qi >= qiRequired) {
                    showNotification('breakthrough', "Breakthrough Ready", 
                        `You have enough qi to attempt a breakthrough to the next stage!`);
                    gameState.player.lastBreakthroughCheck = now;
                    saveGameState();
                }
            }
        }

        // Process idle qi gains
        function processIdleQiGains() {
            const now = Date.now();
            const timeDiff = now - gameState.player.lastUpdated;
            
            // Cap idle time at 24 hours (1440 minutes)
            const maxIdleTime = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
            const cappedTimeDiff = Math.min(timeDiff, maxIdleTime);
            
            if (cappedTimeDiff > 0) {
                const minutesOffline = cappedTimeDiff / (60 * 1000);
                
                // Calculate idle qi gains
                const idleRate = getCurrentIdleRate();
                const qiGained = Math.floor(idleRate * minutesOffline);
                
                if (qiGained > 0) {
                    gameState.player.qi += qiGained;
                    gameState.stats.totalQiEarned += qiGained;
                    gameState.stats.totalQiPassive += qiGained;
                    
                    // Check if we should show idle rewards notification
                    if (gameState.notifications.settings.idleRewards && minutesOffline >= 5) {
                        showNotification('idle', "Idle Cultivation", 
                            `You gained ${formatNumber(qiGained)} qi while away (${formatTime(minutesOffline)})`);
                    }
                    
                    // Check for fellow cultivator meeting if offline long enough
                    checkFellowCultivatorMeeting(minutesOffline);
                }
            }
            
            gameState.player.lastUpdated = now;
        }

        // Check for fellow cultivator meeting
        function checkFellowCultivatorMeeting(minutesOffline) {
            // Don't meet if already boosted or if no time has passed since last meeting
            const now = Date.now();
            const timeSinceLastMeeting = now - gameState.fellowCultivators.lastMeetingTime;
            
            // Must be at least 10 minutes since last meeting
            if (timeSinceLastMeeting < 10 * 60 * 1000) return;
            
            // Calculate chance based on offline time
            let meetingChance = 0;
            if (minutesOffline >= 60) {
                meetingChance = 0.3; // 30% for 1+ hours
            } else if (minutesOffline >= 30) {
                meetingChance = 0.2; // 20% for 30+ minutes
            } else if (minutesOffline >= 10) {
                meetingChance = 0.1; // 10% for 10+ minutes
            }
            
            if (Math.random() < meetingChance) {
                meetFellowCultivator();
            }
        }

        // Meet a fellow cultivator
        function meetFellowCultivator() {
            const availableCultivators = gameState.settings.onlyMeetCustomCultivators
                ? gameState.fellowCultivators.pool.filter(c => c.custom)
                : gameState.fellowCultivators.pool;
            
            if (availableCultivators.length === 0) return;
            
            // Choose a random cultivator
            const cultivator = availableCultivators[Math.floor(Math.random() * availableCultivators.length)];
            
            // Increase encounter count
            cultivator.encounters = (cultivator.encounters || 0) + 1;
            
            // Determine if this is first meeting with this cultivator
            const isFirstMeeting = cultivator.encounters === 1;
            
            // Choose appropriate message
            const messagePool = isFirstMeeting 
                ? fellowCultivatorMessages.firstMeeting 
                : fellowCultivatorMessages.repeatMeeting;
            
            const messageTemplate = messagePool[Math.floor(Math.random() * messagePool.length)];
            const message = messageTemplate.replace('[name]', cultivator.name);
            
            // Calculate boost duration (60-120 minutes)
            const boostDuration = Math.floor(Math.random() * 61) + 60; // 60-120 minutes
            
            // Add boost time, but cap total boost time at 10 hours
            const now = Date.now();
            const currentBoostRemaining = Math.max(0, gameState.fellowCultivators.boostEndTime - now);
            const newBoostTime = currentBoostRemaining + (boostDuration * 60 * 1000);
            const maxBoostTime = 10 * 60 * 60 * 1000; // 10 hours in milliseconds
            
            gameState.fellowCultivators.boostEndTime = now + Math.min(newBoostTime, maxBoostTime);
            gameState.fellowCultivators.lastMeetingTime = now;
            
            // Store last encounter details
            gameState.fellowCultivators.lastEncounter = {
                message: message,
                timestamp: now,
                cultivatorName: cultivator.name,
                isFirstMeeting: isFirstMeeting
            };
            
            // Update statistics
            gameState.stats.cultivatorsMet++;
            gameState.stats.totalBoostTime += boostDuration;
            
            // Check if we hit maximum boost time
            if (newBoostTime >= maxBoostTime) {
                checkAchievement("cultivators_max_boost");
            }
            
            // Show notification
            if (gameState.notifications.settings.fellowCultivator) {
                showNotification('fellowCultivator', "Fellow Cultivator", 
                    `${message}\n\nIdle cultivation rate doubled for ${formatTime(boostDuration)}!`);
            }
            
            // Check achievements
            checkAchievement("cultivators_first_meeting");
            checkAchievement("cultivators_meet_10");
            checkAchievement("cultivators_boost_24h");
            checkAchievement("cultivators_meet_same_5");
            
            // Save game state
            saveGameState();
        }

        // Add spirit stone click handlers
        function addSpiritStoneHandlers() {
            const spiritStones = document.querySelectorAll('.spirit-stone[data-type]');
            
            spiritStones.forEach(stone => {
                stone.addEventListener('click', () => {
                    const type = stone.getAttribute('data-type');
                    const availableCount = gameState.stones[type] || 0;
                    
                    if (availableCount > 0) {
                        // Add one stone to selection
                        if (!gameState.selectedStones[type]) gameState.selectedStones[type] = 0;
                        
                        if (gameState.selectedStones[type] < availableCount) {
                            gameState.selectedStones[type]++;
                            updateStonesUI();
                            updateCultivationUI();
                        }
                    }
                });
            });
        }

        // Clear selected stones
        function clearSelectedStones() {
            gameState.selectedStones = {
                basic: 0,
                low: 0,
                medium: 0,
                high: 0,
                supreme: 0,
                divine: 0
            };
            updateStonesUI();
            updateCultivationUI();
        }

        // Attempt breakthrough
        function attemptBreakthrough() {
            const qiRequired = getQiRequiredForBreakthrough();
            
            if (gameState.player.qi < qiRequired) {
                showToast("Insufficient qi for breakthrough", "error");
                return;
            }
            
            const successRate = getTotalSuccessRate();
            const isSuccess = Math.random() * 100 < successRate;
            
            // Consume qi and stones regardless of outcome
            gameState.player.qi -= qiRequired;
            
            // Consume selected stones
            for (const [type, count] of Object.entries(gameState.selectedStones)) {
                if (count > 0) {
                    gameState.stones[type] -= count;
                    gameState.selectedStones[type] = 0;
                }
            }
            
            if (isSuccess) {
                // Successful breakthrough
                gameState.stats.breakthroughs++;
                
                // Check for breakthrough streak achievement
                if (!gameState.achievements.progress["cultivation_breakthrough_streak"]) {
                    gameState.achievements.progress["cultivation_breakthrough_streak"] = 0;
                }
                gameState.achievements.progress["cultivation_breakthrough_streak"]++;
                checkAchievement("cultivation_breakthrough_streak");
                
                // Check perfect breakthrough achievement
                if (successRate >= 99) {
                    checkAchievement("cultivation_perfect_breakthrough");
                }
                
                // Advance stage or realm
                const currentRealm = getCurrentRealm();
                
                if (gameState.player.stage < currentRealm.stages || !isFinite(currentRealm.stages)) {
                    // Advance to next stage
                    gameState.player.stage++;
                    
                    showToast(`Breakthrough successful! Advanced to Stage ${gameState.player.stage}!`, "success");
                    
                    // Check milestone notifications
                    checkMilestoneNotifications();
                } else {
                    // Advance to next realm
                    gameState.player.realm++;
                    gameState.player.stage = 1;
                    
                    // Update highest realm reached
                    if (gameState.player.realm > gameState.stats.highestRealmReached) {
                        gameState.stats.highestRealmReached = gameState.player.realm;
                    }
                    
                    const newRealm = getCurrentRealm();
                    showToast(`Breakthrough successful! Advanced to ${newRealm.name} realm!`, "success");
                    
                    // Add to realm history for analytics
                    gameState.analytics.realmHistory.push({
                        timestamp: Date.now(),
                        realm: gameState.player.realm,
                        stage: gameState.player.stage
                    });
                    
                    // Check milestone notifications
                    checkMilestoneNotifications();
                    
                    // Check realm achievements
                    checkRealmAchievements();
                }
            } else {
                // Failed breakthrough
                gameState.stats.failedAttempts++;
                
                // Reset breakthrough streak
                gameState.achievements.progress["cultivation_breakthrough_streak"] = 0;
                
                // Check for fail at 99% achievement
                if (successRate >= 99) {
                    checkAchievement("cultivation_fail_at_99");
                }
                
                // Lose additional qi on failure (15-35%)
                const additionalLoss = Math.floor(gameState.player.qi * (0.15 + Math.random() * 0.2));
                gameState.player.qi = Math.max(0, gameState.player.qi - additionalLoss);
                
                showToast(`Breakthrough failed! You lost some qi.`, "error");
            }
            
            // Clear selected stones
            clearSelectedStones();
            
            // Update UI
            updateCultivationUI();
            updateStonesUI();
            
            // Save game state
            saveGameState();
        }

        // Check milestone notifications
        function checkMilestoneNotifications() {
            if (!gameState.notifications.settings.cultivationMilestones) return;
            
            const currentRealm = gameState.player.realm;
            const currentStage = gameState.player.stage;
            
            // Check if this realm is newly reached
            if (!gameState.player.reachedMilestones.realms.includes(currentRealm)) {
                gameState.player.reachedMilestones.realms.push(currentRealm);
                
                const realmInfo = getCurrentRealm();
                showNotification('milestone', "Realm Milestone", 
                    `Congratulations on reaching the ${realmInfo.name} realm!`);
            }
            
            // Check if this stage is newly reached for this realm
            if (!gameState.player.reachedMilestones.stages[currentRealm]) {
                gameState.player.reachedMilestones.stages[currentRealm] = [];
            }
            
            if (!gameState.player.reachedMilestones.stages[currentRealm].includes(currentStage)) {
                gameState.player.reachedMilestones.stages[currentRealm].push(currentStage);
                
                // Show notification for certain stages
                if (currentStage === 5 || currentStage === 9) {
                    const realmInfo = getCurrentRealm();
                    showNotification('milestone', "Stage Milestone", 
                        `Reached Stage ${currentStage} of the ${realmInfo.name} realm!`);
                }
            }
        }

        // Check realm achievements
        function checkRealmAchievements() {
            // Individual realm achievements
            if (gameState.player.realm >= 1) checkAchievement("cultivation_reach_qi");
            if (gameState.player.realm >= 2) checkAchievement("cultivation_reach_foundation");
            if (gameState.player.realm >= 3) checkAchievement("cultivation_reach_core");
            if (gameState.player.realm >= 4) checkAchievement("cultivation_reach_nascent");
            if (gameState.player.realm >= 5) checkAchievement("cultivation_reach_transformation");
            if (gameState.player.realm >= 6) checkAchievement("cultivation_reach_void");
            if (gameState.player.realm >= 7) checkAchievement("cultivation_reach_integration");
            if (gameState.player.realm >= 8) checkAchievement("cultivation_reach_mahayana");
            if (gameState.player.realm >= 9) checkAchievement("cultivation_reach_immortal");
            if (gameState.player.realm >= 10) checkAchievement("cultivation_reach_golden");
            if (gameState.player.realm >= 11) checkAchievement("cultivation_reach_emperor");
            if (gameState.player.realm >= 12) checkAchievement("cultivation_reach_sovereign");
            
            // Qi millionaire achievement
            checkAchievement("cultivation_qi_millionaire");
        }

        // Fuse spirit stones
        function fuseStones(fromType) {
            const stoneInfo = spiritStones[fromType];
            const toType = stoneInfo.nextTier;
            
            if (!toType || gameState.stones[fromType] < 100) {
                showToast("Cannot fuse stones", "error");
                return;
            }
            
            // Consume 100 lower tier stones, create 1 higher tier stone
            gameState.stones[fromType] -= 100;
            gameState.stones[toType] += 1;
            
            // Update statistics
            gameState.stats.stonesFused[fromType]++;
            gameState.stats.totalStonesFound[toType]++; // Count fused stones as "found"
            
            showToast(`Fused 100 ${stoneInfo.name}s into 1 ${spiritStones[toType].name}`, "success");
            
            // Check achievements
            checkAchievement("stones_fuse_first");
            if (toType === 'divine') {
                checkAchievement("stones_fuse_divine");
            }
            checkAchievement("stones_all_types");
            
            // Update UI
            updateStonesUI();
            
            // Save game state
            saveGameState();
        }

        // Use rename scroll
        function useRenameScroll() {
            if (gameState.stones.rename <= 0) {
                showToast("No rename scroll available", "error");
                return;
            }
            
            showNameChangeModal(true);
        }

        // Show name change modal
        function showNameChangeModal(isRenameScroll = false) {
            elements.cultivatorNameInput.value = '';
            elements.cultivatorNameInput.placeholder = 'Enter your cultivator name';
            
            if (isRenameScroll) {
                elements.renameWarning.textContent = 'Using a Rename Scroll to change your cultivator name.';
            } else {
                elements.renameWarning.textContent = 'Note: Changing your name after this initial setup will require a Rename Scroll, which is a rare item that can be found by completing tasks.';
            }
            
            elements.nameChangeOverlay.classList.remove('hidden');
            elements.nameChangeOverlay.dataset.isRenameScroll = isRenameScroll;
        }

        // Confirm name change
        function confirmNameChange() {
            const newName = elements.cultivatorNameInput.value.trim();
            const isRenameScroll = elements.nameChangeOverlay.dataset.isRenameScroll === 'true';
            
            if (!newName) {
                showToast("Please enter a name", "error");
                return;
            }
            
            if (newName.length > 30) {
                showToast("Name must be 30 characters or less", "error");
                return;
            }
            
            // If using rename scroll, consume it
            if (isRenameScroll) {
                gameState.stones.rename--;
                gameState.stats.renameScrollsUsed++;
                
                // Check achievement
                checkAchievement("stones_rename_use");
            }
            
            // Update name
            gameState.player.name = newName;
            
            // Close modal
            elements.nameChangeOverlay.classList.add('hidden');
            
            // Update UI
            updateCultivationUI();
            updateStonesUI();
            
            // Show success message
            showToast(`Cultivator name changed to: ${newName}`, "success");
            
            // Save game state
            saveGameState();
        }

        // Pomodoro timer functions
        let pomodoroInterval = null;

        function startPomodoroTimer() {
            if (gameState.pomodoro.isRunning && !gameState.pomodoro.isPaused) return;
            
            if (gameState.pomodoro.isPaused) {
                // Resume from pause
                gameState.pomodoro.isPaused = false;
                gameState.pomodoro.isRunning = true;
            } else {
                // Start new session
                gameState.pomodoro.isRunning = true;
                gameState.pomodoro.isPaused = false;
                gameState.pomodoro.startTime = Date.now();
                
                // Set timer duration
                const duration = gameState.pomodoro.isBreak 
                    ? gameState.pomodoro.breakDuration 
                    : gameState.pomodoro.focusDuration;
                gameState.pomodoro.timeRemaining = duration * 60; // Convert to seconds
            }
            
            // Start the interval
            pomodoroInterval = setInterval(updatePomodoroTimer, 1000);
            
            updatePomodoroUI();
            saveGameState();
        }

        function pausePomodoroTimer() {
            if (!gameState.pomodoro.isRunning || gameState.pomodoro.isPaused) return;
            
            gameState.pomodoro.isPaused = true;
            gameState.pomodoro.pauseTime = Date.now();
            
            // Clear the interval
            clearInterval(pomodoroInterval);
            pomodoroInterval = null;
            
            updatePomodoroUI();
            saveGameState();
        }

        function resetPomodoroTimer() {
            // Clear the interval
            clearInterval(pomodoroInterval);
            pomodoroInterval = null;
            
            // Reset state
            gameState.pomodoro.isRunning = false;
            gameState.pomodoro.isPaused = false;
            gameState.pomodoro.isBreak = false;
            gameState.pomodoro.timeRemaining = gameState.pomodoro.focusDuration * 60;
            gameState.pomodoro.startTime = null;
            gameState.pomodoro.endTime = null;
            gameState.pomodoro.pauseTime = null;
            
            updatePomodoroUI();
            saveGameState();
        }

        function updatePomodoroTimer() {
            if (!gameState.pomodoro.isRunning || gameState.pomodoro.isPaused) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                return;
            }
            
            gameState.pomodoro.timeRemaining--;
            
            if (gameState.pomodoro.timeRemaining <= 0) {
                completePomodoroSession();
            }
            
            updatePomodoroUI();
        }

        function completePomodoroSession() {
            // Clear the interval
            clearInterval(pomodoroInterval);
            pomodoroInterval = null;
            
            const wasBreak = gameState.pomodoro.isBreak;
            const sessionDuration = wasBreak 
                ? gameState.pomodoro.breakDuration 
                : gameState.pomodoro.focusDuration;
            
            if (!wasBreak) {
                // Focus session completed
                gameState.stats.pomodoroSessions++;
                gameState.stats.pomodoroTotalMinutes += sessionDuration;
                
                // Add to analytics
                if (gameState.analytics.pomodoroByDuration[sessionDuration] !== undefined) {
                    gameState.analytics.pomodoroByDuration[sessionDuration]++;
                }
                
                // Add to history
                gameState.pomodoro.history.push({
                    startTime: gameState.pomodoro.startTime,
                    endTime: Date.now(),
                    duration: sessionDuration,
                    type: 'focus'
                });
                
                // Award boosts based on duration
                let boostsAwarded = 0;
                if (sessionDuration >= 25) {
                    boostsAwarded = 10;
                } else if (sessionDuration >= 20) {
                    boostsAwarded = 8;
                } else if (sessionDuration >= 15) {
                    boostsAwarded = 5;
                }
                
                if (boostsAwarded > 0) {
                    gameState.pomodoro.boostsRemaining += boostsAwarded;
                    gameState.stats.pomodoroBoostsEarned += boostsAwarded;
                    
                    if (gameState.notifications.settings.pomodoro) {
                        showNotification('pomodoro', "Pomodoro Complete", 
                            `Focus session completed! Earned ${boostsAwarded} task boosts.`);
                    }
                } else {
                    if (gameState.notifications.settings.pomodoro) {
                        showNotification('pomodoro', "Pomodoro Complete", 
                            `Focus session completed! (No boosts for sessions under 15 minutes)`);
                    }
                }
                
                // Check achievements
                checkAchievement("pomodoro_first_session");
                checkAchievement("pomodoro_10_sessions");
                checkAchievement("pomodoro_50_sessions");
                checkAchievement("pomodoro_100_sessions");
                checkAchievement("pomodoro_10_hours");
                
                if (sessionDuration >= 25) {
                    checkAchievement("pomodoro_max_boost");
                }
                
                // Check daily streak achievement (simplified - this could be enhanced)
                checkPomodoroStreakAchievement();
                
                // Start break if enabled
                if (gameState.pomodoro.useBreak && gameState.pomodoro.breakDuration > 0) {
                    gameState.pomodoro.isBreak = true;
                    gameState.pomodoro.timeRemaining = gameState.pomodoro.breakDuration * 60;
                    gameState.pomodoro.isRunning = true;
                    gameState.pomodoro.isPaused = false;
                    
                    // Restart the interval for break
                    pomodoroInterval = setInterval(updatePomodoroTimer, 1000);
                } else {
                    // No break, reset timer
                    resetPomodoroTimer();
                }
            } else {
                // Break completed
                showToast("Break time over! Ready for another focus session?", "info");
                
                // Reset to focus mode
                gameState.pomodoro.isBreak = false;
                gameState.pomodoro.timeRemaining = gameState.pomodoro.focusDuration * 60;
                gameState.pomodoro.isRunning = false;
                gameState.pomodoro.isPaused = false;
            }
            
            updatePomodoroUI();
            saveGameState();
        }

        function checkPomodoroStreakAchievement() {
            // This is a simplified implementation
            // In a full implementation, you'd track daily completion dates
            const today = new Date().toDateString();
            const todaySessions = gameState.pomodoro.history.filter(session => {
                return new Date(session.endTime).toDateString() === today;
            }).length;
            
            if (todaySessions === 1) { // First session of the day
                // For now, just give progress toward the streak
                // A full implementation would need to track consecutive days
                if (!gameState.achievements.progress["pomodoro_daily_streak"]) {
                    gameState.achievements.progress["pomodoro_daily_streak"] = 1;
                } else {
                    gameState.achievements.progress["pomodoro_daily_streak"]++;
                }
                checkAchievement("pomodoro_daily_streak");
            }
        }

        // Add task functions
        function addTask() {
            const name = elements.taskName.value.trim();
            const tags = elements.taskTags.value.trim();
            
            if (!name) {
                showToast("Please enter a task name", "error");
                return;
            }
            
            // Parse tags
            const parsedTags = tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            
            // Create new task
            const newTask = {
                id: Date.now() + Math.random(), // Simple unique ID
                name: name,
                tags: parsedTags,
                createdAt: Date.now(),
                completionCount: 0,
                completionDates: []
            };
            
            gameState.tasks.push(newTask);
            gameState.stats.totalTasks++;
            
            // Clear inputs
            elements.taskName.value = '';
            elements.taskTags.value = '';
            
            // Update UI
            renderTaskList();
            
            // Check achievements
            checkAchievement("tasks_create_10");
            
            // Show success message
            showToast(`Added task: ${name}`, "success");
            
            // Save game state
            saveGameState();
        }

        // Select all tasks
        function selectAllTasks() {
            const checkboxes = document.querySelectorAll('.custom-checkbox[data-id]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
            
            updateTaskSelectionButtons();
        }

        // Edit selected task
        function editSelectedTask() {
            const checkedBoxes = document.querySelectorAll('.custom-checkbox[data-id]:checked');
            
            if (checkedBoxes.length !== 1) {
                showToast("Please select exactly one task to edit", "error");
                return;
            }
            
            const taskId = parseFloat(checkedBoxes[0].dataset.id);
            const task = gameState.tasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast("Task not found", "error");
                return;
            }
            
            // Pre-fill the form with current task data
            elements.taskName.value = task.name;
            elements.taskTags.value = task.tags.join(', ');
            
            // Show confirmation modal
            showModal("Edit Task", 
                `Editing task: "${task.name}". Update the name and tags in the form above, then confirm to save changes.`,
                "Update", "Cancel", () => {
                    updateTask(taskId);
                });
        }

        // Update task
        function updateTask(taskId) {
            const task = gameState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const newName = elements.taskName.value.trim();
            const newTags = elements.taskTags.value.trim();
            
            if (!newName) {
                showToast("Please enter a task name", "error");
                return;
            }
            
            // Update task
            task.name = newName;
            task.tags = newTags ? newTags.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            
            // Clear inputs
            elements.taskName.value = '';
            elements.taskTags.value = '';
            
            // Clear selection
            document.querySelectorAll('.custom-checkbox[data-id]').forEach(cb => cb.checked = false);
            
            // Update UI
            renderTaskList();
            updateTaskSelectionButtons();
            
            showToast(`Updated task: ${newName}`, "success");
            saveGameState();
        }

        // Delete selected tasks
        function deleteSelectedTasks() {
            const checkedBoxes = document.querySelectorAll('.custom-checkbox[data-id]:checked');
            
            if (checkedBoxes.length === 0) {
                showToast("Please select tasks to delete", "error");
                return;
            }
            
            const taskCount = checkedBoxes.length;
            const taskNames = Array.from(checkedBoxes).map(cb => {
                const taskId = parseFloat(cb.dataset.id);
                const task = gameState.tasks.find(t => t.id === taskId);
                return task ? task.name : 'Unknown';
            }).join(', ');
            
            showModal("Delete Tasks", 
                `Are you sure you want to delete ${taskCount} task${taskCount > 1 ? 's' : ''}?\n\n${taskNames}`,
                "Delete", "Cancel", () => {
                    // Delete tasks
                    const taskIds = Array.from(checkedBoxes).map(cb => parseFloat(cb.dataset.id));
                    gameState.tasks = gameState.tasks.filter(task => !taskIds.includes(task.id));
                    gameState.stats.totalTasks = gameState.tasks.length;
                    
                    // Update UI
                    renderTaskList();
                    updateTaskSelectionButtons();
                    
                    showToast(`Deleted ${taskCount} task${taskCount > 1 ? 's' : ''}`, "success");
                    saveGameState();
                });
        }

        // Generate random tasks
        function generateTasks() {
            const taskCount = parseInt(elements.taskCount.value) || 1;
            const filterTags = elements.filterTags.value.trim();
            
            if (gameState.tasks.length === 0) {
                showToast("Please add some tasks first", "error");
                return;
            }
            
            // Filter tasks by tags if specified
            let availableTasks = gameState.tasks;
            if (filterTags) {
                const filterTagList = filterTags.split(',').map(tag => tag.trim().toLowerCase());
                availableTasks = gameState.tasks.filter(task => {
                    return task.tags.some(tag => 
                        filterTagList.includes(tag.toLowerCase())
                    );
                });
                
                if (availableTasks.length === 0) {
                    showToast("No tasks found with the specified tags", "error");
                    return;
                }
            }
            
            // Generate random tasks
            const generatedTasks = [];
            for (let i = 0; i < taskCount; i++) {
                const randomTask = availableTasks[Math.floor(Math.random() * availableTasks.length)];
                generatedTasks.push({ ...randomTask }); // Create a copy
            }
            
            gameState.generatedTasks = generatedTasks;
            
            // Update UI
            renderGeneratedTasks();
            
            showToast(`Generated ${taskCount} task${taskCount > 1 ? 's' : ''}`, "success");
            saveGameState();
        }

        // Add fellow cultivator
        function addFellowCultivator() {
            const name = elements.newCultivatorName.value.trim();
            
            if (!name) {
                showToast("Please enter a cultivator name", "error");
                return;
            }
            
            if (name.length > 30) {
                showToast("Name must be 30 characters or less", "error");
                return;
            }
            
            // Check daily limit
            checkNewDay();
            if (gameState.fellowCultivators.addedToday >= 5) {
                showToast("You can only add 5 cultivators per day", "error");
                return;
            }
            
            // Check total limit for custom cultivators
            const customCount = gameState.fellowCultivators.pool.filter(c => c.custom).length;
            if (customCount >= 32) {
                showToast("Maximum of 32 custom cultivators allowed", "error");
                return;
            }
            
            // Check if name already exists
            const nameExists = gameState.fellowCultivators.pool.some(c => 
                c.name.toLowerCase() === name.toLowerCase()
            );
            
            if (nameExists) {
                showToast("A cultivator with this name already exists", "error");
                return;
            }
            
            // Create new cultivator
            const newCultivator = {
                id: `custom-${Date.now()}-${Math.random()}`,
                name: name,
                custom: true,
                editCooldown: 0,
                encounters: 0
            };
            
            gameState.fellowCultivators.pool.push(newCultivator);
            gameState.fellowCultivators.addedToday++;
            
            // Clear input
            elements.newCultivatorName.value = '';
            
            // Update UI
            updateFellowCultivatorsUI();
            
            // Check achievements
            checkAchievement("cultivators_add_custom");
            checkAchievement("cultivators_add_5_custom");
            checkAchievement("cultivators_fill_pool");
            
            showToast(`Added fellow cultivator: ${name}`, "success");
            saveGameState();
        }

        // Handle cultivator dropdown selection
        function handleCultivatorSelection() {
            const selectedId = elements.editCultivatorSelect.value;
            
            if (!selectedId) {
                elements.editCultivatorForm.classList.add('hidden');
                elements.editCooldownInfo.classList.add('hidden');
                return;
            }
            
            const cultivator = gameState.fellowCultivators.pool.find(c => c.id === selectedId);
            if (!cultivator) return;
            
            const now = Date.now();
            const canEdit = now > cultivator.editCooldown;
            
            if (canEdit) {
                elements.editCultivatorForm.classList.remove('hidden');
                elements.editCooldownInfo.classList.add('hidden');
                elements.editCultivatorName.value = cultivator.name;
            } else {
                elements.editCultivatorForm.classList.add('hidden');
                elements.editCooldownInfo.classList.remove('hidden');
                const cooldownEnds = new Date(cultivator.editCooldown);
                elements.editAvailableTime.textContent = cooldownEnds.toLocaleString();
            }
        }

        // Save cultivator edit
        function saveCultivatorEdit() {
            const selectedId = elements.editCultivatorSelect.value;
            const newName = elements.editCultivatorName.value.trim();
            
            if (!selectedId || !newName) {
                showToast("Please select a cultivator and enter a new name", "error");
                return;
            }
            
            if (newName.length > 30) {
                showToast("Name must be 30 characters or less", "error");
                return;
            }
            
            const cultivator = gameState.fellowCultivators.pool.find(c => c.id === selectedId);
            if (!cultivator) return;
            
            // Check if name already exists (excluding current cultivator)
            const nameExists = gameState.fellowCultivators.pool.some(c => 
                c.id !== selectedId && c.name.toLowerCase() === newName.toLowerCase()
            );
            
            if (nameExists) {
                showToast("A cultivator with this name already exists", "error");
                return;
            }
            
            const oldName = cultivator.name;
            cultivator.name = newName;
            
            // Set cooldown (48 hours)
            cultivator.editCooldown = Date.now() + (48 * 60 * 60 * 1000);
            
            // Clear selection
            elements.editCultivatorSelect.value = '';
            elements.editCultivatorForm.classList.add('hidden');
            
            // Update UI
            updateFellowCultivatorsUI();
            
            showToast(`Renamed "${oldName}" to "${newName}"`, "success");
            saveGameState();
        }

        // Remove cultivator
        function removeFellowCultivator() {
            const selectedId = elements.removeCultivatorSelect.value;
            
            if (!selectedId) {
                showToast("Please select a cultivator to remove", "error");
                return;
            }
            
            const cultivator = gameState.fellowCultivators.pool.find(c => c.id === selectedId);
            if (!cultivator) return;
            
            showModal("Remove Cultivator", 
                `Are you sure you want to remove "${cultivator.name}" from your cultivator pool?`,
                "Remove", "Cancel", () => {
                    // Remove cultivator
                    gameState.fellowCultivators.pool = gameState.fellowCultivators.pool.filter(c => c.id !== selectedId);
                    
                    // Clear selection
                    elements.removeCultivatorSelect.value = '';
                    
                    // Update UI
                    updateFellowCultivatorsUI();
                    
                    showToast(`Removed cultivator: ${cultivator.name}`, "success");
                    saveGameState();
                });
        }

        // Show modal
        function showModal(title, message, confirmText, cancelText, onConfirm) {
            elements.modalHeader.textContent = title;
            elements.modalBody.textContent = message;
            elements.modalConfirm.textContent = confirmText;
            elements.modalCancel.textContent = cancelText;
            
            // Remove old event listeners and add new ones
            const newConfirmBtn = elements.modalConfirm.cloneNode(true);
            const newCancelBtn = elements.modalCancel.cloneNode(true);
            
            elements.modalConfirm.parentNode.replaceChild(newConfirmBtn, elements.modalConfirm);
            elements.modalCancel.parentNode.replaceChild(newCancelBtn, elements.modalCancel);
            
            elements.modalConfirm = newConfirmBtn;
            elements.modalCancel = newCancelBtn;
            
            elements.modalConfirm.addEventListener('click', () => {
                elements.modalOverlay.classList.add('hidden');
                if (onConfirm) onConfirm();
            });
            
            elements.modalCancel.addEventListener('click', () => {
                elements.modalOverlay.classList.add('hidden');
            });
            
            elements.modalOverlay.classList.remove('hidden');
        }

        // Show toast notification
        function showToast(message, type = "info") {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 p-4 rounded shadow-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-yellow-500' : 
                'bg-blue-500'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // Show custom notification
        function showNotification(type, title, message) {
            const notification = document.createElement('div');
            notification.className = `notification notification-type-${type} rounded-lg p-4 text-white shadow-lg`;
            
            // Choose icon based on type
            let icon = '';
            switch (type) {
                case 'breakthrough':
                    icon = '<i class="fas fa-mountain"></i>';
                    break;
                case 'idle':
                    icon = '<i class="fas fa-leaf"></i>';
                    break;
                case 'milestone':
                    icon = '<i class="fas fa-flag"></i>';
                    break;
                case 'fellowCultivator':
                    icon = '<i class="fas fa-user-friends"></i>';
                    break;
                case 'achievement':
                    icon = '<i class="fas fa-trophy"></i>';
                    break;
                case 'pomodoro':
                    icon = '<i class="fas fa-stopwatch"></i>';
                    break;
                default:
                    icon = '<i class="fas fa-info"></i>';
            }
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="notification-icon">${icon}</div>
                    <div class="flex-grow">
                        <div class="notification-header">${title}</div>
                        <div class="notification-body">${message.replace(/\n/g, '<br>')}</div>
                    </div>
                    <button class="ml-2 text-white hover:text-gray-200" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="notification-progress"></div>
            `;
            
            elements.notificationContainer.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('closing');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 400);
                }
            }, 5000);
        }

        // Save game state to localStorage
        function saveGameState() {
            try {
                const saveData = JSON.stringify(gameState);
                localStorage.setItem('cultivationGame', saveData);
            } catch (error) {
                console.error('Failed to save game state:', error);
                showToast("Failed to save game", "error");
            }
        }

        // Load game state from localStorage
        function loadGameState() {
            try {
                const saveData = localStorage.getItem('cultivationGame');
                if (saveData) {
                    const loadedState = JSON.parse(saveData);
                    
                    // Merge loaded state with default state to handle new properties
                    Object.assign(gameState, loadedState);
                    
                    // Ensure all required properties exist (backward compatibility)
                    if (!gameState.fellowCultivators) {
                        gameState.fellowCultivators = {
                            pool: [],
                            meetings: [],
                            boostEndTime: 0,
                            lastMeetingTime: 0,
                            lastEncounter: null,
                            addedToday: 0,
                            dayLastAdded: null
                        };
                    }
                    
                    if (!gameState.pomodoro) {
                        gameState.pomodoro = {
                            focusDuration: 25,
                            breakDuration: 5,
                            useBreak: true,
                            isRunning: false,
                            isPaused: false,
                            isBreak: false,
                            timeRemaining: 25 * 60,
                            startTime: null,
                            endTime: null,
                            pauseTime: null,
                            boostsRemaining: 0,
                            lastSessionTime: null,
                            history: []
                        };
                    }
                    
                    if (!gameState.achievements) {
                        gameState.achievements = {
                            unlocked: {},
                            progress: {},
                            lastUnlocked: null,
                            discoveredHidden: []
                        };
                    }
                    
                    if (!gameState.analytics) {
                        gameState.analytics = {
                            qiEfficiency: [],
                            realmHistory: [],
                            lastAnalyticsUpdate: Date.now(),
                            pomodoroByDuration: {
                                5: 0,
                                10: 0,
                                15: 0,
                                20: 0,
                                25: 0
                            }
                        };
                    }
                    
                    // Initialize fellow cultivator pool if empty
                    if (gameState.fellowCultivators.pool.length === 0) {
                        gameState.fellowCultivators.pool = [...initialFellowCultivators];
                    }
                    
                    // Handle version updates
                    if (!gameState.version || gameState.version !== '1.5') {
                        // Perform any version-specific updates here
                        gameState.version = '1.5';
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('Failed to load game state:', error);
                showToast("Failed to load saved game", "error");
            }
            return false;
        }

// Export game data
function exportGameData() {
    try {
        const exportData = JSON.stringify(gameState);
        const base64Data = btoa(exportData);
        
        // Show the Base64 data in the import textarea for easy copying
        elements.importData.value = base64Data;
        
        // Also create a downloadable text file with the Base64 data
        const blob = new Blob([base64Data], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `cultivation-game-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        URL.revokeObjectURL(url);
        
        showToast("Game data exported as Base64 (also copied to import field)", "success");
        
        // Check achievement
        checkAchievement("misc_export_data");
        
    } catch (error) {
        console.error('Failed to export game data:', error);
        showToast("Failed to export game data", "error");
    }
}

        // Import game data
function importGameData() {
    const importData = elements.importData.value.trim();
    
    if (!importData) {
        showToast("Please paste game data to import", "error");
        return;
    }
    
    try {
        // First decode from Base64
        const decodedData = atob(importData);
        // Then parse JSON
        const loadedState = JSON.parse(decodedData);
        
        // Validate the data structure
        if (!loadedState.player || !loadedState.tasks) {
            throw new Error("Invalid game data format");
        }
        
        showModal("Import Game Data", 
            "Are you sure you want to import this game data? This will replace your current progress!",
            "Import", "Cancel", () => {
                // Replace game state
                Object.assign(gameState, loadedState);
                
                // Initialize missing properties for backward compatibility
                if (!gameState.fellowCultivators) {
                    gameState.fellowCultivators = {
                        pool: [...initialFellowCultivators],
                        meetings: [],
                        boostEndTime: 0,
                        lastMeetingTime: 0,
                        lastEncounter: null,
                        addedToday: 0,
                        dayLastAdded: null
                    };
                }
                
                // Clear import field
                elements.importData.value = '';
                
                // Update all UI
                updateAllUI();
                
                // Save the imported data
                saveGameState();
                
                showToast("Game data imported successfully", "success");
            });
        
    } catch (error) {
        console.error('Failed to import game data:', error);
        showToast("Invalid Base64 game data format", "error");
    }
}

        // Reset statistics only
        function resetStatistics() {
            showModal("Reset Statistics", 
                "Are you sure you want to reset all statistics? This will clear your completion history but keep your current progress.",
                "Reset Stats", "Cancel", () => {
                    // Reset only statistics
                    gameState.stats = {
                        totalTasks: gameState.tasks.length, // Keep current task count
                        completedTasks: 0,
                        totalQiEarned: 0,
                        totalQiPassive: 0,
                        totalQiPomodoro: 0,
                        totalStonesFound: {
                            basic: 0,
                            low: 0,
                            medium: 0,
                            high: 0,
                            supreme: 0,
                            divine: 0,
                            rename: 0
                        },
                        stonesFused: {
                            basic: 0,
                            low: 0,
                            medium: 0,
                            high: 0,
                            supreme: 0
                        },
                        breakthroughs: 0,
                        failedAttempts: 0,
                        highestRealmReached: gameState.player.realm, // Keep current realm
                        renameScrollsUsed: 0,
                        taskHistory: [],
                        completionByTag: {},
                        completionByDayOfWeek: [0, 0, 0, 0, 0, 0, 0],
                        cultivatorsMet: 0,
                        totalBoostTime: 0,
                        qiFromBoosts: 0,
                        pomodoroSessions: 0,
                        pomodoroTotalMinutes: 0,
                        pomodoroBoostsEarned: 0,
                        pomodoroTasksCompleted: 0
                    };
                    
                    // Reset analytics
                    gameState.analytics = {
                        qiEfficiency: [],
                        realmHistory: [],
                        lastAnalyticsUpdate: Date.now(),
                        pomodoroByDuration: {
                            5: 0,
                            10: 0,
                            15: 0,
                            20: 0,
                            25: 0
                        }
                    };
                    
                    // Reset task completion counts
                    gameState.tasks.forEach(task => {
                        task.completionCount = 0;
                        task.completionDates = [];
                    });
                    
                    // Update UI
                    updateAllUI();
                    saveGameState();
                    
                    showToast("Statistics reset successfully", "success");
                });
        }

        // Hard reset
        function hardReset() {
            showModal("Hard Reset", 
                "Are you sure you want to delete ALL game data? This action cannot be undone!",
                "Delete All", "Cancel", () => {
                    // Clear localStorage
                    localStorage.removeItem('cultivationGame');
                    
                    // Reload the page to restart fresh
                    location.reload();
                });
        }

        // Update all UI elements
        function updateAllUI() {
            updateCultivationUI();
            updateStonesUI();
            renderTaskList();
            renderGeneratedTasks();
            updateFellowCultivatorsUI();
            updatePomodoroUI();
            updateAchievementsUI();
            updateStatisticsUI();
            updateAnalyticsUI();
            applyTheme();
            
            // Update generate tasks button state
            updateGenerateTasksButton();
            
            // Update settings UI
            updateSettingsUI();
        }

        // Update generate tasks button state
        function updateGenerateTasksButton() {
            const hasGeneratedTasks = gameState.generatedTasks.length > 0;
            elements.generateTasks.disabled = hasGeneratedTasks;
            
            if (hasGeneratedTasks) {
                elements.generateTasks.textContent = "Complete current tasks first";
            } else {
                elements.generateTasks.textContent = "Generate Tasks";
            }
        }

        // Update settings UI
        function updateSettingsUI() {
            // Theme settings
            elements.themeSelect.value = gameState.settings.theme;
            elements.themeModeToggle.checked = gameState.settings.darkMode;
            elements.themeModeLabel.textContent = gameState.settings.darkMode ? 'Dark' : 'Light';
            
            // Display settings
            elements.showCompletionCount.checked = gameState.settings.showCompletionCount;
            elements.useScientificNotation.checked = gameState.settings.useScientificNotation;
            elements.scientificNotationThreshold.value = gameState.settings.scientificNotationThreshold;
            
            // Fellow cultivator settings
            elements.onlyMeetCustomCultivators.checked = gameState.settings.onlyMeetCustomCultivators;
            
            // Notification settings
            elements.notificationBreakthrough.checked = gameState.notifications.settings.breakthroughReadiness;
            elements.notificationIdle.checked = gameState.notifications.settings.idleRewards;
            elements.notificationMilestone.checked = gameState.notifications.settings.cultivationMilestones;
            elements.notificationFellowCultivator.checked = gameState.notifications.settings.fellowCultivator;
            elements.notificationAchievement.checked = gameState.notifications.settings.achievement;
            elements.notificationPomodoro.checked = gameState.notifications.settings.pomodoro;
            
            // Pomodoro settings
            elements.focusDuration.value = gameState.pomodoro.focusDuration;
            elements.focusDurationDisplay.textContent = `${gameState.pomodoro.focusDuration} min`;
            elements.breakDuration.value = gameState.pomodoro.breakDuration;
            elements.breakDurationDisplay.textContent = `${gameState.pomodoro.breakDuration} min`;
            elements.useBreak.checked = gameState.pomodoro.useBreak;
        }

        // Tutorial functions
        let currentTutorialPage = 0;

        function showTutorial() {
            currentTutorialPage = 0;
            updateTutorialPage();
            elements.tutorialOverlay.classList.remove('hidden');
        }

        function updateTutorialPage() {
            const tutorial = tutorialContent[currentTutorialPage];
            elements.tutorialBody.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">${tutorial.title}</h2>
                ${tutorial.content}
            `;
            
            elements.tutorialPage.textContent = `${currentTutorialPage + 1}/${tutorialContent.length}`;
            
            elements.tutorialPrev.disabled = currentTutorialPage === 0;
            elements.tutorialNext.textContent = currentTutorialPage === tutorialContent.length - 1 ? 'Finish' : 'Next';
        }

        function nextTutorialPage() {
            if (currentTutorialPage < tutorialContent.length - 1) {
                currentTutorialPage++;
                updateTutorialPage();
            } else {
                // Finish tutorial
                elements.tutorialOverlay.classList.add('hidden');
            }
        }

        function prevTutorialPage() {
            if (currentTutorialPage > 0) {
                currentTutorialPage--;
                updateTutorialPage();
            }
        }

        function skipTutorial() {
            elements.tutorialOverlay.classList.add('hidden');
        }

        // Initialize the game
        function initializeGame() {
            // Apply dark mode detection
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
            
            // Load game state
            const gameLoaded = loadGameState();
            
            // Initialize fellow cultivator pool if empty
            if (gameState.fellowCultivators.pool.length === 0) {
                gameState.fellowCultivators.pool = [...initialFellowCultivators];
            }
            
            // Process idle qi gains if game was loaded
            if (gameLoaded) {
                processIdleQiGains();
            }
            
            // Update analytics for qi efficiency tracking
            updateQiEfficiencyAnalytics();
            
            // Apply theme
            applyTheme();
            
            // Update all UI
            updateAllUI();
            
            // Check achievements on load
            checkInitialAchievements();
            
            // Set up auto-save interval (every 30 seconds)
            setInterval(saveGameState, 30000);
            
            // Set up idle qi update interval (every second)
            setInterval(() => {
                processIdleQiGains();
                updateCultivationUI();
                
                // Update fellow cultivator boost timer
                const now = Date.now();
                if (now < gameState.fellowCultivators.boostEndTime) {
                    const remainingMinutes = (gameState.fellowCultivators.boostEndTime - now) / (60 * 1000);
                    elements.boostTimeRemaining.textContent = formatTime(remainingMinutes);
                    elements.fcBoostTimeRemaining.textContent = formatTime(remainingMinutes);
                }
                
                // Update pomodoro timer if running
                if (gameState.pomodoro.isRunning && !gameState.pomodoro.isPaused) {
                    updatePomodoroUI();
                }
            }, 1000);
            
            // Show name change modal if player has no name
            if (gameState.player.name === 'Unnamed Cultivator') {
                showNameChangeModal(false);
            }
            
            // Show tutorial for new players
            if (!gameLoaded) {
                showTutorial();
            }
            
            console.log('青云修仙录 initialized successfully!');
        }

        // Check initial achievements that should be unlocked
        function checkInitialAchievements() {
            // Check the "beginning of journey" achievement
            checkAchievement("misc_first_day");
            
            // Check all tabs unlocked achievement
            checkAchievement("misc_unlock_all_tabs");
            
            // Check other achievements that might have been met
            checkAllAchievements();
        }

        // Check all achievements
        function checkAllAchievements() {
            Object.keys(achievementData).forEach(achievementId => {
                checkAchievement(achievementId);
            });
        }

        // Update qi efficiency analytics
        function updateQiEfficiencyAnalytics() {
            const now = Date.now();
            const timeSinceLastUpdate = now - gameState.analytics.lastAnalyticsUpdate;
            
            // Update efficiency data every time tasks are completed
            if (gameState.stats.taskHistory.length > 0) {
                // Calculate average qi per task for recent completions
                const recentTasks = gameState.stats.taskHistory.slice(-10); // Last 10 tasks
                const averageQi = recentTasks.reduce((sum, task) => sum + task.qiReward, 0) / recentTasks.length;
                
                // Add to efficiency tracking
                gameState.analytics.qiEfficiency.push(averageQi);
                
                // Keep only last 20 data points
                if (gameState.analytics.qiEfficiency.length > 20) {
                    gameState.analytics.qiEfficiency.shift();
                }
            }
            
            gameState.analytics.lastAnalyticsUpdate = now;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Cultivation tab event listeners
            elements.clearStones.addEventListener('click', clearSelectedStones);
            elements.attemptBreakthrough.addEventListener('click', attemptBreakthrough);
            
            // Tasks tab event listeners
            elements.addTask.addEventListener('click', addTask);
            elements.taskName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });
            elements.sortTasks.addEventListener('change', renderTaskList);
            elements.selectAllTasks.addEventListener('click', selectAllTasks);
            elements.editSelectedTask.addEventListener('click', editSelectedTask);
            elements.deleteSelectedTasks.addEventListener('click', deleteSelectedTasks);
            
            elements.generateTasks.addEventListener('click', generateTasks);
            elements.completeAllTasks.addEventListener('click', completeAllTasks);
            elements.giveUpTasks.addEventListener('click', giveUpTasks);
            
            // Pomodoro tab event listeners
            elements.timerStart.addEventListener('click', startPomodoroTimer);
            elements.timerPause.addEventListener('click', pausePomodoroTimer);
            elements.timerReset.addEventListener('click', resetPomodoroTimer);
            
            elements.focusDuration.addEventListener('input', (e) => {
                gameState.pomodoro.focusDuration = parseInt(e.target.value);
                elements.focusDurationDisplay.textContent = `${gameState.pomodoro.focusDuration} min`;
                
                // Update timer if not running
                if (!gameState.pomodoro.isRunning && !gameState.pomodoro.isBreak) {
                    gameState.pomodoro.timeRemaining = gameState.pomodoro.focusDuration * 60;
                    updatePomodoroUI();
                }
                saveGameState();
            });
            
            elements.breakDuration.addEventListener('input', (e) => {
                gameState.pomodoro.breakDuration = parseInt(e.target.value);
                elements.breakDurationDisplay.textContent = `${gameState.pomodoro.breakDuration} min`;
                saveGameState();
            });
            
            elements.useBreak.addEventListener('change', (e) => {
                gameState.pomodoro.useBreak = e.target.checked;
                saveGameState();
            });
            
            // Inventory tab event listeners
            elements.stoneButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const stoneType = button.getAttribute('data-stone');
                    fuseStones(stoneType);
                });
            });
            
            elements.useRenameScroll.addEventListener('click', useRenameScroll);
            
            // Fellow Cultivators tab event listeners
            elements.addCultivator.addEventListener('click', addFellowCultivator);
            elements.newCultivatorName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addFellowCultivator();
            });
            
            elements.editCultivatorSelect.addEventListener('change', handleCultivatorSelection);
            elements.saveCultivatorEdit.addEventListener('click', saveCultivatorEdit);
            elements.removeCultivator.addEventListener('click', removeFellowCultivator);
            
            elements.removeCultivatorSelect.addEventListener('change', (e) => {
                elements.removeCultivator.disabled = !e.target.value;
            });
            
            // Achievement tab event listeners
            document.querySelectorAll('.achievement-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update active tab
                    document.querySelectorAll('.achievement-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update achievement list
                    const category = tab.getAttribute('data-category');
                    updateAchievementsUI(category);
                });
            });
            
            // Settings tab event listeners
            elements.exportGame.addEventListener('click', exportGameData);
            elements.manualSave.addEventListener('click', () => {
                saveGameState();
                showToast("Game saved manually", "success");
            });
            elements.importGame.addEventListener('click', importGameData);
            elements.resetStats.addEventListener('click', resetStatistics);
            elements.hardReset.addEventListener('click', hardReset);
            elements.showTutorial.addEventListener('click', showTutorial);
            
            elements.settingsChangeName.addEventListener('click', () => {
                if (gameState.stones.rename > 0) {
                    useRenameScroll();
                } else {
                    showToast("Requires a Rename Scroll", "error");
                }
            });
            
            // Theme settings
            elements.themeSelect.addEventListener('change', (e) => {
                gameState.settings.theme = e.target.value;
                applyTheme();
                saveGameState();
                
                // Track theme achievement
                if (!gameState.achievements.progress["misc_theme_explorer"]) {
                    gameState.achievements.progress["misc_theme_explorer"] = 1;
                } else {
                    gameState.achievements.progress["misc_theme_explorer"]++;
                }
                checkAchievement("misc_theme_explorer");
            });
            
            elements.themeModeToggle.addEventListener('change', (e) => {
                gameState.settings.darkMode = e.target.checked;
                applyTheme();
                saveGameState();
            });
            
            // Display settings
            elements.showCompletionCount.addEventListener('change', (e) => {
                gameState.settings.showCompletionCount = e.target.checked;
                renderTaskList();
                saveGameState();
            });
            
            elements.useScientificNotation.addEventListener('change', (e) => {
                gameState.settings.useScientificNotation = e.target.checked;
                updateAllUI();
                saveGameState();
            });
            
            elements.scientificNotationThreshold.addEventListener('change', (e) => {
                gameState.settings.scientificNotationThreshold = parseInt(e.target.value);
                updateAllUI();
                saveGameState();
            });
            
            // Fellow cultivator settings
            elements.onlyMeetCustomCultivators.addEventListener('change', (e) => {
                gameState.settings.onlyMeetCustomCultivators = e.target.checked;
                saveGameState();
            });
            
            // Notification settings
            elements.notificationBreakthrough.addEventListener('change', (e) => {
                gameState.notifications.settings.breakthroughReadiness = e.target.checked;
                saveGameState();
            });
            
            elements.notificationIdle.addEventListener('change', (e) => {
                gameState.notifications.settings.idleRewards = e.target.checked;
                saveGameState();
            });
            
            elements.notificationMilestone.addEventListener('change', (e) => {
                gameState.notifications.settings.cultivationMilestones = e.target.checked;
                saveGameState();
            });
            
            elements.notificationFellowCultivator.addEventListener('change', (e) => {
                gameState.notifications.settings.fellowCultivator = e.target.checked;
                saveGameState();
            });
            
            elements.notificationAchievement.addEventListener('change', (e) => {
                gameState.notifications.settings.achievement = e.target.checked;
                saveGameState();
            });
            
            elements.notificationPomodoro.addEventListener('change', (e) => {
                gameState.notifications.settings.pomodoro = e.target.checked;
                saveGameState();
            });
            
            // Modal event listeners
            elements.modalOverlay.addEventListener('click', (e) => {
                if (e.target === elements.modalOverlay) {
                    elements.modalOverlay.classList.add('hidden');
                }
            });
            
            // Name change modal event listeners
            elements.nameChangeCancel.addEventListener('click', () => {
                elements.nameChangeOverlay.classList.add('hidden');
            });
            
            elements.nameChangeConfirm.addEventListener('click', confirmNameChange);
            
            elements.cultivatorNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') confirmNameChange();
            });
            
            // Achievement unlock modal event listener
            elements.achievementUnlockConfirm.addEventListener('click', () => {
                elements.achievementUnlockOverlay.classList.add('hidden');
            });
            
            // Tutorial event listeners
            elements.tutorialPrev.addEventListener('click', prevTutorialPage);
            elements.tutorialNext.addEventListener('click', nextTutorialPage);
            elements.tutorialSkip.addEventListener('click', skipTutorial);
            
            // Close tutorial when clicking outside
            elements.tutorialOverlay.addEventListener('click', (e) => {
                if (e.target === elements.tutorialOverlay) {
                    skipTutorial();
                }
            });
            
            // Add spirit stone handlers
            addSpiritStoneHandlers();
            
            // Initialize the game
            initializeGame();
        });

        // Handle page visibility changes for idle gains
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Page became visible, process idle gains
                processIdleQiGains();
                updateCultivationUI();
                saveGameState();
            }
        });

        // Handle page unload to save game state
        window.addEventListener('beforeunload', () => {
            saveGameState();
        });
    </script>
</body>
</html>
